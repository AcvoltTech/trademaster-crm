<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master - CRM HVACR</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkHcL1QcgKzxABmI4IJeEmjjvnZz_Xtys"></script>
  </head>
  <body>

    <!-- ==================== AUTH PAGE ==================== -->
    <div id="authPage" class="auth-container">
      <div class="auth-card">
        <div class="auth-left">
          <div class="auth-brand">
            <div class="brand-icon">üîß</div>
            <h1>Trade Master</h1>
            <p class="brand-subtitle">CRM HVACR - Sistema Multi-Empresa</p>
            <ul class="feature-list">
              <li><span class="check">‚úÖ</span> Gesti√≥n completa de clientes y trabajos</li>
              <li><span class="check">‚úÖ</span> Despacho de t√©cnicos con GPS</li>
              <li><span class="check">‚úÖ</span> Facturaci√≥n y cobranza integrada</li>
              <li><span class="check">‚úÖ</span> Seguimiento de leads con Google Maps</li>
            </ul>
          </div>
        </div>
        <div class="auth-right">
          <div class="auth-tabs">
            <button class="tab-btn active" onclick="switchTab('login')">Iniciar Sesi√≥n</button>
            <button class="tab-btn" onclick="switchTab('register')">Registrar Empresa</button>
          </div>
          <div id="loginForm" class="auth-form active">
            <h2>Bienvenido</h2>
            <div id="loginError" class="error-msg" style="display:none;"></div>
            <form onsubmit="handleLogin(event)">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" required>
              </div>
              <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
              </div>
              <button type="submit" class="btn-primary" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
            <p class="auth-link">¬øNo tienes cuenta? <a href="#" onclick="switchTab('register')">Reg√≠strate aqu√≠</a></p>
          </div>
          <div id="registerForm" class="auth-form">
            <h2>Crear Cuenta Empresarial</h2>
            <div id="registerError" class="error-msg" style="display:none;"></div>
            <div id="registerSuccess" class="success-msg" style="display:none;"></div>
            <form onsubmit="handleRegister(event)">
              <div class="form-group">
                <label>Nombre de la Empresa</label>
                <input type="text" id="companyName" placeholder="Nombre de la Empresa" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" id="firstName" placeholder="Nombre" required>
                </div>
                <div class="form-group">
                  <label>Apellido</label>
                  <input type="text" id="lastName" placeholder="Apellido" required>
                </div>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="tu@email.com" required>
              </div>
              <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="phone" placeholder="(555) 123-4567" required>
              </div>
              <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres" required>
              </div>
              <div class="form-group">
                <label>Confirmar Contrase√±a</label>
                <input type="password" id="confirmPassword" placeholder="Confirmar Contrase√±a" required>
              </div>
              <button type="submit" class="btn-primary" id="registerBtn">Crear Cuenta Empresarial</button>
            </form>
            <p class="auth-link">¬øYa tienes cuenta? <a href="#" onclick="switchTab('login')">Inicia sesi√≥n</a></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DASHBOARD PAGE ==================== -->
    <div id="dashboardPage" class="dashboard-container" style="display:none;">
      <aside class="sidebar">
        <div class="sidebar-brand">
          <span class="sidebar-icon">üîß</span>
          <h2>Trade Master</h2>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-group">
            <span class="nav-group-title">Principal</span>
            <a href="#" onclick="showSection('dashboard')" class="nav-link active"><span>üìä</span> Dashboard</a>
            <a href="#" onclick="showSection('leads')" class="nav-link"><span>üéØ</span> Leads</a>
            <a href="#" onclick="showSection('dispatch')" class="nav-link"><span>üöö</span> Dispatch</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title">Gesti√≥n</span>
            <a href="#" onclick="showSection('clients')" class="nav-link"><span>üë•</span> Clientes</a>
            <a href="#" onclick="showSection('jobs')" class="nav-link"><span>üîß</span> Trabajos</a>
            <a href="#" onclick="showSection('technicians')" class="nav-link"><span>üë∑</span> T√©cnicos</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title">Finanzas</span>
            <a href="#" onclick="showSection('invoices')" class="nav-link"><span>üìÑ</span> Facturas</a>
            <a href="#" onclick="showSection('collections')" class="nav-link"><span>üí∞</span> Cobranza</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title">Sistema</span>
            <a href="#" onclick="showSection('settings')" class="nav-link"><span>‚öôÔ∏è</span> Configuraci√≥n</a>
          </div>
        </nav>
        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar-sm" id="sidebarInitials">M</div>
            <span id="sidebarUserName" class="user-name-text">Usuario</span>
          </div>
          <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n</button>
        </div>
      </aside>

      <main class="main-content">
        <header class="top-bar">
          <h1 id="pageTitle">Dashboard</h1>
          <div class="top-bar-right">
            <span id="companyDisplay" class="company-name"></span>
            <div id="userInitials" class="user-avatar">M</div>
          </div>
        </header>

        <div class="content-area">

          <!-- ===== DASHBOARD ===== -->
          <div id="dashboard-section" class="section active">
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">Leads</span><span class="kpi-value" id="leadCountKPI">0</span><span class="kpi-sub">Total de leads</span></div>
              <div class="kpi-card"><span class="kpi-label">Trabajos Activos</span><span class="kpi-value" id="jobCountKPI">0</span><span class="kpi-sub">En progreso</span></div>
              <div class="kpi-card"><span class="kpi-label">T√©cnicos</span><span class="kpi-value" id="techCountKPI">0</span><span class="kpi-sub">Registrados</span></div>
              <div class="kpi-card"><span class="kpi-label">Clientes</span><span class="kpi-value" id="clientCountKPI">0</span><span class="kpi-sub">Clientes activos</span></div>
            </div>
            <div class="cards-row">
              <div class="card"><h3>Trabajos Recientes</h3><p class="empty-msg">No hay trabajos recientes</p></div>
              <div class="card"><h3>Pr√≥ximas Citas</h3><p class="empty-msg">No hay citas programadas</p></div>
            </div>
          </div>

          <!-- ===== LEADS ===== -->
          <div id="leads-section" class="section">
            <div class="card">
              <div class="card-top"><h3>Leads Registrados</h3><button class="btn-primary btn-sm" onclick="showLeadForm()">+ Nuevo Lead</button></div>
              <div id="leadFormContainer" style="display:none; margin-bottom:20px;">
                <form id="leadForm" onsubmit="handleLeadCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="leadName" placeholder="Nombre del cliente" required></div>
                    <div class="form-group"><label>Tel√©fono</label><input type="tel" id="leadPhone" placeholder="Tel√©fono" required></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="leadEmail" placeholder="Email"></div>
                    <div class="form-group">
                      <label>Servicio</label>
                      <select id="leadService" required>
                        <option value="">Seleccionar</option>
                        <option value="Instalaci√≥n AC">Instalaci√≥n AC</option>
                        <option value="Reparaci√≥n AC">Reparaci√≥n AC</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Calefacci√≥n">Calefacci√≥n</option>
                        <option value="Refrigeraci√≥n">Refrigeraci√≥n</option>
                        <option value="Ductos">Ductos</option>
                        <option value="Otro">Otro</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>Direcci√≥n</label><input type="text" id="leadAddress" placeholder="Direcci√≥n completa" required><input type="hidden" id="leadLat"><input type="hidden" id="leadLng"></div>
                  <div class="form-group"><label>Notas</label><textarea id="leadNotes" rows="3" placeholder="Notas adicionales"></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">Guardar Lead</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideLeadForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="leadsList"></div>
            </div>
            <div class="card"><h3>Mapa de Leads</h3><div id="leadsMap" style="width:100%;height:500px;border-radius:8px;"></div></div>
          </div>

          <!-- ===== DISPATCH ===== -->
          <div id="dispatch-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>üó∫Ô∏è Mapa de Dispatch en Tiempo Real</h3>
                <div class="dispatch-legend">
                  <span class="legend-item"><span class="legend-dot tech-dot"></span> T√©cnicos</span>
                  <span class="legend-item"><span class="legend-dot job-dot"></span> Trabajos</span>
                  <span class="legend-item"><span class="legend-dot client-dot"></span> Clientes</span>
                </div>
              </div>
              <div id="dispatchMap" style="width:100%;height:500px;border-radius:8px;"></div>
            </div>
            <div class="dispatch-panels">
              <div class="card">
                <div class="card-top"><h3>üë∑ T√©cnicos</h3><button class="btn-primary btn-sm" onclick="showTechForm()">+ Agregar T√©cnico</button></div>
                <div id="techFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="techForm" onsubmit="handleTechCreate(event)">
                    <div class="form-row">
                      <div class="form-group"><label>Nombre</label><input type="text" id="techName" required placeholder="Nombre completo"></div>
                      <div class="form-group"><label>Tel√©fono</label><input type="tel" id="techPhone" placeholder="Tel√©fono"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Email</label><input type="email" id="techEmail" placeholder="Email"></div>
                      <div class="form-group">
                        <label>Especialidad</label>
                        <select id="techSpecialty">
                          <option value="HVAC">HVAC</option>
                          <option value="Refrigeraci√≥n">Refrigeraci√≥n</option>
                          <option value="El√©ctrico">El√©ctrico</option>
                          <option value="Plomer√≠a">Plomer√≠a</option>
                          <option value="General">General</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn-primary btn-sm">Guardar</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideTechForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="techniciansList"></div>
              </div>
              <div class="card">
                <div class="card-top"><h3>üìã Trabajos Pendientes</h3><button class="btn-primary btn-sm" onclick="showJobForm()">+ Nuevo Trabajo</button></div>
                <div id="jobFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="jobForm" onsubmit="handleJobCreate(event)">
                    <div class="form-group"><label>T√≠tulo</label><input type="text" id="jobTitle" required placeholder="Descripci√≥n del trabajo"></div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Tipo de Servicio</label>
                        <select id="jobServiceType">
                          <option value="Instalaci√≥n">Instalaci√≥n</option>
                          <option value="Reparaci√≥n">Reparaci√≥n</option>
                          <option value="Mantenimiento">Mantenimiento</option>
                          <option value="Emergencia">Emergencia</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Prioridad</label>
                        <select id="jobPriority">
                          <option value="normal">Normal</option>
                          <option value="high">Alta</option>
                          <option value="urgent">Urgente</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group"><label>Direcci√≥n</label><input type="text" id="jobAddress" required placeholder="Direcci√≥n del trabajo"><input type="hidden" id="jobLat"><input type="hidden" id="jobLng"></div>
                    <div class="form-row">
                      <div class="form-group"><label>Fecha</label><input type="date" id="jobDate"></div>
                      <div class="form-group">
                        <label>Asignar T√©cnico</label>
                        <select id="jobTechId"><option value="">Sin asignar</option></select>
                      </div>
                    </div>
                    <div class="form-group"><label>Notas</label><textarea id="jobNotes" rows="2" placeholder="Notas"></textarea></div>
                    <div class="form-actions">
                      <button type="submit" class="btn-primary btn-sm">Crear Trabajo</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideJobForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="jobsList"></div>
              </div>
            </div>
          </div>

          <!-- ===== T√âCNICOS ===== -->
          <div id="technicians-section" class="section">
            <div class="card">
              <div class="card-top"><h3>Gesti√≥n de T√©cnicos</h3><button class="btn-primary btn-sm" onclick="showSection('dispatch')">Ir a Dispatch</button></div>
              <div id="techniciansFullList"></div>
            </div>
            <div class="card">
              <h3>üì± Link de Tracking para T√©cnicos</h3>
              <p style="color:var(--text-light);font-size:14px;margin-bottom:12px;">Comparte este link con tus t√©cnicos para que reporten su ubicaci√≥n en tiempo real desde su celular:</p>
              <div id="trackingLinkContainer" class="tracking-link-box"></div>
            </div>
          </div>

          <!-- ===== OTHER SECTIONS ===== -->
          <div id="clients-section" class="section"><div class="card"><h3>Gesti√≥n de Clientes</h3><p class="empty-msg">M√≥dulo en desarrollo</p></div></div>
          <div id="jobs-section" class="section"><div class="card"><h3>Gesti√≥n de Trabajos</h3><p class="empty-msg">Ir a Dispatch para gestionar trabajos</p></div></div>
          <div id="invoices-section" class="section"><div class="card"><h3>Facturas</h3><p class="empty-msg">M√≥dulo en desarrollo</p></div></div>
          <div id="collections-section" class="section"><div class="card"><h3>Cobranza</h3><p class="empty-msg">M√≥dulo en desarrollo</p></div></div>
          <div id="settings-section" class="section">
            <div class="card">
              <h3>Configuraci√≥n de la Empresa</h3>
              <div class="settings-form">
                <div class="form-group"><label>Nombre de la Empresa</label><input type="text" id="settingsCompanyName" placeholder="Nombre"></div>
                <div class="form-group"><label>Tel√©fono</label><input type="tel" id="settingsPhone" placeholder="Tel√©fono"></div>
                <div class="form-group"><label>Email</label><input type="email" id="settingsEmail" placeholder="Email"></div>
                <button class="btn-primary btn-sm" onclick="saveSettings()">Guardar Configuraci√≥n</button>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>

    <!-- ==================== TECH TRACKING PAGE (separate URL) ==================== -->
    <div id="techTrackingPage" style="display:none;">
      <div class="tracking-container">
        <div class="tracking-header">
          <span>üîß</span>
          <h2>Trade Master - GPS Tracking</h2>
        </div>
        <div id="trackingStatus" class="tracking-status">Conectando...</div>
        <div id="trackingMap" style="width:100%;height:400px;border-radius:8px;margin:20px 0;"></div>
        <button id="trackingBtn" class="btn-primary" onclick="toggleTracking()">Iniciar Tracking GPS</button>
        <p id="trackingInfo" style="color:#94a3b8;font-size:13px;text-align:center;margin-top:12px;"></p>
      </div>
    </div>

    <script src="script.js"></script>
  </body>
</html>
