<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master - CRM HVACR</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkHcL1QcgKzxABmI4IJeEmjjvnZz_Xtys"></script>
  </head>
  <body>

    <!-- ==================== AUTH PAGE ==================== -->
    <div id="authPage" class="auth-container">
      <div class="auth-card">
        <div class="auth-left">
          <div class="auth-brand">
            <div class="brand-icon">ğŸ”§</div>
            <h1>Trade Master</h1>
            <p class="brand-subtitle">CRM HVACR - Sistema Multi-Empresa</p>
            <ul class="feature-list">
              <li><span class="check">âœ…</span> GestiÃ³n completa de clientes y trabajos</li>
              <li><span class="check">âœ…</span> Despacho de tÃ©cnicos con GPS</li>
              <li><span class="check">âœ…</span> FacturaciÃ³n y cobranza integrada</li>
              <li><span class="check">âœ…</span> Seguimiento de leads con Google Maps</li>
            </ul>
          </div>
        </div>
        <div class="auth-right">
          <div class="auth-tabs">
            <button class="tab-btn active" onclick="switchTab('login')">Iniciar SesiÃ³n</button>
            <button class="tab-btn" onclick="switchTab('register')">Registrar Empresa</button>
          </div>
          <div id="loginForm" class="auth-form active">
            <h2>Bienvenido</h2>
            <div id="loginError" class="error-msg" style="display:none;"></div>
            <form onsubmit="handleLogin(event)">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" required>
              </div>
              <div class="form-group">
                <label>ContraseÃ±a</label>
                <input type="password" id="loginPassword" placeholder="ContraseÃ±a" required>
              </div>
              <button type="submit" class="btn-primary" id="loginBtn">Iniciar SesiÃ³n</button>
            </form>
            <p class="auth-link">Â¿No tienes cuenta? <a href="#" onclick="switchTab('register')">RegÃ­strate aquÃ­</a></p>
          </div>
          <div id="registerForm" class="auth-form">
            <h2>Crear Cuenta Empresarial</h2>
            <div id="registerError" class="error-msg" style="display:none;"></div>
            <div id="registerSuccess" class="success-msg" style="display:none;"></div>
            <form onsubmit="handleRegister(event)">
              <div class="form-group">
                <label>Nombre de la Empresa</label>
                <input type="text" id="companyName" placeholder="Nombre de la Empresa" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" id="firstName" placeholder="Nombre" required>
                </div>
                <div class="form-group">
                  <label>Apellido</label>
                  <input type="text" id="lastName" placeholder="Apellido" required>
                </div>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="tu@email.com" required>
              </div>
              <div class="form-group">
                <label>TelÃ©fono</label>
                <input type="tel" id="phone" placeholder="(555) 123-4567" required>
              </div>
              <div class="form-group">
                <label>ContraseÃ±a</label>
                <input type="password" id="registerPassword" placeholder="MÃ­nimo 6 caracteres" required>
              </div>
              <div class="form-group">
                <label>Confirmar ContraseÃ±a</label>
                <input type="password" id="confirmPassword" placeholder="Confirmar ContraseÃ±a" required>
              </div>
              <button type="submit" class="btn-primary" id="registerBtn">Crear Cuenta Empresarial</button>
            </form>
            <p class="auth-link">Â¿Ya tienes cuenta? <a href="#" onclick="switchTab('login')">Inicia sesiÃ³n</a></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DASHBOARD PAGE ==================== -->
    <div id="dashboardPage" class="dashboard-container" style="display:none;">
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="brand-logo" id="companyLogo">
            <svg viewBox="0 0 60 60" width="44" height="44">
              <!-- Blue gauge (low pressure) -->
              <circle cx="18" cy="22" r="14" fill="none" stroke="#3b82f6" stroke-width="2.5"/>
              <circle cx="18" cy="22" r="11" fill="#1e293b"/>
              <path d="M18 22 L12 15" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
              <text x="18" y="34" text-anchor="middle" fill="#3b82f6" font-size="4" font-weight="bold">LO</text>
              <!-- Red gauge (high pressure) -->
              <circle cx="42" cy="22" r="14" fill="none" stroke="#ef4444" stroke-width="2.5"/>
              <circle cx="42" cy="22" r="11" fill="#1e293b"/>
              <path d="M42 22 L48 15" stroke="#ef4444" stroke-width="2" stroke-linecap="round"/>
              <text x="42" y="34" text-anchor="middle" fill="#ef4444" font-size="4" font-weight="bold">HI</text>
              <!-- Amp clamp meter -->
              <rect x="22" y="42" width="16" height="14" rx="2" fill="#f59e0b" stroke="#ca8a04" stroke-width="1"/>
              <text x="30" y="51" text-anchor="middle" fill="#1e293b" font-size="5" font-weight="bold">A</text>
              <path d="M26 42 L26 38 Q26 36 28 36 L32 36 Q34 36 34 38 L34 42" fill="none" stroke="#f59e0b" stroke-width="2"/>
              <!-- Connection hoses -->
              <line x1="18" y1="36" x2="18" y2="44" stroke="#3b82f6" stroke-width="1.5"/>
              <line x1="42" y1="36" x2="42" y2="44" stroke="#ef4444" stroke-width="1.5"/>
            </svg>
          </div>
          <h2>Trade Master</h2>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_principal">Principal</span>
            <a href="#" onclick="showSection('dashboard')" class="nav-link active"><span>ğŸ“Š</span> <span data-i18n="nav_dashboard">Tablero</span></a>
            <a href="#" onclick="showSection('inbox')" class="nav-link"><span>ğŸ“¬</span> <span data-i18n="nav_inbox">Bandeja</span></a>
            <a href="#" onclick="showSection('calendar')" class="nav-link"><span>ğŸ“…</span> <span data-i18n="nav_schedule">Agenda</span></a>
            <a href="#" onclick="showSection('clients')" class="nav-link"><span>ğŸ‘¥</span> <span data-i18n="nav_customers">Clientes</span></a>
            <a href="#" onclick="showSection('leads')" class="nav-link"><span>ğŸ¯</span> <span data-i18n="nav_leads">Prospectos</span></a>
            <a href="#" onclick="showSection('pipeline')" class="nav-link"><span>ğŸ“ˆ</span> <span data-i18n="nav_pipeline">Flujo de Ventas</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_operations">Operaciones</span>
            <a href="#" onclick="showSection('dispatch')" class="nav-link"><span>ğŸšš</span> <span data-i18n="nav_dispatch">Despacho</span></a>
            <a href="#" onclick="showSection('jobs')" class="nav-link"><span>ğŸ”§</span> <span data-i18n="nav_jobs">Trabajos</span></a>
            <a href="#" onclick="showSection('technicians')" class="nav-link"><span>ğŸ‘·</span> <span data-i18n="nav_technicians">TÃ©cnicos</span></a>
            <a href="#" onclick="showSection('advisors')" class="nav-link"><span>ğŸ </span> <span data-i18n="nav_advisors">Asesores del Hogar</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_finance">Finanzas</span>
            <a href="#" onclick="showSection('invoices')" class="nav-link"><span>ğŸ“„</span> <span data-i18n="nav_invoices">Facturas</span></a>
            <a href="#" onclick="showSection('collections')" class="nav-link"><span>ğŸ’°</span> <span data-i18n="nav_collections">Cobranza</span></a>
            <a href="#" onclick="showSection('receipts')" class="nav-link"><span>ğŸ§¾</span> Recibos</a>
            <a href="#" onclick="showSection('expenses')" class="nav-link"><span>ğŸ¢</span> Gastos del Negocio</a>
            <a href="#" onclick="showSection('mymoney')" class="nav-link"><span>ğŸ’µ</span> <span data-i18n="nav_mymoney">Mi Dinero</span></a>
            <a href="#" onclick="showSection('payroll')" class="nav-link"><span>ğŸ’³</span> <span data-i18n="nav_payroll">NÃ³mina</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title">ComunicaciÃ³n</span>
            <a href="#" onclick="showSection('mailbox')" class="nav-link"><span>ğŸ“¬</span> Correo del Negocio</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_growth">Crecimiento</span>
            <a href="#" onclick="showSection('marketing')" class="nav-link"><span>ğŸ“£</span> <span data-i18n="nav_marketing">Mercadotecnia</span></a>
            <a href="#" onclick="showSection('pricebook')" class="nav-link"><span>ğŸ“’</span> <span data-i18n="nav_pricebook">Lista de Precios</span></a>
            <a href="#" onclick="showSection('reports')" class="nav-link"><span>ğŸ“Š</span> <span data-i18n="nav_reports">Reportes</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_system">Sistema</span>
            <a href="#" onclick="showSection('team')" class="nav-link"><span>ğŸ‘¥</span> Usuarios y Equipo</a>
            <a href="#" onclick="showSection('settings')" class="nav-link"><span>âš™ï¸</span> <span data-i18n="nav_settings">ConfiguraciÃ³n</span></a>
          </div>
        </nav>
        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar-sm" id="sidebarInitials">M</div>
            <span id="sidebarUserName" class="user-name-text">Usuario</span>
          </div>
          <button onclick="logout()" class="btn-logout">Cerrar SesiÃ³n</button>
        </div>
      </aside>

      <main class="main-content">
        <header class="top-bar">
          <h1 id="pageTitle">Tablero</h1>
          <div class="top-bar-right">
            <!-- Global Search -->
            <div class="global-search-wrap">
              <input type="text" id="globalSearchInput" placeholder="ğŸ” Buscar cliente, trabajo, factura..." oninput="globalSearch(this.value)" onfocus="this.parentElement.classList.add('focused')" onblur="setTimeout(function(){document.querySelector('.global-search-wrap').classList.remove('focused')},200)">
              <div id="globalSearchResults" class="global-search-results"></div>
            </div>
            <!-- Quick Add -->
            <div class="quick-add-wrap">
              <button class="quick-add-btn" onclick="toggleQuickAdd()" title="Crear RÃ¡pido">+</button>
              <div id="quickAddMenu" class="quick-add-menu" style="display:none;">
                <div class="quick-add-title">Crear Nuevo</div>
                <a href="#" onclick="quickAddAction('client')">ğŸ‘¥ Nuevo Cliente</a>
                <a href="#" onclick="quickAddAction('job')">ğŸ”§ Nuevo Trabajo</a>
                <a href="#" onclick="quickAddAction('lead')">ğŸ¯ Nuevo Lead</a>
                <a href="#" onclick="quickAddAction('appointment')">ğŸ“… Nueva Cita</a>
                <a href="#" onclick="quickAddAction('invoice')">ğŸ“„ Nueva Factura</a>
                <a href="#" onclick="quickAddAction('estimate')">ğŸ’° Nuevo Estimado</a>
              </div>
            </div>
            <!-- Notifications -->
            <div class="notif-wrap">
              <button class="notif-btn" onclick="toggleNotifications()" title="Notificaciones">
                ğŸ””
                <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
              </button>
              <div id="notifPanel" class="notif-panel" style="display:none;">
                <div class="notif-header">ğŸ”” Notificaciones</div>
                <div id="notifList" class="notif-list"><p class="empty-msg">Sin notificaciones</p></div>
              </div>
            </div>
            <span id="companyDisplay" class="company-name"></span>
            <!-- Language Toggle -->
            <button class="lang-toggle-btn" onclick="toggleLanguage()" title="Cambiar Idioma / Change Language">
              <span id="langFlag">ğŸ‡²ğŸ‡½</span> <span id="langLabel">ES</span>
            </button>
            <div id="userInitials" class="user-avatar">M</div>
          </div>
        </header>

        <div class="content-area">

          <!-- ===== DASHBOARD ===== -->
          <div id="dashboard-section" class="section active">

            <!-- HCP-Style Welcome Banner -->
            <div class="hcp-welcome-banner">
              <button class="hcp-close-banner" onclick="this.parentElement.style.display='none'">âœ•</button>
              <h2 id="dashWelcomeMsg" data-i18n="dash_welcome">Hola, Â¿en quÃ© nos enfocamos hoy?</h2>
              <div class="hcp-quick-actions">
                <button onclick="quickAddAction('estimate')">âœ¨ <span data-i18n="dash_add_material">Agregar materiales</span></button>
                <button onclick="showSection('clients')">âœ¨ <span data-i18n="dash_import_data">Importar datos</span></button>
                <button onclick="showSection('marketing')">âœ¨ <span data-i18n="dash_connect_reviews">Conectar reseÃ±as</span></button>
                <button onclick="showSection('reports')">âœ¨ <span data-i18n="dash_ask_something">Preguntar algo</span></button>
              </div>
            </div>

            <!-- HCP-Style Summary Cards (Estimates / Jobs / Invoices / Plan de Servicios) -->
            <div class="hcp-summary-grid">
              <div class="hcp-summary-card" onclick="showSection('jobs')">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ“‹</span>
                  <span data-i18n="dash_estimates">Estimados</span>
                  <button class="hcp-plus-btn" onclick="event.stopPropagation();quickAddAction('estimate')">+</button>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpOpenEstimates">0</span>
                  <div class="hcp-summary-detail">
                    <span data-i18n="dash_open_estimates">Estimados abiertos</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <span class="hcp-sub-amount" id="hcpEstimatesAmount">$0.00</span>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('jobs')" data-i18n="dash_view_all_estimates">Ver todos los estimados</a>
              </div>

              <div class="hcp-summary-card" onclick="showSection('dispatch')">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ”§</span>
                  <span data-i18n="dash_jobs">Trabajos</span>
                  <button class="hcp-plus-btn" onclick="event.stopPropagation();quickAddAction('job')">+</button>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpUnschedJobs">0</span>
                  <div class="hcp-summary-detail">
                    <span data-i18n="dash_unsched_jobs">Trabajos sin agendar</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <span class="hcp-sub-amount" id="hcpJobsAmount">$0.00</span>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('jobs')" data-i18n="dash_view_all_jobs">Ver todos los trabajos</a>
              </div>

              <div class="hcp-summary-card" onclick="showSection('invoices')">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ“„</span>
                  <span data-i18n="dash_invoices">Facturas</span>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpOpenInvoices">0</span>
                  <div class="hcp-summary-detail">
                    <span data-i18n="dash_open_invoices">Facturas abiertas</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <span class="hcp-sub-amount" id="hcpInvoicesAmount">$0.00</span>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('invoices')" data-i18n="dash_view_all_invoices">Ver todas las facturas</a>
              </div>

              <div class="hcp-summary-card" onclick="showSection('dashboard')">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ›¡ï¸</span>
                  <span data-i18n="dash_service_plans">Planes de Servicio</span>
                </div>
                <div class="hcp-summary-body">
                  <p class="hcp-sp-text" data-i18n="dash_sp_desc">Crea planes de servicio para crecer ingresos y fidelizar clientes.</p>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showServicePlanForm()" data-i18n="dash_create_template">+ Crear plantilla</a>
              </div>
            </div>

            <!-- Year to Date KPIs (Housecall Pro style) -->
            <div class="hcp-ytd-section">
              <div class="hcp-ytd-header">
                <select id="ytdPeriod" class="inline-select" onchange="renderYTDKpis()" style="padding:6px 10px;font-size:13px;font-weight:600;">
                  <option value="ytd" data-i18n="dash_ytd">AÃ±o hasta la fecha</option>
                  <option value="mtd" data-i18n="dash_mtd">Mes hasta la fecha</option>
                  <option value="last30" data-i18n="dash_last30">Ãšltimos 30 dÃ­as</option>
                  <option value="last90" data-i18n="dash_last90">Ãšltimos 90 dÃ­as</option>
                </select>
                <a class="hcp-link" onclick="showSection('reports')" data-i18n="dash_view_reports">Ver todos los reportes</a>
              </div>
              <div class="hcp-ytd-grid">
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_revenue">INGRESOS GANADOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdRevenue">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_completed">TRABAJOS COMPLETADOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdCompleted">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_avg_job">TICKET PROMEDIO</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdAvgJob">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_new_booked">NUEVOS TRABAJOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdNewBooked">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_online_booked">RESERVADOS EN LÃNEA</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdOnlineBooked">--</span>
                </div>
              </div>
            </div>

            <!-- Employee Status + Map (Housecall Pro style) -->
            <div class="hcp-employee-section">
              <div class="hcp-employee-left">
                <div class="hcp-employee-header">
                  <h3 data-i18n="dash_employee_status">Estado de Empleados</h3>
                  <div class="hcp-today-toggle">
                    <button class="hcp-toggle-btn active" onclick="setEmployeeView('today')" data-i18n="dash_today">Hoy</button>
                    <button class="hcp-toggle-btn" onclick="setEmployeeView('tomorrow')" data-i18n="dash_tomorrow">MaÃ±ana</button>
                  </div>
                </div>
                <div id="employeeStatusList" class="hcp-employee-list">
                  <p class="empty-msg" data-i18n="dash_see_jobs">Ve los trabajos y estimados del dÃ­a</p>
                </div>
                <div class="hcp-employee-actions">
                  <button class="btn-secondary btn-sm" onclick="quickAddAction('job')" data-i18n="dash_add_job">Agregar trabajo</button>
                  <button class="btn-secondary btn-sm" onclick="quickAddAction('estimate')" data-i18n="dash_add_estimate">Agregar estimado</button>
                </div>
              </div>
              <div class="hcp-employee-right">
                <div id="employeeStatusMap" style="width:100%;height:100%;min-height:300px;border-radius:8px;"></div>
              </div>
            </div>

            <!-- ===== CLOCK IN / OUT WIDGET ===== -->
            <div class="clock-widget-card">
              <div class="clock-widget-left">
                <div class="clock-display">
                  <span class="clock-time" id="dashClockTime">00:00:00</span>
                  <span class="clock-date" id="dashClockDate"></span>
                </div>
                <div class="clock-controls">
                  <div class="form-row" style="margin-bottom:10px;">
                    <div class="form-group" style="margin:0;">
                      <label style="font-size:11px;margin-bottom:4px;" data-i18n="clock_select_tech">Seleccionar Persona</label>
                      <select id="clockTechSelect" onchange="onClockTechChange()" style="padding:8px;font-size:12px;"></select>
                    </div>
                    <div class="form-group" style="margin:0;">
                      <label style="font-size:11px;margin-bottom:4px;" data-i18n="clock_hourly_rate">Tarifa por Hora</label>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="font-size:14px;">$</span>
                        <input type="number" id="clockHourlyRate" value="0" min="0" step="0.50" style="padding:8px;font-size:14px;font-weight:700;width:80px;" onchange="saveClockRate()">
                        <span style="font-size:11px;color:var(--text-muted);">/hr</span>
                      </div>
                    </div>
                  </div>
                  <button class="clock-btn clock-btn-in" id="clockInOutBtn" onclick="toggleDashClockInOut()">
                    <span class="clock-btn-icon" id="clockBtnIcon">ğŸŸ¢</span>
                    <span id="clockBtnText" data-i18n="clock_in">Marcar Entrada</span>
                  </button>
                </div>
              </div>
              <div class="clock-widget-right">
                <div class="clock-earning-box">
                  <span class="clock-earning-label" data-i18n="clock_worked_today">Trabajado Hoy</span>
                  <span class="clock-earning-time" id="clockWorkedTime">0h 0m 0s</span>
                </div>
                <div class="clock-earning-box clock-earning-highlight">
                  <span class="clock-earning-label" data-i18n="clock_earned_today">Ganado Hoy</span>
                  <span class="clock-earning-money" id="clockEarnedToday">$0.00</span>
                </div>
                <div class="clock-earning-box">
                  <span class="clock-earning-label" data-i18n="clock_projected_8h">ProyecciÃ³n 8hrs</span>
                  <span class="clock-earning-sub" id="clockProjected8">$0.00</span>
                </div>
                <!-- Today's Clock History -->
                <div class="clock-history">
                  <span class="clock-history-title" data-i18n="clock_history">Historial de Hoy</span>
                  <div id="clockHistoryList"></div>
                </div>
              </div>
            </div>

            <!-- Estimates Pipeline -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“‹ <span data-i18n="dash_est_pipeline">Flujo de Estimados</span></h3>
                <button class="btn-primary btn-sm" onclick="showSection('jobs')">+ <span data-i18n="dash_new_estimate">Nuevo Estimado</span></button>
              </div>
              <div id="estimatePipeline" class="pipeline-row">
                <div class="pipeline-card pipeline-open">
                  <div class="pipeline-num" id="pipeOpenCount">0</div>
                  <div class="pipeline-label">Abiertos</div>
                  <div class="pipeline-amount" id="pipeOpenAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-approved">
                  <div class="pipeline-num" id="pipeApprovedCount">0</div>
                  <div class="pipeline-label">Aprobados</div>
                  <div class="pipeline-amount" id="pipeApprovedAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-invoiced">
                  <div class="pipeline-num" id="pipeInvoicedCount">0</div>
                  <div class="pipeline-label">Facturados</div>
                  <div class="pipeline-amount" id="pipeInvoicedAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-paid">
                  <div class="pipeline-num" id="pipePaidCount">0</div>
                  <div class="pipeline-label">Cobrados</div>
                  <div class="pipeline-amount" id="pipePaidAmt">$0</div>
                </div>
              </div>
              <div id="pipeConversionRate" style="text-align:center;margin-top:8px;font-size:12px;color:var(--text-muted);"></div>
            </div>

            <!-- Revenue Pipeline -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ’° Flujo de Efectivo</h3>
                <select id="pipelineYear" class="inline-select" onchange="renderPipeline()" style="padding:8px 12px;">
                </select>
              </div>
              <div id="pipelineChart" class="pipeline-chart"></div>
              <div id="pipelineStats" class="pipeline-stats"></div>
            </div>

            <div class="cards-row">
              <!-- Recent Jobs -->
              <div class="card">
                <h3>ğŸ”§ Trabajos Recientes</h3>
                <div id="dashRecentJobs"></div>
              </div>
              <!-- Upcoming Appointments -->
              <div class="card">
                <h3>ğŸ“… PrÃ³ximas Citas</h3>
                <div id="dashUpcomingAppts"></div>
              </div>
            </div>

            <!-- Overdue Invoices Alert -->
            <div id="dashOverdueAlert" style="display:none;" class="card">
              <h3>ğŸ”´ Facturas Vencidas</h3>
              <div id="dashOverdueList"></div>
            </div>

            <!-- Plan de Servicios -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ›¡ï¸ Planes de Servicio / Plan de Servicios</h3>
                <button class="btn-primary btn-sm" onclick="showServicePlanForm()">+ Nuevo Plan</button>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">MembresÃ­as de mantenimiento recurrente. Genera ingresos estables y fideliza clientes.</p>
              <div id="servicePlanFormArea" style="display:none;margin-bottom:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">Crear Plan de Servicio</h4>
                <form onsubmit="createServicePlan(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre del Plan</label><input type="text" id="spName" required placeholder="Ej: Plan Gold Mantenimiento"></div>
                    <div class="form-group"><label>Precio Mensual ($)</label><input type="number" id="spPrice" required min="0" step="0.01" placeholder="49.99"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Visitas por AÃ±o</label><input type="number" id="spVisits" value="2" min="1" max="12"></div>
                    <div class="form-group"><label>Descuento en Reparaciones (%)</label><input type="number" id="spDiscount" value="15" min="0" max="50"></div>
                  </div>
                  <div class="form-group"><label>Incluye</label><textarea id="spIncludes" rows="2" placeholder="Ej: 2 Tune-Ups al aÃ±o, inspecciÃ³n de filtros, prioridad en emergencias, 15% descuento en reparaciones"></textarea></div>
                  <div class="form-row">
                    <div class="form-group"><label>DuraciÃ³n</label>
                      <select id="spDuration">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="annual">Anual</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tipo de Equipo</label>
                      <select id="spEquipType">
                        <option value="residential_ac">AC Residencial</option>
                        <option value="commercial_ac">AC Comercial</option>
                        <option value="heating">Heating / Furnace</option>
                        <option value="full_system">Sistema Completo (AC + Heating)</option>
                        <option value="refrigeration">RefrigeraciÃ³n</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Plan</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideServicePlanForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="servicePlansList"></div>
            </div>
          </div>

          <!-- ===== CALENDAR / SCHEDULE ===== -->
          <div id="calendar-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“… Calendario de Citas</h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <div class="cal-view-toggle">
                    <button class="cal-view-btn active" id="calViewMonth" onclick="setCalView('month')">Mes</button>
                    <button class="cal-view-btn" id="calViewWeek" onclick="setCalView('week')">Semana</button>
                    <button class="cal-view-btn" id="calViewDay" onclick="setCalView('day')">DÃ­a</button>
                  </div>
                  <button class="btn-secondary btn-sm" onclick="calPrev()" style="padding:6px 12px;">â—€</button>
                  <span id="calMonthLabel" style="font-weight:700;font-size:15px;color:var(--primary);min-width:160px;text-align:center;"></span>
                  <button class="btn-secondary btn-sm" onclick="calNext()" style="padding:6px 12px;">â–¶</button>
                  <button class="btn-secondary btn-sm" onclick="calToday()" style="margin-left:8px;">Hoy</button>
                  <button class="btn-primary btn-sm" onclick="showApptForm()">+ Nueva Cita</button>
                </div>
              </div>

              <!-- Appointment Form -->
              <div id="apptFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);" id="apptFormTitle">ğŸ“… Nueva Cita</h4>
                <form id="apptForm" onsubmit="handleApptCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>TÃ­tulo / Servicio</label><input type="text" id="apptTitle" required placeholder="Ej: Tune-Up AC, ReparaciÃ³n Furnace..."></div>
                    <div class="form-group"><label>Cliente</label>
                      <select id="apptClientSelect" onchange="loadApptClientInfo()">
                        <option value="">Seleccionar o crear...</option>
                        <option value="__new__">â• Nuevo Cliente</option>
                      </select>
                    </div>
                  </div>
                  <!-- New client fields (hidden by default) -->
                  <div id="apptNewClientFields" style="display:none;">
                    <div class="form-row">
                      <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="apptNewClientName" placeholder="Nombre completo"></div>
                      <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="apptNewClientPhone" placeholder="(555) 123-4567"></div>
                    </div>
                    <div class="form-group"><label>Email</label><input type="email" id="apptNewClientEmail" placeholder="email@cliente.com"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Fecha</label><input type="date" id="apptDate" required></div>
                    <div class="form-group"><label>Hora Inicio</label><input type="time" id="apptStartTime" value="09:00"></div>
                    <div class="form-group"><label>Hora Fin</label><input type="time" id="apptEndTime" value="10:00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TÃ©cnico</label>
                      <select id="apptTechSelect"><option value="">Sin asignar</option></select>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="apptAddress" placeholder="DirecciÃ³n del servicio"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="apptNotes" rows="2" placeholder="Detalles adicionales..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm" id="apptSubmitBtn">ğŸ’¾ Crear Cita</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideApptForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Calendar Grid -->
              <div id="calendarGrid" class="calendar-grid"></div>
              <div id="calWeekGrid" class="cal-week-grid" style="display:none;"></div>
              <div id="calDayGrid" class="cal-day-grid" style="display:none;"></div>
            </div>

            <!-- Day Detail -->
            <div class="card" style="margin-top:16px;">
              <h3 id="calDayTitle">ğŸ“‹ Citas del DÃ­a</h3>
              <div id="calDayAppts"></div>
            </div>
          </div>

          <!-- ===== INBOX ===== -->
          <div id="inbox-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“¬ Bandeja - Centro de ComunicaciÃ³n</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="inboxFilter" onchange="renderInbox()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                    <option value="all">ğŸ“‹ Todas</option>
                    <option value="call_out">ğŸ“± Llamadas Salientes</option>
                    <option value="call_in">ğŸ“² Llamadas Entrantes</option>
                    <option value="text">ğŸ’¬ Texto/SMS</option>
                    <option value="email">ğŸ“§ Email</option>
                    <option value="visit">ğŸ  Visitas</option>
                    <option value="follow_up">ğŸ”„ Follow-Ups</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showInboxCompose()">+ Nueva ComunicaciÃ³n</button>
                </div>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Registro centralizado de todas las comunicaciones con clientes. Llamadas, textos, emails, visitas y follow-ups.</p>
              
              <div id="inboxComposeArea" style="display:none;margin-bottom:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Registrar ComunicaciÃ³n</h4>
                <form onsubmit="createInboxComm(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Cliente</label>
                      <select id="inboxClient" required>
                        <option value="">Seleccionar cliente...</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tipo</label>
                      <select id="inboxType">
                        <option value="call_out">ğŸ“± Llamada Saliente</option>
                        <option value="call_in">ğŸ“² Llamada Entrante</option>
                        <option value="text">ğŸ’¬ Texto/SMS</option>
                        <option value="email">ğŸ“§ Email</option>
                        <option value="visit">ğŸ  Visita</option>
                        <option value="follow_up">ğŸ”„ Follow-Up</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>DescripciÃ³n</label><textarea id="inboxNote" rows="2" required placeholder="Resumen de la comunicaciÃ³n..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideInboxCompose()">Cancelar</button>
                  </div>
                </form>
              </div>
              
              <div id="inboxList"></div>
            </div>
          </div>

          <!-- ===== LEADS ===== -->
          <div id="leads-section" class="section">
            <div class="card">
              <div class="card-top"><h3>Leads Registrados</h3><button class="btn-primary btn-sm" onclick="showLeadForm()">+ Nuevo Lead</button></div>
              <div id="leadFormContainer" style="display:none; margin-bottom:20px;">
                <form id="leadForm" onsubmit="handleLeadCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="leadName" placeholder="Nombre del cliente" required></div>
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="leadPhone" placeholder="TelÃ©fono" required></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="leadEmail" placeholder="Email"></div>
                    <div class="form-group">
                      <label>Servicio</label>
                      <select id="leadService" required>
                        <option value="">Seleccionar</option>
                        <option value="InstalaciÃ³n AC">InstalaciÃ³n AC</option>
                        <option value="ReparaciÃ³n AC">ReparaciÃ³n AC</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="CalefacciÃ³n">CalefacciÃ³n</option>
                        <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                        <option value="Ductos">Ductos</option>
                        <option value="Otro">Otro</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Tipo de Propiedad</label>
                      <select id="leadPropertyType">
                        <option value="residential">ğŸ  Residencial</option>
                        <option value="commercial">ğŸ¢ Comercial</option>
                        <option value="industrial">ğŸ­ Industrial</option>
                        <option value="restaurant">ğŸ½ï¸ Restaurante</option>
                      </select>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="leadAddress" placeholder="DirecciÃ³n completa" required><input type="hidden" id="leadLat"><input type="hidden" id="leadLng"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="leadNotes" rows="3" placeholder="Notas adicionales"></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">Guardar Lead</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideLeadForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="leadsList"></div>
            </div>
            <div class="card"><h3>Mapa de Leads</h3><div id="leadsMap" style="width:100%;height:500px;border-radius:8px;"></div></div>
          </div>

          <!-- ===== DISPATCH ===== -->
          <div id="dispatch-section" class="section">
            <!-- Dispatch Coordinator -->
            <div class="card" style="margin-bottom:16px;border:2px solid var(--primary);">
              <div class="card-top">
                <h3>ğŸ¯ Coordinador de Despacho</h3>
                <button class="btn-secondary btn-sm" onclick="toggleDispatchCoord()" id="dispCoordToggle">âœï¸ Editar</button>
              </div>
              <div id="dispCoordDisplay" style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;padding:8px 0;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <div id="dispCoordAvatar" class="dispatch-avatar-container" style="width:70px;height:70px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;overflow:hidden;position:relative;">?</div>
                  <div>
                    <div id="dispCoordName" style="font-weight:700;font-size:15px;color:var(--text-primary);">Sin asignar</div>
                    <div id="dispCoordRole" style="font-size:11px;color:var(--text-muted);">Asigna un responsable de despacho</div>
                  </div>
                </div>
                <div id="dispCoordInfo" style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;"></div>
              </div>
              <div id="dispCoordForm" style="display:none;margin-top:12px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <!-- Profile Photo Upload -->
                <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
                  <div id="dcPhotoPreview" class="dc-photo-preview">
                    <span id="dcPhotoPlaceholder">ğŸ“·</span>
                    <img id="dcPhotoImg" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;">
                  </div>
                  <div style="flex:1;">
                    <h5 style="margin-bottom:6px;color:var(--text-primary);">Foto de Perfil</h5>
                    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Sube una foto del coordinador de despacho. Se mostrarÃ¡ en el panel principal.</p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <label class="btn-primary btn-sm" style="cursor:pointer;">
                        ğŸ“· Subir Foto
                        <input type="file" accept="image/*" onchange="handleDCPhotoUpload(this)" style="display:none;" id="dcPhotoInput">
                      </label>
                      <button type="button" class="btn-secondary btn-sm" onclick="takeDCPhoto()">ğŸ“¸ Tomar Foto</button>
                      <button type="button" class="btn-secondary btn-sm" style="color:#ef4444;" onclick="removeDCPhoto()">ğŸ—‘ï¸ Quitar</button>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Nombre Completo</label><input type="text" id="dcName" placeholder="Nombre del coordinador"></div>
                  <div class="form-group"><label>Puesto / Cargo</label><input type="text" id="dcRole" placeholder="Ej: Coordinador de Despacho, Gerente de Oficina"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="dcPhone" placeholder="(555) 123-4567"></div>
                  <div class="form-group"><label>Email</label><input type="email" id="dcEmail" placeholder="dispatch@empresa.com"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Licencia / CertificaciÃ³n</label><input type="text" id="dcLicense" placeholder="Ej: C-10 #1234567"></div>
                  <div class="form-group"><label>Turno / Horario</label>
                    <select id="dcShift">
                      <option value="Tiempo Completo 7am-5pm">Tiempo Completo 7am-5pm</option>
                      <option value="MaÃ±ana 6am-2pm">MaÃ±ana 6am-2pm</option>
                      <option value="Tarde 2pm-10pm">Tarde 2pm-10pm</option>
                      <option value="Noche 10pm-6am">Noche 10pm-6am</option>
                      <option value="Guardia 24/7">Guardia 24/7</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Notas / Responsabilidades</label><textarea id="dcNotes" rows="2" placeholder="Responsabilidades principales, zona de cobertura, etc."></textarea></div>
                </div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveDispatchCoord()">ğŸ’¾ Guardar</button>
                  <button class="btn-secondary btn-sm" onclick="toggleDispatchCoord()">Cancelar</button>
                </div>
              </div>
            </div>

            <div class="dispatch-panels">
              <div class="card">
                <div class="card-top"><h3>ğŸ‘· TÃ©cnicos</h3><button class="btn-primary btn-sm" onclick="showTechForm()">+ Agregar TÃ©cnico</button></div>
                <div id="techFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="techForm" onsubmit="handleTechCreate(event)">
                    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
                      <!-- Photo Upload -->
                      <div style="text-align:center;min-width:120px;">
                        <div id="techPhotoPreview" style="width:110px;height:130px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:6px;background:var(--bg-input);cursor:pointer;" onclick="document.getElementById('techPhotoInput').click()">
                          <span style="font-size:11px;color:var(--text-muted);text-align:center;">ğŸ“· Foto del<br>TÃ©cnico</span>
                        </div>
                        <input type="file" id="techPhotoInput" accept="image/*" style="display:none" onchange="previewTechPhoto(this)">
                        <button type="button" class="btn-secondary btn-sm" style="font-size:10px;padding:2px 8px;" onclick="document.getElementById('techPhotoInput').click()">ğŸ“¤ Subir Foto</button>
                      </div>
                      <!-- Info Fields -->
                      <div style="flex:1;min-width:280px;">
                        <div class="form-row">
                          <div class="form-group"><label>Nombre</label><input type="text" id="techName" required placeholder="Nombre completo"></div>
                          <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="techPhone" placeholder="TelÃ©fono"></div>
                        </div>
                        <div class="form-row">
                          <div class="form-group"><label>Email</label><input type="email" id="techEmail" placeholder="Email"></div>
                          <div class="form-group">
                            <label>Especialidad</label>
                            <select id="techSpecialty">
                              <option value="HVAC">HVAC</option>
                              <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                              <option value="ElÃ©ctrico">ElÃ©ctrico</option>
                              <option value="PlomerÃ­a">PlomerÃ­a</option>
                              <option value="General">General</option>
                            </select>
                          </div>
                        </div>
                        <h5 style="color:var(--primary);margin:8px 0 4px;font-size:12px;">ğŸš VehÃ­culo Asignado / Assigned Vehicle</h5>
                        <div class="form-row">
                          <div class="form-group"><label>VehÃ­culo</label><input type="text" id="techVehicle" placeholder="Ej: 2022 Ford Transit"></div>
                          <div class="form-group"><label>Placas / License Plate</label><input type="text" id="techPlate" placeholder="Ej: ABC1234"></div>
                        </div>
                        <div class="form-row">
                          <div class="form-group"><label>VIN #</label><input type="text" id="techVin" placeholder="Vehicle ID Number"></div>
                          <div class="form-group"><label>Color</label><input type="text" id="techVehicleColor" placeholder="Ej: Blanco"></div>
                        </div>
                      </div>
                    </div>
                    <div class="form-actions" style="margin-top:10px;">
                      <button type="submit" class="btn-primary btn-sm">Guardar</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideTechForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="techniciansList"></div>
              </div>
              <div class="card">
                <div class="card-top"><h3>ğŸ“‹ Trabajos Pendientes</h3><button class="btn-primary btn-sm" onclick="showJobForm()">+ Nuevo Trabajo</button></div>
                <div id="jobFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="jobForm" onsubmit="handleJobCreate(event)">
                    <div class="form-group"><label>TÃ­tulo</label><input type="text" id="jobTitle" required placeholder="DescripciÃ³n del trabajo"></div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Tipo de Servicio</label>
                        <select id="jobServiceType">
                          <option value="InstalaciÃ³n">InstalaciÃ³n</option>
                          <option value="ReparaciÃ³n">ReparaciÃ³n</option>
                          <option value="Mantenimiento">Mantenimiento</option>
                          <option value="Emergencia">Emergencia</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Prioridad</label>
                        <select id="jobPriority">
                          <option value="normal">Normal</option>
                          <option value="high">Alta</option>
                          <option value="urgent">Urgente</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="jobAddress" required placeholder="DirecciÃ³n del trabajo"><input type="hidden" id="jobLat"><input type="hidden" id="jobLng"></div>
                    <div class="form-row">
                      <div class="form-group"><label>Fecha</label><input type="date" id="jobDate"></div>
                      <div class="form-group">
                        <label>Asignar TÃ©cnico</label>
                        <select id="jobTechId"><option value="">Sin asignar</option></select>
                      </div>
                    </div>
                    <div class="form-group"><label>Notas</label><textarea id="jobNotes" rows="2" placeholder="Notas"></textarea></div>
                    <div class="form-actions">
                      <button type="submit" class="btn-primary btn-sm">Crear Trabajo</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideJobForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="jobsList"></div>
              </div>
            </div>
            <div class="card">
              <div class="card-top">
                <h3>ğŸ—ºï¸ Mapa de Despacho en Tiempo Real</h3>
                <div class="dispatch-legend">
                  <span class="legend-item"><span style="color:#3b82f6;">ğŸš</span> Disponible</span>
                  <span class="legend-item"><span style="color:#f59e0b;">ğŸš</span> Ocupado</span>
                  <span class="legend-item"><span style="color:#8b5cf6;">ğŸš</span> En Ruta</span>
                  <span class="legend-item"><span class="legend-dot job-dot"></span> Trabajos</span>
                  <span class="legend-item"><span class="legend-dot client-dot"></span> Clientes</span>
                </div>
              </div>
              <div id="dispatchMap" style="width:100%;height:500px;border-radius:8px;"></div>
            </div>
          </div>

          <!-- ===== TÃ‰CNICOS ===== -->
          <div id="technicians-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ‘· GestiÃ³n de TÃ©cnicos</h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showTechFormInTechSection()">+ Agregar TÃ©cnico</button>
                  <button class="btn-secondary btn-sm" onclick="showSection('dispatch')">ğŸ¯ Ir a Despacho</button>
                </div>
              </div>

              <!-- Tech Form (same as dispatch but works here too) -->
              <div id="techFormContainerAlt" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ‘· Nuevo TÃ©cnico</h4>
                <form onsubmit="handleTechCreateAlt(event)">
                  <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
                    <div style="text-align:center;min-width:120px;">
                      <div id="techPhotoPreviewAlt" style="width:110px;height:130px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:6px;background:var(--bg-card);cursor:pointer;" onclick="document.getElementById('techPhotoInputAlt').click()">
                        <span style="font-size:11px;color:var(--text-muted);text-align:center;">ğŸ“· Foto del<br>TÃ©cnico</span>
                      </div>
                      <input type="file" id="techPhotoInputAlt" accept="image/*" style="display:none" onchange="previewTechPhotoAlt(this)">
                      <button type="button" class="btn-secondary btn-sm" style="font-size:10px;padding:2px 8px;" onclick="document.getElementById('techPhotoInputAlt').click()">ğŸ“¤ Subir Foto</button>
                    </div>
                    <div style="flex:1;min-width:280px;">
                      <div class="form-row">
                        <div class="form-group"><label>Nombre Completo</label><input type="text" id="techNameAlt" required placeholder="Ej: Juan PÃ©rez"></div>
                        <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="techPhoneAlt" placeholder="(555) 123-4567"></div>
                      </div>
                      <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="techEmailAlt" placeholder="tecnico@email.com"></div>
                        <div class="form-group"><label>Especialidad</label>
                          <select id="techSpecialtyAlt">
                            <option value="HVAC">HVAC</option>
                            <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                            <option value="ElÃ©ctrico">ElÃ©ctrico</option>
                            <option value="PlomerÃ­a">PlomerÃ­a</option>
                            <option value="General">General</option>
                          </select>
                        </div>
                      </div>
                      <h5 style="color:var(--primary);margin:8px 0 4px;font-size:12px;">ğŸš VehÃ­culo Asignado</h5>
                      <div class="form-row">
                        <div class="form-group"><label>VehÃ­culo</label><input type="text" id="techVehicleAlt" placeholder="Ej: 2022 Ford Transit"></div>
                        <div class="form-group"><label>Placas</label><input type="text" id="techPlateAlt" placeholder="Ej: ABC1234"></div>
                      </div>
                      <div class="form-row">
                        <div class="form-group"><label>VIN #</label><input type="text" id="techVinAlt" placeholder="NÃºmero de identificaciÃ³n del vehÃ­culo"></div>
                        <div class="form-group"><label>Color</label><input type="text" id="techVehicleColorAlt" placeholder="Ej: Blanco"></div>
                      </div>
                    </div>
                  </div>
                  <div class="form-actions" style="margin-top:10px;">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar TÃ©cnico</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideTechFormAlt()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Technicians List with cards -->
              <div id="techniciansFullList"></div>
            </div>

            <!-- Technician Credentials -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“œ Credenciales de TÃ©cnicos</h3>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube las credenciales y certificaciones de cada tÃ©cnico. Estos documentos se pueden incluir en estimados y facturas para cumplir con requisitos de empresas y clientes comerciales.</p>
              
              <div class="form-group" style="max-width:300px;margin-bottom:16px;">
                <label>Seleccionar TÃ©cnico</label>
                <select id="techCredSelect" onchange="loadTechCredentials()">
                  <option value="">-- Seleccionar TÃ©cnico --</option>
                </select>
              </div>

              <div id="techCredArea" style="display:none;">

                <!-- Tech Profile Card with Photo -->
                <div id="techProfileCard" style="display:flex;gap:16px;align-items:flex-start;padding:16px;background:var(--bg-input);border:2px solid var(--primary);border-radius:12px;margin-bottom:16px;flex-wrap:wrap;">
                  <div style="text-align:center;">
                    <div id="techCredPhoto" style="width:120px;height:150px;border:2px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:white;">
                      <span style="font-size:40px;">ğŸ‘¤</span>
                    </div>
                    <label class="btn-secondary btn-sm doc-upload-btn" style="margin-top:6px;font-size:10px;">
                      ğŸ“· Actualizar Foto
                      <input type="file" accept="image/*" style="display:none" onchange="uploadTechPhoto(this)">
                    </label>
                  </div>
                  <div style="flex:1;min-width:200px;">
                    <h4 id="techCredName" style="color:var(--primary);margin-bottom:4px;">â€”</h4>
                    <p id="techCredSpecialty" style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">â€”</p>
                    <div id="techCredVehicleInfo" style="font-size:12px;line-height:1.8;"></div>
                    <div style="margin-top:8px;">
                      <h5 style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Editar VehÃ­culo:</h5>
                      <div class="form-row" style="gap:6px;">
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVehicle" placeholder="2022 Ford Transit" style="font-size:11px;padding:4px 8px;"></div>
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcPlate" placeholder="Placas: ABC1234" style="font-size:11px;padding:4px 8px;"></div>
                      </div>
                      <div class="form-row" style="gap:6px;">
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVin" placeholder="VIN #" style="font-size:11px;padding:4px 8px;"></div>
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVehicleColor" placeholder="Color" style="font-size:11px;padding:4px 8px;"></div>
                      </div>
                    </div>
                  </div>
                  <div style="text-align:center;">
                    <button class="btn-primary btn-sm" onclick="generateTechIDCard()" style="font-size:11px;">ğŸªª Generar ID Card</button>
                    <p style="font-size:9px;color:var(--text-muted);margin-top:4px;">IdentificaciÃ³n para<br>portar en todo momento</p>
                  </div>
                </div>

                <h5 style="color:var(--primary);margin-bottom:8px;font-size:13px;">ğŸ“œ Certificaciones y Licencias</h5>
                <div id="techCredGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px;">
                  
                  <!-- Driver's License -->
                  <div class="doc-upload-card" id="tcCard_drivers_license">
                    <div class="doc-icon">ğŸªª</div>
                    <div class="doc-info"><strong>Licencia de Manejar</strong><small>Driver's License</small></div>
                    <div class="doc-status" id="tcStatus_drivers_license"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('drivers_license',this)"></label>
                      <button onclick="viewTechCred('drivers_license')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_drivers_license">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('drivers_license')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_drivers_license">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_drivers_license" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                  <!-- EPA 608 -->
                  <div class="doc-upload-card" id="tcCard_epa_608">
                    <div class="doc-icon">ğŸŒ¿</div>
                    <div class="doc-info"><strong>EPA Section 608</strong><small>Refrigerant Certification</small></div>
                    <div class="doc-status" id="tcStatus_epa_608"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('epa_608',this)"></label>
                      <button onclick="viewTechCred('epa_608')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_epa_608">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('epa_608')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_epa_608">âœ•</button>
                    </div>
                  </div>

                  <!-- NATE -->
                  <div class="doc-upload-card" id="tcCard_nate">
                    <div class="doc-icon">ğŸ†</div>
                    <div class="doc-info"><strong>NATE Certification</strong><small>North American Technician Excellence</small></div>
                    <div class="doc-status" id="tcStatus_nate"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('nate',this)"></label>
                      <button onclick="viewTechCred('nate')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_nate">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('nate')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_nate">âœ•</button>
                    </div>
                  </div>

                  <!-- OSHA -->
                  <div class="doc-upload-card" id="tcCard_osha">
                    <div class="doc-icon">â›‘ï¸</div>
                    <div class="doc-info"><strong>OSHA 10/30</strong><small>Safety Certification</small></div>
                    <div class="doc-status" id="tcStatus_osha"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('osha',this)"></label>
                      <button onclick="viewTechCred('osha')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_osha">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('osha')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_osha">âœ•</button>
                    </div>
                  </div>

                  <!-- HVAC Excellence -->
                  <div class="doc-upload-card" id="tcCard_hvac_excellence">
                    <div class="doc-icon">â„ï¸</div>
                    <div class="doc-info"><strong>HVAC Excellence</strong><small>Professional Certification</small></div>
                    <div class="doc-status" id="tcStatus_hvac_excellence"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('hvac_excellence',this)"></label>
                      <button onclick="viewTechCred('hvac_excellence')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_hvac_excellence">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('hvac_excellence')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_hvac_excellence">âœ•</button>
                    </div>
                  </div>

                  <!-- School / Trade School Certificate -->
                  <div class="doc-upload-card" id="tcCard_school_cert">
                    <div class="doc-icon">ğŸ“</div>
                    <div class="doc-info"><strong>Certificado Escolar</strong><small>Trade School / College Certificate</small></div>
                    <div class="doc-status" id="tcStatus_school_cert"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('school_cert',this)"></label>
                      <button onclick="viewTechCred('school_cert')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_school_cert">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('school_cert')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_school_cert">âœ•</button>
                    </div>
                  </div>

                  <!-- NCCER -->
                  <div class="doc-upload-card" id="tcCard_nccer">
                    <div class="doc-icon">ğŸ”§</div>
                    <div class="doc-info"><strong>NCCER</strong><small>National Center for Construction Ed</small></div>
                    <div class="doc-status" id="tcStatus_nccer"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('nccer',this)"></label>
                      <button onclick="viewTechCred('nccer')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_nccer">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('nccer')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_nccer">âœ•</button>
                    </div>
                  </div>

                  <!-- Other Cert -->
                  <div class="doc-upload-card" id="tcCard_other_cert">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info"><strong>Otro Certificado</strong><small>Other Certification</small></div>
                    <div class="doc-status" id="tcStatus_other_cert"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('other_cert',this)"></label>
                      <button onclick="viewTechCred('other_cert')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_other_cert">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('other_cert')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_other_cert">âœ•</button>
                    </div>
                  </div>

                </div>

                <h5 style="color:var(--accent);margin:16px 0 8px;font-size:13px;">ğŸš Documentos del VehÃ­culo / Vehicle Documents</h5>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px;">

                  <!-- Vehicle Registration -->
                  <div class="doc-upload-card" id="tcCard_vehicle_reg">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info"><strong>RegistraciÃ³n del VehÃ­culo</strong><small>Vehicle Registration</small></div>
                    <div class="doc-status" id="tcStatus_vehicle_reg"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('vehicle_reg',this)"></label>
                      <button onclick="viewTechCred('vehicle_reg')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_vehicle_reg">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('vehicle_reg')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_vehicle_reg">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_vehicle_reg" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                  <!-- Commercial Vehicle Insurance -->
                  <div class="doc-upload-card" id="tcCard_vehicle_insurance">
                    <div class="doc-icon">ğŸ›¡ï¸</div>
                    <div class="doc-info"><strong>Seguro Comercial del VehÃ­culo</strong><small>Commercial Auto Insurance</small></div>
                    <div class="doc-status" id="tcStatus_vehicle_insurance"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('vehicle_insurance',this)"></label>
                      <button onclick="viewTechCred('vehicle_insurance')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_vehicle_insurance">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('vehicle_insurance')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_vehicle_insurance">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_vehicle_insurance" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                </div>

                <button class="btn-primary btn-sm" onclick="saveTechCredentials()" style="margin-top:8px;">ğŸ’¾ Guardar Credenciales</button>
              </div>
            </div>

            <div class="card">
              <h3>ğŸ“± Link de Tracking para TÃ©cnicos</h3>
              <p style="color:var(--text-light);font-size:14px;margin-bottom:12px;">Comparte este link con tus tÃ©cnicos para que reporten su ubicaciÃ³n en tiempo real desde su celular:</p>
              <div id="trackingLinkContainer" class="tracking-link-box"></div>
            </div>
          </div>

          <!-- ===== OTHER SECTIONS ===== -->
          <!-- ===== CLIENTS ===== -->
          <div id="clients-section" class="section">
            <!-- Client List View -->
            <div id="clientListView" class="card">
              <div class="card-top">
                <h3>ğŸ‘¥ Clientes <span id="clientCount" style="font-size:13px;color:var(--text-muted);font-weight:400;"></span></h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="text" id="clientSearchInput" placeholder="ğŸ” Buscar cliente..." oninput="renderClientsList()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;width:200px;">
                  <select id="clientFilterTag" onchange="renderClientsList()" style="padding:8px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                    <option value="">Todos</option>
                    <option value="Residencial">ğŸ  Residencial</option>
                    <option value="Comercial">ğŸ¢ Comercial</option>
                    <option value="Industrial">ğŸ­ Industrial</option>
                    <option value="VIP">â­ VIP</option>
                    <option value="Plan de Servicio">ğŸ›¡ï¸ Plan de Servicio</option>
                  </select>
                  <button class="btn-secondary btn-sm" onclick="exportClientsCSV()" title="Exportar">ğŸ“¥ Exportar</button>
                  <button class="btn-primary btn-sm" onclick="showImportCenter()" style="background:#f59e0b;border-color:#f59e0b;">ğŸ“¤ Importar de HCP</button>
                  <label class="btn-secondary btn-sm" style="cursor:pointer;" title="Importar CSV genÃ©rico">ğŸ“„ CSV
                    <input type="file" accept=".csv" onchange="importClientsCSV(this)" style="display:none;">
                  </label>
                  <button class="btn-primary btn-sm" onclick="showClientForm()">+ Nuevo Cliente</button>
                </div>
              </div>

              <!-- ===== HCP IMPORT CENTER ===== -->
              <div id="importCenterContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:2px solid #f59e0b;border-radius:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                  <h4 style="color:#f59e0b;margin:0;">ğŸ“¤ Centro de ImportaciÃ³n â€” Housecall Pro</h4>
                  <button onclick="hideImportCenter()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted);">âœ•</button>
                </div>

                <!-- Step 1: Instructions -->
                <div class="import-instructions" style="margin-bottom:16px;padding:14px;background:var(--bg-card);border-radius:8px;border-left:4px solid #3b82f6;">
                  <h5 style="margin-bottom:8px;color:var(--primary);">ğŸ“‹ CÃ³mo exportar de Housecall Pro:</h5>
                  <ol style="font-size:12px;color:var(--text-muted);padding-left:20px;margin:0;line-height:1.8;">
                    <li>Abre <strong>Housecall Pro</strong> â†’ ve a <strong>Customers</strong></li>
                    <li>Click en <strong>Export</strong> (esquina superior derecha)</li>
                    <li>Selecciona <strong>All Customers</strong> o filtra por tipo</li>
                    <li>Descarga el archivo <strong>.CSV</strong></li>
                    <li>Sube el archivo aquÃ­ abajo ğŸ‘‡</li>
                  </ol>
                </div>

                <!-- Step 2: Category Tabs -->
                <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                  <button class="import-tab active" id="importTabAll" onclick="setImportTab('all')">ğŸ“‹ Todos</button>
                  <button class="import-tab" id="importTabWon" onclick="setImportTab('won')">ğŸ† Clientes Ganados</button>
                  <button class="import-tab" id="importTabEstimate" onclick="setImportTab('estimate')">ğŸ“ En Estimado</button>
                  <button class="import-tab" id="importTabExisting" onclick="setImportTab('existing')">ğŸ‘¥ Existentes</button>
                </div>

                <!-- File Upload -->
                <div class="import-upload-zone" id="importDropZone" style="margin-bottom:16px;">
                  <div style="text-align:center;padding:30px;">
                    <span style="font-size:40px;">ğŸ“</span>
                    <p style="font-size:14px;font-weight:600;color:var(--text-primary);margin:8px 0 4px;">Arrastra tu archivo CSV aquÃ­</p>
                    <p style="font-size:12px;color:var(--text-muted);">o haz clic para seleccionar</p>
                    <label class="btn-primary btn-sm" style="cursor:pointer;margin-top:8px;display:inline-block;">
                      Seleccionar Archivo
                      <input type="file" accept=".csv,.txt" onchange="handleImportFile(this)" style="display:none;" id="importFileInput">
                    </label>
                  </div>
                </div>

                <!-- OR Manual Paste -->
                <div style="margin-bottom:12px;">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="flex:1;height:1px;background:var(--border);"></span>
                    <span style="font-size:11px;color:var(--text-muted);font-weight:600;">O PEGA LOS DATOS MANUALMENTE</span>
                    <span style="flex:1;height:1px;background:var(--border);"></span>
                  </div>
                  <p style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Pega datos de Excel, Google Sheets, o texto separado por comas. Formato: <strong>Nombre, TelÃ©fono, Email, DirecciÃ³n</strong> (uno por lÃ­nea)</p>
                  <textarea id="importManualData" rows="6" placeholder="John Smith, (555) 123-4567, john@email.com, 123 Main St&#10;MarÃ­a GarcÃ­a, (555) 987-6543, maria@email.com, 456 Oak Ave&#10;Bob Johnson, (555) 456-7890, , 789 Pine Rd" style="width:100%;padding:10px;font-size:12px;font-family:monospace;border:1px solid var(--border);border-radius:6px;resize:vertical;"></textarea>
                </div>

                <!-- Import Options -->
                <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">CategorÃ­a de ImportaciÃ³n</label>
                    <select id="importCategory" style="padding:8px;font-size:12px;">
                      <option value="won">ğŸ† Cliente Ganado (Won)</option>
                      <option value="estimate">ğŸ“ En Estimado</option>
                      <option value="existing">ğŸ‘¥ Cliente Existente</option>
                      <option value="lead">ğŸ¯ Lead / Prospecto</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">Tipo de Propiedad</label>
                    <select id="importPropertyType" style="padding:8px;font-size:12px;">
                      <option value="Residencial">ğŸ  Residencial</option>
                      <option value="Comercial">ğŸ¢ Comercial</option>
                      <option value="Industrial">ğŸ­ Industrial</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">Fuente / Source</label>
                    <select id="importSource" style="padding:8px;font-size:12px;">
                      <option value="housecall_pro">Housecall Pro</option>
                      <option value="service_titan">ServiceTitan</option>
                      <option value="jobber">Jobber</option>
                      <option value="excel">Excel / Spreadsheet</option>
                      <option value="other">Otro</option>
                    </select>
                  </div>
                  <div style="display:flex;align-items:center;gap:6px;margin-top:16px;">
                    <input type="checkbox" id="importSkipDuplicates" checked>
                    <label style="font-size:11px;">Omitir duplicados</label>
                  </div>
                </div>

                <!-- Preview Area -->
                <div id="importPreviewArea" style="display:none;margin-bottom:12px;max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;"></div>

                <!-- Import Status -->
                <div id="importStatusArea" style="display:none;margin-bottom:12px;padding:12px;border-radius:8px;font-size:13px;"></div>

                <!-- Actions -->
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="executeImport()" id="importExecuteBtn" disabled>ğŸ“¥ Importar Clientes</button>
                  <button class="btn-secondary btn-sm" onclick="previewImport()">ğŸ‘ï¸ Vista Previa</button>
                  <button class="btn-secondary btn-sm" onclick="hideImportCenter()">Cancelar</button>
                </div>
              </div>

              <!-- Client Form -->
              <div id="clientFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);" id="clientFormTitle">ğŸ‘¥ Nuevo Cliente</h4>
                <form id="clientForm" onsubmit="handleClientCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="clientName" required placeholder="Nombre completo"></div>
                    <div class="form-group"><label>Empresa</label><input type="text" id="clientCompany" placeholder="Nombre de empresa (opcional)"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="clientPhone" placeholder="(555) 123-4567"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="clientEmail" placeholder="email@cliente.com"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Tipo de Propiedad</label>
                      <select id="clientPropertyType">
                        <option value="Residencial">ğŸ  Residencial</option>
                        <option value="Comercial">ğŸ¢ Comercial</option>
                        <option value="Industrial">ğŸ­ Industrial</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tags / Etiquetas</label>
                      <select id="clientTags" multiple style="height:60px;">
                        <option value="VIP">â­ VIP</option>
                        <option value="Plan de Servicio">ğŸ›¡ï¸ Plan de Servicio</option>
                        <option value="ConstrucciÃ³n Nueva">ğŸ—ï¸ ConstrucciÃ³n Nueva</option>
                        <option value="Referido">ğŸ¤ Referido</option>
                        <option value="GarantÃ­a">ğŸ”§ GarantÃ­a</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="clientAddress" placeholder="DirecciÃ³n completa"></div>
                  <div class="form-group"><label>Notas</label><textarea id="clientNotes" rows="2" placeholder="Notas sobre el cliente..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm" id="clientSubmitBtn">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideClientForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <div id="clientsList"></div>
            </div>

            <!-- Client Profile View (hidden by default) -->
            <div id="clientProfileView" style="display:none;">
              <div class="card" style="margin-bottom:0;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  <button class="btn-secondary btn-sm" onclick="closeClientProfile()">â† Regresar</button>
                  <span style="color:var(--text-muted);font-size:12px;">Clientes &gt;</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                  <div>
                    <h2 id="cpName" style="font-size:24px;color:var(--text-primary);margin-bottom:4px;">â€”</h2>
                    <div id="cpCompany" style="font-size:13px;color:var(--text-muted);margin-bottom:6px;"></div>
                    <div id="cpTags" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('job')">+ Trabajo</button>
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('estimate')">+ Estimado</button>
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('appointment')">+ Cita</button>
                    <button class="btn-secondary btn-sm" onclick="showClientForm(currentProfileClientId)">âœï¸ Editar</button>
                  </div>
                </div>
                <div id="cpContact" style="font-size:13px;margin-top:10px;line-height:1.8;"></div>

                <!-- Client Tabs -->
                <div class="cp-tabs" style="margin-top:16px;">
                  <button class="cp-tab active" onclick="switchClientTab('profile')">ğŸ“‹ Perfil</button>
                  <button class="cp-tab" onclick="switchClientTab('jobs')">ğŸ”§ Trabajos</button>
                  <button class="cp-tab" onclick="switchClientTab('estimates')">ğŸ’° Estimados</button>
                  <button class="cp-tab" onclick="switchClientTab('invoices')">ğŸ“„ Facturas</button>
                  <button class="cp-tab" onclick="switchClientTab('notes')">ğŸ“ Notas</button>
                  <button class="cp-tab" onclick="switchClientTab('attachments')">ğŸ“ Archivos</button>
                  <button class="cp-tab" onclick="switchClientTab('comms')">ğŸ’¬ ComunicaciÃ³n</button>
                </div>
              </div>

              <!-- Tab Contents -->
              <div class="card" style="margin-top:2px;border-top-left-radius:0;border-top-right-radius:0;">
                <div id="cpTabProfile" class="cp-tab-content active">
                  <div class="cards-row">
                    <div>
                      <h4 style="color:var(--primary);margin-bottom:8px;">ğŸ“Š Resumen del Cliente</h4>
                      <div id="cpStats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;"></div>
                    </div>
                    <div>
                      <h4 style="color:var(--primary);margin-bottom:8px;">ğŸ“ UbicaciÃ³n</h4>
                      <div id="cpAddress" style="font-size:13px;color:var(--text-muted);"></div>
                      <div id="cpPropertyType" style="font-size:12px;margin-top:4px;"></div>
                    </div>
                  </div>
                  <div style="margin-top:16px;">
                    <h4 style="color:var(--primary);margin-bottom:8px;">â±ï¸ Historial Reciente</h4>
                    <div id="cpTimeline" style="font-size:12px;"></div>
                  </div>
                </div>
                <div id="cpTabJobs" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ”§ Trabajos de este cliente</h4>
                  <div id="cpJobsList"></div>
                </div>
                <div id="cpTabEstimates" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’° Estimados de este cliente</h4>
                  <div id="cpEstimatesList"></div>
                </div>
                <div id="cpTabInvoices" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Facturas de este cliente</h4>
                  <div id="cpInvoicesList"></div>
                </div>
                <div id="cpTabNotes" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Notas Internas</h4>
                  <div style="margin-bottom:12px;">
                    <textarea id="cpNewNote" rows="2" placeholder="Agregar nota..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;"></textarea>
                    <button class="btn-primary btn-sm" onclick="addClientNote()" style="margin-top:6px;">ğŸ’¾ Guardar Nota</button>
                  </div>
                  <div id="cpNotesList"></div>
                </div>
                <div id="cpTabAttachments" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Archivos Adjuntos</h4>
                  <div style="margin-bottom:12px;">
                    <label class="btn-secondary btn-sm" style="cursor:pointer;">
                      ğŸ“¤ Subir Archivo
                      <input type="file" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="uploadClientAttachment(this)">
                    </label>
                    <span style="font-size:10px;color:var(--text-muted);margin-left:8px;">PDF, JPG, PNG, DOC (mÃ¡x 5MB)</span>
                  </div>
                  <div id="cpAttachmentsList"></div>
                </div>
                <div id="cpTabComms" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’¬ Registro de ComunicaciÃ³n</h4>
                  <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
                    <select id="cpCommType" style="padding:6px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="call_out">ğŸ“± Llamada Saliente</option>
                      <option value="call_in">ğŸ“² Llamada Entrante</option>
                      <option value="text">ğŸ’¬ Texto/SMS</option>
                      <option value="email">ğŸ“§ Email</option>
                      <option value="visit">ğŸ  Visita</option>
                      <option value="follow_up">ğŸ”„ Follow-Up</option>
                    </select>
                    <input type="text" id="cpCommNote" placeholder="DescripciÃ³n..." style="flex:1;min-width:200px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;">
                    <button class="btn-primary btn-sm" onclick="addClientComm()">+ Registrar</button>
                  </div>
                  <div id="cpCommsList"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="jobs-section" class="section">
            <div class="card">
              <div class="card-top"><h3>ğŸ’° Crear Estimado / PresentaciÃ³n</h3></div>
              <div id="estimateBuilder">
                <!-- Step 1: Select Job -->
                <div class="estimate-step">
                  <h4>1. Seleccionar Trabajo</h4>
                  <select id="estJobSelect" class="form-select" onchange="loadEstimateJob()">
                    <option value="">Seleccionar trabajo...</option>
                  </select>
                  <div id="estJobInfo" style="display:none;" class="est-job-info"></div>
                </div>

                <!-- Step 2: Equipment Info -->
                <div class="estimate-step">
                  <h4>2. InformaciÃ³n del Equipo</h4>
                  <div class="equip-grid">
                    <button class="equip-btn" onclick="selectEquipType('ac_single')">â„ï¸<br>AC Single Stage</button>
                    <button class="equip-btn" onclick="selectEquipType('heat_pump')">ğŸ”„<br>Heat Pump Single Stage</button>
                    <button class="equip-btn" onclick="selectEquipType('furnace_80')">ğŸ”¥<br>Furnace 80% AFUE<br><small>Cat I - Induced Draft</small></button>
                    <button class="equip-btn" onclick="selectEquipType('furnace_90')">ğŸ”¥<br>Furnace 90%+ AFUE<br><small>Cat IV - Condensing</small></button>
                    <button class="equip-btn" onclick="selectEquipType('mini_split')">ğŸŒ¬ï¸<br>Mini Split</button>
                    <button class="equip-btn" onclick="selectEquipType('package_unit')">ğŸ“¦<br>Package Unit</button>
                  </div>
                  <div class="equip-details" style="margin-top:16px;">
                    <div class="form-row">
                      <div class="form-group"><label>Modelo #</label><input type="text" id="estModelNum" placeholder="Ej: GSX140361"></div>
                      <div class="form-group"><label>Serial #</label><input type="text" id="estSerialNum" placeholder="Ej: 1234567890"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Marca</label>
                        <select id="estBrand"><option value="">Seleccionar...</option><option>Goodman</option><option>Carrier</option><option>Trane</option><option>Lennox</option><option>Rheem</option><option>Ruud</option><option>York</option><option>Bryant</option><option>Amana</option><option>Daikin</option><option>Mitsubishi</option><option>Fujitsu</option><option>Bosch</option><option>American Standard</option><option>Otra</option></select>
                      </div>
                      <div class="form-group"><label>Edad Aprox (aÃ±os)</label><input type="number" id="estEquipAge" placeholder="Ej: 15" min="0" max="50"></div>
                    </div>
                    <div class="form-group">
                      <label>ğŸ“· Fotos del Equipo (modelo, serial, data plate, condiciÃ³n)</label>
                      <input type="file" id="estPhotos" multiple accept="image/*" onchange="handleEquipPhotos(event)">
                      <div id="photoPreviewGrid" class="photo-grid"></div>
                    </div>
                    <div id="equipAgeWarning" style="display:none;" class="age-warning">
                      âš ï¸ Equipo con mÃ¡s de 15 aÃ±os â€” considerar reemplazo
                      <button class="btn-warning-sm" onclick="referToAdvisor()">ğŸ  Referir a Home Advisor para Reemplazo</button>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Service Call Fee -->
                <div class="estimate-step">
                  <h4>3. Llamada de Servicio (Service Call)</h4>
                  <p style="color:var(--text-muted);font-size:12px;margin-bottom:10px;">âš¡ La llamada de servicio SIEMPRE se cobra â€” si el cliente decide hacer el trabajo, se cobra ADICIONAL a labor + partes.</p>
                  <div class="service-call-options">
                    <label class="sc-option" onclick="selectServiceCall(70)">
                      <input type="radio" name="serviceCall" value="70">
                      <div class="sc-card"><span class="sc-price">$70</span><span class="sc-desc">0-10 millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(120)">
                      <input type="radio" name="serviceCall" value="120">
                      <div class="sc-card"><span class="sc-price">$120</span><span class="sc-desc">10-20 millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(200)">
                      <input type="radio" name="serviceCall" value="200">
                      <div class="sc-card"><span class="sc-price">$200</span><span class="sc-desc">20+ millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(-1)">
                      <input type="radio" name="serviceCall" value="custom">
                      <div class="sc-card"><span class="sc-price">$?</span><span class="sc-desc">Custom</span></div>
                    </label>
                  </div>
                  <div id="customServiceCall" style="display:none;margin-top:8px;">
                    <div class="form-group"><label>Monto personalizado</label><input type="number" id="customSCAmount" placeholder="$" onchange="selectServiceCall(parseFloat(this.value))"></div>
                  </div>
                  <div class="form-row" style="margin-top:12px;">
                    <div class="form-group">
                      <label>Â¿Cliente aprueba el trabajo?</label>
                      <select id="estClientDecision" onchange="handleClientDecision()">
                        <option value="">Pendiente...</option>
                        <option value="yes">âœ… SÃ â€” Hacer reparaciÃ³n</option>
                        <option value="no">âŒ NO â€” Solo cobrar service call</option>
                        <option value="replace">ğŸ”„ Quiere equipo nuevo (referir)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Horas de labor</label>
                      <input type="number" id="estLaborHours" value="1" min="0.5" step="0.5" onchange="updateEstimateTotals()">
                    </div>
                  </div>
                  <div id="advisorReferidoBox" style="display:none;margin-top:12px;">
                    <div class="referral-box">
                      <h5>ğŸ  Referir a Home Advisor</h5>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Seleccionar Advisor</label>
                          <select id="estAdvisorSelect"><option value="">Seleccionar...</option></select>
                        </div>
                        <div class="form-group">
                          <label>Urgencia</label>
                          <select id="referralUrgency">
                            <option value="normal">Normal</option>
                            <option value="urgente">Urgente</option>
                            <option value="programar">Programar visita</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group"><label>Notas para el Advisor</label><textarea id="referralNotes" rows="2" placeholder="Estado del equipo, lo que necesita el cliente..."></textarea></div>
                      <button class="btn-primary btn-sm" onclick="sendReferidoToAdvisor()">ğŸ“© Enviar Referencia al Advisor</button>
                    </div>
                  </div>
                </div>

                <!-- Step 4: Select Components (only if approved) -->
                <div class="estimate-step" id="componentsStep">
                  <h4>4. Componentes y Reparaciones</h4>
                  <div id="componentsList"></div>
                </div>

                <!-- Step 5: Summary -->
                <div class="estimate-step">
                  <h4>5. Resumen del Estimado</h4>
                  <div id="estimateSummary"></div>
                  <div class="form-row" style="margin-top:12px;">
                    <div class="form-group"><label>Descuento (%)</label><input type="number" id="estDiscount" value="0" min="0" max="100" onchange="updateEstimateTotals()"></div>
                    <div class="form-group"><label>Tax (%)</label><input type="number" id="estTax" value="8.75" step="0.25" onchange="updateEstimateTotals()"></div>
                  </div>
                  <div id="estimateTotals" class="est-totals"></div>
                  <div class="form-group" style="margin-top:12px;"><label>Notas para el cliente</label><textarea id="estNotes" rows="3" placeholder="GarantÃ­a, condiciones, recomendaciones..."></textarea></div>
                  <div class="form-actions" style="margin-top:16px;">
                    <button class="btn-primary" onclick="generateEstimatePDF()">ğŸ“„ Generar Estimado PDF</button>
                    <button class="btn-secondary" onclick="presentEstimateToClient()">ğŸ“± Presentar al Cliente</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <h3>ğŸ“‹ Estimados Guardados</h3>
              <div id="savedEstimates"><p class="empty-msg">No hay estimados guardados</p></div>
            </div>

            <!-- Job Permits & Documents -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“‘ Permisos y Documentos del Trabajo / Job Permits</h3>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube los permisos, inspecciones, fotos y documentos de cada trabajo. Todo queda archivado con el expediente del trabajo.</p>
              
              <div class="form-group" style="max-width:400px;margin-bottom:16px;">
                <label>Seleccionar Trabajo</label>
                <select id="jobPermitSelect" onchange="loadJobPermits()">
                  <option value="">-- Seleccionar Trabajo --</option>
                </select>
              </div>

              <div id="jobPermitArea" style="display:none;">
                <div id="jobPermitGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:16px;">

                  <div class="doc-upload-card" id="jpCard_building_permit">
                    <div class="doc-icon">ğŸ—ï¸</div>
                    <div class="doc-info"><strong>Building Permit</strong><small>Permiso de ConstrucciÃ³n</small></div>
                    <div class="doc-status" id="jpStatus_building_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('building_permit',this)"></label>
                      <button onclick="viewJobPermit('building_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_building_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('building_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_building_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_mechanical_permit">
                    <div class="doc-icon">âš™ï¸</div>
                    <div class="doc-info"><strong>Mechanical Permit</strong><small>Permiso MecÃ¡nico</small></div>
                    <div class="doc-status" id="jpStatus_mechanical_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('mechanical_permit',this)"></label>
                      <button onclick="viewJobPermit('mechanical_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_mechanical_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('mechanical_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_mechanical_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_inspection_pass">
                    <div class="doc-icon">âœ…</div>
                    <div class="doc-info"><strong>Inspection Passed</strong><small>InspecciÃ³n Aprobada</small></div>
                    <div class="doc-status" id="jpStatus_inspection_pass"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('inspection_pass',this)"></label>
                      <button onclick="viewJobPermit('inspection_pass')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_inspection_pass">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('inspection_pass')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_inspection_pass">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_before_photos">
                    <div class="doc-icon">ğŸ“¸</div>
                    <div class="doc-info"><strong>Fotos Antes</strong><small>Before Photos</small></div>
                    <div class="doc-status" id="jpStatus_before_photos"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none" onchange="uploadJobPermit('before_photos',this)"></label>
                      <button onclick="viewJobPermit('before_photos')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_before_photos">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('before_photos')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_before_photos">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_after_photos">
                    <div class="doc-icon">ğŸ“¸</div>
                    <div class="doc-info"><strong>Fotos DespuÃ©s</strong><small>After Photos</small></div>
                    <div class="doc-status" id="jpStatus_after_photos"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none" onchange="uploadJobPermit('after_photos',this)"></label>
                      <button onclick="viewJobPermit('after_photos')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_after_photos">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('after_photos')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_after_photos">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_other_permit">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info"><strong>Otro Documento</strong><small>Other Document</small></div>
                    <div class="doc-status" id="jpStatus_other_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('other_permit',this)"></label>
                      <button onclick="viewJobPermit('other_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_other_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('other_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_other_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_electrical_permit">
                    <div class="doc-icon">âš¡</div>
                    <div class="doc-info"><strong>Electrical Permit</strong><small>Permiso ElÃ©ctrico</small></div>
                    <div class="doc-status" id="jpStatus_electrical_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('electrical_permit',this)"></label>
                      <button onclick="viewJobPermit('electrical_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_electrical_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('electrical_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_electrical_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_plumbing_permit">
                    <div class="doc-icon">ğŸ”§</div>
                    <div class="doc-info"><strong>Plumbing Permit</strong><small>Permiso de PlomerÃ­a</small></div>
                    <div class="doc-status" id="jpStatus_plumbing_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('plumbing_permit',this)"></label>
                      <button onclick="viewJobPermit('plumbing_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_plumbing_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('plumbing_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_plumbing_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_city_approval">
                    <div class="doc-icon">ğŸ›ï¸</div>
                    <div class="doc-info"><strong>City Approval</strong><small>AprobaciÃ³n del Municipio</small></div>
                    <div class="doc-status" id="jpStatus_city_approval"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('city_approval',this)"></label>
                      <button onclick="viewJobPermit('city_approval')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_city_approval">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('city_approval')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_city_approval">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_changeout_form">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info"><strong>Changeout Form</strong><small>Formulario de Cambio</small></div>
                    <div class="doc-status" id="jpStatus_changeout_form"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('changeout_form',this)"></label>
                      <button onclick="viewJobPermit('changeout_form')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_changeout_form">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('changeout_form')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_changeout_form">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_load_calc">
                    <div class="doc-icon">ğŸ”¢</div>
                    <div class="doc-info"><strong>Manual J / Load Calc</strong><small>CÃ¡lculo de Carga</small></div>
                    <div class="doc-status" id="jpStatus_load_calc"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('load_calc',this)"></label>
                      <button onclick="viewJobPermit('load_calc')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_load_calc">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('load_calc')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_load_calc">âœ•</button>
                    </div>
                  </div>

                </div>
                <button class="btn-primary btn-sm" onclick="saveJobPermits()">ğŸ’¾ Guardar Permisos</button>
              </div>
            </div>

            <!-- ===== REPORTES DE INSPECCIÃ“N / AUDITORÃA ===== -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“Š Reportes de InspecciÃ³n y AuditorÃ­a</h3>
                <button class="btn-primary btn-sm" onclick="showInspReportForm()">+ Nuevo Reporte</button>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube HERS Ratings, Home Inspections, Energy Audits y otros reportes de inspecciÃ³n. Se vinculan al trabajo y al cliente.</p>

              <div id="inspReportForm" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“Š Nuevo Reporte de InspecciÃ³n</h4>
                <div class="form-row">
                  <div class="form-group"><label>Tipo de Reporte</label>
                    <select id="irType">
                      <optgroup label="ğŸ  Eficiencia EnergÃ©tica">
                        <option value="hers_rating">ğŸ“Š HERS Rating (Home Energy Rating)</option>
                        <option value="energy_audit">ğŸ”‹ Energy Audit / AuditorÃ­a EnergÃ©tica</option>
                        <option value="title24">ğŸ“ Title 24 Compliance</option>
                        <option value="cf1r">ğŸ“‹ CF-1R (Certificate of Compliance)</option>
                        <option value="cf2r">ğŸ“‹ CF-2R (Certificate of Installation)</option>
                        <option value="cf3r">ğŸ“‹ CF-3R (Certificate of Verification)</option>
                      </optgroup>
                      <optgroup label="ğŸ” Inspecciones de Casa">
                        <option value="home_inspection">ğŸ¡ Home Inspection Completa</option>
                        <option value="hvac_inspection">â„ï¸ HVAC System Inspection</option>
                        <option value="duct_test">ğŸ’¨ Duct Leakage Test / Prueba de Ductos</option>
                        <option value="refrigerant_charge">ğŸ§Š Refrigerant Charge Verification</option>
                        <option value="airflow_test">ğŸŒ¬ï¸ Airflow Test / Prueba de Flujo</option>
                        <option value="combustion_test">ğŸ”¥ Combustion Analysis</option>
                      </optgroup>
                      <optgroup label="ğŸ›¡ï¸ Seguridad y Cumplimiento">
                        <option value="co_test">âš ï¸ Carbon Monoxide Test</option>
                        <option value="gas_leak_test">ğŸ”¥ Gas Leak Test</option>
                        <option value="epa_compliance">ğŸŒ¿ EPA Compliance Report</option>
                        <option value="asbestos_test">â˜£ï¸ Asbestos / Lead Test</option>
                      </optgroup>
                      <optgroup label="ğŸ“„ Otros Reportes">
                        <option value="warranty_registration">ğŸ“œ Warranty Registration</option>
                        <option value="maintenance_report">ğŸ”§ Maintenance Report</option>
                        <option value="proposal_letter">ğŸ“ Proposal Letter</option>
                        <option value="other_report">ğŸ“„ Otro Reporte</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="form-group"><label>Trabajo Relacionado</label>
                    <select id="irJobId"><option value="">-- Sin trabajo --</option></select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Cliente</label><input type="text" id="irClient" placeholder="Nombre del cliente"></div>
                  <div class="form-group"><label>DirecciÃ³n de la Propiedad</label><input type="text" id="irAddress" placeholder="DirecciÃ³n donde se hizo la inspecciÃ³n"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Fecha de InspecciÃ³n</label><input type="date" id="irDate"></div>
                  <div class="form-group"><label>Inspector / TÃ©cnico</label><input type="text" id="irInspector" placeholder="Nombre del inspector"></div>
                  <div class="form-group"><label>CalificaciÃ³n / Score</label><input type="text" id="irScore" placeholder="Ej: HERS 65, Pass, Fail"></div>
                </div>
                <div class="form-group"><label>Resultado / Resumen</label>
                  <select id="irResult">
                    <option value="pass">âœ… Aprobado / Pass</option>
                    <option value="fail">âŒ Reprobado / Fail</option>
                    <option value="conditional">âš ï¸ Condicional / Requiere Correcciones</option>
                    <option value="pending">â³ Pendiente de Resultados</option>
                    <option value="info">â„¹ï¸ Informativo (sin calificaciÃ³n)</option>
                  </select>
                </div>
                <div class="form-group"><label>Notas / Hallazgos</label><textarea id="irNotes" rows="3" placeholder="Detalle los hallazgos, recomendaciones, deficiencias encontradas..."></textarea></div>
                <div class="form-group">
                  <label>ğŸ“ Subir Reporte (PDF, foto, scan)</label>
                  <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('irFileInput').click()">
                    <span style="font-size:28px;">ğŸ“</span>
                    <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic para subir el reporte PDF, foto o scan</p>
                    <img id="irFilePreview" src="" style="display:none;max-width:200px;margin-top:8px;border-radius:6px;">
                    <span id="irFileName" style="display:none;font-size:12px;color:var(--primary);margin-top:6px;"></span>
                  </div>
                  <input type="file" id="irFileInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="previewInspReport(this)">
                </div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveInspReport()">ğŸ’¾ Guardar Reporte</button>
                  <button class="btn-secondary btn-sm" onclick="hideInspReportForm()">Cancelar</button>
                </div>
              </div>

              <!-- Filter tabs -->
              <div style="display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap;">
                <button class="import-tab active" onclick="setIRTab('all')" id="irTabAll">ğŸ“Š Todos</button>
                <button class="import-tab" onclick="setIRTab('hers')" id="irTabHers">ğŸ“Š HERS</button>
                <button class="import-tab" onclick="setIRTab('inspection')" id="irTabInsp">ğŸ” Inspecciones</button>
                <button class="import-tab" onclick="setIRTab('energy')" id="irTabEnergy">ğŸ”‹ EnergÃ­a</button>
                <button class="import-tab" onclick="setIRTab('safety')" id="irTabSafety">ğŸ›¡ï¸ Seguridad</button>
              </div>

              <div id="inspReportsList"></div>
            </div>
          </div>
          <!-- ===== HOME ADVISORS (Vendedores) ===== -->
          <div id="advisors-section" class="section">
            <div class="card">
              <div class="card-top"><h3>ğŸ  Home Advisors (Vendedores)</h3><button class="btn-primary btn-sm" onclick="showAdvisorForm()">+ Nuevo Advisor</button></div>
              <div id="advisorFormContainer" style="display:none;margin-bottom:16px;">
                <form id="advisorForm" onsubmit="handleAdvisorCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="advisorName" required placeholder="Nombre completo"></div>
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="advisorPhone" required placeholder="(555) 123-4567"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="advisorEmail" placeholder="email@empresa.com"></div>
                    <div class="form-group"><label>Especialidad</label>
                      <select id="advisorSpecialty">
                        <option value="Residencial">Residencial</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Residencial y Comercial">Residencial y Comercial</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>Zona de cobertura</label><input type="text" id="advisorZone" placeholder="Ej: Inland Empire, San Bernardino, Riverside"></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideAdvisorForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="advisorsList"></div>
            </div>
            <div class="card">
              <div class="card-top"><h3>ğŸ“‹ Ã“rdenes Referidas</h3></div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Trabajos referidos por tÃ©cnicos para reemplazo de equipo</p>
              <div id="referralsList"></div>
            </div>
          </div>

          <!-- ===== INVOICES (Facturas) ===== -->
          <div id="invoices-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“„ Facturas</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="invoiceFilterStatus" class="inline-select" onchange="renderInvoicesTable()" style="padding:8px 12px;font-size:12px;">
                    <option value="all">Todas</option>
                    <option value="draft">Borrador</option>
                    <option value="sent">Enviadas</option>
                    <option value="paid">Pagadas</option>
                    <option value="partial">Pago Parcial</option>
                    <option value="overdue">Vencidas</option>
                    <option value="cancelled">Canceladas</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showInvoiceForm()">+ Nueva Factura</button>
                </div>
              </div>

              <!-- Invoice KPIs -->
              <div class="invoice-kpis" id="invoiceKPIs"></div>

              <!-- Invoice Form -->
              <div id="invoiceFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);">ğŸ“„ Nueva Factura</h4>
                <form id="invoiceForm" onsubmit="handleInvoiceCreate(event)">
                  <!-- Source: from job or manual -->
                  <div class="form-group">
                    <label>Crear desde Trabajo (opcional)</label>
                    <select id="invJobSelect" onchange="loadInvoiceFromJob()">
                      <option value="">â€” Factura manual â€”</option>
                    </select>
                  </div>

                  <div class="form-row">
                    <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="invClientName" required placeholder="Nombre completo"></div>
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="invClientPhone" placeholder="(555) 123-4567"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="invClientEmail" placeholder="email@cliente.com"></div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="invClientAddress" placeholder="DirecciÃ³n del servicio"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TÃ©cnico</label>
                      <select id="invTechSelect"><option value="">Seleccionar...</option></select>
                    </div>
                    <div class="form-group"><label>Fecha de Vencimiento</label><input type="date" id="invDueDate"></div>
                  </div>

                  <!-- Line Items -->
                  <div style="margin:16px 0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <label style="font-weight:600;font-size:13px;color:var(--primary);">LÃ­neas de Factura</label>
                      <button type="button" class="btn-secondary btn-sm" onclick="addInvoiceLine()" style="padding:6px 12px;font-size:11px;">+ Agregar LÃ­nea</button>
                    </div>
                    <div id="invoiceLines"></div>
                  </div>

                  <!-- Service Call -->
                  <div class="form-row">
                    <div class="form-group"><label>Service Call Fee ($)</label><input type="number" id="invServiceCall" value="0" min="0" step="0.01" onchange="calcInvoiceTotals()"></div>
                    <div class="form-group"><label>Descuento (%)</label><input type="number" id="invDiscount" value="0" min="0" max="100" onchange="calcInvoiceTotals()"></div>
                    <div class="form-group"><label>Tax (%)</label><input type="number" id="invTax" value="8.75" step="0.25" onchange="calcInvoiceTotals()"></div>
                  </div>

                  <!-- Totals Preview -->
                  <div id="invoiceTotalsPreview" class="est-totals" style="margin:12px 0;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;"></div>

                  <div class="form-group"><label>Notas para el Cliente</label><textarea id="invNotes" rows="2" placeholder="GarantÃ­a, tÃ©rminos, condiciones..."></textarea></div>
                  <div class="form-group"><label>Notas Internas (no se muestran al cliente)</label><textarea id="invInternalNotes" rows="2" placeholder="Notas internas..."></textarea></div>

                  <div class="form-actions" style="margin-top:12px;">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Factura</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideInvoiceForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Invoice Table -->
              <div id="invoicesTable"></div>
            </div>

            <!-- Invoice Detail Modal -->
            <div id="invoiceDetailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
              <div style="max-width:700px;margin:40px auto;background:var(--bg-card);border-radius:12px;padding:30px;position:relative;">
                <button onclick="closeInvoiceDetail()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);">âœ•</button>
                <div id="invoiceDetailContent"></div>
              </div>
            </div>
          </div>
          <!-- ===== COLLECTIONS (Cobranza) ===== -->
          <div id="collections-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ’° Cobranza</h3>
                <select id="collectionsFilter" class="inline-select" onchange="renderCollections()" style="padding:8px 12px;font-size:12px;">
                  <option value="all_due">Todas con Balance</option>
                  <option value="overdue">Vencidas</option>
                  <option value="partial">Pago Parcial</option>
                  <option value="sent">Enviadas (sin pago)</option>
                  <option value="recent_paid">ReciÃ©n Pagadas</option>
                </select>
              </div>

              <!-- Collections KPIs -->
              <div id="collectionsKPIs" class="invoice-kpi-row"></div>

              <!-- Collections Table -->
              <div id="collectionsTable"></div>
            </div>

            <!-- Payment History -->
            <div class="card" style="margin-top:16px;">
              <h3>ğŸ“‹ Historial de Pagos</h3>
              <div id="paymentsHistory"></div>
            </div>
          </div>

          <!-- ===== USUARIOS Y EQUIPO ===== -->
          <div id="team-section" class="section">
            <div class="card" style="margin-bottom:16px;border:2px solid var(--primary);">
              <div class="card-top">
                <h3>ğŸ‘¥ Usuarios y Control de Acceso</h3>
                <button class="btn-primary btn-sm" onclick="showTeamUserForm()">+ Agregar Usuario</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Administra quiÃ©n puede acceder al CRM y quÃ© secciones puede ver. Solo el <strong>DueÃ±o/CEO</strong> puede administrar usuarios.</p>

              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:16px;">
                <div style="padding:12px;border:1px solid #3b82f6;border-radius:8px;background:#eff6ff;">
                  <h5 style="color:#1d4ed8;font-size:13px;">ğŸ‘‘ DueÃ±o / CEO</h5>
                  <p style="font-size:10px;color:#1e40af;line-height:1.5;">Acceso total. Mi Dinero, cuenta bancaria, configuraciÃ³n, usuarios. <strong>Solo 1 por empresa.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #8b5cf6;border-radius:8px;background:#f5f3ff;">
                  <h5 style="color:#6d28d9;font-size:13px;">ğŸ“Š Contabilidad / Admin</h5>
                  <p style="font-size:10px;color:#5b21b6;line-height:1.5;">NÃ³mina, gastos, recibos, facturas, QuickBooks, reportes. <strong>No ve Mi Dinero ni cuenta bancaria.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #f59e0b;border-radius:8px;background:#fffbeb;">
                  <h5 style="color:#b45309;font-size:13px;">ğŸ¯ Coordinador de Despacho</h5>
                  <p style="font-size:10px;color:#92400e;line-height:1.5;">Despacho, trabajos, tÃ©cnicos, clientes, correo, agenda. <strong>No ve finanzas ni nÃ³mina.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #10b981;border-radius:8px;background:#ecfdf5;">
                  <h5 style="color:#047857;font-size:13px;">ğŸ”§ TÃ©cnico</h5>
                  <p style="font-size:10px;color:#065f46;line-height:1.5;">Solo sus trabajos asignados, reloj de entrada/salida. <strong>No ve otros datos.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #94a3b8;border-radius:8px;background:#f8fafc;">
                  <h5 style="color:#475569;font-size:13px;">ğŸ‘ï¸ Solo Vista</h5>
                  <p style="font-size:10px;color:#64748b;line-height:1.5;">Puede ver tablero y reportes pero no puede editar ni crear nada.</p>
                </div>
              </div>

              <div id="teamUserForm" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ‘¤ Nuevo Usuario</h4>
                <div class="form-row">
                  <div class="form-group"><label>Nombre Completo</label><input type="text" id="tuName" required placeholder="Ej: MarÃ­a GarcÃ­a"></div>
                  <div class="form-group"><label>Email</label><input type="email" id="tuEmail" required placeholder="usuario@empresa.com"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="tuPhone" placeholder="(555) 123-4567"></div>
                  <div class="form-group"><label>Nombre de Usuario</label><input type="text" id="tuUsername" required placeholder="Ej: maria.garcia"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="tuPassword" required placeholder="MÃ­nimo 6 caracteres"></div>
                  <div class="form-group"><label>Confirmar ContraseÃ±a</label><input type="password" id="tuPasswordConfirm" required placeholder="Repetir contraseÃ±a"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Rol / Puesto</label>
                    <select id="tuRole" onchange="previewRolePerms()">
                      <option value="owner">ğŸ‘‘ DueÃ±o / CEO</option>
                      <option value="accounting">ğŸ“Š Contabilidad / Admin</option>
                      <option value="dispatcher">ğŸ¯ Coordinador de Despacho</option>
                      <option value="technician">ğŸ”§ TÃ©cnico</option>
                      <option value="viewer">ğŸ‘ï¸ Solo Vista</option>
                    </select>
                  </div>
                  <div class="form-group"><label>Estado</label>
                    <select id="tuStatus">
                      <option value="active">âœ… Activo</option>
                      <option value="inactive">â›” Inactivo</option>
                    </select>
                  </div>
                </div>
                <div id="tuPermPreview" style="margin:12px 0;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;">
                  <h5 style="font-size:12px;color:var(--primary);margin-bottom:6px;">ğŸ” Permisos de este Rol:</h5>
                  <div id="tuPermList" style="font-size:11px;color:var(--text-muted);line-height:1.8;"></div>
                </div>
                <div class="form-group"><label>Notas</label><textarea id="tuNotes" rows="2" placeholder="Responsabilidades, horario, etc."></textarea></div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveTeamUser()">ğŸ’¾ Guardar Usuario</button>
                  <button class="btn-secondary btn-sm" onclick="hideTeamUserForm()">Cancelar</button>
                </div>
              </div>

              <div id="teamUsersList"></div>
            </div>

            <div class="card">
              <div class="card-top"><h3>ğŸŸ¢ Sesiones Activas</h3></div>
              <div id="teamActiveSessions">
                <p class="empty-msg">Las sesiones activas aparecerÃ¡n aquÃ­ cuando los usuarios inicien sesiÃ³n.</p>
              </div>
            </div>
          </div>

          <div id="settings-section" class="section">
            <div class="card">
              <h3>ConfiguraciÃ³n de la Empresa</h3>
              <div class="settings-form">
                <div class="form-group">
                  <label>Logo de la Empresa</label>
                  <div class="logo-upload-area">
                    <div id="logoPreview" class="logo-preview">
                      <span>Haz clic para subir logo</span>
                    </div>
                    <input type="file" id="logoFileInput" accept="image/*" onchange="handleLogoUpload(event)" style="display:none;">
                    <button class="btn-secondary btn-sm" onclick="document.getElementById('logoFileInput').click()">ğŸ“· Cambiar Logo</button>
                    <button class="btn-secondary btn-sm" onclick="resetLogo()">â†©ï¸ Logo Default</button>
                  </div>
                </div>
                <div class="form-group"><label>Nombre de la Empresa</label><input type="text" id="settingsCompanyName" placeholder="Nombre"></div>
                <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="settingsPhone" placeholder="TelÃ©fono"></div>
                <div class="form-group"><label>Email</label><input type="email" id="settingsEmail" placeholder="Email"></div>
                <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="settingsAddress" placeholder="DirecciÃ³n de la empresa"></div>
                <div class="form-row">
                  <div class="form-group"><label>ğŸ“œ Licencia de Contratista (C-10, C-20, etc.)</label><input type="text" id="settingsLicense" placeholder="Ej: C-10 #1051648, C-20 #1051648"></div>
                  <div class="form-group"><label>ğŸ¦ Contractor Bond #</label><input type="text" id="settingsBond" placeholder="Ej: Bond #12345678"></div>
                </div>
                <div class="form-group"><label>ğŸ‘¤ Nombre del DueÃ±o / CEO</label><input type="text" id="settingsOwnerName" placeholder="Nombre completo del dueÃ±o"></div>
                <button class="btn-primary btn-sm" onclick="saveSettings()">Guardar ConfiguraciÃ³n</button>
                
                <hr style="margin:20px 0;border-color:var(--border);">
                
                <!-- ===== COMPANY DOCUMENTS ===== -->
                <h4 style="color:var(--primary);margin-bottom:4px;">ğŸ“ Documentos de la Empresa Documents</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">Sube tus documentos legales y de seguros. Estos se incluirÃ¡n automÃ¡ticamente en estimados y facturas cuando el cliente o empresa lo solicite.</p>

                <div id="companyDocsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:16px;">
                  
                  <!-- Workers' Compensation -->
                  <div class="doc-upload-card" id="docCard_workers_comp">
                    <div class="doc-icon">ğŸ›¡ï¸</div>
                    <div class="doc-info">
                      <strong>Workers' Compensation</strong>
                      <small>Certificate of Insurance</small>
                    </div>
                    <div class="doc-status" id="docStatus_workers_comp">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('workers_comp', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('workers_comp')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_workers_comp">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('workers_comp')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_workers_comp">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_workers_comp" onchange="saveDocExpiry('workers_comp')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- General Liability -->
                  <div class="doc-upload-card" id="docCard_general_liability">
                    <div class="doc-icon">ğŸ¢</div>
                    <div class="doc-info">
                      <strong>General Liability Insurance</strong>
                      <small>Certificate of Liability Insurance</small>
                    </div>
                    <div class="doc-status" id="docStatus_general_liability">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('general_liability', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('general_liability')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_general_liability">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('general_liability')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_general_liability">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_general_liability" onchange="saveDocExpiry('general_liability')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- W-9 Form -->
                  <div class="doc-upload-card" id="docCard_w9">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info">
                      <strong>W-9 Form</strong>
                      <small>Request for Taxpayer ID</small>
                    </div>
                    <div class="doc-status" id="docStatus_w9">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('w9', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('w9')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_w9">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('w9')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_w9">âœ•</button>
                    </div>
                  </div>

                  <!-- Contractor License Bond -->
                  <div class="doc-upload-card" id="docCard_bond">
                    <div class="doc-icon">ğŸ’°</div>
                    <div class="doc-info">
                      <strong>Contractor License Bond</strong>
                      <small>Surety Bond Certificate</small>
                    </div>
                    <div class="doc-status" id="docStatus_bond">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('bond', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('bond')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_bond">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('bond')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_bond">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_bond" onchange="saveDocExpiry('bond')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- Contractor License -->
                  <div class="doc-upload-card" id="docCard_contractor_license">
                    <div class="doc-icon">ğŸ›ï¸</div>
                    <div class="doc-info">
                      <strong>Contractor License</strong>
                      <small>State License (CSLB, TDLR, etc.)</small>
                    </div>
                    <div class="doc-status" id="docStatus_contractor_license">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('contractor_license', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('contractor_license')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_contractor_license">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('contractor_license')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_contractor_license">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_contractor_license" onchange="saveDocExpiry('contractor_license')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- EPA Section 608 -->
                  <div class="doc-upload-card" id="docCard_epa_608">
                    <div class="doc-icon">ğŸŒ¿</div>
                    <div class="doc-info">
                      <strong>EPA Section 608</strong>
                      <small>Refrigerant Certification</small>
                    </div>
                    <div class="doc-status" id="docStatus_epa_608">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('epa_608', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('epa_608')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_epa_608">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('epa_608')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_epa_608">âœ•</button>
                    </div>
                  </div>

                  <!-- Vehicle Insurance -->
                  <div class="doc-upload-card" id="docCard_vehicle_insurance">
                    <div class="doc-icon">ğŸš</div>
                    <div class="doc-info">
                      <strong>Vehicle Insurance</strong>
                      <small>Auto Liability Certificate</small>
                    </div>
                    <div class="doc-status" id="docStatus_vehicle_insurance">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('vehicle_insurance', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('vehicle_insurance')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_vehicle_insurance">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('vehicle_insurance')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_vehicle_insurance">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_vehicle_insurance" onchange="saveDocExpiry('vehicle_insurance')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- Other Document -->
                  <div class="doc-upload-card" id="docCard_other">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info">
                      <strong>Otro Documento / Other</strong>
                      <small>Cualquier documento adicional</small>
                    </div>
                    <div class="doc-status" id="docStatus_other">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('other', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('other')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_other">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('other')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_other">âœ•</button>
                    </div>
                  </div>

                </div>

                <!-- Include in Estimates toggle -->
                <div style="padding:10px;background:#f0fdf4;border:1px solid #10b981;border-radius:8px;margin-bottom:16px;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                    <input type="checkbox" id="includeDocsInEstimates" checked onchange="saveDocSettings()" style="width:18px;height:18px;accent-color:#10b981;">
                    <span><strong>Incluir documentos en estimados y facturas</strong> â€” El cliente podrÃ¡ ver/descargar Workers' Comp, GL, Bond, License, etc. directamente desde el estimado.</span>
                  </label>
                </div>

                <hr style="margin:20px 0;border-color:var(--border);">
                <h4 style="color:var(--primary);margin-bottom:4px;">ğŸ“‹ ClÃ¡usulas del Contrato / Invoice</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">Personaliza los tÃ©rminos legales que aparecen en tus facturas e invoices. Edita segÃºn las leyes de tu estado.</p>
                
                <div class="form-group">
                  <label>ğŸ‡ºğŸ‡¸ Estado / State</label>
                  <select id="clauseState" onchange="loadDefaultClauses()" style="max-width:300px;">
                    <optgroup label="â”€â”€ Estados Principales â”€â”€">
                      <option value="CA">California</option>
                      <option value="TX">Texas</option>
                      <option value="AZ">Arizona</option>
                      <option value="NV">Nevada</option>
                      <option value="FL">Florida</option>
                      <option value="NY">New York</option>
                    </optgroup>
                    <optgroup label="â”€â”€ Todos los Estados â”€â”€">
                      <option value="AL">Alabama</option>
                      <option value="AK">Alaska</option>
                      <option value="AR">Arkansas</option>
                      <option value="CO">Colorado</option>
                      <option value="CT">Connecticut</option>
                      <option value="DE">Delaware</option>
                      <option value="GA">Georgia</option>
                      <option value="HI">Hawaii</option>
                      <option value="ID">Idaho</option>
                      <option value="IL">Illinois</option>
                      <option value="IN">Indiana</option>
                      <option value="IA">Iowa</option>
                      <option value="KS">Kansas</option>
                      <option value="KY">Kentucky</option>
                      <option value="LA">Louisiana</option>
                      <option value="ME">Maine</option>
                      <option value="MD">Maryland</option>
                      <option value="MA">Massachusetts</option>
                      <option value="MI">Michigan</option>
                      <option value="MN">Minnesota</option>
                      <option value="MS">Mississippi</option>
                      <option value="MO">Missouri</option>
                      <option value="MT">Montana</option>
                      <option value="NE">Nebraska</option>
                      <option value="NH">New Hampshire</option>
                      <option value="NJ">New Jersey</option>
                      <option value="NM">New Mexico</option>
                      <option value="NC">North Carolina</option>
                      <option value="ND">North Dakota</option>
                      <option value="OH">Ohio</option>
                      <option value="OK">Oklahoma</option>
                      <option value="OR">Oregon</option>
                      <option value="PA">Pennsylvania</option>
                      <option value="RI">Rhode Island</option>
                      <option value="SC">South Carolina</option>
                      <option value="SD">South Dakota</option>
                      <option value="TN">Tennessee</option>
                      <option value="UT">Utah</option>
                      <option value="VT">Vermont</option>
                      <option value="VA">Virginia</option>
                      <option value="WA">Washington</option>
                      <option value="WV">West Virginia</option>
                      <option value="WI">Wisconsin</option>
                      <option value="WY">Wyoming</option>
                      <option value="DC">Washington D.C.</option>
                      <option value="PR">Puerto Rico</option>
                    </optgroup>
                  </select>
                  <div id="stateRegSummary" style="margin-top:8px;padding:10px;background:rgba(244,118,33,0.08);border-left:3px solid var(--primary);border-radius:4px;font-size:11px;color:var(--text-muted);display:none;"></div>
                </div>

                <div class="form-group">
                  <label>ğŸ’° TÃ©rminos de Pago / Payment Terms</label>
                  <textarea id="clausePayment" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>âš ï¸ Derecho de CancelaciÃ³n / Right to Cancel</label>
                  <textarea id="clauseCancel" rows="5" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”„ CancelaciÃ³n & Restocking Fee</label>
                  <textarea id="clauseRestock" rows="5" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ›ï¸ Licencia del Contratista / Contractor License Board</label>
                  <textarea id="clauseLicense" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ’µ Enganche / Down Payment Limit</label>
                  <textarea id="clauseDownPayment" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”— Aviso de Liens / Mechanics Lien Warning</label>
                  <textarea id="clauseLien" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ›¡ï¸ GarantÃ­a / GarantÃ­a</label>
                  <textarea id="clauseWarranty" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸŒ¿ EPA / Refrigerants & Environmental</label>
                  <textarea id="clauseEpa" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ“‹ Permisos & Inspecciones / Permits & Inspections</label>
                  <textarea id="clausePermits" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ¦º Seguro & Bonding / Insurance & Bonding</label>
                  <textarea id="clauseInsurance" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”’ PolÃ­tica de Privacidad / Privacy Policy</label>
                  <textarea id="clausePrivacy" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸš« Reserva de Derecho / Right to Refuse Service</label>
                  <textarea id="clauseRefuse" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ“ ClÃ¡usula Adicional (Opcional)</label>
                  <textarea id="clauseCustom" rows="3" style="font-size:12px;" placeholder="Agrega cualquier tÃ©rmino adicional aquÃ­..."></textarea>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn-primary btn-sm" onclick="saveClauses()">ğŸ’¾ Guardar ClÃ¡usulas</button>
                  <button class="btn-secondary btn-sm" onclick="loadDefaultClauses()">ğŸ”„ Restaurar Defaults del Estado</button>
                </div>

                <hr style="margin:20px 0;border-color:var(--border);">
                <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ§ª Datos de DemostraciÃ³n</h4>
                <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Crea tÃ©cnicos, clientes, leads y citas de ejemplo para probar el sistema.</p>
                <button class="btn-secondary btn-sm" onclick="seedDemoData()">ğŸ² Crear Datos Demo</button>
              </div>
            </div>
          </div>

          <!-- ===== PIPELINE ===== -->
          <div id="pipeline-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“ˆ <span data-i18n="pipe_title">Flujo de Ventas</span></h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="pipeFilterPeriod" class="inline-select" onchange="renderPipelineSection()" style="padding:8px 12px;font-size:12px;">
                    <option value="all" data-i18n="pipe_all">Todos</option>
                    <option value="week" data-i18n="pipe_week">Esta Semana</option>
                    <option value="month" data-i18n="pipe_month">Este Mes</option>
                    <option value="quarter" data-i18n="pipe_quarter">Este Trimestre</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="quickAddAction('estimate')">+ <span data-i18n="pipe_new_est">Nuevo Estimado</span></button>
                </div>
              </div>

              <!-- Pipeline Kanban Board -->
              <div class="pipeline-kanban" id="pipelineKanban">
                <div class="kanban-col kanban-new">
                  <div class="kanban-col-header"><span data-i18n="pipe_new">Nuevos</span> <span class="kanban-count" id="kanbanNewCount">0</span></div>
                  <div class="kanban-items" id="kanbanNew"></div>
                </div>
                <div class="kanban-col kanban-quoted">
                  <div class="kanban-col-header"><span data-i18n="pipe_quoted">Cotizados</span> <span class="kanban-count" id="kanbanQuotedCount">0</span></div>
                  <div class="kanban-items" id="kanbanQuoted"></div>
                </div>
                <div class="kanban-col kanban-approved">
                  <div class="kanban-col-header"><span data-i18n="pipe_approved">Aprobados</span> <span class="kanban-count" id="kanbanApprovedCount">0</span></div>
                  <div class="kanban-items" id="kanbanApproved"></div>
                </div>
                <div class="kanban-col kanban-scheduled">
                  <div class="kanban-col-header"><span data-i18n="pipe_scheduled">Agendados</span> <span class="kanban-count" id="kanbanScheduledCount">0</span></div>
                  <div class="kanban-items" id="kanbanScheduled"></div>
                </div>
                <div class="kanban-col kanban-won">
                  <div class="kanban-col-header"><span data-i18n="pipe_won">Ganados</span> <span class="kanban-count" id="kanbanWonCount">0</span></div>
                  <div class="kanban-items" id="kanbanWon"></div>
                </div>
              </div>

              <!-- Pipeline Stats -->
              <div class="hcp-ytd-grid" style="margin-top:16px;">
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_total_value">VALOR TOTAL</span><span class="hcp-ytd-value" id="pipeTotalValue">$0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_conversion">TASA DE CONVERSIÃ“N</span><span class="hcp-ytd-value" id="pipeConvRate">0%</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_avg_deal">TRATO PROMEDIO</span><span class="hcp-ytd-value" id="pipeAvgDeal">$0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_avg_close">DÃAS PARA CERRAR</span><span class="hcp-ytd-value" id="pipeAvgClose">0</span></div>
              </div>
            </div>
          </div>

          <!-- ===== MY MONEY / MI DINERO ===== -->
          <div id="mymoney-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’µ</span> <span data-i18n="money_income">Ingresos</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#10b981;" id="moneyIncome">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¤</span> <span data-i18n="money_expenses">Gastos</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#ef4444;" id="moneyExpenses">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> <span data-i18n="money_profit">Ganancia Neta</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#3b82f6;" id="moneyProfit">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â³</span> <span data-i18n="money_outstanding">Por Cobrar</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#f59e0b;" id="moneyOutstanding">$0.00</span><span class="hcp-sub-amount" data-i18n="money_overdue_invoices">Facturas pendientes</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ’µ <span data-i18n="money_transactions">Transacciones</span></h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showMoneyExpenseForm()" data-i18n="money_add_expense">+ Agregar Gasto</button>
                  <select id="moneyPeriodFilter" class="inline-select" onchange="renderMyMoney()" style="padding:6px 10px;font-size:12px;">
                    <option value="month" data-i18n="money_f_month">Este Mes</option>
                    <option value="quarter" data-i18n="money_f_quarter">Este Trimestre</option>
                    <option value="year" data-i18n="money_f_year">Este AÃ±o</option>
                  </select>
                </div>
              </div>

              <!-- Expense Form -->
              <div id="moneyExpFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="money_new_expense">Nuevo Gasto</h4>
                <form onsubmit="handleMoneyExpCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="money_desc">DescripciÃ³n</label><input type="text" id="moneyExpDesc" required placeholder="Ej: Materiales, Herramientas..."></div>
                    <div class="form-group"><label data-i18n="money_amount">Monto</label><input type="number" id="moneyExpAmount" required min="0" step="0.01" placeholder="0.00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="money_category">CategorÃ­a</label>
                      <select id="moneyExpCat">
                        <option value="materials">Materiales / Parts</option>
                        <option value="tools">Herramientas</option>
                        <option value="fuel">Gasolina / Fuel</option>
                        <option value="vehicle">VehÃ­culo / Vehicle</option>
                        <option value="insurance">Seguros / Insurance</option>
                        <option value="licenses">Licencias / Licenses</option>
                        <option value="marketing">Mercadotecnia / Publicidad</option>
                        <option value="payroll">NÃ³mina / Payroll</option>
                        <option value="rent">Renta / Rent</option>
                        <option value="utilities">Servicios / Utilities</option>
                        <option value="other">Otro / Other</option>
                      </select>
                    </div>
                    <div class="form-group"><label data-i18n="money_date">Fecha</label><input type="date" id="moneyExpDate"></div>
                  </div>
                  <div class="form-group"><label data-i18n="money_notes">Notas</label><textarea id="moneyExpNotes2" rows="2" placeholder="Notas adicionales..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="money_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideMoneyExpenseForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Profit/Loss Chart -->
              <div id="moneyChart" class="pipeline-chart" style="margin-bottom:16px;"></div>

              <!-- Transactions Table -->
              <div id="moneyTransactions"></div>
            </div>
          </div>

          <!-- ===== PAYROLL / NÃ“MINA ===== -->
          <div id="payroll-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ‘·</span> <span data-i18n="pay_employees">Empleados</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payEmployeeCount">0</span><span class="hcp-sub-amount" data-i18n="pay_active">Activos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> <span data-i18n="pay_this_period">Este PerÃ­odo</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payPeriodTotal">$0.00</span><span class="hcp-sub-amount" data-i18n="pay_total_payroll">Total nÃ³mina</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â°</span> <span data-i18n="pay_hours">Horas</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payTotalHours">0</span><span class="hcp-sub-amount" data-i18n="pay_this_week">Esta semana</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“‹</span> <span data-i18n="pay_pending">Pendiente</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payPending">0</span><span class="hcp-sub-amount" data-i18n="pay_to_process">Por procesar</span></div>
              </div>
            </div>

            <div class="card">
              <div class="card-top">
                <h3>ğŸ§¾ <span data-i18n="pay_title">NÃ³mina</span></h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showPayrollEntry()">+ <span data-i18n="pay_add_entry">Agregar Entrada</span></button>
                  <select id="payPeriodFilter" class="inline-select" onchange="renderPayroll()" style="padding:6px 10px;font-size:12px;">
                    <option value="week" data-i18n="pay_f_week">Esta Semana</option>
                    <option value="biweekly" data-i18n="pay_f_biweek">Quincenal</option>
                    <option value="month" data-i18n="pay_f_month">Mensual</option>
                  </select>
                </div>
              </div>

              <div id="payrollFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="pay_new_entry">Nueva Entrada de NÃ³mina</h4>
                <form onsubmit="handlePayrollCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_tech">TÃ©cnico</label><select id="payTechSelect"></select></div>
                    <div class="form-group"><label data-i18n="pay_type">Tipo</label>
                      <select id="payType">
                        <option value="hourly">Por Hora</option>
                        <option value="salary">Salario</option>
                        <option value="commission">ComisiÃ³n</option>
                        <option value="bonus">Bono</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_hours_worked">Horas Trabajadas</label><input type="number" id="payHours" min="0" step="0.5" placeholder="40"></div>
                    <div class="form-group"><label data-i18n="pay_rate">Tarifa ($)</label><input type="number" id="payRate" min="0" step="0.01" placeholder="25.00"></div>
                    <div class="form-group"><label data-i18n="pay_total">Total ($)</label><input type="number" id="payTotal" min="0" step="0.01" placeholder="1000.00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_period_start">Inicio del PerÃ­odo</label><input type="date" id="payStart"></div>
                    <div class="form-group"><label data-i18n="pay_period_end">Fin del PerÃ­odo</label><input type="date" id="payEnd"></div>
                  </div>
                  <div class="form-group"><label data-i18n="pay_notes">Notas</label><textarea id="payNotes" rows="2" placeholder="Tiempo extra, deducciones, notas..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="pay_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hidePayrollEntry()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Payroll Table -->
              <div id="payrollTable"></div>
            </div>

            <!-- ===== PAYROLL PROVIDER MANAGER ===== -->
            <div class="card" style="margin-top:16px;">
              <div class="card-top">
                <h3>ğŸ”— <span data-i18n="pay_provider_title">Proveedor de NÃ³mina</span></h3>
                <span class="badge" id="payProviderStatus" style="background:#f59e0b22;color:#f59e0b;">No conectado</span>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;" data-i18n="pay_provider_desc">Conecta tu proveedor de nÃ³mina para sincronizar horas, pagos y reportes automÃ¡ticamente.</p>

              <!-- Provider Cards -->
              <div class="payroll-providers-grid">
                <div class="payroll-provider-card" id="providerCard_adp" onclick="selectPayrollProvider('adp')">
                  <div class="provider-logo">ADP</div>
                  <div class="provider-info">
                    <strong>ADP Workforce</strong>
                    <small>NÃ³mina completa, impuestos, beneficios</small>
                  </div>
                  <span class="provider-check" id="providerCheck_adp">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_gusto" onclick="selectPayrollProvider('gusto')">
                  <div class="provider-logo" style="background:#f45d48;">Gusto</div>
                  <div class="provider-info">
                    <strong>Gusto</strong>
                    <small>NÃ³mina para pequeÃ±as empresas</small>
                  </div>
                  <span class="provider-check" id="providerCheck_gusto">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_qb" onclick="selectPayrollProvider('qb')">
                  <div class="provider-logo" style="background:#2ca01c;">QB</div>
                  <div class="provider-info">
                    <strong>QuickBooks NÃ³mina</strong>
                    <small>Integrado con contabilidad QB</small>
                  </div>
                  <span class="provider-check" id="providerCheck_qb">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_paychex" onclick="selectPayrollProvider('paychex')">
                  <div class="provider-logo" style="background:#004b87;">PCX</div>
                  <div class="provider-info">
                    <strong>Paychex</strong>
                    <small>NÃ³mina y HR para empresas medianas</small>
                  </div>
                  <span class="provider-check" id="providerCheck_paychex">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_square" onclick="selectPayrollProvider('square')">
                  <div class="provider-logo" style="background:#006aff;">â– </div>
                  <div class="provider-info">
                    <strong>Square NÃ³mina</strong>
                    <small>NÃ³mina + pagos con Square</small>
                  </div>
                  <span class="provider-check" id="providerCheck_square">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_manual" onclick="selectPayrollProvider('manual')">
                  <div class="provider-logo" style="background:#64748b;">âœ‹</div>
                  <div class="provider-info">
                    <strong data-i18n="pay_manual">Manual / Sin Proveedor</strong>
                    <small data-i18n="pay_manual_desc">Administra nÃ³mina manualmente en Trade Master</small>
                  </div>
                  <span class="provider-check" id="providerCheck_manual">â—‹</span>
                </div>
              </div>

              <!-- Provider Config (shown after selection) -->
              <div id="providerConfigArea" style="display:none;margin-top:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" id="providerConfigTitle">Configurar Proveedor</h4>
                <div class="form-row">
                  <div class="form-group"><label data-i18n="pay_api_key">API Key / Client ID</label><input type="text" id="providerApiKey" placeholder="Ingresa tu API Key..."></div>
                  <div class="form-group"><label data-i18n="pay_api_secret">API Secret</label><input type="password" id="providerApiSecret" placeholder="Ingresa tu Secret..."></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label data-i18n="pay_company_id">Company ID</label><input type="text" id="providerCompanyId" placeholder="ID de tu empresa en el proveedor"></div>
                  <div class="form-group"><label data-i18n="pay_sync_freq">Frecuencia de Sync</label>
                    <select id="providerSyncFreq">
                      <option value="manual">Manual</option>
                      <option value="daily">Diario</option>
                      <option value="weekly">Semanal</option>
                      <option value="biweekly">Quincenal</option>
                    </select>
                  </div>
                </div>
                <div class="form-row" style="margin-top:8px;">
                  <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="providerSyncHours" checked> <label style="margin:0;font-size:12px;" data-i18n="pay_sync_hours">Sincronizar horas de Entrada/Salida</label>
                  </div>
                  <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="providerSyncRates" checked> <label style="margin:0;font-size:12px;" data-i18n="pay_sync_rates">Sincronizar tarifas de tÃ©cnicos</label>
                  </div>
                </div>
                <div class="form-actions" style="margin-top:12px;">
                  <button class="btn-primary btn-sm" onclick="savePayrollProvider()">ğŸ”— <span data-i18n="pay_connect">Conectar</span></button>
                  <button class="btn-secondary btn-sm" onclick="testPayrollConnection()" data-i18n="pay_test">ğŸ§ª Probar ConexiÃ³n</button>
                  <button class="btn-secondary btn-sm" onclick="syncPayrollNow()" data-i18n="pay_sync_now">ğŸ”„ Sincronizar Ahora</button>
                  <button class="btn-secondary btn-sm" style="color:#ef4444;" onclick="disconnectProvider()" data-i18n="pay_disconnect">âœ• Desconectar</button>
                </div>
                <div id="providerSyncStatus" style="margin-top:10px;font-size:12px;color:var(--text-muted);"></div>
              </div>

              <!-- Sync History -->
              <div style="margin-top:12px;">
                <h4 style="font-size:13px;color:var(--text-muted);margin-bottom:8px;" data-i18n="pay_sync_history">Historial de SincronizaciÃ³n</h4>
                <div id="providerSyncHistory"></div>
              </div>
            </div>
          </div>

          <!-- ===== RECIBOS DE PROVEEDORES ===== -->
          <div id="receipts-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ§¾</span> Total Recibos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptTotal">0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> Total Gastado</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptTotalSpent">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¦</span> Proveedores</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptProviders">0</span><span class="hcp-sub-amount">Activos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¸</span> Sin Foto</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptNoPhoto">0</span><span class="hcp-sub-amount">Pendientes</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ§¾ Recibos de Proveedores</h3>
                <button class="btn-primary btn-sm" onclick="showReceiptForm()">+ Agregar Recibo</button>
              </div>

              <div id="receiptFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Nuevo Recibo</h4>
                <form onsubmit="handleReceiptCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Proveedor</label>
                      <select id="rcptProvider">
                        <optgroup label="ğŸª Distribuidores HVAC/R">
                          <option value="Ferguson">Ferguson HVAC</option>
                          <option value="Johnstone Supply">Johnstone Supply</option>
                          <option value="Carrier Enterprise">Carrier Enterprise</option>
                          <option value="US Air Conditioning">US Air Conditioning</option>
                          <option value="Gemaire">Gemaire</option>
                          <option value="Grainger">Grainger</option>
                          <option value="SupplyHouse">SupplyHouse.com</option>
                          <option value="Trane Supply">Trane Supply</option>
                          <option value="LennoxPros">LennoxPros</option>
                        </optgroup>
                        <optgroup label="ğŸ  Tiendas Generales">
                          <option value="Home Depot">Home Depot</option>
                          <option value="Lowes">Lowe's</option>
                          <option value="Ace Hardware">Ace Hardware</option>
                          <option value="Harbor Freight">Harbor Freight</option>
                          <option value="Walmart">Walmart</option>
                          <option value="Costco">Costco</option>
                        </optgroup>
                        <optgroup label="ğŸŒ En LÃ­nea">
                          <option value="Amazon">Amazon</option>
                          <option value="eBay">eBay</option>
                        </optgroup>
                        <optgroup label="â›½ Gasolina y VehÃ­culos">
                          <option value="Shell">Shell</option>
                          <option value="Chevron">Chevron</option>
                          <option value="ARCO">ARCO</option>
                          <option value="AutoZone">AutoZone</option>
                          <option value="OReilly">O'Reilly Auto</option>
                        </optgroup>
                        <option value="__other__">âœï¸ Otro proveedor...</option>
                      </select>
                    </div>
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="rcptCategory">
                        <option value="ac_equipment">Equipos de Aire Acondicionado</option>
                        <option value="refrigeration_equipment">Equipos de RefrigeraciÃ³n</option>
                        <option value="heating_equipment">Equipos de CalefacciÃ³n</option>
                        <option value="parts">Partes y Refacciones</option>
                        <option value="refrigerant">Refrigerantes</option>
                        <option value="tools">Herramientas</option>
                        <option value="electrical">Material ElÃ©ctrico</option>
                        <option value="ductwork">Ductos y Accesorios</option>
                        <option value="filters">Filtros</option>
                        <option value="gas_fuel">Gasolina / Combustible</option>
                        <option value="vehicle">VehÃ­culo / Mantenimiento</option>
                        <option value="office">Oficina / PapelerÃ­a</option>
                        <option value="safety">Seguridad / EPP</option>
                        <option value="misc">MiscelÃ¡neo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Monto ($)</label><input type="number" id="rcptAmount" min="0" step="0.01" required placeholder="0.00"></div>
                    <div class="form-group"><label>Impuesto ($)</label><input type="number" id="rcptTax" min="0" step="0.01" placeholder="0.00"></div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="rcptDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label># de Recibo / Invoice</label><input type="text" id="rcptNumber" placeholder="Ej: INV-12345"></div>
                    <div class="form-group"><label>MÃ©todo de Pago</label>
                      <select id="rcptPayMethod">
                        <option value="credit_card">Tarjeta de CrÃ©dito</option>
                        <option value="debit_card">Tarjeta de DÃ©bito</option>
                        <option value="cash">Efectivo</option>
                        <option value="check">Cheque</option>
                        <option value="transfer">Transferencia</option>
                        <option value="account">Cuenta del Proveedor</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Trabajo Relacionado</label>
                      <select id="rcptJobId"><option value="">-- Sin trabajo --</option></select>
                    </div>
                  </div>
                  <div class="form-group"><label>DescripciÃ³n / Items</label><textarea id="rcptDescription" rows="2" placeholder="Ej: 2x Capacitor 45/5 MFD, 1x Contactor 2P 40A"></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“¸ Foto del Recibo</label>
                    <div id="rcptPhotoZone" style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('rcptPhotoInput').click()">
                      <span style="font-size:24px;">ğŸ“·</span>
                      <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic o arrastra la foto del recibo aquÃ­</p>
                      <img id="rcptPhotoPreview" src="" style="display:none;max-width:200px;margin-top:8px;border-radius:6px;">
                    </div>
                    <input type="file" id="rcptPhotoInput" accept="image/*" style="display:none" onchange="previewReceiptPhoto(this)">
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Recibo</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideReceiptForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Filters -->
              <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                <select id="rcptFilterProvider" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todos los Proveedores</option>
                </select>
                <select id="rcptFilterCategory" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todas las CategorÃ­as</option>
                  <option value="ac_equipment">Equipos AC</option>
                  <option value="refrigeration_equipment">Equipos RefrigeraciÃ³n</option>
                  <option value="parts">Partes</option>
                  <option value="tools">Herramientas</option>
                  <option value="gas_fuel">Gasolina</option>
                  <option value="vehicle">VehÃ­culo</option>
                  <option value="misc">MiscelÃ¡neo</option>
                </select>
                <select id="rcptFilterMonth" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todo el AÃ±o</option>
                  <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                  <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                  <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                  <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                <button class="btn-secondary btn-sm" onclick="exportReceiptsCSV()">ğŸ“¥ Exportar CSV</button>
              </div>

              <div id="receiptsList"></div>
            </div>
          </div>

          <!-- ===== GASTOS DEL NEGOCIO ===== -->
          <div id="expenses-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ¢</span> Gastos Fijos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expFixed">$0</span><span class="hcp-sub-amount">Mensuales</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ”„</span> Gastos Variables</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expVariable">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“Š</span> Total Gastos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expTotal">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“—</span> QuickBooks</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="font-size:16px;">ğŸ”—</span><span class="hcp-sub-amount"><a href="https://quickbooks.intuit.com" target="_blank" style="color:var(--primary);">Ir a QuickBooks</a></span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ¢ Gastos Fijos y Recurrentes del Negocio</h3>
                <button class="btn-primary btn-sm" onclick="showExpenseForm()">+ Agregar Gasto</button>
              </div>

              <div id="expenseFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’¸ Nuevo Gasto del Negocio</h4>
                <form onsubmit="handleExpenseCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="expCategory">
                        <optgroup label="ğŸ  Local / Oficina">
                          <option value="rent">Renta del Local / Oficina</option>
                          <option value="utilities_electric">Electricidad</option>
                          <option value="utilities_water">Agua</option>
                          <option value="utilities_gas">Gas Natural</option>
                          <option value="internet">Internet / TelÃ©fono</option>
                          <option value="storage">AlmacÃ©n / Bodega</option>
                        </optgroup>
                        <optgroup label="ğŸš VehÃ­culos">
                          <option value="vehicle_insurance">Seguro de VehÃ­culos</option>
                          <option value="vehicle_payment">Pago de VehÃ­culo / Lease</option>
                          <option value="vehicle_gas">Gasolina</option>
                          <option value="vehicle_maintenance">Mantenimiento de VehÃ­culo</option>
                          <option value="vehicle_registration">Registro / Placas</option>
                        </optgroup>
                        <optgroup label="ğŸ›¡ï¸ Seguros">
                          <option value="general_liability">General Liability Insurance</option>
                          <option value="workers_comp">Workers Compensation</option>
                          <option value="bond">Contractor Bond</option>
                          <option value="health_insurance">Seguro MÃ©dico</option>
                          <option value="e_and_o">Errors & Omissions</option>
                        </optgroup>
                        <optgroup label="ğŸ“œ Licencias y Permisos">
                          <option value="contractor_license">Licencia de Contratista</option>
                          <option value="business_license">Licencia de Negocio</option>
                          <option value="epa_cert">Certificaciones EPA / NATE</option>
                          <option value="city_permits">Permisos de la Ciudad</option>
                        </optgroup>
                        <optgroup label="ğŸ’» Software y Servicios">
                          <option value="software_crm">CRM / Software de GestiÃ³n</option>
                          <option value="software_accounting">QuickBooks / Contabilidad</option>
                          <option value="software_marketing">Publicidad / Marketing</option>
                          <option value="website">Sitio Web / Hosting</option>
                          <option value="answering_service">Servicio de ContestaciÃ³n</option>
                        </optgroup>
                        <optgroup label="ğŸ¦ Financiero">
                          <option value="loan_payment">Pago de PrÃ©stamo</option>
                          <option value="equipment_lease">Leasing de Equipos</option>
                          <option value="taxes">Impuestos</option>
                          <option value="accounting">Contador / CPA</option>
                          <option value="bank_fees">Comisiones Bancarias</option>
                        </optgroup>
                        <option value="other">Otro</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Proveedor / A quiÃ©n se paga</label><input type="text" id="expVendor" placeholder="Ej: State Farm, QuickBooks, Landlord"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Monto ($)</label><input type="number" id="expAmount" min="0" step="0.01" required placeholder="0.00"></div>
                    <div class="form-group"><label>Frecuencia</label>
                      <select id="expFrequency">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="semi_annual">Semestral</option>
                        <option value="annual">Anual</option>
                        <option value="one_time">Una sola vez</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Fecha de Pago</label><input type="date" id="expDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Tipo</label>
                      <select id="expType">
                        <option value="fixed">Gasto Fijo</option>
                        <option value="variable">Gasto Variable</option>
                      </select>
                    </div>
                    <div class="form-group"><label>MÃ©todo de Pago</label>
                      <select id="expPayMethod">
                        <option value="ach">ACH / DÃ©bito AutomÃ¡tico</option>
                        <option value="credit_card">Tarjeta de CrÃ©dito</option>
                        <option value="check">Cheque</option>
                        <option value="cash">Efectivo</option>
                        <option value="transfer">Transferencia</option>
                      </select>
                    </div>
                    <div class="form-group"><label># de PÃ³liza / Cuenta</label><input type="text" id="expPolicyNum" placeholder="# de referencia"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="expNotes" rows="2" placeholder="Detalles adicionales..."></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“¸ Foto de Factura / Comprobante</label>
                    <div style="display:flex;gap:8px;">
                      <label class="btn-secondary btn-sm" style="cursor:pointer;">ğŸ“· Subir Foto <input type="file" id="expPhotoInput" accept="image/*,.pdf" style="display:none" onchange="previewExpensePhoto(this)"></label>
                      <span id="expPhotoName" style="font-size:11px;color:var(--text-muted);align-self:center;"></span>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Gasto</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideExpenseForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <div id="expensesList"></div>
            </div>

            <!-- QuickBooks Integration -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“— IntegraciÃ³n con QuickBooks</h3>
              </div>
              <div style="display:flex;gap:16px;flex-wrap:wrap;padding:8px 0;">
                <a href="https://quickbooks.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#2ca01c;">QB</div>
                  <div class="supplier-info"><strong>QuickBooks Online</strong><small>Iniciar sesiÃ³n en tu cuenta</small></div>
                </a>
                <a href="https://selfemployed.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#0077c5;">SE</div>
                  <div class="supplier-info"><strong>QB Self-Employed</strong><small>Para contratistas independientes</small></div>
                </a>
                <a href="https://payroll.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#393185;">QP</div>
                  <div class="supplier-info"><strong>QB Payroll</strong><small>NÃ³mina y impuestos</small></div>
                </a>
                <a href="https://quickbooks.intuit.com/accounting/expenses/" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#2ca01c;">ğŸ“Š</div>
                  <div class="supplier-info"><strong>QB Expenses</strong><small>Rastreo de gastos</small></div>
                </a>
              </div>
              <p style="font-size:11px;color:var(--text-muted);margin-top:8px;">ğŸ’¡ <strong>Tip:</strong> Exporta tus recibos y gastos como CSV y sÃºbelos a QuickBooks para mantener tu contabilidad al dÃ­a. Tu contador puede acceder directamente a QuickBooks con su propia cuenta.</p>
              <div style="margin-top:8px;display:flex;gap:8px;">
                <button class="btn-primary btn-sm" style="background:#10b981;" onclick="exportReceiptsCSV()">ğŸ§¾ Exportar Recibos CSV</button>
                <button class="btn-primary btn-sm" style="background:#ef4444;" onclick="exportExpensesCSV()">ğŸ¢ Exportar Gastos CSV</button>
              </div>
            </div>
          </div>

          <!-- ===== CORREO DEL NEGOCIO ===== -->
          <div id="mailbox-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¥</span> Entrada</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailInCount">0</span><span class="hcp-sub-amount">Documentos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¤</span> Salida</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailOutCount">0</span><span class="hcp-sub-amount">Documentos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">âš ï¸</span> Urgente</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailUrgent">0</span><span class="hcp-sub-amount">Pendientes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“</span> Archivados</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailArchived">0</span><span class="hcp-sub-amount">Total</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“¬ Correo del Negocio</h3>
                <button class="btn-primary btn-sm" onclick="showMailForm()">+ Agregar Documento</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">El coordinador de despacho puede subir correo fÃ­sico o digital importante del negocio: facturas de proveedores, avisos del gobierno, correspondencia de seguros, etc.</p>

              <div id="mailFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Nuevo Documento</h4>
                <form onsubmit="handleMailCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Tipo</label>
                      <select id="mailType">
                        <option value="incoming">ğŸ“¥ Correo Entrante</option>
                        <option value="outgoing">ğŸ“¤ Correo Saliente</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Prioridad</label>
                      <select id="mailPriority">
                        <option value="normal">Normal</option>
                        <option value="important">â­ Importante</option>
                        <option value="urgent">ğŸ”´ Urgente</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="mailDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>De / Remitente</label><input type="text" id="mailFrom" placeholder="Ej: State Farm, City of San Bernardino"></div>
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="mailCategory">
                        <option value="invoice">Factura / Invoice</option>
                        <option value="insurance">Seguros</option>
                        <option value="government">Gobierno / Permisos</option>
                        <option value="tax">Impuestos / IRS / FTB</option>
                        <option value="bank">Banco / Financiero</option>
                        <option value="vendor">Proveedor</option>
                        <option value="legal">Legal / Abogado</option>
                        <option value="warranty">GarantÃ­a</option>
                        <option value="customer">Cliente</option>
                        <option value="other">Otro</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>Asunto / DescripciÃ³n</label><input type="text" id="mailSubject" required placeholder="Ej: RenovaciÃ³n de pÃ³liza General Liability 2026"></div>
                  <div class="form-group"><label>Notas</label><textarea id="mailNotes" rows="2" placeholder="Detalles importantes, fechas lÃ­mite, acciones requeridas..."></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“ Adjuntar Documento (foto, PDF, scan)</label>
                    <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('mailFileInput').click()">
                      <span style="font-size:24px;">ğŸ“</span>
                      <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic para subir foto, PDF o scan del documento</p>
                      <span id="mailFileName" style="font-size:12px;color:var(--primary);display:none;margin-top:6px;"></span>
                    </div>
                    <input type="file" id="mailFileInput" accept="image/*,.pdf,.doc,.docx" style="display:none" onchange="previewMailFile(this)">
                  </div>
                  <div class="form-group">
                    <label><input type="checkbox" id="mailNeedsAction"> âš¡ Requiere AcciÃ³n (aparecerÃ¡ en pendientes)</label>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideMailForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Tabs -->
              <div style="display:flex;gap:4px;margin-bottom:12px;">
                <button class="import-tab active" onclick="setMailTab('all')" id="mailTabAll">ğŸ“¬ Todos</button>
                <button class="import-tab" onclick="setMailTab('incoming')" id="mailTabIn">ğŸ“¥ Entrante</button>
                <button class="import-tab" onclick="setMailTab('outgoing')" id="mailTabOut">ğŸ“¤ Saliente</button>
                <button class="import-tab" onclick="setMailTab('urgent')" id="mailTabUrgent">ğŸ”´ Urgente</button>
                <button class="import-tab" onclick="setMailTab('archived')" id="mailTabArchived">ğŸ“ Archivado</button>
              </div>

              <div id="mailList"></div>
            </div>
          </div>

          <!-- ===== MARKETING ===== -->
          <div id="marketing-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â­</span> <span data-i18n="mkt_reviews">ReseÃ±as</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktReviewCount">0</span><span class="hcp-sub-amount" data-i18n="mkt_avg_rating">Rating promedio</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“§</span> <span data-i18n="mkt_campaigns">CampaÃ±as</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktCampaignCount">0</span><span class="hcp-sub-amount" data-i18n="mkt_active">Activas</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“±</span> <span data-i18n="mkt_lead_source">Fuentes de Leads</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktLeadSources">0</span><span class="hcp-sub-amount" data-i18n="mkt_channels">Canales</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’¸</span> <span data-i18n="mkt_roi">Retorno de InversiÃ³n</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktROI">0%</span><span class="hcp-sub-amount" data-i18n="mkt_return">Retorno</span></div>
              </div>
            </div>

            <!-- ===== PLATAFORMAS DE GENERACIÃ“N DE LEADS ===== -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ¯ Plataformas de GeneraciÃ³n de Leads</h3>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Accede directamente a tus plataformas para administrar campaÃ±as, responder leads y monitorear resultados.</p>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ“¢ Plataformas de Publicidad y Leads</h5>
              <div class="supplier-grid" style="margin-bottom:16px;">
                <a class="supplier-card" href="https://www.facebook.com/marketplace" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">f</div>
                  <div class="supplier-info"><strong>Facebook Marketplace</strong><small>Publica servicios y genera leads locales</small></div>
                </a>
                <a class="supplier-card" href="https://business.facebook.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">FB</div>
                  <div class="supplier-info"><strong>Facebook Business / Ads</strong><small>Administra campaÃ±as y anuncios pagados</small></div>
                </a>
                <a class="supplier-card" href="https://business.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#4285f4;">G</div>
                  <div class="supplier-info"><strong>Google My Business</strong><small>Perfil de negocio, reseÃ±as, fotos</small></div>
                </a>
                <a class="supplier-card" href="https://ads.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#34a853;">GA</div>
                  <div class="supplier-info"><strong>Google Ads</strong><small>CampaÃ±as de bÃºsqueda y display</small></div>
                </a>
                <a class="supplier-card" href="https://biz.yelp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#d32323;">Y</div>
                  <div class="supplier-info"><strong>Yelp para Negocios</strong><small>ReseÃ±as, fotos, responde a clientes</small></div>
                </a>
                <a class="supplier-card" href="https://www.angi.com/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6153;">AL</div>
                  <div class="supplier-info"><strong>Angi Leads (Angie's List)</strong><small>Leads de proyectos de hogar</small></div>
                </a>
                <a class="supplier-card" href="https://pro.homeadvisor.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#f68b24;">HA</div>
                  <div class="supplier-info"><strong>HomeAdvisor Pro</strong><small>Leads de servicios del hogar</small></div>
                </a>
                <a class="supplier-card" href="https://www.thumbtack.com/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#009fd9;">TT</div>
                  <div class="supplier-info"><strong>Thumbtack Pro</strong><small>Leads de servicios locales</small></div>
                </a>
                <a class="supplier-card" href="https://nextdoor.com/business" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#8ed500;">ND</div>
                  <div class="supplier-info"><strong>Nextdoor Business</strong><small>Recomendaciones del vecindario</small></div>
                </a>
                <a class="supplier-card" href="https://www.bbb.org" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#005a8c;">BB</div>
                  <div class="supplier-info"><strong>Better Business Bureau</strong><small>AcreditaciÃ³n y confianza</small></div>
                </a>
                <a class="supplier-card" href="https://www.bark.com/en/us/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#00c4cc;">BK</div>
                  <div class="supplier-info"><strong>Bark Pro</strong><small>Leads de servicios profesionales</small></div>
                </a>
                <a class="supplier-card" href="https://www.networx.com/contractor" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0073bb;">NX</div>
                  <div class="supplier-info"><strong>Networx</strong><small>Leads de contratistas del hogar</small></div>
                </a>
              </div>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ“± Redes Sociales y Contenido</h5>
              <div class="supplier-grid" style="margin-bottom:16px;">
                <a class="supplier-card" href="https://www.facebook.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">f</div>
                  <div class="supplier-info"><strong>Facebook</strong><small>Publica contenido, interactÃºa con clientes</small></div>
                </a>
                <a class="supplier-card" href="https://www.instagram.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);">IG</div>
                  <div class="supplier-info"><strong>Instagram</strong><small>Fotos y reels de trabajos completados</small></div>
                </a>
                <a class="supplier-card" href="https://www.tiktok.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#010101;">TK</div>
                  <div class="supplier-info"><strong>TikTok</strong><small>Videos cortos, tutoriales, tendencias</small></div>
                </a>
                <a class="supplier-card" href="https://www.youtube.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff0000;">YT</div>
                  <div class="supplier-info"><strong>YouTube</strong><small>Videos largos, tutoriales, canal de marca</small></div>
                </a>
                <a class="supplier-card" href="https://www.linkedin.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0a66c2;">in</div>
                  <div class="supplier-info"><strong>LinkedIn</strong><small>Red profesional, comercial e industrial</small></div>
                </a>
                <a class="supplier-card" href="https://x.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#000000;">ğ•</div>
                  <div class="supplier-info"><strong>X (Twitter)</strong><small>Noticias, actualizaciones rÃ¡pidas</small></div>
                </a>
                <a class="supplier-card" href="https://www.pinterest.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e60023;">P</div>
                  <div class="supplier-info"><strong>Pinterest</strong><small>Fotos de proyectos, antes/despuÃ©s</small></div>
                </a>
                <a class="supplier-card" href="https://business.whatsapp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#25d366;">WA</div>
                  <div class="supplier-info"><strong>WhatsApp Business</strong><small>ComunicaciÃ³n directa con clientes</small></div>
                </a>
              </div>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ› ï¸ Herramientas de Mercadotecnia</h5>
              <div class="supplier-grid">
                <a class="supplier-card" href="https://www.canva.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#7d2ae8;">C</div>
                  <div class="supplier-info"><strong>Canva</strong><small>DiseÃ±a flyers, posts, tarjetas</small></div>
                </a>
                <a class="supplier-card" href="https://mailchimp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ffe01b;color:#000;"><strong>MC</strong></div>
                  <div class="supplier-info"><strong>Mailchimp</strong><small>Email marketing y automatizaciÃ³n</small></div>
                </a>
                <a class="supplier-card" href="https://analytics.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e37400;">ğŸ“Š</div>
                  <div class="supplier-info"><strong>Google Analytics</strong><small>AnalÃ­tica web y trÃ¡fico</small></div>
                </a>
                <a class="supplier-card" href="https://search.google.com/search-console" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#4285f4;">SC</div>
                  <div class="supplier-info"><strong>Google Search Console</strong><small>SEO y posicionamiento web</small></div>
                </a>
                <a class="supplier-card" href="https://www.housecallpro.com/login" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6b35;">HC</div>
                  <div class="supplier-info"><strong>Housecall Pro</strong><small>CRM, reviews, booking online</small></div>
                </a>
                <a class="supplier-card" href="https://www.servicetitan.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1b2a4a;">ST</div>
                  <div class="supplier-info"><strong>ServiceTitan</strong><small>Plataforma de gestiÃ³n de servicios</small></div>
                </a>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“£ <span data-i18n="mkt_title">Mercadotecnia</span></h3>
                <button class="btn-primary btn-sm" onclick="showCampaignForm()">+ <span data-i18n="mkt_new_campaign">Nueva CampaÃ±a</span></button>
              </div>

              <div id="campaignFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="mkt_create_campaign">Crear CampaÃ±a</h4>
                <form onsubmit="handleCampaignCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="mkt_camp_name">Nombre</label><input type="text" id="campName" required placeholder="Ej: Promo Verano AC"></div>
                    <div class="form-group"><label data-i18n="mkt_camp_type">Tipo</label>
                      <select id="campType">
                        <option value="email">Correo ElectrÃ³nico</option>
                        <option value="sms">SMS / Texto</option>
                        <option value="social">Redes Sociales</option>
                        <option value="postcard">Postal / Postcard</option>
                        <option value="referral">Referidos / Referido</option>
                        <option value="google_ads">Google Ads</option>
                        <option value="facebook_ads">Facebook Ads</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="mkt_budget">Presupuesto ($)</label><input type="number" id="campBudget" min="0" step="0.01" placeholder="500.00"></div>
                    <div class="form-group"><label data-i18n="mkt_start">Inicio</label><input type="date" id="campStart"></div>
                    <div class="form-group"><label data-i18n="mkt_end">Fin</label><input type="date" id="campEnd"></div>
                  </div>
                  <div class="form-group"><label data-i18n="mkt_message">Mensaje</label><textarea id="campMessage" rows="3" placeholder="Contenido de la campaÃ±a..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="mkt_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideCampaignForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Lead Source Breakdown -->
              <h4 style="margin:12px 0 8px;color:var(--text-muted);font-size:13px;" data-i18n="mkt_lead_breakdown">Desglose de Fuentes de Leads</h4>
              <div id="leadSourceChart" class="pipeline-chart" style="margin-bottom:16px;"></div>

              <!-- Campaigns List -->
              <div id="campaignsList"></div>
            </div>

            <!-- Review Request Tool -->
            <div class="card">
              <div class="card-top">
                <h3>â­ <span data-i18n="mkt_review_requests">Solicitar ReseÃ±as</span></h3>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;" data-i18n="mkt_review_desc">EnvÃ­a solicitudes de reseÃ±as a tus clientes satisfechos para mejorar tu presencia en lÃ­nea.</p>
              <div class="form-row">
                <div class="form-group"><label data-i18n="mkt_select_client">Cliente</label><select id="reviewClientSelect"></select></div>
                <div class="form-group"><label data-i18n="mkt_platform">Plataforma</label>
                  <select id="reviewPlatform">
                    <option value="google">Google Business</option>
                    <option value="yelp">Yelp</option>
                    <option value="facebook">Facebook</option>
                    <option value="nextdoor">Nextdoor</option>
                  </select>
                </div>
              </div>
              <button class="btn-primary btn-sm" onclick="sendReviewRequest()" data-i18n="mkt_send_request">ğŸ“§ Enviar Solicitud</button>
              <div id="reviewHistory" style="margin-top:12px;"></div>
            </div>
          </div>

          <!-- ===== PRICE BOOK / LISTA DE PRECIOS ===== -->
          <div id="pricebook-section" class="section">

            <!-- Supplier Quick Links -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸª <span data-i18n="pb_suppliers">Proveedores</span></h3>
                <button class="btn-primary btn-sm" onclick="loadDefaultPriceBook()">ğŸ“¦ <span data-i18n="pb_load_catalog">Cargar CatÃ¡logo HVAC Completo</span></button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;" data-i18n="pb_supplier_desc">Busca precios directamente en los distribuidores mÃ¡s usados en HVAC/R. Haz clic para abrir su sitio.</p>
              <div class="supplier-grid">
                <a class="supplier-card" href="https://www.ferguson.com/category/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#003da5;">F</div>
                  <div class="supplier-info"><strong>Ferguson HVAC</strong><small>TuberÃ­a, conexiones, equipos</small></div>
                </a>
                <a class="supplier-card" href="https://www.johnstonewaregroup.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e31837;">JS</div>
                  <div class="supplier-info"><strong>Johnstone Supply</strong><small>Partes AC/CalefacciÃ³n, refrigerantes</small></div>
                </a>
                <a class="supplier-card" href="https://www.carrierenterprise.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0057a0;">CE</div>
                  <div class="supplier-info"><strong>Carrier Enterprise</strong><small>Equipos Carrier, Bryant, Payne</small></div>
                </a>
                <a class="supplier-card" href="https://www.usaircon.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6b00;">US</div>
                  <div class="supplier-info"><strong>US Air Conditioning</strong><small>Goodman, Daikin, Amana</small></div>
                </a>
                <a class="supplier-card" href="https://www.gemaire.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1a8c3e;">GE</div>
                  <div class="supplier-info"><strong>Gemaire Distributors</strong><small>Rheem, Ruud, equipos completos</small></div>
                </a>
                <a class="supplier-card" href="https://www.grainger.com/category/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#c8102e;">GR</div>
                  <div class="supplier-info"><strong>Grainger</strong><small>Motores, controles, herramientas</small></div>
                </a>
                <a class="supplier-card" href="https://www.supplyhouse.com/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0077c8;">SH</div>
                  <div class="supplier-info"><strong>SupplyHouse</strong><small>Mini-splits, boilers, partes</small></div>
                </a>
                <a class="supplier-card" href="https://www.amazon.com/s?k=hvac+parts" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff9900;">AZ</div>
                  <div class="supplier-info"><strong>Amazon HVAC</strong><small>Partes, herramientas, accesorios</small></div>
                </a>
                <a class="supplier-card" href="https://www.homedepot.com/b/Heating-Venting-Cooling/N-5yc1vZc4k8" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#f96302;">HD</div>
                  <div class="supplier-info"><strong>Home Depot Pro</strong><small>Equipos, filtros, ductos</small></div>
                </a>
                <a class="supplier-card" href="https://www.ebay.com/b/HVAC-Parts/41986/bn_1865194" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e53238;">eB</div>
                  <div class="supplier-info"><strong>eBay HVAC Parts</strong><small>Partes usadas y nuevas, boards</small></div>
                </a>
                <a class="supplier-card" href="https://www.trane.com/commercial/north-america/us/en.html" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#002f6c;">TR</div>
                  <div class="supplier-info"><strong>Trane Supply</strong><small>Equipos y partes Trane/American Standard</small></div>
                </a>
                <a class="supplier-card" href="https://www.lennoxpros.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#003087;">LX</div>
                  <div class="supplier-info"><strong>LennoxPros</strong><small>Equipos y partes Lennox</small></div>
                </a>
              </div>
            </div>

            <div class="card">
              <div class="card-top">
                <h3>ğŸ“’ <span data-i18n="pb_title">Lista de Precios</span></h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="text" id="pbSearch" placeholder="ğŸ” Buscar parte, servicio..." oninput="filterPriceBook()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;width:200px;">
                  <select id="pbCategoryFilter" class="inline-select" onchange="filterPriceBook()" style="padding:8px 12px;font-size:12px;">
                    <option value="all" data-i18n="pb_all">Todas las categorÃ­as</option>
                    <option value="ac_parts">Partes de AC</option>
                    <option value="heating_parts">Partes de CalefacciÃ³n</option>
                    <option value="refrigeration">RefrigeraciÃ³n</option>
                    <option value="electrical">ElÃ©ctrico</option>
                    <option value="motors_fans">Motores y Ventiladores</option>
                    <option value="controls">Controles y Termostatos</option>
                    <option value="refrigerants">Refrigerantes</option>
                    <option value="ductwork">Ductos y Accesorios</option>
                    <option value="filters">Filtros</option>
                    <option value="tools">Herramientas</option>
                    <option value="labor">Mano de Obra</option>
                    <option value="equipment">Equipo Nuevo</option>
                    <option value="misc">MiscelÃ¡neos</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showPriceBookForm()">+ <span data-i18n="pb_add_item">Agregar ArtÃ­culo</span></button>
                  <button class="btn-secondary btn-sm" onclick="clearPriceBook()" style="color:#ef4444;">ğŸ—‘ï¸</button>
                </div>
              </div>

              <div id="priceBookFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="pb_new_item">Nuevo ArtÃ­culo</h4>
                <form onsubmit="handlePriceBookCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_name">Nombre</label><input type="text" id="pbName" required placeholder="Ej: Capacitor 45/5 MFD"></div>
                    <div class="form-group"><label data-i18n="pb_sku">SKU / Part #</label><input type="text" id="pbSku" placeholder="CAP-455"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_category">CategorÃ­a</label>
                      <select id="pbCategory">
                        <option value="ac_parts">Partes de AC</option>
                        <option value="heating_parts">Partes de CalefacciÃ³n</option>
                        <option value="refrigeration">RefrigeraciÃ³n</option>
                        <option value="electrical">ElÃ©ctrico</option>
                        <option value="motors_fans">Motores y Ventiladores</option>
                        <option value="controls">Controles y Termostatos</option>
                        <option value="refrigerants">Refrigerantes</option>
                        <option value="ductwork">Ductos y Accesorios</option>
                        <option value="filters">Filtros</option>
                        <option value="tools">Herramientas</option>
                        <option value="labor">Mano de Obra</option>
                        <option value="equipment">Equipo Nuevo</option>
                        <option value="misc">MiscelÃ¡neos</option>
                      </select>
                    </div>
                    <div class="form-group"><label data-i18n="pb_unit">Unidad</label>
                      <select id="pbUnit">
                        <option value="each">Pieza</option>
                        <option value="hour">Hora</option>
                        <option value="foot">Pie</option>
                        <option value="lb">Libra</option>
                        <option value="flat">Precio Fijo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_cost">Costo ($)</label><input type="number" id="pbCost" min="0" step="0.01" placeholder="15.00"></div>
                    <div class="form-group"><label data-i18n="pb_price">Precio de Venta ($)</label><input type="number" id="pbPrice" required min="0" step="0.01" placeholder="45.00"></div>
                    <div class="form-group"><label data-i18n="pb_markup">Markup %</label><input type="number" id="pbMarkup" readonly style="background:var(--bg-card);"></div>
                  </div>
                  <div class="form-group"><label data-i18n="pb_description">DescripciÃ³n</label><textarea id="pbDesc" rows="2" placeholder="DescripciÃ³n del artÃ­culo..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="pb_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hidePriceBookForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Price Book Stats -->
              <div class="hcp-ytd-grid" style="margin:12px 0;">
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_total_items">TOTAL ARTÃCULOS</span><span class="hcp-ytd-value" id="pbTotalItems">0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_avg_markup">MARKUP PROMEDIO</span><span class="hcp-ytd-value" id="pbAvgMarkup">0%</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_categories">CATEGORÃAS</span><span class="hcp-ytd-value" id="pbCategories">0</span></div>
              </div>

              <!-- Price Book Table -->
              <div id="priceBookTable"></div>
            </div>
          </div>

          <!-- ===== REPORTS / REPORTES ===== -->
          <div id="reports-section" class="section">
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“Š <span data-i18n="rpt_title">Reportes</span></h3>
                <div style="display:flex;gap:8px;">
                  <select id="rptPeriod" class="inline-select" onchange="renderReports()" style="padding:8px 12px;font-size:12px;">
                    <option value="week" data-i18n="rpt_week">Esta Semana</option>
                    <option value="month" selected data-i18n="rpt_month">Este Mes</option>
                    <option value="quarter" data-i18n="rpt_quarter">Este Trimestre</option>
                    <option value="year" data-i18n="rpt_year">Este AÃ±o</option>
                    <option value="custom" data-i18n="rpt_custom">Personalizado</option>
                  </select>
                  <div id="rptCustomRange" style="display:none;gap:8px;">
                    <input type="date" id="rptStart" onchange="renderReports()">
                    <input type="date" id="rptEnd" onchange="renderReports()">
                  </div>
                </div>
              </div>

              <!-- Report Cards Grid -->
              <div class="hcp-summary-grid" style="margin-bottom:16px;">
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’µ</span> <span data-i18n="rpt_revenue">Ingresos</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptRevenue">$0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“‹</span> <span data-i18n="rpt_jobs_done">Trabajos</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptJobsDone">0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ‘¥</span> <span data-i18n="rpt_new_customers">Nuevos Clientes</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptNewCustomers">0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“ˆ</span> <span data-i18n="rpt_close_rate">Tasa de Cierre</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptCloseRate">0%</span></div></div>
              </div>
            </div>

            <!-- Revenue Chart -->
            <div class="card" style="margin-bottom:16px;">
              <h3>ğŸ’° <span data-i18n="rpt_revenue_chart">Ingresos por PerÃ­odo</span></h3>
              <div id="rptRevenueChart" class="pipeline-chart"></div>
            </div>

            <!-- Reports Grid -->
            <div class="cards-row">
              <div class="card">
                <h3>ğŸ”§ <span data-i18n="rpt_by_tech">Por TÃ©cnico</span></h3>
                <div id="rptByTech"></div>
              </div>
              <div class="card">
                <h3>ğŸ“Š <span data-i18n="rpt_by_source">Por Fuente</span></h3>
                <div id="rptBySource"></div>
              </div>
            </div>

            <div class="cards-row" style="margin-top:16px;">
              <div class="card">
                <h3>ğŸ† <span data-i18n="rpt_top_services">Top Servicios</span></h3>
                <div id="rptTopServices"></div>
              </div>
              <div class="card">
                <h3>ğŸ“… <span data-i18n="rpt_by_day">Por DÃ­a de la Semana</span></h3>
                <div id="rptByDay"></div>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>

    <!-- ==================== TECH TRACKING PAGE (separate URL) ==================== -->
    <div id="techTrackingPage" style="display:none;">
      <div class="tracking-container">
        <div class="tracking-header">
          <span>ğŸ”§</span>
          <h2>Trade Master - GPS Tracking</h2>
        </div>
        <h3 id="trackingTechName" style="text-align:center;color:var(--primary);margin-bottom:12px;">TÃ©cnico</h3>
        <div id="trackingStatus" class="tracking-status">Conectando...</div>
        <div id="trackingMap" style="width:100%;height:350px;border-radius:8px;margin:16px 0;"></div>
        <button id="clockInBtn" class="btn-primary" onclick="toggleClockIn()">ğŸŸ¢ Iniciar Jornada (Clock In)</button>
        <button id="trackingBtn" class="btn-primary" onclick="toggleTracking()" style="display:none;margin-top:10px;">â¸ï¸ Pausar Tracking GPS</button>
        <p id="trackingInfo" style="color:#94a3b8;font-size:13px;text-align:center;margin-top:12px;"></p>
        <div class="tracking-hours-info">
          <p>ğŸ“ Tu ubicaciÃ³n se envÃ­a cada 30 segundos mientras estÃ©s en servicio</p>
          <p>ğŸ”´ Al terminar tu jornada, haz Marcar Salida para dejar de compartir ubicaciÃ³n</p>
        </div>
      </div>
    </div>

    <script src="script.js"></script>
  </body>
</html>
