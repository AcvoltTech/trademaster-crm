<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trade Master">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
        <meta name="description" content="Trade Master CRM - Sistema de gestiÃ³n profesional para tÃ©cnicos y empresas de HVAC, refrigeraciÃ³n y aire acondicionado. Administra clientes, estimados, facturas e inventario con asistente AI integrado.">
        <meta name="keywords" content="CRM HVAC, Trade Master, gestiÃ³n HVAC, tÃ©cnicos aire acondicionado, refrihgeraciÃ³n, estimados HVAC, facturaciÃ³n HVAC, CRM refrigeraciÃ³n">
        <meta name="author" content="AcvoltTech">
        <meta name="robots" content="index, follow">
        <link rel="canonical" href="https://acvolttech.github.io/trademaster-crm/">
        <meta property="og:title" content="Trade Master - CRM HVACR">
        <meta property="og:description" content="Sistema de gestiÃ³n profesional para tÃ©cnicos y empresas de HVAC. Administra clientes, estimados, facturas e inventario con asistente AI.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://acvolttech.github.io/trademaster-crm/">
        <meta property="og:image" content="https://acvolttech.github.io/trademaster-crm/icon-512.png">
        <meta property="og:locale" content="es_US">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Trade Master - CRM HVACR">
        <meta name="twitter:description" content="CRM profesional para tÃ©cnicos HVAC con asistente AI integrado.">
    <title>Trade Master - CRM HVACR | GestiÃ³n para TÃ©cnicos HVAC</title>
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkHcL1QcgKzxABmI4IJeEmjjvnZz_Xtys"></script>
  </head>
  <body>

    <!-- ==================== AUTH PAGE ==================== -->
    <div id="authPage" class="auth-container">
      <div class="auth-card">
        <div class="auth-left">
          <div class="auth-brand">
            <div class="brand-icon">
              <svg viewBox="0 0 120 120" width="80" height="80">
                <!-- Outer circle -->
                <circle cx="60" cy="60" r="56" fill="none" stroke-width="3"/>
                <!-- Left half - Blue (Cold/AC) -->
                <clipPath id="leftHalf"><rect x="0" y="0" width="60" height="120"/></clipPath>
                <clipPath id="rightHalf"><rect x="60" y="0" width="60" height="120"/></clipPath>
                <!-- Blue background half -->
                <path d="M60 4 A56 56 0 0 0 60 116 Z" fill="#1e3a5f"/>
                <!-- Red background half -->
                <path d="M60 4 A56 56 0 0 1 60 116 Z" fill="#7f1d1d"/>
                <!-- Snowflake (left side) -->
                <g clip-path="url(#leftHalf)">
                  <!-- Main vertical line -->
                  <line x1="38" y1="28" x2="38" y2="92" stroke="#60a5fa" stroke-width="3" stroke-linecap="round"/>
                  <!-- Main horizontal line -->
                  <line x1="14" y1="60" x2="58" y2="60" stroke="#60a5fa" stroke-width="3" stroke-linecap="round"/>
                  <!-- Diagonal lines -->
                  <line x1="22" y1="38" x2="54" y2="82" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"/>
                  <line x1="54" y1="38" x2="22" y2="82" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"/>
                  <!-- Branch tips top -->
                  <line x1="38" y1="28" x2="32" y2="34" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <line x1="38" y1="28" x2="44" y2="34" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <!-- Branch tips bottom -->
                  <line x1="38" y1="92" x2="32" y2="86" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <line x1="38" y1="92" x2="44" y2="86" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <!-- Branch tips left -->
                  <line x1="14" y1="60" x2="20" y2="54" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <line x1="14" y1="60" x2="20" y2="66" stroke="#93c5fd" stroke-width="2" stroke-linecap="round"/>
                  <!-- Small crystals -->
                  <circle cx="26" cy="45" r="2" fill="#93c5fd"/>
                  <circle cx="26" cy="75" r="2" fill="#93c5fd"/>
                  <circle cx="48" cy="45" r="2" fill="#93c5fd"/>
                  <circle cx="48" cy="75" r="2" fill="#93c5fd"/>
                </g>
                <!-- Fire (right side) -->
                <g clip-path="url(#rightHalf)">
                  <!-- Main flame -->
                  <path d="M82 88 C82 88 68 72 68 58 C68 44 76 38 80 30 C80 30 82 44 88 48 C90 38 94 34 94 34 C94 34 100 50 100 62 C100 76 92 88 82 88 Z" fill="#f97316" opacity="0.9"/>
                  <!-- Inner flame -->
                  <path d="M82 88 C82 88 74 78 74 68 C74 58 78 52 82 46 C82 46 84 56 88 58 C88 52 92 48 92 48 C92 48 96 58 96 66 C96 78 88 88 82 88 Z" fill="#fbbf24" opacity="0.9"/>
                  <!-- Core flame -->
                  <path d="M82 88 C82 88 78 82 78 76 C78 70 80 66 82 60 C84 66 86 70 86 76 C86 82 82 88 82 88 Z" fill="#fef3c7"/>
                  <!-- Ember dots -->
                  <circle cx="76" cy="42" r="1.5" fill="#f97316" opacity="0.6"/>
                  <circle cx="90" cy="36" r="1" fill="#fbbf24" opacity="0.5"/>
                  <circle cx="72" cy="50" r="1" fill="#f97316" opacity="0.4"/>
                </g>
                <!-- Center dividing line -->
                <line x1="60" y1="8" x2="60" y2="112" stroke="white" stroke-width="2" opacity="0.3"/>
                <!-- Outer ring highlight -->
                <circle cx="60" cy="60" r="56" fill="none" stroke="white" stroke-width="1.5" opacity="0.15"/>
              </svg>
            </div>
            <h1>Trade Master</h1>
            <p class="brand-subtitle">CRM HVACR - Sistema Multi-Empresa</p>
            <ul class="feature-list">
              <li><span class="check">âœ…</span> GestiÃ³n completa de clientes y trabajos</li>
              <li><span class="check">âœ…</span> Despacho de tÃ©cnicos con GPS</li>
              <li><span class="check">âœ…</span> FacturaciÃ³n y cobranza integrada</li>
              <li><span class="check">âœ…</span> Seguimiento de leads con Google Maps</li>
            </ul>
          </div>
        </div>
        <div class="auth-right">
          <div class="auth-tabs">
            <button class="tab-btn active" onclick="switchTab('login')">Iniciar SesiÃ³n</button>
            <button class="tab-btn" onclick="switchTab('register')">Registrar Empresa</button>
          </div>
          <div id="loginForm" class="auth-form active">
            <h2>Bienvenido</h2>
            <div id="loginError" class="error-msg" style="display:none;"></div>
            <form onsubmit="handleLogin(event)">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" required>
              </div>
              <div class="form-group">
                <label>ContraseÃ±a</label>
                <input type="password" id="loginPassword" placeholder="ContraseÃ±a" required>
              </div>
              
              <!-- Terms Checkbox for Login -->
              <div style="margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e5e7eb;">
                <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;font-size:12px;color:#374151;">
                  <input type="checkbox" id="acceptTermsLogin" required style="margin-top:2px;width:18px;height:18px;accent-color:#1e3a5f;">
                  <span>
                    I accept the <a href="terms.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Terms</a>, 
                    <a href="privacy.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Privacy</a>,
                    <a href="billing.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Billing</a> & 
                    <a href="nda.html" target="_blank" style="color:#dc2626;font-weight:600;">NDA</a>.
                    <br><span style="font-size:10px;color:#6b7280;">Acepto TÃ©rminos, Privacidad, FacturaciÃ³n y NDA.</span>
                  </span>
                </label>
              </div>
              
              <button type="submit" class="btn-primary" id="loginBtn">Iniciar SesiÃ³n</button>
            </form>
            <p class="auth-link">Â¿No tienes cuenta? <a href="#" onclick="switchTab('register')">RegÃ­strate aquÃ­</a></p>
            
            <!-- Forgot Password -->
            <div style="text-align:center;margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb;">
              <a href="#" onclick="showForgotPassword()" style="color:#1e3a5f;text-decoration:none;font-size:14px;">ğŸ”‘ Â¿Olvidaste tu contraseÃ±a?</a>
            </div>
            
            <!-- Install App Instructions -->
            <div id="installInstructions" style="margin-top:20px;padding:16px;background:#eff6ff;border-radius:12px;border:1px solid #3b82f6;">
              <h4 style="margin:0 0 8px 0;color:#1e3a5f;font-size:14px;">ğŸ“± Â¿Eres tÃ©cnico o vendedor?</h4>
              <p style="margin:0 0 12px 0;font-size:12px;color:#475569;">Instala Trade Master en tu celular para acceso rÃ¡pido:</p>
              
              <!-- PWA Install Button (for supported browsers) -->
              <button id="pwaInstallBtn" onclick="installPWA()" style="display:none;width:100%;padding:12px;background:#f47621;color:white;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;margin-bottom:10px;">
                ğŸ“² Instalar App en mi Celular
              </button>
              
              <!-- Manual instructions -->
              <div id="manualInstallInstructions" style="font-size:11px;color:#64748b;">
                <p style="margin:0 0 6px 0;"><strong>iPhone (Safari):</strong></p>
                <p style="margin:0 0 8px 0;">1. Toca <span style="background:#e5e7eb;padding:2px 6px;border-radius:4px;">â¬†ï¸ Compartir</span> â†’ 2. <span style="background:#e5e7eb;padding:2px 6px;border-radius:4px;">Agregar a Inicio</span></p>
                <p style="margin:0 0 6px 0;"><strong>Android (Chrome):</strong></p>
                <p style="margin:0;">1. Toca <span style="background:#e5e7eb;padding:2px 6px;border-radius:4px;">â‹® MenÃº</span> â†’ 2. <span style="background:#e5e7eb;padding:2px 6px;border-radius:4px;">Instalar app</span></p>
              </div>
            </div>
          </div>
          <div id="registerForm" class="auth-form">
            <h2>Crear Cuenta Empresarial</h2>
            <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#92400e;">
              <strong>âš ï¸ IMPORTANTE:</strong> Todos los campos son obligatorios. Necesitamos tu informaciÃ³n completa para brindarte soporte y enviarte tu guÃ­a de onboarding.
            </div>
            <div id="registerError" class="error-msg" style="display:none;"></div>
            <div id="registerSuccess" class="success-msg" style="display:none;"></div>
            <form onsubmit="handleRegister(event)" id="registerFormEl">
              <div class="form-group">
                <label>Nombre de la Empresa <span style="color:#dc2626">*</span></label>
                <input type="text" id="companyName" placeholder="Ej: ABC Heating & Cooling LLC" required minlength="3" title="MÃ­nimo 3 caracteres">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nombre <span style="color:#dc2626">*</span></label>
                  <input type="text" id="firstName" placeholder="Tu nombre" required minlength="2">
                </div>
                <div class="form-group">
                  <label>Apellido <span style="color:#dc2626">*</span></label>
                  <input type="text" id="lastName" placeholder="Tu apellido" required minlength="2">
                </div>
              </div>
              <div class="form-group">
                <label>Email <span style="color:#dc2626">*</span></label>
                <input type="email" id="registerEmail" placeholder="tu@email.com (preferible Gmail)" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Ingresa un email vÃ¡lido">
                <small style="color:#6b7280;font-size:11px;">ğŸ“§ Usaremos este email para enviarte tu guÃ­a y soporte</small>
              </div>
              <div class="form-group">
                <label>TelÃ©fono <span style="color:#dc2626">*</span></label>
                <input type="tel" id="phone" placeholder="(555) 123-4567" required minlength="10" pattern="[\d\s\-\(\)\+]{10,}" title="Ingresa un telÃ©fono vÃ¡lido (mÃ­nimo 10 dÃ­gitos)" oninput="formatPhone(this)">
                <small style="color:#6b7280;font-size:11px;">ğŸ“ Para contactarte si necesitas ayuda</small>
              </div>
              <div class="form-group">
                <label>ContraseÃ±a <span style="color:#dc2626">*</span></label>
                <input type="password" id="registerPassword" placeholder="MÃ­nimo 6 caracteres" required minlength="6">
              </div>
              <div class="form-group">
                <label>Confirmar ContraseÃ±a <span style="color:#dc2626">*</span></label>
                <input type="password" id="confirmPassword" placeholder="Confirmar ContraseÃ±a" required minlength="6">
              </div>
              
              <!-- Terms and Conditions Checkbox -->
              <div style="margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e5e7eb;">
                <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;font-size:13px;color:#374151;">
                  <input type="checkbox" id="acceptTerms" required style="margin-top:3px;width:18px;height:18px;accent-color:#1e3a5f;">
                  <span>
                    I accept the <a href="terms.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Terms of Service</a>, 
                    <a href="privacy.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Privacy Policy</a>,
                    <a href="billing.html" target="_blank" style="color:#1e3a5f;font-weight:600;">Billing Policy</a>, and
                    <a href="nda.html" target="_blank" style="color:#dc2626;font-weight:600;">Non-Disclosure Agreement (NDA)</a>.
                    <br><span style="font-size:11px;color:#6b7280;">Acepto los TÃ©rminos, Privacidad, FacturaciÃ³n y Acuerdo de Confidencialidad (NDA).</span>
                  </span>
                </label>
              </div>
              
              <p style="font-size:11px;color:#6b7280;margin-bottom:12px;text-align:center;">Al registrarte aceptas recibir tu guÃ­a de onboarding y comunicaciones de soporte.</p>
              <button type="submit" class="btn-primary" id="registerBtn">Crear Cuenta Empresarial</button>
            </form>
            <p class="auth-link">Â¿Ya tienes cuenta? <a href="#" onclick="switchTab('login')">Inicia sesiÃ³n</a></p>
          </div>
        </div>
        
        <!-- Legal Footer -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid #e5e7eb;text-align:center;">
          <p style="font-size:10px;color:#9ca3af;margin:0 0 8px 0;">
            Trade Master CRMâ„¢ is a product of <strong>ACVOLT Tech School Inc.</strong>
          </p>
          <p style="font-size:10px;color:#9ca3af;margin:0 0 8px 0;">
            San Bernardino, California, USA | Â© 2026 All Rights Reserved
          </p>
          <div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;font-size:10px;">
            <a href="terms.html" target="_blank" style="color:#6b7280;text-decoration:none;">Terms</a>
            <a href="privacy.html" target="_blank" style="color:#6b7280;text-decoration:none;">Privacy</a>
            <a href="billing.html" target="_blank" style="color:#6b7280;text-decoration:none;">Billing</a>
            <a href="nda.html" target="_blank" style="color:#6b7280;text-decoration:none;">NDA</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DASHBOARD PAGE ==================== -->
    <div id="dashboardPage" class="dashboard-container" style="display:none;">

    <!-- ===== ONBOARDING WELCOME ===== -->
    <div id="onboardingWelcome" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
      <div style="background:#fff;border-radius:20px;max-width:520px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,.2);overflow:hidden;animation:obIn .5s ease">
        <style>@keyframes obIn{from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}</style>
        <div style="background:linear-gradient(135deg,#1e3a5f 0%,#2d5a8e 100%);padding:32px;color:#fff;text-align:center;position:relative;overflow:hidden">
          <div style="font-size:56px;margin-bottom:8px">ğŸš€</div>
          <h2 style="font-size:24px;font-weight:900;margin:0 0 8px">Â¡Bienvenido a Trade Master CRM!</h2>
          <p style="font-size:13px;opacity:.8;margin:0">Tu asistente AI te darÃ¡ un tour completo en menos de 10 minutos</p>
        </div>
        <div style="padding:28px 32px">
          <p style="font-size:14px;color:#374151;margin-bottom:20px;line-height:1.6">Nuestra AI <strong>Brenda</strong> te guiarÃ¡ paso a paso por todas las funciones del CRM con voz y narraciÃ³n en vivo. VerÃ¡s cÃ³mo:</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:24px;font-size:12px">
            <div style="background:#f0fdf4;padding:10px;border-radius:8px;color:#166534">âœ… Agregar clientes</div>
            <div style="background:#eff6ff;padding:10px;border-radius:8px;color:#1d4ed8">âœ… Despachar tÃ©cnicos</div>
            <div style="background:#fdf4ff;padding:10px;border-radius:8px;color:#86198f">âœ… Crear facturas</div>
            <div style="background:#fff7ed;padding:10px;border-radius:8px;color:#9a3412">âœ… Cobrar pagos</div>
            <div style="background:#fefce8;padding:10px;border-radius:8px;color:#854d0e">âœ… Manejar nÃ³mina</div>
            <div style="background:#f0f9ff;padding:10px;border-radius:8px;color:#0c4a6e">âœ… Y mucho mÃ¡s...</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <button onclick="startOnboardingTour()" style="width:100%;padding:16px;background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;border:none;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;box-shadow:0 4px 15px rgba(249,115,22,.3)">ğŸ¬ Â¡Empezar Tour Guiado!</button>
            <button onclick="skipOnboarding()" style="width:100%;padding:12px;background:none;color:#9ca3af;border:1px solid #e5e7eb;border-radius:12px;font-weight:600;font-size:13px;cursor:pointer">Ya sÃ© usar el CRM â€” Saltar â†’</button>
          </div>
        </div>
      </div>
    </div>
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="brand-logo" id="companyLogo">
            <svg viewBox="0 0 120 120" width="44" height="44">
              <path d="M60 4 A56 56 0 0 0 60 116 Z" fill="#1e3a5f"/>
              <path d="M60 4 A56 56 0 0 1 60 116 Z" fill="#7f1d1d"/>
              <clipPath id="sLeftH"><rect x="0" y="0" width="60" height="120"/></clipPath>
              <clipPath id="sRightH"><rect x="60" y="0" width="60" height="120"/></clipPath>
              <g clip-path="url(#sLeftH)">
                <line x1="38" y1="28" x2="38" y2="92" stroke="#60a5fa" stroke-width="4" stroke-linecap="round"/>
                <line x1="14" y1="60" x2="58" y2="60" stroke="#60a5fa" stroke-width="4" stroke-linecap="round"/>
                <line x1="22" y1="38" x2="54" y2="82" stroke="#60a5fa" stroke-width="3" stroke-linecap="round"/>
                <line x1="54" y1="38" x2="22" y2="82" stroke="#60a5fa" stroke-width="3" stroke-linecap="round"/>
                <line x1="38" y1="28" x2="31" y2="35" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="38" y1="28" x2="45" y2="35" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="38" y1="92" x2="31" y2="85" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="38" y1="92" x2="45" y2="85" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="14" y1="60" x2="21" y2="53" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="14" y1="60" x2="21" y2="67" stroke="#93c5fd" stroke-width="2.5" stroke-linecap="round"/>
              </g>
              <g clip-path="url(#sRightH)">
                <path d="M82 88 C82 88 68 72 68 58 C68 44 76 38 80 30 C80 30 82 44 88 48 C90 38 94 34 94 34 C94 34 100 50 100 62 C100 76 92 88 82 88 Z" fill="#f97316"/>
                <path d="M82 88 C82 88 74 78 74 68 C74 58 78 52 82 46 C82 46 84 56 88 58 C88 52 92 48 92 48 C92 48 96 58 96 66 C96 78 88 88 82 88 Z" fill="#fbbf24"/>
                <path d="M82 88 C82 88 78 82 78 76 C78 70 80 66 82 60 C84 66 86 70 86 76 C86 82 82 88 82 88 Z" fill="#fef3c7"/>
              </g>
              <line x1="60" y1="8" x2="60" y2="112" stroke="white" stroke-width="2" opacity="0.2"/>
              <circle cx="60" cy="60" r="56" fill="none" stroke="white" stroke-width="1" opacity="0.1"/>
            </svg>
          </div>
          <h2>Trade Master</h2>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_principal">Principal</span>
            <a href="#" onclick="showSection('dashboard')" class="nav-link active"><span>ğŸ“Š</span> <span data-i18n="nav_dashboard">Tablero</span></a>
            <a href="#" onclick="showSection('inbox')" class="nav-link"><span>ğŸ“¬</span> <span data-i18n="nav_inbox">Bandeja</span></a>
            <a href="#" onclick="showSection('calendar')" class="nav-link"><span>ğŸ“…</span> <span data-i18n="nav_schedule">Agenda</span></a>
            <a href="#" onclick="showSection('clients')" class="nav-link"><span>ğŸ‘¥</span> <span data-i18n="nav_customers">Clientes</span></a>
            <a href="#" onclick="showSection('leads')" class="nav-link"><span>ğŸ¯</span> <span data-i18n="nav_leads">Prospectos</span></a>
            <a href="#" onclick="showSection('pipeline')" class="nav-link"><span>ğŸ“ˆ</span> <span data-i18n="nav_pipeline">Flujo de Ventas</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_operations">Operaciones</span>
            <a href="#" onclick="showSection('servicecalls')" class="nav-link"><span>ğŸ“</span> <span data-i18n="nav_servicecalls">Llamadas de Servicio</span></a>
            <a href="#" onclick="showSection('dispatch')" class="nav-link"><span>ğŸšš</span> <span data-i18n="nav_dispatch">Despacho</span></a>
            <a href="#" onclick="showSection('jobs')" class="nav-link"><span>ğŸ”§</span> <span data-i18n="nav_jobs">Trabajos</span></a>
            <a href="#" onclick="showSection('technicians')" class="nav-link"><span>ğŸ‘·</span> <span data-i18n="nav_technicians">TÃ©cnicos</span></a>
            <a href="#" onclick="showSection('advisors')" class="nav-link"><span>ğŸ </span> <span data-i18n="nav_advisors">Asesores del Hogar</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_finance">Finanzas</span>
            <a href="#" onclick="showSection('invoices')" class="nav-link"><span>ğŸ“„</span> <span data-i18n="nav_invoices">Facturas</span></a>
            <a href="#" onclick="showSection('collections')" class="nav-link"><span>ğŸ’°</span> <span data-i18n="nav_collections">Cobranza</span></a>
            <a href="#" onclick="showSection('receipts')" class="nav-link"><span>ğŸ§¾</span> Recibos</a>
            <a href="#" onclick="showSection('expenses')" class="nav-link"><span>ğŸ¢</span> Gastos del Negocio</a>
            <a href="#" onclick="showSection('mymoney')" class="nav-link"><span>ğŸ’µ</span> <span data-i18n="nav_mymoney">Mi Dinero</span></a>
            <a href="#" onclick="showSection('payroll')" class="nav-link"><span>ğŸ’³</span> <span data-i18n="nav_payroll">NÃ³mina</span></a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title">ComunicaciÃ³n</span>
            <a href="#" onclick="showSection('mailbox')" class="nav-link"><span>ğŸ“¬</span> Correo del Negocio</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_growth">Crecimiento</span>
            <a href="#" onclick="showSection('marketing')" class="nav-link"><span>ğŸ“£</span> <span data-i18n="nav_marketing">Mercadotecnia</span></a>
            <a href="#" onclick="showSection('pricebook')" class="nav-link"><span>ğŸ“’</span> <span data-i18n="nav_pricebook">Lista de Precios</span></a>
            <a href="#" onclick="showSection('reports')" class="nav-link"><span>ğŸ“Š</span> <span data-i18n="nav_reports">Reportes</span></a>
            <a href="#" onclick="showSection('ambassadors')" class="nav-link"><span>ğŸŒŸ</span> Programa Embajadores</a>
          </div>
          <div class="nav-group">
            <span class="nav-group-title" data-i18n="nav_system">Sistema</span>
            <a href="#" onclick="showSection('team')" class="nav-link"><span>ğŸ‘¥</span> Usuarios y Equipo</a>
            <a href="#" onclick="showSection('hr')" class="nav-link"><span>ğŸ›¡ï¸</span> Recursos Humanos</a>
            <a href="#" onclick="launchDemoManual()" class="nav-link" style="color:#f97316"><span>ğŸ¬</span> Tour AI / Demo</a>
            <a href="#" onclick="showSection('settings')" class="nav-link"><span>âš™ï¸</span> <span data-i18n="nav_settings">ConfiguraciÃ³n</span></a>
          </div>
        </nav>
        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar-sm" id="sidebarInitials">M</div>
            <span id="sidebarUserName" class="user-name-text">Usuario</span>
          </div>
          <button onclick="logout()" class="btn-logout">Cerrar SesiÃ³n</button>
        </div>
      </aside>

      <main class="main-content">
        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>
        
        <header class="top-bar">
          <div style="display:flex;align-items:center;gap:12px;">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
            <h1 id="pageTitle">Tablero</h1>
          </div>
          <div class="top-bar-right">
            <!-- Global Search -->
            <div class="global-search-wrap">
              <input type="text" id="globalSearchInput" placeholder="ğŸ” Buscar cliente, trabajo, factura..." oninput="globalSearch(this.value)" onfocus="this.parentElement.classList.add('focused')" onblur="setTimeout(function(){document.querySelector('.global-search-wrap').classList.remove('focused')},200)">
              <div id="globalSearchResults" class="global-search-results"></div>
            </div>
            <!-- Quick Add -->
            <div class="quick-add-wrap">
              <button class="quick-add-btn" onclick="toggleQuickAdd()" title="Crear RÃ¡pido">+</button>
              <div id="quickAddMenu" class="quick-add-menu" style="display:none;">
                <div class="quick-add-title">Crear Nuevo</div>
                <a href="#" onclick="quickAddAction('client')">ğŸ‘¥ Nuevo Cliente</a>
                <a href="#" onclick="quickAddAction('job')">ğŸ”§ Nuevo Trabajo</a>
                <a href="#" onclick="quickAddAction('lead')">ğŸ¯ Nuevo Lead</a>
                <a href="#" onclick="quickAddAction('appointment')">ğŸ“… Nueva Cita</a>
                <a href="#" onclick="quickAddAction('invoice')">ğŸ“„ Nueva Factura</a>
                <a href="#" onclick="quickAddAction('estimate')">ğŸ’° Nuevo Estimado</a>
              </div>
            </div>
            <!-- Notifications -->
            <div class="notif-wrap">
              <button class="notif-btn" onclick="toggleNotifications()" title="Notificaciones">
                ğŸ””
                <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
              </button>
              <div id="notifPanel" class="notif-panel" style="display:none;">
                <div class="notif-header">ğŸ”” Notificaciones</div>
                <div id="notifList" class="notif-list"><p class="empty-msg">Sin notificaciones</p></div>
              </div>
            </div>
            <span id="companyDisplay" class="company-name"></span>
            <!-- Language Toggle -->
            <button class="lang-toggle-btn" onclick="toggleLanguage()" title="Cambiar Idioma / Change Language">
              <span id="langFlag">ğŸ‡²ğŸ‡½</span> <span id="langLabel">ES</span>
            </button>
            <div id="userInitials" class="user-avatar">M</div>
          </div>
        </header>

        <div class="content-area">

          <!-- ===== DASHBOARD ===== -->
          <div id="dashboard-section" class="section active">

            <!-- HCP-Style Welcome Banner -->
            <div class="hcp-welcome-banner">
              <button class="hcp-close-banner" onclick="this.parentElement.style.display='none'">âœ•</button>
              <h2 id="dashWelcomeMsg" data-i18n="dash_welcome">Hola, Â¿en quÃ© nos enfocamos hoy?</h2>
              <div class="hcp-quick-actions">
                <button onclick="quickAddAction('estimate')">âœ¨ <span data-i18n="dash_add_material">Agregar materiales</span></button>
                <button onclick="showSection('clients')">âœ¨ <span data-i18n="dash_import_data">Importar datos</span></button>
                <button onclick="showSection('marketing')">âœ¨ <span data-i18n="dash_connect_reviews">Conectar reseÃ±as</span></button>
                <button onclick="showSection('reports')">âœ¨ <span data-i18n="dash_ask_something">Preguntar algo</span></button>
                <button onclick="launchDemoManual()" style="background:linear-gradient(135deg,#f97316,#ea580c);color:#fff">ğŸ¬ Ver Demo AI</button>
              </div>
            </div>

            <!-- CENTRO DE MANDO - COMMAND CENTER -->
            <div class="card" style="margin-bottom:20px;border:2px solid var(--primary);background:linear-gradient(135deg,#1e3a5f 0%,#2d4a6f 100%);">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                <div>
                  <h2 style="color:white;margin:0;font-size:24px;">ğŸ¯ Centro de Mando</h2>
                  <p style="color:rgba(255,255,255,0.7);margin:4px 0 0 0;font-size:13px;">Operaciones en tiempo real - Haz clic en cada tarjeta para ver detalles y ubicaciones</p>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showSection('dispatch')" style="background:#f47621;">ğŸ—ºï¸ Ver Mapa General</button>
                  <button class="btn-secondary btn-sm" onclick="refreshCommandCenter()" style="background:rgba(255,255,255,0.2);color:white;border:none;">ğŸ”„ Actualizar</button>
                </div>
              </div>
            </div>

            <!-- HCP-Style Summary Cards - CENTRO DE MANDO -->
            <div class="hcp-summary-grid">
              <!-- TRABAJOS GANADOS -->
              <div class="hcp-summary-card" onclick="showSection('jobs');setTimeout(filterWonJobs,300);" style="border-top:3px solid #10b981;">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ†</span>
                  <span>Trabajos Ganados</span>
                  <button class="hcp-plus-btn" onclick="event.stopPropagation();quickAddAction('job')">+</button>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpWonJobs">0</span>
                  <div class="hcp-summary-detail">
                    <span>Por agendar</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <span class="hcp-sub-amount" id="hcpWonJobsAmount">$0.00</span>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('jobs')">Ver trabajos ganados</a>
              </div>

              <!-- LLAMADAS DE SERVICIO -->
              <div class="hcp-summary-card" onclick="showSection('servicecalls')" style="border-top:3px solid #ef4444;">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ“</span>
                  <span>Llamadas de Servicio</span>
                  <button class="hcp-plus-btn" onclick="event.stopPropagation();showSection('servicecalls');setTimeout(showServiceCallForm,300);">+</button>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpActiveServiceCalls">0</span>
                  <div class="hcp-summary-detail">
                    <span>Llamadas activas</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <div style="display:flex;gap:12px;font-size:11px;margin-top:4px;">
                    <span style="color:#ef4444;">ğŸ†• <span id="hcpSCNew">0</span></span>
                    <span style="color:#f59e0b;">ğŸ‘· <span id="hcpSCAssigned">0</span></span>
                    <span style="color:#3b82f6;">ğŸš <span id="hcpSCEnroute">0</span></span>
                  </div>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('servicecalls')">Ver llamadas de servicio</a>
              </div>

              <!-- HOME ADVISORS / VENDEDORES -->
              <div class="hcp-summary-card" onclick="showSection('advisors')" style="border-top:3px solid #10b981;">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ </span>
                  <span>Home Advisors</span>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpActiveAdvisors">0</span>
                  <div class="hcp-summary-detail">
                    <span>Vendedores activos</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <div style="display:flex;gap:8px;font-size:11px;margin-top:4px;">
                    <span style="color:#10b981;">ğŸ’° $<span id="hcpAdvPendingComm">0</span> pendiente</span>
                  </div>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('advisors')">Ver vendedores</a>
              </div>

              <!-- TÃ‰CNICOS EN CAMPO -->
              <div class="hcp-summary-card" onclick="showSection('technicians')" style="border-top:3px solid #3b82f6;">
                <div class="hcp-summary-header">
                  <span class="hcp-summary-icon">ğŸ‘·</span>
                  <span>TÃ©cnicos en Campo</span>
                </div>
                <div class="hcp-summary-body">
                  <span class="hcp-big-num" id="hcpTechsAvailable">0</span>
                  <div class="hcp-summary-detail">
                    <span>Disponibles</span> <span class="hcp-summary-info">â“˜</span>
                  </div>
                  <div style="display:flex;gap:12px;font-size:11px;margin-top:4px;">
                    <span style="color:#10b981;">ğŸŸ¢ <span id="hcpTechsOnline">0</span></span>
                    <span style="color:#f59e0b;">ğŸ”¶ <span id="hcpTechsBusy">0</span></span>
                    <span style="color:#94a3b8;">âš« <span id="hcpTechsOffline">0</span></span>
                  </div>
                </div>
                <a class="hcp-summary-link" onclick="event.stopPropagation();showSection('dispatch')">Ver en despacho</a>
              </div>
            </div>

            <!-- MAPA DE OPERACIONES EN TIEMPO REAL -->
            <div class="card" style="margin-bottom:20px;">
              <div class="card-top">
                <h3>ğŸ—ºï¸ Mapa de Operaciones en Tiempo Real</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="btn-secondary btn-sm" onclick="refreshCommandCenterMap()">ğŸ”„</button>
                </div>
              </div>
              <div id="commandCenterMap" style="width:100%;height:350px;border-radius:8px;"></div>
              <div style="display:flex;gap:16px;padding:12px 0 0 0;flex-wrap:wrap;font-size:12px;">
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#10b981;border-radius:50%;display:inline-block;"></span> TÃ©cnico Disponible</div>
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#f59e0b;border-radius:50%;display:inline-block;"></span> TÃ©cnico Ocupado</div>
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#8b5cf6;border-radius:50%;display:inline-block;"></span> Vendedor</div>
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#ef4444;border-radius:50%;display:inline-block;"></span> Trabajo Nuevo</div>
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#3b82f6;border-radius:50%;display:inline-block;"></span> Trabajo En Progreso</div>
              </div>
            </div>

            <!-- ESTADO DE TODOS LOS EMPLEADOS -->
            <div class="card" style="margin-bottom:20px;">
              <div class="card-top">
                <h3>ğŸ‘¥ Estado de Todo el Personal</h3>
                <div style="display:flex;gap:8px;">
                  <span style="font-size:11px;color:#64748b;">ğŸ‘· TÃ©cnicos: <strong id="totalTechsCount">0</strong></span>
                  <span style="font-size:11px;color:#64748b;">ğŸ  Vendedores: <strong id="totalAdvisorsCount">0</strong></span>
                </div>
              </div>
              <div id="allEmployeesStatusList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;max-height:300px;overflow-y:auto;padding:8px 0;"></div>
            </div>

            <!-- INSTALACIONES EN PROGRESO -->
            <div class="card" style="margin-bottom:20px;border:2px solid #8b5cf6;">
              <div class="card-top">
                <h3>ğŸ”§ Instalaciones en Progreso</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <span style="font-size:12px;color:#64748b;">Total: <strong id="installationsCount">0</strong></span>
                  <button class="btn-primary btn-sm" onclick="showNewInstallationModal()">+ Nueva InstalaciÃ³n</button>
                </div>
              </div>
              
              <!-- Installation Status Pipeline -->
              <div style="display:flex;gap:4px;margin:16px 0;overflow-x:auto;padding-bottom:8px;">
                <div style="flex:1;min-width:100px;text-align:center;padding:8px;background:#fef3c7;border-radius:8px;">
                  <div style="font-size:20px;font-weight:bold;color:#f59e0b;" id="instStatusIniciado">0</div>
                  <div style="font-size:10px;color:#92400e;">ğŸš€ INICIADO</div>
                </div>
                <div style="display:flex;align-items:center;color:#cbd5e1;">â†’</div>
                <div style="flex:1;min-width:100px;text-align:center;padding:8px;background:#dbeafe;border-radius:8px;">
                  <div style="font-size:20px;font-weight:bold;color:#3b82f6;" id="instStatusProgreso">0</div>
                  <div style="font-size:10px;color:#1e40af;">ğŸ”§ EN PROGRESO</div>
                </div>
                <div style="display:flex;align-items:center;color:#cbd5e1;">â†’</div>
                <div style="flex:1;min-width:100px;text-align:center;padding:8px;background:#fce7f3;border-radius:8px;">
                  <div style="font-size:20px;font-weight:bold;color:#ec4899;" id="instStatusTerminado">0</div>
                  <div style="font-size:10px;color:#9d174d;">âœ… TERMINADO</div>
                </div>
                <div style="display:flex;align-items:center;color:#cbd5e1;">â†’</div>
                <div style="flex:1;min-width:100px;text-align:center;padding:8px;background:#e0e7ff;border-radius:8px;">
                  <div style="font-size:20px;font-weight:bold;color:#6366f1;" id="instStatusDocumentado">0</div>
                  <div style="font-size:10px;color:#3730a3;">ğŸ“‹ DOCUMENTADO</div>
                </div>
                <div style="display:flex;align-items:center;color:#cbd5e1;">â†’</div>
                <div style="flex:1;min-width:100px;text-align:center;padding:8px;background:#d1fae5;border-radius:8px;">
                  <div style="font-size:20px;font-weight:bold;color:#10b981;" id="instStatusFinalizado">0</div>
                  <div style="font-size:10px;color:#065f46;">ğŸ FINALIZADO</div>
                </div>
              </div>

              <!-- Installations List -->
              <div id="installationsList" style="max-height:400px;overflow-y:auto;"></div>
            </div>

            <!-- New Installation Modal -->
            <div id="newInstallationModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
              <div style="background:white;border-radius:12px;padding:24px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                  <h3 style="margin:0;color:#1e3a5f;">ğŸ”§ Nueva InstalaciÃ³n</h3>
                  <button onclick="closeInstallationModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">Ã—</button>
                </div>
                <form id="newInstallationForm" onsubmit="handleCreateInstallation(event)">
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ‘¤ Cliente</label>
                      <input type="text" id="instClientName" required placeholder="Nombre del cliente">
                    </div>
                    <div class="form-group">
                      <label>ğŸ“± TelÃ©fono</label>
                      <input type="tel" id="instClientPhone" placeholder="(555) 123-4567">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>ğŸ“ DirecciÃ³n de InstalaciÃ³n</label>
                    <input type="text" id="instAddress" required placeholder="DirecciÃ³n completa">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ  Vendedor (Home Advisor)</label>
                      <select id="instAdvisorId">
                        <option value="">-- Seleccionar vendedor --</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>ğŸ’° Precio de Venta</label>
                      <input type="number" id="instSalePrice" step="0.01" placeholder="0.00">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ“… Fecha de Inicio</label>
                      <input type="date" id="instStartDate" required>
                    </div>
                    <div class="form-group">
                      <label>ğŸ“… Fecha Estimada de Fin</label>
                      <input type="date" id="instEndDate">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>ğŸ‘· TÃ©cnicos Asignados</label>
                    <div id="instTechCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:8px;background:var(--bg-input);border-radius:8px;"></div>
                  </div>
                  <div class="form-group">
                    <label>ğŸ”§ Tipo de Equipo</label>
                    <input type="text" id="instEquipmentType" placeholder="Ej: AC Split 3 Ton, Furnace 80K BTU">
                  </div>
                  <div class="form-group">
                    <label>ğŸ“ Notas</label>
                    <textarea id="instNotes" rows="2" placeholder="Notas adicionales..."></textarea>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary">ğŸ’¾ Crear InstalaciÃ³n</button>
                    <button type="button" class="btn-secondary" onclick="closeInstallationModal()">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Year to Date KPIs (Housecall Pro style) -->
            <div class="hcp-ytd-section">
              <div class="hcp-ytd-header">
                <select id="ytdPeriod" class="inline-select" onchange="renderYTDKpis()" style="padding:6px 10px;font-size:13px;font-weight:600;">
                  <option value="ytd" data-i18n="dash_ytd">AÃ±o hasta la fecha</option>
                  <option value="mtd" data-i18n="dash_mtd">Mes hasta la fecha</option>
                  <option value="last30" data-i18n="dash_last30">Ãšltimos 30 dÃ­as</option>
                  <option value="last90" data-i18n="dash_last90">Ãšltimos 90 dÃ­as</option>
                </select>
                <a class="hcp-link" onclick="showSection('reports')" data-i18n="dash_view_reports">Ver todos los reportes</a>
              </div>
              <div class="hcp-ytd-grid">
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_revenue">INGRESOS GANADOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdRevenue">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_completed">TRABAJOS COMPLETADOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdCompleted">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_avg_job">TICKET PROMEDIO</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdAvgJob">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_new_booked">NUEVOS TRABAJOS</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdNewBooked">--</span>
                </div>
                <div class="hcp-ytd-card">
                  <span class="hcp-ytd-label" data-i18n="kpi_online_booked">RESERVADOS EN LÃNEA</span> <span class="hcp-summary-info">â“˜</span>
                  <span class="hcp-ytd-value" id="ytdOnlineBooked">--</span>
                </div>
              </div>
            </div>

            <!-- Employee Status + Map (Housecall Pro style) -->
            <div class="hcp-employee-section">
              <div class="hcp-employee-left">
                <div class="hcp-employee-header">
                  <h3 data-i18n="dash_employee_status">Estado de Empleados</h3>
                  <div class="hcp-today-toggle">
                    <button class="hcp-toggle-btn active" onclick="setEmployeeView('today')" data-i18n="dash_today">Hoy</button>
                    <button class="hcp-toggle-btn" onclick="setEmployeeView('tomorrow')" data-i18n="dash_tomorrow">MaÃ±ana</button>
                  </div>
                </div>
                <div id="employeeStatusList" class="hcp-employee-list">
                  <p class="empty-msg" data-i18n="dash_see_jobs">Ve los trabajos y estimados del dÃ­a</p>
                </div>
                <div class="hcp-employee-actions">
                  <button class="btn-secondary btn-sm" onclick="quickAddAction('job')" data-i18n="dash_add_job">Agregar trabajo</button>
                  <button class="btn-secondary btn-sm" onclick="quickAddAction('estimate')" data-i18n="dash_add_estimate">Agregar estimado</button>
                </div>
              </div>
              <div class="hcp-employee-right">
                <div id="employeeStatusMap" style="width:100%;height:100%;min-height:300px;border-radius:8px;"></div>
              </div>
            </div>

            <!-- ===== CLOCK IN / OUT WIDGET ===== -->
            <div class="clock-widget-card">
              <div class="clock-widget-left">
                <div class="clock-display">
                  <span class="clock-time" id="dashClockTime">00:00:00</span>
                  <span class="clock-date" id="dashClockDate"></span>
                </div>
                <div class="clock-controls">
                  <div class="form-row" style="margin-bottom:10px;">
                    <div class="form-group" style="margin:0;">
                      <label style="font-size:11px;margin-bottom:4px;" data-i18n="clock_select_tech">Seleccionar Persona</label>
                      <select id="clockTechSelect" onchange="onClockTechChange()" style="padding:8px;font-size:12px;"></select>
                    </div>
                    <div class="form-group" style="margin:0;">
                      <label style="font-size:11px;margin-bottom:4px;" data-i18n="clock_hourly_rate">Tarifa por Hora</label>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="font-size:14px;">$</span>
                        <input type="number" id="clockHourlyRate" value="0" min="0" step="0.50" style="padding:8px;font-size:14px;font-weight:700;width:80px;" onchange="saveClockRate()">
                        <span style="font-size:11px;color:var(--text-muted);">/hr</span>
                      </div>
                    </div>
                  </div>
                  <button class="clock-btn clock-btn-in" id="clockInOutBtn" onclick="toggleDashClockInOut()">
                    <span class="clock-btn-icon" id="clockBtnIcon">ğŸŸ¢</span>
                    <span id="clockBtnText" data-i18n="clock_in">Marcar Entrada</span>
                  </button>
                </div>
              </div>
              <div class="clock-widget-right">
                <div class="clock-earning-box">
                  <span class="clock-earning-label" data-i18n="clock_worked_today">Trabajado Hoy</span>
                  <span class="clock-earning-time" id="clockWorkedTime">0h 0m 0s</span>
                </div>
                <div class="clock-earning-box clock-earning-highlight">
                  <span class="clock-earning-label" data-i18n="clock_earned_today">Ganado Hoy</span>
                  <span class="clock-earning-money" id="clockEarnedToday">$0.00</span>
                </div>
                <div class="clock-earning-box">
                  <span class="clock-earning-label" data-i18n="clock_projected_8h">ProyecciÃ³n 8hrs</span>
                  <span class="clock-earning-sub" id="clockProjected8">$0.00</span>
                </div>
                <!-- Today's Clock History -->
                <div class="clock-history">
                  <span class="clock-history-title" data-i18n="clock_history">Historial de Hoy</span>
                  <div id="clockHistoryList"></div>
                </div>
              </div>
            </div>

            <!-- Estimates Pipeline -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“‹ <span data-i18n="dash_est_pipeline">Flujo de Estimados</span></h3>
                <button class="btn-primary btn-sm" onclick="showSection('jobs')">+ <span data-i18n="dash_new_estimate">Nuevo Estimado</span></button>
              </div>
              <div id="estimatePipeline" class="pipeline-row">
                <div class="pipeline-card pipeline-open">
                  <div class="pipeline-num" id="pipeOpenCount">0</div>
                  <div class="pipeline-label">Abiertos</div>
                  <div class="pipeline-amount" id="pipeOpenAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-approved">
                  <div class="pipeline-num" id="pipeApprovedCount">0</div>
                  <div class="pipeline-label">Aprobados</div>
                  <div class="pipeline-amount" id="pipeApprovedAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-invoiced">
                  <div class="pipeline-num" id="pipeInvoicedCount">0</div>
                  <div class="pipeline-label">Facturados</div>
                  <div class="pipeline-amount" id="pipeInvoicedAmt">$0</div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-card pipeline-paid">
                  <div class="pipeline-num" id="pipePaidCount">0</div>
                  <div class="pipeline-label">Cobrados</div>
                  <div class="pipeline-amount" id="pipePaidAmt">$0</div>
                </div>
              </div>
              <div id="pipeConversionRate" style="text-align:center;margin-top:8px;font-size:12px;color:var(--text-muted);"></div>
            </div>

            <!-- Revenue Pipeline -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ’° Flujo de Efectivo</h3>
                <select id="pipelineYear" class="inline-select" onchange="renderPipeline()" style="padding:8px 12px;">
                </select>
              </div>
              <div id="pipelineChart" class="pipeline-chart"></div>
              <div id="pipelineStats" class="pipeline-stats"></div>
            </div>

            <div class="cards-row">
              <!-- Recent Jobs -->
              <div class="card">
                <h3>ğŸ”§ Trabajos Recientes</h3>
                <div id="dashRecentJobs"></div>
              </div>
              <!-- Upcoming Appointments -->
              <div class="card">
                <h3>ğŸ“… PrÃ³ximas Citas</h3>
                <div id="dashUpcomingAppts"></div>
              </div>
            </div>

            <!-- Overdue Invoices Alert -->
            <div id="dashOverdueAlert" style="display:none;" class="card">
              <h3>ğŸ”´ Facturas Vencidas</h3>
              <div id="dashOverdueList"></div>
            </div>

            <!-- Plan de Servicios -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ›¡ï¸ Planes de Servicio / Plan de Servicios</h3>
                <button class="btn-primary btn-sm" onclick="showServicePlanForm()">+ Nuevo Plan</button>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">MembresÃ­as de mantenimiento recurrente. Genera ingresos estables y fideliza clientes.</p>
              <div id="servicePlanFormArea" style="display:none;margin-bottom:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">Crear Plan de Servicio</h4>
                <form onsubmit="createServicePlan(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre del Plan</label><input type="text" id="spName" required placeholder="Ej: Plan Gold Mantenimiento"></div>
                    <div class="form-group"><label>Precio Mensual ($)</label><input type="number" id="spPrice" required min="0" step="0.01" placeholder="49.99"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Visitas por AÃ±o</label><input type="number" id="spVisits" value="2" min="1" max="12"></div>
                    <div class="form-group"><label>Descuento en Reparaciones (%)</label><input type="number" id="spDiscount" value="15" min="0" max="50"></div>
                  </div>
                  <div class="form-group"><label>Incluye</label><textarea id="spIncludes" rows="2" placeholder="Ej: 2 Tune-Ups al aÃ±o, inspecciÃ³n de filtros, prioridad en emergencias, 15% descuento en reparaciones"></textarea></div>
                  <div class="form-row">
                    <div class="form-group"><label>DuraciÃ³n</label>
                      <select id="spDuration">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="annual">Anual</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tipo de Equipo</label>
                      <select id="spEquipType">
                        <option value="residential_ac">AC Residencial</option>
                        <option value="commercial_ac">AC Comercial</option>
                        <option value="heating">Heating / Furnace</option>
                        <option value="full_system">Sistema Completo (AC + Heating)</option>
                        <option value="refrigeration">RefrigeraciÃ³n</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Plan</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideServicePlanForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="servicePlansList"></div>
            </div>
          </div>

          <!-- ===== CALENDAR / SCHEDULE ===== -->
          <div id="calendar-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“… Calendario de Citas</h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <div class="cal-view-toggle">
                    <button class="cal-view-btn active" id="calViewMonth" onclick="setCalView('month')">Mes</button>
                    <button class="cal-view-btn" id="calViewWeek" onclick="setCalView('week')">Semana</button>
                    <button class="cal-view-btn" id="calViewDay" onclick="setCalView('day')">DÃ­a</button>
                  </div>
                  <button class="btn-secondary btn-sm" onclick="calPrev()" style="padding:6px 12px;">â—€</button>
                  <span id="calMonthLabel" style="font-weight:700;font-size:15px;color:var(--primary);min-width:160px;text-align:center;"></span>
                  <button class="btn-secondary btn-sm" onclick="calNext()" style="padding:6px 12px;">â–¶</button>
                  <button class="btn-secondary btn-sm" onclick="calToday()" style="margin-left:8px;">Hoy</button>
                  <button class="btn-primary btn-sm" onclick="showApptForm()">+ Nueva Cita</button>
                </div>
              </div>

              <!-- Appointment Form -->
              <div id="apptFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);" id="apptFormTitle">ğŸ“… Nueva Cita</h4>
                <form id="apptForm" onsubmit="handleApptCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>TÃ­tulo / Servicio</label><input type="text" id="apptTitle" required placeholder="Ej: Tune-Up AC, ReparaciÃ³n Furnace..."></div>
                    <div class="form-group"><label>Cliente</label>
                      <select id="apptClientSelect" onchange="loadApptClientInfo()">
                        <option value="">Seleccionar o crear...</option>
                        <option value="__new__">â• Nuevo Cliente</option>
                      </select>
                    </div>
                  </div>
                  <!-- New client fields (hidden by default) -->
                  <div id="apptNewClientFields" style="display:none;">
                    <div class="form-row">
                      <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="apptNewClientName" placeholder="Nombre completo"></div>
                      <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="apptNewClientPhone" placeholder="(555) 123-4567"></div>
                    </div>
                    <div class="form-group"><label>Email</label><input type="email" id="apptNewClientEmail" placeholder="email@cliente.com"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Fecha</label><input type="date" id="apptDate" required></div>
                    <div class="form-group"><label>Hora Inicio</label><input type="time" id="apptStartTime" value="09:00"></div>
                    <div class="form-group"><label>Hora Fin</label><input type="time" id="apptEndTime" value="10:00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TÃ©cnico</label>
                      <select id="apptTechSelect"><option value="">Sin asignar</option></select>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="apptAddress" placeholder="DirecciÃ³n del servicio"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="apptNotes" rows="2" placeholder="Detalles adicionales..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm" id="apptSubmitBtn">ğŸ’¾ Crear Cita</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideApptForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Calendar Grid -->
              <div id="calendarGrid" class="calendar-grid"></div>
              <div id="calWeekGrid" class="cal-week-grid" style="display:none;"></div>
              <div id="calDayGrid" class="cal-day-grid" style="display:none;"></div>
            </div>

            <!-- Day Detail -->
            <div class="card" style="margin-top:16px;">
              <h3 id="calDayTitle">ğŸ“‹ Citas del DÃ­a</h3>
              <div id="calDayAppts"></div>
            </div>
          </div>

          <!-- ===== INBOX ===== -->
          <div id="inbox-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“¬ Bandeja - Centro de ComunicaciÃ³n</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="inboxFilter" onchange="renderInbox()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                    <option value="all">ğŸ“‹ Todas</option>
                    <option value="call_out">ğŸ“± Llamadas Salientes</option>
                    <option value="call_in">ğŸ“² Llamadas Entrantes</option>
                    <option value="text">ğŸ’¬ Texto/SMS</option>
                    <option value="email">ğŸ“§ Email</option>
                    <option value="visit">ğŸ  Visitas</option>
                    <option value="follow_up">ğŸ”„ Follow-Ups</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showInboxCompose()">+ Nueva ComunicaciÃ³n</button>
                </div>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Registro centralizado de todas las comunicaciones con clientes. Llamadas, textos, emails, visitas y follow-ups.</p>
              
              <div id="inboxComposeArea" style="display:none;margin-bottom:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Registrar ComunicaciÃ³n</h4>
                <form onsubmit="createInboxComm(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Cliente</label>
                      <select id="inboxClient" required>
                        <option value="">Seleccionar cliente...</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tipo</label>
                      <select id="inboxType">
                        <option value="call_out">ğŸ“± Llamada Saliente</option>
                        <option value="call_in">ğŸ“² Llamada Entrante</option>
                        <option value="text">ğŸ’¬ Texto/SMS</option>
                        <option value="email">ğŸ“§ Email</option>
                        <option value="visit">ğŸ  Visita</option>
                        <option value="follow_up">ğŸ”„ Follow-Up</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>DescripciÃ³n</label><textarea id="inboxNote" rows="2" required placeholder="Resumen de la comunicaciÃ³n..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideInboxCompose()">Cancelar</button>
                  </div>
                </form>
              </div>
              
              <div id="inboxList"></div>
            </div>
          </div>

          <!-- ===== LEADS ===== -->
          <div id="leads-section" class="section">
            <div class="card">
              <div class="card-top"><h3>Leads Registrados</h3><button class="btn-primary btn-sm" onclick="showLeadForm()">+ Nuevo Lead</button></div>
              <div id="leadFormContainer" style="display:none; margin-bottom:20px;">
                <form id="leadForm" onsubmit="handleLeadCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="leadName" placeholder="Nombre del cliente" required></div>
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="leadPhone" placeholder="TelÃ©fono" required></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="leadEmail" placeholder="Email"></div>
                    <div class="form-group">
                      <label>Servicio</label>
                      <select id="leadService" required>
                        <option value="">Seleccionar</option>
                        <option value="InstalaciÃ³n AC">InstalaciÃ³n AC</option>
                        <option value="ReparaciÃ³n AC">ReparaciÃ³n AC</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="CalefacciÃ³n">CalefacciÃ³n</option>
                        <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                        <option value="Ductos">Ductos</option>
                        <option value="Otro">Otro</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Tipo de Propiedad</label>
                      <select id="leadPropertyType">
                        <option value="residential">ğŸ  Residencial</option>
                        <option value="commercial">ğŸ¢ Comercial</option>
                        <option value="industrial">ğŸ­ Industrial</option>
                        <option value="restaurant">ğŸ½ï¸ Restaurante</option>
                      </select>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="leadAddress" placeholder="DirecciÃ³n completa" required><input type="hidden" id="leadLat"><input type="hidden" id="leadLng"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="leadNotes" rows="3" placeholder="Notas adicionales"></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">Guardar Lead</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideLeadForm()">Cancelar</button>
                  </div>
                </form>
              </div>
              <div id="leadsList"></div>
            </div>
            <div class="card"><h3>Mapa de Leads</h3><div id="leadsMap" style="width:100%;height:500px;border-radius:8px;"></div></div>
          </div>

          <!-- ===== SERVICE CALLS / LLAMADAS DE SERVICIO ===== -->
          <div id="servicecalls-section" class="section">
            <!-- KPI Cards -->
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ†•</span> Nuevas</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="scKpiNew">0</span><span class="hcp-sub-amount">Sin asignar</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ‘·</span> Asignadas</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="scKpiAssigned">0</span><span class="hcp-sub-amount">Esperando</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸš</span> En Camino</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="scKpiEnroute">0</span><span class="hcp-sub-amount">En ruta</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">âœ…</span> Completadas Hoy</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="scKpiCompleted">0</span><span class="hcp-sub-amount">Finalizadas</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“ Llamadas de Servicio</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="scFilterStatus" onchange="renderServiceCallCards()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;">
                    <option value="active" selected>ğŸ”´ Activas (sin completar)</option>
                    <option value="new">ğŸ†• Nuevas (sin asignar)</option>
                    <option value="assigned">ğŸ‘· Asignadas</option>
                    <option value="enroute">ğŸš En Progreso</option>
                    <option value="completed">âœ… Completadas</option>
                    <option value="all">ğŸ“‹ Todas</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showServiceCallForm()">+ Nueva Llamada</button>
                </div>
              </div>

              <!-- New Service Call Form -->
              <div id="serviceCallFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:2px solid var(--primary);border-radius:12px;">
                <h4 style="color:var(--primary);margin-bottom:16px;">ğŸ“ Nueva Llamada de Servicio</h4>
                <form id="serviceCallForm" onsubmit="handleServiceCallCreate(event)">
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ‘¤ Nombre del Cliente</label>
                      <input type="text" id="scClientName" required placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                      <label>ğŸ“± TelÃ©fono</label>
                      <input type="tel" id="scClientPhone" required placeholder="(555) 123-4567">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>ğŸ“ DirecciÃ³n del Servicio</label>
                    <input type="text" id="scAddress" required placeholder="DirecciÃ³n completa">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ”§ Problema / DescripciÃ³n</label>
                      <textarea id="scProblem" rows="2" required placeholder="Â¿CuÃ¡l es el problema? AC no enfrÃ­a, calefacciÃ³n no enciende, etc."></textarea>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>âš¡ Urgencia</label>
                      <select id="scUrgency">
                        <option value="normal">ğŸŸ¢ Normal</option>
                        <option value="priority">ğŸŸ¡ Prioritario</option>
                        <option value="emergency">ğŸ”´ Emergencia</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>ğŸ  Tipo de Propiedad</label>
                      <select id="scPropertyType">
                        <option value="residential">ğŸ  Residencial</option>
                        <option value="commercial">ğŸ¢ Comercial</option>
                        <option value="industrial">ğŸ­ Industrial</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>ğŸ‘· Asignar TÃ©cnico (opcional)</label>
                      <select id="scTechAssign">
                        <option value="">-- Asignar despuÃ©s --</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>ğŸ“… Fecha Preferida</label>
                      <input type="date" id="scPreferredDate">
                    </div>
                    <div class="form-group">
                      <label>ğŸ• Hora Preferida</label>
                      <select id="scPreferredTime">
                        <option value="">Cualquier hora</option>
                        <option value="morning">ğŸŒ… MaÃ±ana (8am-12pm)</option>
                        <option value="afternoon">â˜€ï¸ Tarde (12pm-5pm)</option>
                        <option value="asap">âš¡ Lo antes posible</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>ğŸ“ Notas Adicionales</label>
                    <textarea id="scNotes" rows="2" placeholder="CÃ³digo de acceso, mascota, instrucciones especiales..."></textarea>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary">ğŸ’¾ Guardar Llamada</button>
                    <button type="button" class="btn-secondary" onclick="hideServiceCallForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Service Calls Cards Grid -->
              <div id="serviceCallsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;"></div>
            </div>

            <!-- Service Calls Map -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ—ºï¸ Mapa de Llamadas de Servicio</h3>
                <div class="dispatch-legend">
                  <span class="legend-item"><span style="color:#ef4444;">ğŸ“</span> Nueva</span>
                  <span class="legend-item"><span style="color:#f59e0b;">ğŸ“</span> Asignada</span>
                  <span class="legend-item"><span style="color:#3b82f6;">ğŸ“</span> En Camino</span>
                  <span class="legend-item"><span style="color:#10b981;">ğŸ“</span> Completada</span>
                </div>
              </div>
              <div id="serviceCallsMap" style="width:100%;height:400px;border-radius:8px;"></div>
            </div>
          </div>

          <!-- ===== DISPATCH ===== -->
          <div id="dispatch-section" class="section">
            <!-- Dispatch Coordinator -->
            <div class="card" style="margin-bottom:16px;border:2px solid var(--primary);">
              <div class="card-top">
                <h3>ğŸ¯ Coordinador de Despacho</h3>
                <button class="btn-secondary btn-sm" onclick="toggleDispatchCoord()" id="dispCoordToggle">âœï¸ Editar</button>
              </div>
              <div id="dispCoordDisplay" style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;padding:8px 0;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <div id="dispCoordAvatar" class="dispatch-avatar-container" style="width:70px;height:70px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;overflow:hidden;position:relative;">?</div>
                  <div>
                    <div id="dispCoordName" style="font-weight:700;font-size:15px;color:var(--text-primary);">Sin asignar</div>
                    <div id="dispCoordRole" style="font-size:11px;color:var(--text-muted);">Asigna un responsable de despacho</div>
                  </div>
                </div>
                <div id="dispCoordInfo" style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;"></div>
              </div>
              <div id="dispCoordForm" style="display:none;margin-top:12px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <!-- Profile Photo Upload -->
                <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
                  <div id="dcPhotoPreview" class="dc-photo-preview">
                    <span id="dcPhotoPlaceholder">ğŸ“·</span>
                    <img id="dcPhotoImg" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;">
                  </div>
                  <div style="flex:1;">
                    <h5 style="margin-bottom:6px;color:var(--text-primary);">Foto de Perfil</h5>
                    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Sube una foto del coordinador de despacho. Se mostrarÃ¡ en el panel principal.</p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <label class="btn-primary btn-sm" style="cursor:pointer;">
                        ğŸ“· Subir Foto
                        <input type="file" accept="image/*" onchange="handleDCPhotoUpload(this)" style="display:none;" id="dcPhotoInput">
                      </label>
                      <button type="button" class="btn-secondary btn-sm" onclick="takeDCPhoto()">ğŸ“¸ Tomar Foto</button>
                      <button type="button" class="btn-secondary btn-sm" style="color:#ef4444;" onclick="removeDCPhoto()">ğŸ—‘ï¸ Quitar</button>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Nombre Completo</label><input type="text" id="dcName" placeholder="Nombre del coordinador"></div>
                  <div class="form-group"><label>Puesto / Cargo</label><input type="text" id="dcRole" placeholder="Ej: Coordinador de Despacho, Gerente de Oficina"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="dcPhone" placeholder="(555) 123-4567"></div>
                  <div class="form-group"><label>Email</label><input type="email" id="dcEmail" placeholder="dispatch@empresa.com"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Licencia / CertificaciÃ³n</label><input type="text" id="dcLicense" placeholder="Ej: C-10 #1234567"></div>
                  <div class="form-group"><label>Turno / Horario</label>
                    <select id="dcShift">
                      <option value="Tiempo Completo 7am-5pm">Tiempo Completo 7am-5pm</option>
                      <option value="MaÃ±ana 6am-2pm">MaÃ±ana 6am-2pm</option>
                      <option value="Tarde 2pm-10pm">Tarde 2pm-10pm</option>
                      <option value="Noche 10pm-6am">Noche 10pm-6am</option>
                      <option value="Guardia 24/7">Guardia 24/7</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Notas / Responsabilidades</label><textarea id="dcNotes" rows="2" placeholder="Responsabilidades principales, zona de cobertura, etc."></textarea></div>
                </div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveDispatchCoord()">ğŸ’¾ Guardar</button>
                  <button class="btn-secondary btn-sm" onclick="toggleDispatchCoord()">Cancelar</button>
                </div>
              </div>
            </div>

            <div class="dispatch-panels">
              <div class="card">
                <div class="card-top"><h3>ğŸ‘· TÃ©cnicos</h3><button class="btn-primary btn-sm" onclick="showTechForm()">+ Agregar TÃ©cnico</button></div>
                <div id="techFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="techForm" onsubmit="handleTechCreate(event)">
                    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
                      <!-- Photo Upload -->
                      <div style="text-align:center;min-width:120px;">
                        <div id="techPhotoPreview" style="width:110px;height:130px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:6px;background:var(--bg-input);cursor:pointer;" onclick="document.getElementById('techPhotoInput').click()">
                          <span style="font-size:11px;color:var(--text-muted);text-align:center;">ğŸ“· Foto del<br>TÃ©cnico</span>
                        </div>
                        <input type="file" id="techPhotoInput" accept="image/*" style="display:none" onchange="previewTechPhoto(this)">
                        <button type="button" class="btn-secondary btn-sm" style="font-size:10px;padding:2px 8px;" onclick="document.getElementById('techPhotoInput').click()">ğŸ“¤ Subir Foto</button>
                      </div>
                      <!-- Info Fields -->
                      <div style="flex:1;min-width:280px;">
                        <div class="form-row">
                          <div class="form-group"><label>Nombre</label><input type="text" id="techName" required placeholder="Nombre completo"></div>
                          <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="techPhone" placeholder="TelÃ©fono"></div>
                        </div>
                        <div class="form-row">
                          <div class="form-group"><label>Email</label><input type="email" id="techEmail" placeholder="Email"></div>
                          <div class="form-group">
                            <label>Especialidad</label>
                            <select id="techSpecialty">
                              <option value="HVAC">HVAC</option>
                              <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                              <option value="ElÃ©ctrico">ElÃ©ctrico</option>
                              <option value="PlomerÃ­a">PlomerÃ­a</option>
                              <option value="General">General</option>
                            </select>
                          </div>
                        </div>
                        <h5 style="color:var(--primary);margin:8px 0 4px;font-size:12px;">ğŸš VehÃ­culo Asignado / Assigned Vehicle</h5>
                        <div class="form-row">
                          <div class="form-group"><label>VehÃ­culo</label><input type="text" id="techVehicle" placeholder="Ej: 2022 Ford Transit"></div>
                          <div class="form-group"><label>Placas / License Plate</label><input type="text" id="techPlate" placeholder="Ej: ABC1234"></div>
                        </div>
                        <div class="form-row">
                          <div class="form-group"><label>VIN #</label><input type="text" id="techVin" placeholder="Vehicle ID Number"></div>
                          <div class="form-group"><label>Color</label><input type="text" id="techVehicleColor" placeholder="Ej: Blanco"></div>
                        </div>
                      </div>
                    </div>
                    <div class="form-actions" style="margin-top:10px;">
                      <button type="submit" class="btn-primary btn-sm">Guardar</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideTechForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="techniciansList"></div>
              </div>
              <div class="card">
                <div class="card-top"><h3>ğŸ“‹ Trabajos Pendientes</h3><button class="btn-primary btn-sm" onclick="showJobForm()">+ Nuevo Trabajo</button></div>
                <div id="jobFormContainer" style="display:none; margin-bottom:16px;">
                  <form id="jobForm" onsubmit="handleJobCreate(event)">
                    <div class="form-group"><label>TÃ­tulo</label><input type="text" id="jobTitle" required placeholder="DescripciÃ³n del trabajo"></div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Tipo de Servicio</label>
                        <select id="jobServiceType">
                          <option value="InstalaciÃ³n">InstalaciÃ³n</option>
                          <option value="ReparaciÃ³n">ReparaciÃ³n</option>
                          <option value="Mantenimiento">Mantenimiento</option>
                          <option value="Emergencia">Emergencia</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Prioridad</label>
                        <select id="jobPriority">
                          <option value="normal">Normal</option>
                          <option value="high">Alta</option>
                          <option value="urgent">Urgente</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="jobAddress" required placeholder="DirecciÃ³n del trabajo"><input type="hidden" id="jobLat"><input type="hidden" id="jobLng"></div>
                    <div class="form-row">
                      <div class="form-group"><label>Fecha</label><input type="date" id="jobDate"></div>
                      <div class="form-group">
                        <label>Asignar TÃ©cnico</label>
                        <select id="jobTechId"><option value="">Sin asignar</option></select>
                      </div>
                    </div>
                    <div class="form-group"><label>Notas</label><textarea id="jobNotes" rows="2" placeholder="Notas"></textarea></div>
                    <div class="form-actions">
                      <button type="submit" class="btn-primary btn-sm">Crear Trabajo</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideJobForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div id="jobsList"></div>
              </div>
            </div>
            <div class="card">
              <div class="card-top">
                <h3>ğŸ—ºï¸ Mapa de Despacho en Tiempo Real</h3>
                <div class="dispatch-legend">
                  <span class="legend-item"><span style="color:#3b82f6;">ğŸš</span> Disponible</span>
                  <span class="legend-item"><span style="color:#f59e0b;">ğŸš</span> Ocupado</span>
                  <span class="legend-item"><span style="color:#8b5cf6;">ğŸš</span> En Ruta</span>
                  <span class="legend-item"><span class="legend-dot job-dot"></span> Trabajos</span>
                  <span class="legend-item"><span class="legend-dot client-dot"></span> Clientes</span>
                </div>
              </div>
              <div id="dispatchMap" style="width:100%;height:500px;border-radius:8px;"></div>
            </div>
          </div>

          <!-- ===== TÃ‰CNICOS ===== -->
          <div id="technicians-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ‘· GestiÃ³n de TÃ©cnicos</h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showTechFormInTechSection()">+ Agregar TÃ©cnico</button>
                  <button class="btn-secondary btn-sm" onclick="showSection('dispatch')">ğŸ¯ Ir a Despacho</button>
                </div>
              </div>

              <!-- Tech Form (same as dispatch but works here too) -->
              <div id="techFormContainerAlt" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ‘· Nuevo TÃ©cnico</h4>
                <form onsubmit="handleTechCreateAlt(event)">
                  <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
                    <div style="text-align:center;min-width:120px;">
                      <div id="techPhotoPreviewAlt" style="width:110px;height:130px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:6px;background:var(--bg-card);cursor:pointer;" onclick="document.getElementById('techPhotoInputAlt').click()">
                        <span style="font-size:11px;color:var(--text-muted);text-align:center;">ğŸ“· Foto del<br>TÃ©cnico</span>
                      </div>
                      <input type="file" id="techPhotoInputAlt" accept="image/*" style="display:none" onchange="previewTechPhotoAlt(this)">
                      <button type="button" class="btn-secondary btn-sm" style="font-size:10px;padding:2px 8px;" onclick="document.getElementById('techPhotoInputAlt').click()">ğŸ“¤ Subir Foto</button>
                    </div>
                    <div style="flex:1;min-width:280px;">
                      <div class="form-row">
                        <div class="form-group"><label>Nombre Completo</label><input type="text" id="techNameAlt" required placeholder="Ej: Juan PÃ©rez"></div>
                        <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="techPhoneAlt" placeholder="(555) 123-4567"></div>
                      </div>
                      <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="techEmailAlt" placeholder="tecnico@email.com" required></div>
                        <div class="form-group"><label>Especialidad</label>
                          <select id="techSpecialtyAlt">
                            <option value="HVAC">HVAC</option>
                            <option value="RefrigeraciÃ³n">RefrigeraciÃ³n</option>
                            <option value="ElÃ©ctrico">ElÃ©ctrico</option>
                            <option value="PlomerÃ­a">PlomerÃ­a</option>
                            <option value="General">General</option>
                          </select>
                        </div>
                      </div>
                      
                      <!-- ACCESO AL CRM -->
                      <div style="margin:12px 0;padding:12px;background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#1e3a5f;">
                          <input type="checkbox" id="techCreateLoginAlt" checked style="width:18px;height:18px;">
                          ğŸ“± Crear acceso al CRM (para que entre desde su celular)
                        </label>
                        <div id="techLoginFieldsAlt" style="margin-top:10px;">
                          <div class="form-row">
                            <div class="form-group"><label>ContraseÃ±a para entrar al CRM</label><input type="password" id="techPasswordAlt" placeholder="MÃ­nimo 6 caracteres" minlength="6"></div>
                            <div class="form-group"><label>Confirmar ContraseÃ±a</label><input type="password" id="techPasswordConfirmAlt" placeholder="Repetir contraseÃ±a"></div>
                          </div>
                          <p style="font-size:11px;color:#64748b;margin:4px 0 0 0;">ğŸ“§ El tÃ©cnico usarÃ¡ su <strong>email</strong> y esta <strong>contraseÃ±a</strong> para entrar al CRM desde su celular.</p>
                        </div>
                      </div>
                      <h5 style="color:var(--primary);margin:8px 0 4px;font-size:12px;">ğŸš VehÃ­culo Asignado</h5>
                      <div class="form-row">
                        <div class="form-group"><label>VehÃ­culo</label><input type="text" id="techVehicleAlt" placeholder="Ej: 2022 Ford Transit"></div>
                        <div class="form-group"><label>Placas</label><input type="text" id="techPlateAlt" placeholder="Ej: ABC1234"></div>
                      </div>
                      <div class="form-row">
                        <div class="form-group"><label>VIN #</label><input type="text" id="techVinAlt" placeholder="NÃºmero de identificaciÃ³n del vehÃ­culo"></div>
                        <div class="form-group"><label>Color</label><input type="text" id="techVehicleColorAlt" placeholder="Ej: Blanco"></div>
                      </div>
                    </div>
                  </div>
                  <div class="form-actions" style="margin-top:10px;">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar TÃ©cnico</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideTechFormAlt()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Technicians List with cards -->
              <div id="techniciansFullList"></div>
            </div>

            <!-- Technician Credentials -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“œ Credenciales de TÃ©cnicos</h3>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube las credenciales y certificaciones de cada tÃ©cnico. Estos documentos se pueden incluir en estimados y facturas para cumplir con requisitos de empresas y clientes comerciales.</p>
              
              <div class="form-group" style="max-width:300px;margin-bottom:16px;">
                <label>Seleccionar TÃ©cnico</label>
                <select id="techCredSelect" onchange="loadTechCredentials()">
                  <option value="">-- Seleccionar TÃ©cnico --</option>
                </select>
              </div>

              <div id="techCredArea" style="display:none;">

                <!-- Tech Profile Card with Photo -->
                <div id="techProfileCard" style="display:flex;gap:16px;align-items:flex-start;padding:16px;background:var(--bg-input);border:2px solid var(--primary);border-radius:12px;margin-bottom:16px;flex-wrap:wrap;">
                  <div style="text-align:center;">
                    <div id="techCredPhoto" style="width:120px;height:150px;border:2px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:white;">
                      <span style="font-size:40px;">ğŸ‘¤</span>
                    </div>
                    <label class="btn-secondary btn-sm doc-upload-btn" style="margin-top:6px;font-size:10px;">
                      ğŸ“· Actualizar Foto
                      <input type="file" accept="image/*" style="display:none" onchange="uploadTechPhoto(this)">
                    </label>
                  </div>
                  <div style="flex:1;min-width:200px;">
                    <h4 id="techCredName" style="color:var(--primary);margin-bottom:4px;">â€”</h4>
                    <p id="techCredSpecialty" style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">â€”</p>
                    <div id="techCredVehicleInfo" style="font-size:12px;line-height:1.8;"></div>
                    <div style="margin-top:8px;">
                      <h5 style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Editar VehÃ­culo:</h5>
                      <div class="form-row" style="gap:6px;">
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVehicle" placeholder="2022 Ford Transit" style="font-size:11px;padding:4px 8px;"></div>
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcPlate" placeholder="Placas: ABC1234" style="font-size:11px;padding:4px 8px;"></div>
                      </div>
                      <div class="form-row" style="gap:6px;">
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVin" placeholder="VIN #" style="font-size:11px;padding:4px 8px;"></div>
                        <div class="form-group" style="margin-bottom:4px;"><input type="text" id="tcVehicleColor" placeholder="Color" style="font-size:11px;padding:4px 8px;"></div>
                      </div>
                    </div>
                  </div>
                  <div style="text-align:center;">
                    <button class="btn-primary btn-sm" onclick="generateTechIDCard()" style="font-size:11px;">ğŸªª Generar ID Card</button>
                    <p style="font-size:9px;color:var(--text-muted);margin-top:4px;">IdentificaciÃ³n para<br>portar en todo momento</p>
                  </div>
                </div>

                <h5 style="color:var(--primary);margin-bottom:8px;font-size:13px;">ğŸ“œ Certificaciones y Licencias</h5>
                <div id="techCredGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px;">
                  
                  <!-- Driver's License -->
                  <div class="doc-upload-card" id="tcCard_drivers_license">
                    <div class="doc-icon">ğŸªª</div>
                    <div class="doc-info"><strong>Licencia de Manejar</strong><small>Driver's License</small></div>
                    <div class="doc-status" id="tcStatus_drivers_license"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('drivers_license',this)"></label>
                      <button onclick="viewTechCred('drivers_license')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_drivers_license">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('drivers_license')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_drivers_license">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_drivers_license" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                  <!-- EPA 608 -->
                  <div class="doc-upload-card" id="tcCard_epa_608">
                    <div class="doc-icon">ğŸŒ¿</div>
                    <div class="doc-info"><strong>EPA Section 608</strong><small>Refrigerant Certification</small></div>
                    <div class="doc-status" id="tcStatus_epa_608"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('epa_608',this)"></label>
                      <button onclick="viewTechCred('epa_608')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_epa_608">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('epa_608')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_epa_608">âœ•</button>
                    </div>
                  </div>

                  <!-- NATE -->
                  <div class="doc-upload-card" id="tcCard_nate">
                    <div class="doc-icon">ğŸ†</div>
                    <div class="doc-info"><strong>NATE Certification</strong><small>North American Technician Excellence</small></div>
                    <div class="doc-status" id="tcStatus_nate"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('nate',this)"></label>
                      <button onclick="viewTechCred('nate')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_nate">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('nate')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_nate">âœ•</button>
                    </div>
                  </div>

                  <!-- OSHA -->
                  <div class="doc-upload-card" id="tcCard_osha">
                    <div class="doc-icon">â›‘ï¸</div>
                    <div class="doc-info"><strong>OSHA 10/30</strong><small>Safety Certification</small></div>
                    <div class="doc-status" id="tcStatus_osha"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('osha',this)"></label>
                      <button onclick="viewTechCred('osha')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_osha">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('osha')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_osha">âœ•</button>
                    </div>
                  </div>

                  <!-- HVAC Excellence -->
                  <div class="doc-upload-card" id="tcCard_hvac_excellence">
                    <div class="doc-icon">â„ï¸</div>
                    <div class="doc-info"><strong>HVAC Excellence</strong><small>Professional Certification</small></div>
                    <div class="doc-status" id="tcStatus_hvac_excellence"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('hvac_excellence',this)"></label>
                      <button onclick="viewTechCred('hvac_excellence')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_hvac_excellence">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('hvac_excellence')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_hvac_excellence">âœ•</button>
                    </div>
                  </div>

                  <!-- School / Trade School Certificate -->
                  <div class="doc-upload-card" id="tcCard_school_cert">
                    <div class="doc-icon">ğŸ“</div>
                    <div class="doc-info"><strong>Certificado Escolar</strong><small>Trade School / College Certificate</small></div>
                    <div class="doc-status" id="tcStatus_school_cert"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('school_cert',this)"></label>
                      <button onclick="viewTechCred('school_cert')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_school_cert">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('school_cert')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_school_cert">âœ•</button>
                    </div>
                  </div>

                  <!-- NCCER -->
                  <div class="doc-upload-card" id="tcCard_nccer">
                    <div class="doc-icon">ğŸ”§</div>
                    <div class="doc-info"><strong>NCCER</strong><small>National Center for Construction Ed</small></div>
                    <div class="doc-status" id="tcStatus_nccer"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('nccer',this)"></label>
                      <button onclick="viewTechCred('nccer')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_nccer">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('nccer')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_nccer">âœ•</button>
                    </div>
                  </div>

                  <!-- Other Cert -->
                  <div class="doc-upload-card" id="tcCard_other_cert">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info"><strong>Otro Certificado</strong><small>Other Certification</small></div>
                    <div class="doc-status" id="tcStatus_other_cert"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('other_cert',this)"></label>
                      <button onclick="viewTechCred('other_cert')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_other_cert">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('other_cert')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_other_cert">âœ•</button>
                    </div>
                  </div>

                </div>

                <h5 style="color:var(--accent);margin:16px 0 8px;font-size:13px;">ğŸš Documentos del VehÃ­culo / Vehicle Documents</h5>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px;">

                  <!-- Vehicle Registration -->
                  <div class="doc-upload-card" id="tcCard_vehicle_reg">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info"><strong>RegistraciÃ³n del VehÃ­culo</strong><small>Vehicle Registration</small></div>
                    <div class="doc-status" id="tcStatus_vehicle_reg"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('vehicle_reg',this)"></label>
                      <button onclick="viewTechCred('vehicle_reg')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_vehicle_reg">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('vehicle_reg')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_vehicle_reg">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_vehicle_reg" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                  <!-- Commercial Vehicle Insurance -->
                  <div class="doc-upload-card" id="tcCard_vehicle_insurance">
                    <div class="doc-icon">ğŸ›¡ï¸</div>
                    <div class="doc-info"><strong>Seguro Comercial del VehÃ­culo</strong><small>Commercial Auto Insurance</small></div>
                    <div class="doc-status" id="tcStatus_vehicle_insurance"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadTechCred('vehicle_insurance',this)"></label>
                      <button onclick="viewTechCred('vehicle_insurance')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="tcView_vehicle_insurance">ğŸ‘ï¸</button>
                      <button onclick="removeTechCred('vehicle_insurance')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="tcRemove_vehicle_insurance">âœ•</button>
                    </div>
                    <div class="doc-expiry"><label style="font-size:10px;color:var(--text-muted);">Vence:</label><input type="date" id="tcExpiry_vehicle_insurance" onchange="saveTechCredentials()" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;"></div>
                  </div>

                </div>

                <button class="btn-primary btn-sm" onclick="saveTechCredentials()" style="margin-top:8px;">ğŸ’¾ Guardar Credenciales</button>
              </div>
            </div>

            <div class="card">
              <h3>ğŸ“± Link de Tracking para TÃ©cnicos</h3>
              <p style="color:var(--text-light);font-size:14px;margin-bottom:12px;">Comparte este link con tus tÃ©cnicos para que reporten su ubicaciÃ³n en tiempo real desde su celular:</p>
              <div id="trackingLinkContainer" class="tracking-link-box"></div>
            </div>
          </div>

          <!-- ===== OTHER SECTIONS ===== -->
          <!-- ===== CLIENTS ===== -->
          <div id="clients-section" class="section">
            <!-- Client List View -->
            <div id="clientListView" class="card">
              <div class="card-top">
                <h3>ğŸ‘¥ Clientes <span id="clientCount" style="font-size:13px;color:var(--text-muted);font-weight:400;"></span></h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="text" id="clientSearchInput" placeholder="ğŸ” Buscar cliente..." oninput="renderClientsList()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;width:200px;">
                  <select id="clientFilterTag" onchange="renderClientsList()" style="padding:8px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                    <option value="">Todos</option>
                    <option value="Residencial">ğŸ  Residencial</option>
                    <option value="Comercial">ğŸ¢ Comercial</option>
                    <option value="Industrial">ğŸ­ Industrial</option>
                    <option value="VIP">â­ VIP</option>
                    <option value="Plan de Servicio">ğŸ›¡ï¸ Plan de Servicio</option>
                  </select>
                  <button class="btn-secondary btn-sm" onclick="exportClientsCSV()" title="Exportar">ğŸ“¥ Exportar</button>
                  <button class="btn-primary btn-sm" onclick="showImportCenter()" style="background:#f59e0b;border-color:#f59e0b;">ğŸ“¤ Importar de HCP</button>
                  <label class="btn-secondary btn-sm" style="cursor:pointer;" title="Importar CSV genÃ©rico">ğŸ“„ CSV
                    <input type="file" accept=".csv" onchange="importClientsCSV(this)" style="display:none;">
                  </label>
                  <button class="btn-primary btn-sm" onclick="showClientForm()">+ Nuevo Cliente</button>
                </div>
              </div>

              <!-- ===== HCP IMPORT CENTER ===== -->
              <div id="importCenterContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:2px solid #f59e0b;border-radius:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                  <h4 style="color:#f59e0b;margin:0;">ğŸ“¤ Centro de ImportaciÃ³n â€” Housecall Pro</h4>
                  <button onclick="hideImportCenter()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted);">âœ•</button>
                </div>

                <!-- Step 1: Instructions -->
                <div class="import-instructions" style="margin-bottom:16px;padding:14px;background:var(--bg-card);border-radius:8px;border-left:4px solid #3b82f6;">
                  <h5 style="margin-bottom:8px;color:var(--primary);">ğŸ“‹ CÃ³mo exportar de Housecall Pro:</h5>
                  <ol style="font-size:12px;color:var(--text-muted);padding-left:20px;margin:0;line-height:1.8;">
                    <li>Abre <strong>Housecall Pro</strong> â†’ ve a <strong>Customers</strong></li>
                    <li>Click en <strong>Export</strong> (esquina superior derecha)</li>
                    <li>Selecciona <strong>All Customers</strong> o filtra por tipo</li>
                    <li>Descarga el archivo <strong>.CSV</strong></li>
                    <li>Sube el archivo aquÃ­ abajo ğŸ‘‡</li>
                  </ol>
                </div>

                <!-- Step 2: Category Tabs -->
                <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                  <button class="import-tab active" id="importTabAll" onclick="setImportTab('all')">ğŸ“‹ Todos</button>
                  <button class="import-tab" id="importTabWon" onclick="setImportTab('won')">ğŸ† Clientes Ganados</button>
                  <button class="import-tab" id="importTabEstimate" onclick="setImportTab('estimate')">ğŸ“ En Estimado</button>
                  <button class="import-tab" id="importTabExisting" onclick="setImportTab('existing')">ğŸ‘¥ Existentes</button>
                </div>

                <!-- File Upload -->
                <div class="import-upload-zone" id="importDropZone" style="margin-bottom:16px;">
                  <div style="text-align:center;padding:30px;">
                    <span style="font-size:40px;">ğŸ“</span>
                    <p style="font-size:14px;font-weight:600;color:var(--text-primary);margin:8px 0 4px;">Arrastra tu archivo CSV aquÃ­</p>
                    <p style="font-size:12px;color:var(--text-muted);">o haz clic para seleccionar</p>
                    <label class="btn-primary btn-sm" style="cursor:pointer;margin-top:8px;display:inline-block;">
                      Seleccionar Archivo
                      <input type="file" accept=".csv,.txt" onchange="handleImportFile(this)" style="display:none;" id="importFileInput">
                    </label>
                  </div>
                </div>

                <!-- OR Manual Paste -->
                <div style="margin-bottom:12px;">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="flex:1;height:1px;background:var(--border);"></span>
                    <span style="font-size:11px;color:var(--text-muted);font-weight:600;">O PEGA LOS DATOS MANUALMENTE</span>
                    <span style="flex:1;height:1px;background:var(--border);"></span>
                  </div>
                  <p style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Pega datos de Excel, Google Sheets, o texto separado por comas. Formato: <strong>Nombre, TelÃ©fono, Email, DirecciÃ³n</strong> (uno por lÃ­nea)</p>
                  <textarea id="importManualData" rows="6" placeholder="John Smith, (555) 123-4567, john@email.com, 123 Main St&#10;MarÃ­a GarcÃ­a, (555) 987-6543, maria@email.com, 456 Oak Ave&#10;Bob Johnson, (555) 456-7890, , 789 Pine Rd" style="width:100%;padding:10px;font-size:12px;font-family:monospace;border:1px solid var(--border);border-radius:6px;resize:vertical;"></textarea>
                </div>

                <!-- Import Options -->
                <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">CategorÃ­a de ImportaciÃ³n</label>
                    <select id="importCategory" style="padding:8px;font-size:12px;">
                      <option value="won">ğŸ† Cliente Ganado (Won)</option>
                      <option value="estimate">ğŸ“ En Estimado</option>
                      <option value="existing">ğŸ‘¥ Cliente Existente</option>
                      <option value="lead">ğŸ¯ Lead / Prospecto</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">Tipo de Propiedad</label>
                    <select id="importPropertyType" style="padding:8px;font-size:12px;">
                      <option value="Residencial">ğŸ  Residencial</option>
                      <option value="Comercial">ğŸ¢ Comercial</option>
                      <option value="Industrial">ğŸ­ Industrial</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin:0;min-width:150px;">
                    <label style="font-size:11px;margin-bottom:4px;">Fuente / Source</label>
                    <select id="importSource" style="padding:8px;font-size:12px;">
                      <option value="housecall_pro">Housecall Pro</option>
                      <option value="service_titan">ServiceTitan</option>
                      <option value="jobber">Jobber</option>
                      <option value="excel">Excel / Spreadsheet</option>
                      <option value="other">Otro</option>
                    </select>
                  </div>
                  <div style="display:flex;align-items:center;gap:6px;margin-top:16px;">
                    <input type="checkbox" id="importSkipDuplicates" checked>
                    <label style="font-size:11px;">Omitir duplicados</label>
                  </div>
                </div>

                <!-- Preview Area -->
                <div id="importPreviewArea" style="display:none;margin-bottom:12px;max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;"></div>

                <!-- Import Status -->
                <div id="importStatusArea" style="display:none;margin-bottom:12px;padding:12px;border-radius:8px;font-size:13px;"></div>

                <!-- Actions -->
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="executeImport()" id="importExecuteBtn" disabled>ğŸ“¥ Importar Clientes</button>
                  <button class="btn-secondary btn-sm" onclick="previewImport()">ğŸ‘ï¸ Vista Previa</button>
                  <button class="btn-secondary btn-sm" onclick="hideImportCenter()">Cancelar</button>
                </div>
              </div>

              <!-- Client Form -->
              <div id="clientFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);" id="clientFormTitle">ğŸ‘¥ Nuevo Cliente</h4>
                <form id="clientForm" onsubmit="handleClientCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="clientName" required placeholder="Nombre completo"></div>
                    <div class="form-group"><label>Empresa</label><input type="text" id="clientCompany" placeholder="Nombre de empresa (opcional)"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="clientPhone" placeholder="(555) 123-4567"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="clientEmail" placeholder="email@cliente.com"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Tipo de Propiedad</label>
                      <select id="clientPropertyType">
                        <option value="Residencial">ğŸ  Residencial</option>
                        <option value="Comercial">ğŸ¢ Comercial</option>
                        <option value="Industrial">ğŸ­ Industrial</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Tags / Etiquetas</label>
                      <select id="clientTags" multiple style="height:60px;">
                        <option value="VIP">â­ VIP</option>
                        <option value="Plan de Servicio">ğŸ›¡ï¸ Plan de Servicio</option>
                        <option value="ConstrucciÃ³n Nueva">ğŸ—ï¸ ConstrucciÃ³n Nueva</option>
                        <option value="Referido">ğŸ¤ Referido</option>
                        <option value="GarantÃ­a">ğŸ”§ GarantÃ­a</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="clientAddress" placeholder="DirecciÃ³n completa"></div>
                  <div class="form-group"><label>Notas</label><textarea id="clientNotes" rows="2" placeholder="Notas sobre el cliente..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm" id="clientSubmitBtn">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideClientForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <div id="clientsList"></div>
            </div>

            <!-- Client Profile View (hidden by default) -->
            <div id="clientProfileView" style="display:none;">
              <div class="card" style="margin-bottom:0;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  <button class="btn-secondary btn-sm" onclick="closeClientProfile()">â† Regresar</button>
                  <span style="color:var(--text-muted);font-size:12px;">Clientes &gt;</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                  <div>
                    <h2 id="cpName" style="font-size:24px;color:var(--text-primary);margin-bottom:4px;">â€”</h2>
                    <div id="cpCompany" style="font-size:13px;color:var(--text-muted);margin-bottom:6px;"></div>
                    <div id="cpTags" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('job')">+ Trabajo</button>
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('estimate')">+ Estimado</button>
                    <button class="btn-primary btn-sm" onclick="cpQuickAction('appointment')">+ Cita</button>
                    <button class="btn-secondary btn-sm" onclick="showClientForm(currentProfileClientId)">âœï¸ Editar</button>
                  </div>
                </div>
                <div id="cpContact" style="font-size:13px;margin-top:10px;line-height:1.8;"></div>

                <!-- Client Tabs -->
                <div class="cp-tabs" style="margin-top:16px;">
                  <button class="cp-tab active" onclick="switchClientTab('profile')">ğŸ“‹ Perfil</button>
                  <button class="cp-tab" onclick="switchClientTab('jobs')">ğŸ”§ Trabajos</button>
                  <button class="cp-tab" onclick="switchClientTab('estimates')">ğŸ’° Estimados</button>
                  <button class="cp-tab" onclick="switchClientTab('invoices')">ğŸ“„ Facturas</button>
                  <button class="cp-tab" onclick="switchClientTab('notes')">ğŸ“ Notas</button>
                  <button class="cp-tab" onclick="switchClientTab('attachments')">ğŸ“ Archivos</button>
                  <button class="cp-tab" onclick="switchClientTab('comms')">ğŸ’¬ ComunicaciÃ³n</button>
                </div>
              </div>

              <!-- Tab Contents -->
              <div class="card" style="margin-top:2px;border-top-left-radius:0;border-top-right-radius:0;">
                <div id="cpTabProfile" class="cp-tab-content active">
                  <div class="cards-row">
                    <div>
                      <h4 style="color:var(--primary);margin-bottom:8px;">ğŸ“Š Resumen del Cliente</h4>
                      <div id="cpStats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;"></div>
                    </div>
                    <div>
                      <h4 style="color:var(--primary);margin-bottom:8px;">ğŸ“ UbicaciÃ³n</h4>
                      <div id="cpAddress" style="font-size:13px;color:var(--text-muted);"></div>
                      <div id="cpPropertyType" style="font-size:12px;margin-top:4px;"></div>
                    </div>
                  </div>
                  <div style="margin-top:16px;">
                    <h4 style="color:var(--primary);margin-bottom:8px;">â±ï¸ Historial Reciente</h4>
                    <div id="cpTimeline" style="font-size:12px;"></div>
                  </div>
                </div>
                <div id="cpTabJobs" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ”§ Trabajos de este cliente</h4>
                  <div id="cpJobsList"></div>
                </div>
                <div id="cpTabEstimates" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’° Estimados de este cliente</h4>
                  <div id="cpEstimatesList"></div>
                </div>
                <div id="cpTabInvoices" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Facturas de este cliente</h4>
                  <div id="cpInvoicesList"></div>
                </div>
                <div id="cpTabNotes" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Notas Internas</h4>
                  <div style="margin-bottom:12px;">
                    <textarea id="cpNewNote" rows="2" placeholder="Agregar nota..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;"></textarea>
                    <button class="btn-primary btn-sm" onclick="addClientNote()" style="margin-top:6px;">ğŸ’¾ Guardar Nota</button>
                  </div>
                  <div id="cpNotesList"></div>
                </div>
                <div id="cpTabAttachments" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“ Archivos Adjuntos</h4>
                  <div style="margin-bottom:12px;">
                    <label class="btn-secondary btn-sm" style="cursor:pointer;">
                      ğŸ“¤ Subir Archivo
                      <input type="file" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="uploadClientAttachment(this)">
                    </label>
                    <span style="font-size:10px;color:var(--text-muted);margin-left:8px;">PDF, JPG, PNG, DOC (mÃ¡x 5MB)</span>
                  </div>
                  <div id="cpAttachmentsList"></div>
                </div>
                <div id="cpTabComms" class="cp-tab-content" style="display:none;">
                  <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’¬ Registro de ComunicaciÃ³n</h4>
                  <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
                    <select id="cpCommType" style="padding:6px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="call_out">ğŸ“± Llamada Saliente</option>
                      <option value="call_in">ğŸ“² Llamada Entrante</option>
                      <option value="text">ğŸ’¬ Texto/SMS</option>
                      <option value="email">ğŸ“§ Email</option>
                      <option value="visit">ğŸ  Visita</option>
                      <option value="follow_up">ğŸ”„ Follow-Up</option>
                    </select>
                    <input type="text" id="cpCommNote" placeholder="DescripciÃ³n..." style="flex:1;min-width:200px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;">
                    <button class="btn-primary btn-sm" onclick="addClientComm()">+ Registrar</button>
                  </div>
                  <div id="cpCommsList"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="jobs-section" class="section">
            <div class="card">
              <div class="card-top"><h3>ğŸ’° Crear Estimado / PresentaciÃ³n</h3></div>
              <div id="estimateBuilder">
                <!-- Step 1: Select Job -->
                <div class="estimate-step">
                  <h4>1. Seleccionar Trabajo</h4>
                  <select id="estJobSelect" class="form-select" onchange="loadEstimateJob()">
                    <option value="">Seleccionar trabajo...</option>
                  </select>
                  <div id="estJobInfo" style="display:none;" class="est-job-info"></div>
                </div>

                <!-- Step 2: Equipment Info -->
                <div class="estimate-step">
                  <h4>2. InformaciÃ³n del Equipo</h4>
                  <div class="equip-grid">
                    <button class="equip-btn" onclick="selectEquipType('ac_single')">â„ï¸<br>AC Single Stage</button>
                    <button class="equip-btn" onclick="selectEquipType('heat_pump')">ğŸ”„<br>Heat Pump Single Stage</button>
                    <button class="equip-btn" onclick="selectEquipType('furnace_80')">ğŸ”¥<br>Furnace 80% AFUE<br><small>Cat I - Induced Draft</small></button>
                    <button class="equip-btn" onclick="selectEquipType('furnace_90')">ğŸ”¥<br>Furnace 90%+ AFUE<br><small>Cat IV - Condensing</small></button>
                    <button class="equip-btn" onclick="selectEquipType('mini_split')">ğŸŒ¬ï¸<br>Mini Split</button>
                    <button class="equip-btn" onclick="selectEquipType('package_unit')">ğŸ“¦<br>Package Unit</button>
                  </div>
                  <div class="equip-details" style="margin-top:16px;">
                    <div class="form-row">
                      <div class="form-group"><label>Modelo #</label><input type="text" id="estModelNum" placeholder="Ej: GSX140361"></div>
                      <div class="form-group"><label>Serial #</label><input type="text" id="estSerialNum" placeholder="Ej: 1234567890"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Marca</label>
                        <select id="estBrand"><option value="">Seleccionar...</option><option>Goodman</option><option>Carrier</option><option>Trane</option><option>Lennox</option><option>Rheem</option><option>Ruud</option><option>York</option><option>Bryant</option><option>Amana</option><option>Daikin</option><option>Mitsubishi</option><option>Fujitsu</option><option>Bosch</option><option>American Standard</option><option>Otra</option></select>
                      </div>
                      <div class="form-group"><label>Edad Aprox (aÃ±os)</label><input type="number" id="estEquipAge" placeholder="Ej: 15" min="0" max="50"></div>
                    </div>
                    <div class="form-group">
                      <label>ğŸ“· Fotos del Equipo (modelo, serial, data plate, condiciÃ³n)</label>
                      <input type="file" id="estPhotos" multiple accept="image/*" onchange="handleEquipPhotos(event)">
                      <div id="photoPreviewGrid" class="photo-grid"></div>
                    </div>
                    <div id="equipAgeWarning" style="display:none;" class="age-warning">
                      âš ï¸ Equipo con mÃ¡s de 15 aÃ±os â€” considerar reemplazo
                      <button class="btn-warning-sm" onclick="referToAdvisor()">ğŸ  Referir a Home Advisor para Reemplazo</button>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Service Call Fee -->
                <div class="estimate-step">
                  <h4>3. Llamada de Servicio (Service Call)</h4>
                  <p style="color:var(--text-muted);font-size:12px;margin-bottom:10px;">âš¡ La llamada de servicio SIEMPRE se cobra â€” si el cliente decide hacer el trabajo, se cobra ADICIONAL a labor + partes.</p>
                  <div class="service-call-options">
                    <label class="sc-option" onclick="selectServiceCall(70)">
                      <input type="radio" name="serviceCall" value="70">
                      <div class="sc-card"><span class="sc-price">$70</span><span class="sc-desc">0-10 millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(120)">
                      <input type="radio" name="serviceCall" value="120">
                      <div class="sc-card"><span class="sc-price">$120</span><span class="sc-desc">10-20 millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(200)">
                      <input type="radio" name="serviceCall" value="200">
                      <div class="sc-card"><span class="sc-price">$200</span><span class="sc-desc">20+ millas</span></div>
                    </label>
                    <label class="sc-option" onclick="selectServiceCall(-1)">
                      <input type="radio" name="serviceCall" value="custom">
                      <div class="sc-card"><span class="sc-price">$?</span><span class="sc-desc">Custom</span></div>
                    </label>
                  </div>
                  <div id="customServiceCall" style="display:none;margin-top:8px;">
                    <div class="form-group"><label>Monto personalizado</label><input type="number" id="customSCAmount" placeholder="$" onchange="selectServiceCall(parseFloat(this.value))"></div>
                  </div>
                  <div class="form-row" style="margin-top:12px;">
                    <div class="form-group">
                      <label>Â¿Cliente aprueba el trabajo?</label>
                      <select id="estClientDecision" onchange="handleClientDecision()">
                        <option value="">Pendiente...</option>
                        <option value="yes">âœ… SÃ â€” Hacer reparaciÃ³n</option>
                        <option value="no">âŒ NO â€” Solo cobrar service call</option>
                        <option value="replace">ğŸ”„ Quiere equipo nuevo (referir)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Horas de labor</label>
                      <input type="number" id="estLaborHours" value="1" min="0.5" step="0.5" onchange="updateEstimateTotals()">
                    </div>
                  </div>
                  <div id="advisorReferidoBox" style="display:none;margin-top:12px;">
                    <div class="referral-box">
                      <h5>ğŸ  Referir a Home Advisor</h5>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Seleccionar Advisor</label>
                          <select id="estAdvisorSelect"><option value="">Seleccionar...</option></select>
                        </div>
                        <div class="form-group">
                          <label>Urgencia</label>
                          <select id="referralUrgency">
                            <option value="normal">Normal</option>
                            <option value="urgente">Urgente</option>
                            <option value="programar">Programar visita</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group"><label>Notas para el Advisor</label><textarea id="referralNotes" rows="2" placeholder="Estado del equipo, lo que necesita el cliente..."></textarea></div>
                      <button class="btn-primary btn-sm" onclick="sendReferidoToAdvisor()">ğŸ“© Enviar Referencia al Advisor</button>
                    </div>
                  </div>
                </div>

                <!-- Step 4: Select Components (only if approved) -->
                <div class="estimate-step" id="componentsStep">
                  <h4>4. Componentes y Reparaciones</h4>
                  <div id="componentsList"></div>
                </div>

                <!-- Step 5: Summary -->
                <div class="estimate-step">
                  <h4>5. Resumen del Estimado</h4>
                  <div id="estimateSummary"></div>
                  <div class="form-row" style="margin-top:12px;">
                    <div class="form-group"><label>Descuento (%)</label><input type="number" id="estDiscount" value="0" min="0" max="100" onchange="updateEstimateTotals()"></div>
                    <div class="form-group"><label>Tax (%)</label><input type="number" id="estTax" value="8.75" step="0.25" onchange="updateEstimateTotals()"></div>
                  </div>
                  <div id="estimateTotals" class="est-totals"></div>
                  <div class="form-group" style="margin-top:12px;"><label>Notas para el cliente</label><textarea id="estNotes" rows="3" placeholder="GarantÃ­a, condiciones, recomendaciones..."></textarea></div>
                  <div class="form-actions" style="margin-top:16px;">
                    <button class="btn-primary" onclick="generateEstimatePDF()">ğŸ“„ Generar Estimado PDF</button>
                    <button class="btn-secondary" onclick="presentEstimateToClient()">ğŸ“± Presentar al Cliente</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <h3>ğŸ“‹ Estimados Guardados</h3>
              <div id="savedEstimates"><p class="empty-msg">No hay estimados guardados</p></div>
            </div>

            <!-- Job Permits & Documents -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“‘ Permisos y Documentos del Trabajo / Job Permits</h3>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube los permisos, inspecciones, fotos y documentos de cada trabajo. Todo queda archivado con el expediente del trabajo.</p>
              
              <div class="form-group" style="max-width:400px;margin-bottom:16px;">
                <label>Seleccionar Trabajo</label>
                <select id="jobPermitSelect" onchange="loadJobPermits()">
                  <option value="">-- Seleccionar Trabajo --</option>
                </select>
              </div>

              <div id="jobPermitArea" style="display:none;">
                <div id="jobPermitGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:16px;">

                  <div class="doc-upload-card" id="jpCard_building_permit">
                    <div class="doc-icon">ğŸ—ï¸</div>
                    <div class="doc-info"><strong>Building Permit</strong><small>Permiso de ConstrucciÃ³n</small></div>
                    <div class="doc-status" id="jpStatus_building_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('building_permit',this)"></label>
                      <button onclick="viewJobPermit('building_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_building_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('building_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_building_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_mechanical_permit">
                    <div class="doc-icon">âš™ï¸</div>
                    <div class="doc-info"><strong>Mechanical Permit</strong><small>Permiso MecÃ¡nico</small></div>
                    <div class="doc-status" id="jpStatus_mechanical_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('mechanical_permit',this)"></label>
                      <button onclick="viewJobPermit('mechanical_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_mechanical_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('mechanical_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_mechanical_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_inspection_pass">
                    <div class="doc-icon">âœ…</div>
                    <div class="doc-info"><strong>Inspection Passed</strong><small>InspecciÃ³n Aprobada</small></div>
                    <div class="doc-status" id="jpStatus_inspection_pass"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('inspection_pass',this)"></label>
                      <button onclick="viewJobPermit('inspection_pass')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_inspection_pass">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('inspection_pass')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_inspection_pass">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_before_photos">
                    <div class="doc-icon">ğŸ“¸</div>
                    <div class="doc-info"><strong>Fotos Antes</strong><small>Before Photos</small></div>
                    <div class="doc-status" id="jpStatus_before_photos"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none" onchange="uploadJobPermit('before_photos',this)"></label>
                      <button onclick="viewJobPermit('before_photos')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_before_photos">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('before_photos')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_before_photos">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_after_photos">
                    <div class="doc-icon">ğŸ“¸</div>
                    <div class="doc-info"><strong>Fotos DespuÃ©s</strong><small>After Photos</small></div>
                    <div class="doc-status" id="jpStatus_after_photos"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none" onchange="uploadJobPermit('after_photos',this)"></label>
                      <button onclick="viewJobPermit('after_photos')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_after_photos">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('after_photos')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_after_photos">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_other_permit">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info"><strong>Otro Documento</strong><small>Other Document</small></div>
                    <div class="doc-status" id="jpStatus_other_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('other_permit',this)"></label>
                      <button onclick="viewJobPermit('other_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_other_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('other_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_other_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_electrical_permit">
                    <div class="doc-icon">âš¡</div>
                    <div class="doc-info"><strong>Electrical Permit</strong><small>Permiso ElÃ©ctrico</small></div>
                    <div class="doc-status" id="jpStatus_electrical_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('electrical_permit',this)"></label>
                      <button onclick="viewJobPermit('electrical_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_electrical_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('electrical_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_electrical_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_plumbing_permit">
                    <div class="doc-icon">ğŸ”§</div>
                    <div class="doc-info"><strong>Plumbing Permit</strong><small>Permiso de PlomerÃ­a</small></div>
                    <div class="doc-status" id="jpStatus_plumbing_permit"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('plumbing_permit',this)"></label>
                      <button onclick="viewJobPermit('plumbing_permit')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_plumbing_permit">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('plumbing_permit')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_plumbing_permit">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_city_approval">
                    <div class="doc-icon">ğŸ›ï¸</div>
                    <div class="doc-info"><strong>City Approval</strong><small>AprobaciÃ³n del Municipio</small></div>
                    <div class="doc-status" id="jpStatus_city_approval"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('city_approval',this)"></label>
                      <button onclick="viewJobPermit('city_approval')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_city_approval">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('city_approval')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_city_approval">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_changeout_form">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info"><strong>Changeout Form</strong><small>Formulario de Cambio</small></div>
                    <div class="doc-status" id="jpStatus_changeout_form"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('changeout_form',this)"></label>
                      <button onclick="viewJobPermit('changeout_form')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_changeout_form">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('changeout_form')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_changeout_form">âœ•</button>
                    </div>
                  </div>

                  <div class="doc-upload-card" id="jpCard_load_calc">
                    <div class="doc-icon">ğŸ”¢</div>
                    <div class="doc-info"><strong>Manual J / Load Calc</strong><small>CÃ¡lculo de Carga</small></div>
                    <div class="doc-status" id="jpStatus_load_calc"><span class="doc-badge doc-missing">No subido</span></div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">ğŸ“¤ Subir<input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadJobPermit('load_calc',this)"></label>
                      <button onclick="viewJobPermit('load_calc')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;" id="jpView_load_calc">ğŸ‘ï¸</button>
                      <button onclick="removeJobPermit('load_calc')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px;" id="jpRemove_load_calc">âœ•</button>
                    </div>
                  </div>

                </div>
                <button class="btn-primary btn-sm" onclick="saveJobPermits()">ğŸ’¾ Guardar Permisos</button>
              </div>
            </div>

            <!-- ===== REPORTES DE INSPECCIÃ“N / AUDITORÃA ===== -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“Š Reportes de InspecciÃ³n y AuditorÃ­a</h3>
                <button class="btn-primary btn-sm" onclick="showInspReportForm()">+ Nuevo Reporte</button>
              </div>
              <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Sube HERS Ratings, Home Inspections, Energy Audits y otros reportes de inspecciÃ³n. Se vinculan al trabajo y al cliente.</p>

              <div id="inspReportForm" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“Š Nuevo Reporte de InspecciÃ³n</h4>
                <div class="form-row">
                  <div class="form-group"><label>Tipo de Reporte</label>
                    <select id="irType">
                      <optgroup label="ğŸ  Eficiencia EnergÃ©tica">
                        <option value="hers_rating">ğŸ“Š HERS Rating (Home Energy Rating)</option>
                        <option value="energy_audit">ğŸ”‹ Energy Audit / AuditorÃ­a EnergÃ©tica</option>
                        <option value="title24">ğŸ“ Title 24 Compliance</option>
                        <option value="cf1r">ğŸ“‹ CF-1R (Certificate of Compliance)</option>
                        <option value="cf2r">ğŸ“‹ CF-2R (Certificate of Installation)</option>
                        <option value="cf3r">ğŸ“‹ CF-3R (Certificate of Verification)</option>
                      </optgroup>
                      <optgroup label="ğŸ” Inspecciones de Casa">
                        <option value="home_inspection">ğŸ¡ Home Inspection Completa</option>
                        <option value="hvac_inspection">â„ï¸ HVAC System Inspection</option>
                        <option value="duct_test">ğŸ’¨ Duct Leakage Test / Prueba de Ductos</option>
                        <option value="refrigerant_charge">ğŸ§Š Refrigerant Charge Verification</option>
                        <option value="airflow_test">ğŸŒ¬ï¸ Airflow Test / Prueba de Flujo</option>
                        <option value="combustion_test">ğŸ”¥ Combustion Analysis</option>
                      </optgroup>
                      <optgroup label="ğŸ›¡ï¸ Seguridad y Cumplimiento">
                        <option value="co_test">âš ï¸ Carbon Monoxide Test</option>
                        <option value="gas_leak_test">ğŸ”¥ Gas Leak Test</option>
                        <option value="epa_compliance">ğŸŒ¿ EPA Compliance Report</option>
                        <option value="asbestos_test">â˜£ï¸ Asbestos / Lead Test</option>
                      </optgroup>
                      <optgroup label="ğŸ“„ Otros Reportes">
                        <option value="warranty_registration">ğŸ“œ Warranty Registration</option>
                        <option value="maintenance_report">ğŸ”§ Maintenance Report</option>
                        <option value="proposal_letter">ğŸ“ Proposal Letter</option>
                        <option value="other_report">ğŸ“„ Otro Reporte</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="form-group"><label>Trabajo Relacionado</label>
                    <select id="irJobId"><option value="">-- Sin trabajo --</option></select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Cliente</label><input type="text" id="irClient" placeholder="Nombre del cliente"></div>
                  <div class="form-group"><label>DirecciÃ³n de la Propiedad</label><input type="text" id="irAddress" placeholder="DirecciÃ³n donde se hizo la inspecciÃ³n"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Fecha de InspecciÃ³n</label><input type="date" id="irDate"></div>
                  <div class="form-group"><label>Inspector / TÃ©cnico</label><input type="text" id="irInspector" placeholder="Nombre del inspector"></div>
                  <div class="form-group"><label>CalificaciÃ³n / Score</label><input type="text" id="irScore" placeholder="Ej: HERS 65, Pass, Fail"></div>
                </div>
                <div class="form-group"><label>Resultado / Resumen</label>
                  <select id="irResult">
                    <option value="pass">âœ… Aprobado / Pass</option>
                    <option value="fail">âŒ Reprobado / Fail</option>
                    <option value="conditional">âš ï¸ Condicional / Requiere Correcciones</option>
                    <option value="pending">â³ Pendiente de Resultados</option>
                    <option value="info">â„¹ï¸ Informativo (sin calificaciÃ³n)</option>
                  </select>
                </div>
                <div class="form-group"><label>Notas / Hallazgos</label><textarea id="irNotes" rows="3" placeholder="Detalle los hallazgos, recomendaciones, deficiencias encontradas..."></textarea></div>
                <div class="form-group">
                  <label>ğŸ“ Subir Reporte (PDF, foto, scan)</label>
                  <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('irFileInput').click()">
                    <span style="font-size:28px;">ğŸ“</span>
                    <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic para subir el reporte PDF, foto o scan</p>
                    <img id="irFilePreview" src="" style="display:none;max-width:200px;margin-top:8px;border-radius:6px;">
                    <span id="irFileName" style="display:none;font-size:12px;color:var(--primary);margin-top:6px;"></span>
                  </div>
                  <input type="file" id="irFileInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="previewInspReport(this)">
                </div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveInspReport()">ğŸ’¾ Guardar Reporte</button>
                  <button class="btn-secondary btn-sm" onclick="hideInspReportForm()">Cancelar</button>
                </div>
              </div>

              <!-- Filter tabs -->
              <div style="display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap;">
                <button class="import-tab active" onclick="setIRTab('all')" id="irTabAll">ğŸ“Š Todos</button>
                <button class="import-tab" onclick="setIRTab('hers')" id="irTabHers">ğŸ“Š HERS</button>
                <button class="import-tab" onclick="setIRTab('inspection')" id="irTabInsp">ğŸ” Inspecciones</button>
                <button class="import-tab" onclick="setIRTab('energy')" id="irTabEnergy">ğŸ”‹ EnergÃ­a</button>
                <button class="import-tab" onclick="setIRTab('safety')" id="irTabSafety">ğŸ›¡ï¸ Seguridad</button>
              </div>

              <div id="inspReportsList"></div>
            </div>
          </div>
          <!-- ===== HOME ADVISORS (Vendedores) - MÃ“DULO COMPLETO ===== -->
          <div id="advisors-section" class="section">
            
            <!-- KPI Cards -->
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> Comisiones Pendientes</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="advKpiPendingComm">$0</span><span class="hcp-sub-amount">Por pagar</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ¯</span> Leads Activos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="advKpiActiveLeads">0</span><span class="hcp-sub-amount">En seguimiento</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">âš ï¸</span> Leads por Vencer</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="advKpiExpiringLeads">0</span><span class="hcp-sub-amount">&gt;15 dÃ­as sin cerrar</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ§¾</span> Recibos sin Conciliar</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="advKpiUnmatchedRcpt">0</span><span class="hcp-sub-amount">Pendientes</span></div>
              </div>
            </div>

            <!-- Tabs -->
            <div class="card" style="margin-bottom:16px;">
              <div style="display:flex;gap:4px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:16px;">
                <button class="import-tab active" onclick="setAdvTab('team')" id="advTabTeam">ğŸ‘¥ Equipo de Ventas</button>
                <button class="import-tab" onclick="setAdvTab('leads')" id="advTabLeads">ğŸ¯ Leads Asignados</button>
                <button class="import-tab" onclick="setAdvTab('sales')" id="advTabSales">ğŸ’µ Ventas y Comisiones</button>
                <button class="import-tab" onclick="setAdvTab('receipts')" id="advTabReceipts">ğŸ§¾ Recibos y ConciliaciÃ³n</button>
                <button class="import-tab" onclick="setAdvTab('referrals')" id="advTabReferrals">ğŸ“‹ Ã“rdenes Referidas</button>
              </div>

              <!-- TAB: Equipo de Ventas -->
              <div id="advContentTeam" class="adv-tab-content">
                <div class="card-top" style="margin-bottom:12px;">
                  <h3>ğŸ  Home Advisors (Vendedores)</h3>
                  <button class="btn-primary btn-sm" onclick="showAdvisorForm()">+ Nuevo Advisor</button>
                </div>
                
                <!-- Commission Tiers Info -->
                <div style="background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #10b981;border-radius:10px;padding:16px;margin-bottom:16px;">
                  <h4 style="color:#047857;margin-bottom:8px;">ğŸ“Š Estructura de Comisiones (Basada en Ganancia)</h4>
                  <p style="font-size:11px;color:#065f46;margin-bottom:10px;"><strong>FÃ³rmula:</strong> Ganancia = Venta - Materiales - Labor</p>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
                    <div style="background:white;padding:10px;border-radius:6px;text-align:center;border-left:4px solid #10b981;">
                      <div style="font-size:20px;font-weight:700;color:#10b981;">20%</div>
                      <div style="font-size:10px;color:#065f46;">Ganancia $10,000+</div>
                    </div>
                    <div style="background:white;padding:10px;border-radius:6px;text-align:center;border-left:4px solid #3b82f6;">
                      <div style="font-size:20px;font-weight:700;color:#3b82f6;">15%</div>
                      <div style="font-size:10px;color:#1e40af;">Ganancia $7,000-$9,999</div>
                    </div>
                    <div style="background:white;padding:10px;border-radius:6px;text-align:center;border-left:4px solid #f59e0b;">
                      <div style="font-size:20px;font-weight:700;color:#f59e0b;">10%</div>
                      <div style="font-size:10px;color:#92400e;">Ganancia $5,000-$6,999</div>
                    </div>
                    <div style="background:white;padding:10px;border-radius:6px;text-align:center;border-left:4px solid #94a3b8;">
                      <div style="font-size:20px;font-weight:700;color:#64748b;">5%</div>
                      <div style="font-size:10px;color:#475569;">Ganancia &lt;$5,000</div>
                    </div>
                  </div>
                  <p style="font-size:10px;color:#065f46;margin-top:8px;font-style:italic;">* Aplica igual para leads de la empresa y leads propios del vendedor</p>
                </div>

                <!-- Advisor Form -->
                <div id="advisorFormContainer" style="display:none;margin-bottom:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                  <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ‘¤ Nuevo Home Advisor</h4>
                  <form id="advisorForm" onsubmit="handleAdvisorCreate(event)">
                    <div class="form-row">
                      <div class="form-group"><label>Nombre Completo</label><input type="text" id="advisorName" required placeholder="Nombre completo"></div>
                      <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="advisorPhone" required placeholder="(555) 123-4567"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Email</label><input type="email" id="advisorEmail" placeholder="email@empresa.com"></div>
                      <div class="form-group"><label>Especialidad</label>
                        <select id="advisorSpecialty">
                          <option value="Residencial">Residencial</option>
                          <option value="Comercial">Comercial</option>
                          <option value="Residencial y Comercial">Residencial y Comercial</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Zona de Cobertura</label><input type="text" id="advisorZone" placeholder="Ej: Inland Empire, San Bernardino, Riverside"></div>
                      <div class="form-group"><label>Meta Mensual de Ventas ($)</label><input type="number" id="advisorGoal" placeholder="50000" min="0" step="1000"></div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Advisor</button>
                      <button type="button" class="btn-secondary btn-sm" onclick="hideAdvisorForm()">Cancelar</button>
                    </div>
                  </form>
                </div>
                
                <!-- Advisors List with Stats Cards -->
                <div id="advisorsList"></div>
              </div>

              <!-- TAB: Leads Asignados -->
              <div id="advContentLeads" class="adv-tab-content" style="display:none;">
                <div class="card-top" style="margin-bottom:12px;">
                  <h3>ğŸ¯ Leads Asignados a Vendedores</h3>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <select id="advLeadFilterAdvisor" onchange="renderAdvLeads()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todos los Advisors</option>
                    </select>
                    <select id="advLeadFilterStatus" onchange="renderAdvLeads()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todos los Status</option>
                      <option value="new">ğŸ†• Nuevo</option>
                      <option value="followup">ğŸ”„ En Seguimiento</option>
                      <option value="won">ğŸ† Ganado</option>
                      <option value="lost">âŒ Perdido</option>
                    </select>
                    <button class="btn-primary btn-sm" onclick="showAssignLeadModal()">+ Asignar Lead</button>
                  </div>
                </div>
                
                <!-- Expiring Leads Alert -->
                <div id="advExpiringLeadsAlert" style="display:none;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:12px;">
                  <h5 style="color:#92400e;margin-bottom:6px;">âš ï¸ Leads por Vencer (15+ dÃ­as sin cerrar)</h5>
                  <p style="font-size:11px;color:#78350f;margin-bottom:8px;">Estos leads serÃ¡n rotados automÃ¡ticamente al siguiente vendedor disponible.</p>
                  <div id="advExpiringLeadsList"></div>
                </div>
                
                <div id="advLeadsTable"></div>
                
                <!-- Lead Assignment Modal -->
                <div id="assignLeadModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
                  <div style="max-width:500px;margin:60px auto;background:var(--bg-card);border-radius:12px;padding:24px;position:relative;">
                    <button onclick="hideAssignLeadModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
                    <h3 style="color:var(--primary);margin-bottom:16px;">ğŸ¯ Asignar Lead a Vendedor</h3>
                    <div class="form-group"><label>Seleccionar Lead/Cliente</label>
                      <select id="assignLeadSelect" style="width:100%;"></select>
                    </div>
                    <div class="form-group"><label>Asignar a Advisor</label>
                      <select id="assignAdvisorSelect" style="width:100%;"></select>
                    </div>
                    <div class="form-group"><label>Fuente del Lead</label>
                      <select id="assignLeadSource" style="width:100%;">
                        <option value="company">ğŸ¢ Lead de la Empresa</option>
                        <option value="self">ğŸ‘¤ Lead Propio del Vendedor</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Notas</label>
                      <textarea id="assignLeadNotes" rows="2" placeholder="Notas sobre el lead..." style="width:100%;"></textarea>
                    </div>
                    <div class="form-actions">
                      <button class="btn-primary btn-sm" onclick="assignLeadToAdvisor()">âœ… Asignar Lead</button>
                      <button class="btn-secondary btn-sm" onclick="hideAssignLeadModal()">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TAB: Ventas y Comisiones -->
              <div id="advContentSales" class="adv-tab-content" style="display:none;">
                <div class="card-top" style="margin-bottom:12px;">
                  <h3>ğŸ’µ Ventas y Comisiones</h3>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <select id="advSalesFilterAdvisor" onchange="renderAdvSales()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todos los Advisors</option>
                    </select>
                    <select id="advSalesFilterMonth" onchange="renderAdvSales()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todo el AÃ±o</option>
                      <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                      <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                      <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                      <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                    <button class="btn-primary btn-sm" onclick="showAddSaleModal()">+ Registrar Venta</button>
                  </div>
                </div>

                <!-- Sales Stats -->
                <div class="hcp-ytd-grid" style="margin-bottom:16px;">
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">VENTAS TOTALES</span><span class="hcp-ytd-value" id="advSalesTotal">$0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">GANANCIA NETA</span><span class="hcp-ytd-value" id="advProfitTotal">$0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">COMISIONES GENERADAS</span><span class="hcp-ytd-value" id="advCommTotal">$0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">COMISIONES PAGADAS</span><span class="hcp-ytd-value" id="advCommPaid">$0</span></div>
                </div>

                <div id="advSalesTable"></div>
                
                <!-- Add Sale Modal -->
                <div id="addSaleModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
                  <div style="max-width:600px;margin:40px auto;background:var(--bg-card);border-radius:12px;padding:24px;position:relative;">
                    <button onclick="hideAddSaleModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
                    <h3 style="color:var(--primary);margin-bottom:16px;">ğŸ’µ Registrar Venta Cerrada</h3>
                    <div class="form-row">
                      <div class="form-group"><label>Vendedor</label><select id="saleAdvisorSelect" style="width:100%;"></select></div>
                      <div class="form-group"><label>Cliente</label><input type="text" id="saleClientName" placeholder="Nombre del cliente"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="saleAddress" placeholder="DirecciÃ³n del trabajo"></div>
                      <div class="form-group"><label>Fecha de Venta</label><input type="date" id="saleDate"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Monto Total de Venta ($)</label><input type="number" id="saleTotalAmount" min="0" step="0.01" placeholder="25000" onchange="calcSaleCommission()"></div>
                      <div class="form-group"><label>Costo de Materiales ($)</label><input type="number" id="saleMaterialsCost" min="0" step="0.01" placeholder="8000" onchange="calcSaleCommission()"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Costo de Labor ($)</label><input type="number" id="saleLaborCost" min="0" step="0.01" placeholder="3000" onchange="calcSaleCommission()"></div>
                      <div class="form-group"><label>Fuente del Lead</label>
                        <select id="saleLeadSource" style="width:100%;">
                          <option value="company">ğŸ¢ Lead de la Empresa</option>
                          <option value="self">ğŸ‘¤ Lead Propio</option>
                        </select>
                      </div>
                    </div>
                    
                    <!-- Commission Calculator Preview -->
                    <div id="saleCommPreview" style="background:#f0fdf4;border:1px solid #10b981;border-radius:8px;padding:12px;margin:12px 0;">
                      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center;">
                        <div><div style="font-size:10px;color:#065f46;">GANANCIA</div><div id="saleCalcProfit" style="font-size:16px;font-weight:700;color:#047857;">$0</div></div>
                        <div><div style="font-size:10px;color:#065f46;">TIER</div><div id="saleCalcTier" style="font-size:16px;font-weight:700;color:#047857;">-</div></div>
                        <div><div style="font-size:10px;color:#065f46;">% COMISIÃ“N</div><div id="saleCalcPct" style="font-size:16px;font-weight:700;color:#047857;">0%</div></div>
                        <div><div style="font-size:10px;color:#065f46;">COMISIÃ“N</div><div id="saleCalcComm" style="font-size:16px;font-weight:700;color:#10b981;">$0</div></div>
                      </div>
                    </div>
                    
                    <div class="form-group"><label>DescripciÃ³n del Trabajo</label><textarea id="saleDescription" rows="2" placeholder="Ej: InstalaciÃ³n sistema HVAC 4 toneladas, Trane XR15" style="width:100%;"></textarea></div>
                    <div class="form-actions">
                      <button class="btn-primary btn-sm" onclick="saveSale()">ğŸ’¾ Guardar Venta</button>
                      <button class="btn-secondary btn-sm" onclick="hideAddSaleModal()">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TAB: Recibos y ConciliaciÃ³n -->
              <div id="advContentReceipts" class="adv-tab-content" style="display:none;">
                <div class="card-top" style="margin-bottom:12px;">
                  <h3>ğŸ§¾ Recibos del Vendedor y ConciliaciÃ³n</h3>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <select id="advRcptFilterAdvisor" onchange="renderAdvReceipts()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todos los Advisors</option>
                    </select>
                    <select id="advRcptFilterStatus" onchange="renderAdvReceipts()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;">
                      <option value="">Todos</option>
                      <option value="pending">â³ Pendientes</option>
                      <option value="matched">âœ… Conciliados</option>
                      <option value="mismatch">âš ï¸ Con Diferencias</option>
                    </select>
                    <button class="btn-primary btn-sm" onclick="showAdvReceiptModal()">+ Subir Recibo</button>
                  </div>
                </div>
                
                <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;padding:10px;background:#fef3c7;border-radius:6px;">
                  âš ï¸ <strong>Importante:</strong> Los recibos del vendedor deben coincidir con los recibos de la empresa. El sistema compara automÃ¡ticamente monto, fecha y proveedor.
                </p>

                <!-- Reconciliation Summary -->
                <div class="hcp-ytd-grid" style="margin-bottom:16px;">
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">RECIBOS SUBIDOS</span><span class="hcp-ytd-value" id="advRcptCount">0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">CONCILIADOS</span><span class="hcp-ytd-value" style="color:#10b981;" id="advRcptMatched">0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">CON DIFERENCIAS</span><span class="hcp-ytd-value" style="color:#f59e0b;" id="advRcptMismatch">0</span></div>
                  <div class="hcp-ytd-card"><span class="hcp-ytd-label">PENDIENTES</span><span class="hcp-ytd-value" style="color:#ef4444;" id="advRcptPending">0</span></div>
                </div>

                <div id="advReceiptsTable"></div>
                
                <!-- Receipt Upload Modal -->
                <div id="advReceiptModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
                  <div style="max-width:500px;margin:60px auto;background:var(--bg-card);border-radius:12px;padding:24px;position:relative;">
                    <button onclick="hideAdvReceiptModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
                    <h3 style="color:var(--primary);margin-bottom:16px;">ğŸ§¾ Subir Recibo del Vendedor</h3>
                    <div class="form-group"><label>Vendedor</label><select id="advRcptAdvisor" style="width:100%;"></select></div>
                    <div class="form-row">
                      <div class="form-group"><label>Proveedor</label><input type="text" id="advRcptVendor" placeholder="Ej: US Air Conditioning"></div>
                      <div class="form-group"><label>Monto ($)</label><input type="number" id="advRcptAmount" min="0" step="0.01" placeholder="0.00"></div>
                    </div>
                    <div class="form-row">
                      <div class="form-group"><label>Fecha del Recibo</label><input type="date" id="advRcptDate"></div>
                      <div class="form-group"><label># de Recibo</label><input type="text" id="advRcptNumber" placeholder="INV-12345"></div>
                    </div>
                    <div class="form-group"><label>Trabajo/Venta Relacionada</label><select id="advRcptSale" style="width:100%;"><option value="">-- Seleccionar venta --</option></select></div>
                    <div class="form-group">
                      <label>ğŸ“· Foto del Recibo</label>
                      <div style="border:2px dashed var(--border);border-radius:8px;padding:16px;text-align:center;cursor:pointer;" onclick="document.getElementById('advRcptPhoto').click()">
                        <span style="font-size:24px;">ğŸ“·</span>
                        <p style="font-size:11px;color:var(--text-muted);">Haz clic para subir foto</p>
                        <img id="advRcptPhotoPreview" src="" style="display:none;max-width:150px;margin-top:8px;border-radius:6px;">
                      </div>
                      <input type="file" id="advRcptPhoto" accept="image/*" style="display:none" onchange="previewAdvRcptPhoto(this)">
                    </div>
                    <div class="form-actions">
                      <button class="btn-primary btn-sm" onclick="saveAdvReceipt()">ğŸ’¾ Guardar Recibo</button>
                      <button class="btn-secondary btn-sm" onclick="hideAdvReceiptModal()">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TAB: Ã“rdenes Referidas (existente) -->
              <div id="advContentReferrals" class="adv-tab-content" style="display:none;">
                <div class="card-top" style="margin-bottom:12px;">
                  <h3>ğŸ“‹ Ã“rdenes Referidas por TÃ©cnicos</h3>
                </div>
                <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Trabajos referidos por tÃ©cnicos para reemplazo de equipo. Estos son leads pre-calificados listos para cerrar.</p>
                <div id="referralsList"></div>
              </div>
            </div>

            <!-- Follow-up Log Card -->
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“ Registro de Seguimientos (Follow-Ups)</h3>
                <button class="btn-primary btn-sm" onclick="showFollowUpModal()">+ Agregar Seguimiento</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Registra llamadas, visitas, notas y cotizaciones enviadas a cada lead.</p>
              <div id="advFollowUpsTable"></div>
              
              <!-- Follow-up Modal -->
              <div id="followUpModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
                <div style="max-width:500px;margin:60px auto;background:var(--bg-card);border-radius:12px;padding:24px;position:relative;">
                  <button onclick="hideFollowUpModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
                  <h3 style="color:var(--primary);margin-bottom:16px;">ğŸ“ Registrar Seguimiento</h3>
                  <div class="form-group"><label>Lead/Cliente</label><select id="fuLeadSelect" style="width:100%;"></select></div>
                  <div class="form-group"><label>Tipo de Contacto</label>
                    <select id="fuType" style="width:100%;">
                      <option value="call">ğŸ“ Llamada</option>
                      <option value="visit">ğŸ  Visita</option>
                      <option value="quote">ğŸ“ CotizaciÃ³n Enviada</option>
                      <option value="text">ğŸ’¬ Mensaje de Texto</option>
                      <option value="email">ğŸ“§ Email</option>
                    </select>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="fuNotes" rows="3" placeholder="Resumen de la conversaciÃ³n, prÃ³ximos pasos..." style="width:100%;"></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“· Adjuntar Fotos (opcional)</label>
                    <input type="file" id="fuPhotos" accept="image/*" multiple style="width:100%;">
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Monto Cotizado ($)</label><input type="number" id="fuQuoteAmount" min="0" step="0.01" placeholder="0.00"></div>
                    <div class="form-group"><label>PrÃ³ximo Seguimiento</label><input type="date" id="fuNextDate"></div>
                  </div>
                  <div class="form-actions">
                    <button class="btn-primary btn-sm" onclick="saveFollowUp()">ğŸ’¾ Guardar</button>
                    <button class="btn-secondary btn-sm" onclick="hideFollowUpModal()">Cancelar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== INVOICES (Facturas) ===== -->
          <div id="invoices-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“„ Facturas</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="invoiceFilterStatus" class="inline-select" onchange="renderInvoicesTable()" style="padding:8px 12px;font-size:12px;">
                    <option value="all">Todas</option>
                    <option value="draft">Borrador</option>
                    <option value="sent">Enviadas</option>
                    <option value="paid">Pagadas</option>
                    <option value="partial">Pago Parcial</option>
                    <option value="overdue">Vencidas</option>
                    <option value="cancelled">Canceladas</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showInvoiceForm()">+ Nueva Factura</button>
                </div>
              </div>

              <!-- Invoice KPIs -->
              <div class="invoice-kpis" id="invoiceKPIs"></div>

              <!-- Invoice Form -->
              <div id="invoiceFormContainer" style="display:none;margin:16px 0;padding:20px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="margin-bottom:16px;color:var(--primary);">ğŸ“„ Nueva Factura</h4>
                <form id="invoiceForm" onsubmit="handleInvoiceCreate(event)">
                  <!-- Source: from job or manual -->
                  <div class="form-group">
                    <label>Crear desde Trabajo (opcional)</label>
                    <select id="invJobSelect" onchange="loadInvoiceFromJob()">
                      <option value="">â€” Factura manual â€”</option>
                    </select>
                  </div>

                  <div class="form-row">
                    <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="invClientName" required placeholder="Nombre completo"></div>
                    <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="invClientPhone" placeholder="(555) 123-4567"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="invClientEmail" placeholder="email@cliente.com"></div>
                    <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="invClientAddress" placeholder="DirecciÃ³n del servicio"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>TÃ©cnico</label>
                      <select id="invTechSelect"><option value="">Seleccionar...</option></select>
                    </div>
                    <div class="form-group"><label>Fecha de Vencimiento</label><input type="date" id="invDueDate"></div>
                  </div>

                  <!-- Line Items -->
                  <div style="margin:16px 0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <label style="font-weight:600;font-size:13px;color:var(--primary);">LÃ­neas de Factura</label>
                      <button type="button" class="btn-secondary btn-sm" onclick="addInvoiceLine()" style="padding:6px 12px;font-size:11px;">+ Agregar LÃ­nea</button>
                    </div>
                    <div id="invoiceLines"></div>
                  </div>

                  <!-- Service Call -->
                  <div class="form-row">
                    <div class="form-group"><label>Service Call Fee ($)</label><input type="number" id="invServiceCall" value="0" min="0" step="0.01" onchange="calcInvoiceTotals()"></div>
                    <div class="form-group"><label>Descuento (%)</label><input type="number" id="invDiscount" value="0" min="0" max="100" onchange="calcInvoiceTotals()"></div>
                    <div class="form-group"><label>Tax (%)</label><input type="number" id="invTax" value="8.75" step="0.25" onchange="calcInvoiceTotals()"></div>
                  </div>

                  <!-- Totals Preview -->
                  <div id="invoiceTotalsPreview" class="est-totals" style="margin:12px 0;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;"></div>

                  <div class="form-group"><label>Notas para el Cliente</label><textarea id="invNotes" rows="2" placeholder="GarantÃ­a, tÃ©rminos, condiciones..."></textarea></div>
                  <div class="form-group"><label>Notas Internas (no se muestran al cliente)</label><textarea id="invInternalNotes" rows="2" placeholder="Notas internas..."></textarea></div>

                  <div class="form-actions" style="margin-top:12px;">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Factura</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideInvoiceForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Invoice Table -->
              <div id="invoicesTable"></div>
            </div>

            <!-- Invoice Detail Modal -->
            <div id="invoiceDetailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
              <div style="max-width:700px;margin:40px auto;background:var(--bg-card);border-radius:12px;padding:30px;position:relative;">
                <button onclick="closeInvoiceDetail()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);">âœ•</button>
                <div id="invoiceDetailContent"></div>
              </div>
            </div>
          </div>
          <!-- ===== COLLECTIONS (Cobranza) ===== -->
          <div id="collections-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ’° Cobranza</h3>
                <select id="collectionsFilter" class="inline-select" onchange="renderCollections()" style="padding:8px 12px;font-size:12px;">
                  <option value="all_due">Todas con Balance</option>
                  <option value="overdue">Vencidas</option>
                  <option value="partial">Pago Parcial</option>
                  <option value="sent">Enviadas (sin pago)</option>
                  <option value="recent_paid">ReciÃ©n Pagadas</option>
                </select>
              </div>

              <!-- Collections KPIs -->
              <div id="collectionsKPIs" class="invoice-kpi-row"></div>

              <!-- Collections Table -->
              <div id="collectionsTable"></div>
            </div>

            <!-- Payment History -->
            <div class="card" style="margin-top:16px;">
              <h3>ğŸ“‹ Historial de Pagos</h3>
              <div id="paymentsHistory"></div>
            </div>
          </div>

          <!-- ===== PROGRAMA EMBAJADORES ===== -->
          <div id="ambassadors-section" class="section">
            <style>
              @keyframes ambPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
              @keyframes ambGlow{0%,100%{box-shadow:0 0 20px rgba(249,115,22,.3)}50%{box-shadow:0 0 40px rgba(249,115,22,.6),0 0 80px rgba(249,115,22,.2)}}
              @keyframes ambShine{0%{background-position:-200% center}100%{background-position:200% center}}
              @keyframes ambFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
              @keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100px) rotate(720deg);opacity:0}}
              .amb-hero{background:linear-gradient(135deg,#f97316 0%,#ea580c 30%,#dc2626 60%,#f97316 100%);background-size:200% 200%;animation:ambShine 4s ease infinite;border-radius:20px;padding:32px;color:#fff;text-align:center;position:relative;overflow:hidden;margin-bottom:20px}
              .amb-hero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 60%);animation:ambFloat 6s ease-in-out infinite}
              .amb-code-box{animation:ambGlow 3s ease-in-out infinite;background:rgba(0,0,0,.2);backdrop-filter:blur(10px);border-radius:16px;padding:20px;margin:16px auto;max-width:400px;border:2px solid rgba(255,255,255,.3)}
              .amb-code{font-size:36px;font-weight:900;font-family:'Courier New',monospace;letter-spacing:6px;text-shadow:0 2px 10px rgba(0,0,0,.3)}
              .amb-money{font-size:64px;font-weight:900;background:linear-gradient(135deg,#fbbf24,#f59e0b,#fbbf24);background-size:200%;animation:ambShine 2s ease infinite;-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;line-height:1}
              .amb-share-btn{border:none;padding:12px 20px;border-radius:12px;font-weight:800;font-size:13px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
              .amb-share-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
              .amb-stat-card{background:#fff;border-radius:14px;padding:20px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,.05);border:1px solid #f3f4f6;transition:all .2s}
              .amb-stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.1)}
              .amb-step{background:#fff;border-radius:14px;padding:20px;text-align:center;border:2px solid #fed7aa;transition:all .2s}
              .amb-step:hover{border-color:#f97316;transform:translateY(-2px)}
              .amb-qr-card{background:#fff;border:3px dashed #f97316;border-radius:16px;padding:24px;text-align:center}
              .amb-w9-upload{background:linear-gradient(135deg,#f8fafc,#fff);border:2px dashed #cbd5e1;border-radius:14px;padding:24px;text-align:center;cursor:pointer;transition:all .2s}
              .amb-w9-upload:hover{border-color:#f97316;background:#fff7ed}
            </style>

            <!-- HERO SECTION -->
            <div class="amb-hero">
              <div style="position:relative;z-index:1">
                <div style="font-size:48px;margin-bottom:8px">ğŸŒŸ</div>
                <h2 style="font-size:28px;font-weight:900;margin-bottom:4px;text-shadow:0 2px 10px rgba(0,0,0,.2)">PROGRAMA DE EMBAJADORES</h2>
                <p style="font-size:15px;opacity:0.9;margin-bottom:16px">Gana dinero real refiriendo negocios a Trade Master CRM</p>
                <div class="amb-money">$50</div>
                <p style="font-size:18px;font-weight:700;margin-top:4px">POR CADA REFERIDO QUE SE ACTIVE ğŸ”¥</p>
                <p style="font-size:13px;opacity:0.8;margin-top:8px">Sin lÃ­mites â€” mientras mÃ¡s refieras, mÃ¡s ganas ğŸ’°</p>

                <!-- Code Box -->
                <div class="amb-code-box">
                  <p style="font-size:11px;opacity:0.7;margin-bottom:4px;text-transform:uppercase;letter-spacing:2px">Tu CÃ³digo Ãšnico de Embajador</p>
                  <div class="amb-code" id="ambassadorCode">TM-0000</div>
                  <div style="background:rgba(255,255,255,.15);border-radius:8px;padding:8px;font-size:11px;margin-top:10px;word-break:break-all" id="ambassadorLink">https://acvolttech.github.io/trademaster-crm/?ref=TM-0000</div>
                </div>

                <!-- Share Buttons -->
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px">
                  <button onclick="copyRefLink()" class="amb-share-btn" style="background:#fff;color:#ea580c">ğŸ“‹ Copiar Link</button>
                  <button onclick="shareRefWhatsApp()" class="amb-share-btn" style="background:#25d366;color:#fff">ğŸ’¬ WhatsApp</button>
                  <button onclick="shareRefSMS()" class="amb-share-btn" style="background:#34d399;color:#fff">ğŸ“± Texto</button>
                  <button onclick="shareRefEmail()" class="amb-share-btn" style="background:#3b82f6;color:#fff">ğŸ“§ Email</button>
                  <button onclick="shareRefFacebook()" class="amb-share-btn" style="background:#1877f2;color:#fff">ğŸ“˜ Facebook</button>
                  <button onclick="shareRefInstagram()" class="amb-share-btn" style="background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff">ğŸ“¸ Instagram</button>
                  <button onclick="shareRefTwitter()" class="amb-share-btn" style="background:#000;color:#fff">ğ• Twitter</button>
                </div>
              </div>
            </div>

            <!-- STATS -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">
              <div class="amb-stat-card"><div style="font-size:32px;font-weight:900;color:#f97316" id="ambReferred">0</div><div style="font-size:12px;color:#6b7280;font-weight:700">ğŸ‘¥ Referidos</div></div>
              <div class="amb-stat-card"><div style="font-size:32px;font-weight:900;color:#22c55e" id="ambConverted">0</div><div style="font-size:12px;color:#6b7280;font-weight:700">âœ… Activados</div></div>
              <div class="amb-stat-card"><div style="font-size:32px;font-weight:900;color:#8b5cf6" id="ambEarned">$0</div><div style="font-size:12px;color:#6b7280;font-weight:700">ğŸ’° Ganado</div></div>
              <div class="amb-stat-card"><div style="font-size:32px;font-weight:900;color:#3b82f6" id="ambPending">$0</div><div style="font-size:12px;color:#6b7280;font-weight:700">â³ Pendiente</div></div>
            </div>

            <!-- QR CODE + CARD -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
              <div class="amb-qr-card">
                <h4 style="font-size:15px;margin-bottom:12px">ğŸ“± Tu CÃ³digo QR</h4>
                <div id="ambassadorQR" style="margin:0 auto 12px;width:200px;height:200px;background:#f3f4f6;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:13px;color:#9ca3af">Generando QR...</div>
                <div style="display:flex;gap:8px;justify-content:center">
                  <button onclick="downloadQR()" style="background:#f97316;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">â¬‡ï¸ Descargar QR</button>
                  <button onclick="printAmbCard()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">ğŸ–¨ï¸ Imprimir Tarjeta</button>
                </div>
              </div>
              <!-- W9 Upload -->
              <div>
                <div class="amb-w9-upload" onclick="document.getElementById('w9FileInput').click()">
                  <div style="font-size:40px;margin-bottom:8px" id="w9Icon">ğŸ“„</div>
                  <h4 style="font-size:14px;margin-bottom:4px" id="w9Title">Sube tu W-9</h4>
                  <p style="font-size:12px;color:#6b7280" id="w9Desc">Necesitamos tu W-9 para poder pagarte tus comisiones. Click aquÃ­ para subir.</p>
                  <input type="file" id="w9FileInput" accept=".pdf,.jpg,.jpeg,.png" onchange="uploadW9(this)" style="display:none">
                  <div id="w9Status" style="margin-top:12px"></div>
                </div>
                <div style="background:#fefce8;border:1px solid #fde68a;border-radius:10px;padding:12px;margin-top:12px;font-size:11px;color:#92400e">
                  <strong>âš ï¸ Â¿Por quÃ© necesitamos tu W-9?</strong><br>
                  Es requerido por el IRS para pagos mayores a $600/aÃ±o. Tu informaciÃ³n es 100% segura y confidencial.
                </div>
              </div>
            </div>

            <!-- HOW IT WORKS -->
            <div style="margin-bottom:20px">
              <h3 style="font-size:16px;font-weight:800;text-align:center;margin-bottom:16px">ğŸ¯ Â¿CÃ³mo Funciona?</h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                <div class="amb-step"><div style="font-size:36px;margin-bottom:8px">ğŸ“¤</div><h4 style="font-size:13px;font-weight:800">1. Comparte</h4><p style="font-size:11px;color:#6b7280">EnvÃ­a tu cÃ³digo o QR a dueÃ±os de negocios de HVAC</p></div>
                <div class="amb-step"><div style="font-size:36px;margin-bottom:8px">ğŸ“</div><h4 style="font-size:13px;font-weight:800">2. Se Registran</h4><p style="font-size:11px;color:#6b7280">Ellos crean su cuenta usando tu cÃ³digo de referido</p></div>
                <div class="amb-step"><div style="font-size:36px;margin-bottom:8px">âœ…</div><h4 style="font-size:13px;font-weight:800">3. Se Activan</h4><p style="font-size:11px;color:#6b7280">Cuando pagan su primer mes, Â¡tÃº ganas!</p></div>
                <div class="amb-step"><div style="font-size:36px;margin-bottom:8px">ğŸ’°</div><h4 style="font-size:13px;font-weight:800">4. Cobra $50</h4><p style="font-size:11px;color:#6b7280">Recibe $50 por cada negocio que active su plan</p></div>
              </div>
            </div>

            <!-- EPIC MESSAGE PREVIEW -->
            <div style="background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:14px;padding:20px;margin-bottom:20px;color:#fff">
              <h4 style="font-size:14px;margin-bottom:12px">âœï¸ Mensaje Listo Para Enviar</h4>
              <div id="epicMessage" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;font-size:12px;line-height:1.6;white-space:pre-wrap;margin-bottom:12px;color:#e2e8f0">Cargando...</div>
              <div style="display:flex;gap:8px">
                <button onclick="copyEpicMessage()" style="background:#f97316;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">ğŸ“‹ Copiar Mensaje</button>
                <button onclick="refreshEpicMessage()" style="background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 16px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">ğŸ”„ Otro Mensaje</button>
              </div>
            </div>

            <!-- REFERRALS LIST -->
            <div class="card" style="margin-bottom:16px">
              <div class="card-top"><h3>ğŸ“‹ Mis Referidos</h3></div>
              <div id="ambassadorReferrals" style="max-height:400px;overflow-y:auto;padding:16px"><p style="text-align:center;color:#9ca3af;padding:20px;font-size:13px">ğŸš€ AÃºn no tienes referidos â€” Â¡comparte tu cÃ³digo y empieza a ganar $50 por cada uno!</p></div>
            </div>

            <!-- PAYOUT HISTORY -->
            <div class="card">
              <div class="card-top"><h3>ğŸ’¸ Historial de Pagos</h3></div>
              <div id="ambassadorPayouts" style="max-height:300px;overflow-y:auto;padding:16px"><p style="text-align:center;color:#9ca3af;padding:20px;font-size:13px">Sin pagos aÃºn â€” genera referidos para empezar a ganar</p></div>
            </div>
          </div>

          <!-- ===== USUARIOS Y EQUIPO ===== -->
          <div id="team-section" class="section">
            <div class="card" style="margin-bottom:16px;border:2px solid var(--primary);">
              <div class="card-top">
                <h3>ğŸ‘¥ Usuarios y Control de Acceso</h3>
                <button class="btn-primary btn-sm" onclick="showTeamUserForm()">+ Agregar Usuario</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Administra quiÃ©n puede acceder al CRM y quÃ© secciones puede ver. Solo el <strong>DueÃ±o/CEO</strong> puede administrar usuarios.</p>

              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:16px;">
                <div style="padding:12px;border:1px solid #3b82f6;border-radius:8px;background:#eff6ff;">
                  <h5 style="color:#1d4ed8;font-size:13px;">ğŸ‘‘ DueÃ±o / CEO</h5>
                  <p style="font-size:10px;color:#1e40af;line-height:1.5;">Acceso total. Mi Dinero, cuenta bancaria, configuraciÃ³n, usuarios. <strong>Solo 1 por empresa.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #8b5cf6;border-radius:8px;background:#f5f3ff;">
                  <h5 style="color:#6d28d9;font-size:13px;">ğŸ“Š Contabilidad / Admin</h5>
                  <p style="font-size:10px;color:#5b21b6;line-height:1.5;">NÃ³mina, gastos, recibos, facturas, QuickBooks, reportes. <strong>No ve Mi Dinero ni cuenta bancaria.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #f59e0b;border-radius:8px;background:#fffbeb;">
                  <h5 style="color:#b45309;font-size:13px;">ğŸ¯ Coordinador de Despacho</h5>
                  <p style="font-size:10px;color:#92400e;line-height:1.5;">Despacho, trabajos, tÃ©cnicos, clientes, correo, agenda. <strong>No ve finanzas ni nÃ³mina.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #10b981;border-radius:8px;background:#ecfdf5;">
                  <h5 style="color:#047857;font-size:13px;">ğŸ”§ TÃ©cnico</h5>
                  <p style="font-size:10px;color:#065f46;line-height:1.5;">Solo sus trabajos asignados, reloj de entrada/salida. <strong>No ve otros datos.</strong></p>
                </div>
                <div style="padding:12px;border:1px solid #94a3b8;border-radius:8px;background:#f8fafc;">
                  <h5 style="color:#475569;font-size:13px;">ğŸ‘ï¸ Solo Vista</h5>
                  <p style="font-size:10px;color:#64748b;line-height:1.5;">Puede ver tablero y reportes pero no puede editar ni crear nada.</p>
                </div>
              </div>

              <div id="teamUserForm" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ‘¤ Nuevo Usuario</h4>
                <div class="form-row">
                  <div class="form-group"><label>Nombre Completo</label><input type="text" id="tuName" required placeholder="Ej: MarÃ­a GarcÃ­a"></div>
                  <div class="form-group"><label>Email</label><input type="email" id="tuEmail" required placeholder="usuario@empresa.com"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="tuPhone" placeholder="(555) 123-4567"></div>
                  <div class="form-group"><label>Nombre de Usuario</label><input type="text" id="tuUsername" required placeholder="Ej: maria.garcia"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="tuPassword" required placeholder="MÃ­nimo 6 caracteres"></div>
                  <div class="form-group"><label>Confirmar ContraseÃ±a</label><input type="password" id="tuPasswordConfirm" required placeholder="Repetir contraseÃ±a"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Rol / Puesto</label>
                    <select id="tuRole" onchange="previewRolePerms()">
                      <option value="owner">ğŸ‘‘ DueÃ±o / CEO</option>
                      <option value="accounting">ğŸ“Š Contabilidad / Admin</option>
                      <option value="dispatcher">ğŸ¯ Coordinador de Despacho</option>
                      <option value="technician">ğŸ”§ TÃ©cnico</option>
                      <option value="viewer">ğŸ‘ï¸ Solo Vista</option>
                    </select>
                  </div>
                  <div class="form-group"><label>Estado</label>
                    <select id="tuStatus">
                      <option value="active">âœ… Activo</option>
                      <option value="inactive">â›” Inactivo</option>
                    </select>
                  </div>
                </div>
                <div id="tuPermPreview" style="margin:12px 0;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;">
                  <h5 style="font-size:12px;color:var(--primary);margin-bottom:6px;">ğŸ” Permisos de este Rol:</h5>
                  <div id="tuPermList" style="font-size:11px;color:var(--text-muted);line-height:1.8;"></div>
                </div>
                <div class="form-group"><label>Notas</label><textarea id="tuNotes" rows="2" placeholder="Responsabilidades, horario, etc."></textarea></div>
                <div class="form-actions">
                  <button class="btn-primary btn-sm" onclick="saveTeamUser()">ğŸ’¾ Guardar Usuario</button>
                  <button class="btn-secondary btn-sm" onclick="hideTeamUserForm()">Cancelar</button>
                </div>
              </div>

              <div id="teamUsersList"></div>
            </div>

            <div class="card">
              <div class="card-top"><h3>ğŸŸ¢ Sesiones Activas</h3></div>
              <div id="teamActiveSessions">
                <p class="empty-msg">Las sesiones activas aparecerÃ¡n aquÃ­ cuando los usuarios inicien sesiÃ³n.</p>
              </div>
            </div>
          </div>

          <!-- ===== RECURSOS HUMANOS / HR ===== -->
          <div id="hr-section" class="section">
            <div id="mainContent"></div>
          </div>

          <div id="settings-section" class="section">
            <div class="card">
              <h3>ConfiguraciÃ³n de la Empresa</h3>
              <div class="settings-form">
                <div class="form-group">
                  <label>Logo de la Empresa</label>
                  <div class="logo-upload-area">
                    <div id="logoPreview" class="logo-preview">
                      <span>Haz clic para subir logo</span>
                    </div>
                    <input type="file" id="logoFileInput" accept="image/*" onchange="handleLogoUpload(event)" style="display:none;">
                    <button class="btn-secondary btn-sm" onclick="document.getElementById('logoFileInput').click()">ğŸ“· Cambiar Logo</button>
                    <button class="btn-secondary btn-sm" onclick="resetLogo()">â†©ï¸ Logo Default</button>
                  </div>
                </div>
                <div class="form-group"><label>Nombre de la Empresa</label><input type="text" id="settingsCompanyName" placeholder="Nombre"></div>
                <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="settingsPhone" placeholder="TelÃ©fono"></div>
                <div class="form-group"><label>Email</label><input type="email" id="settingsEmail" placeholder="Email"></div>
                <div class="form-group"><label>DirecciÃ³n</label><input type="text" id="settingsAddress" placeholder="DirecciÃ³n de la empresa"></div>
                <div class="form-row">
                  <div class="form-group"><label>ğŸ“œ Licencia de Contratista (C-10, C-20, etc.)</label><input type="text" id="settingsLicense" placeholder="Ej: C-10 #1051648, C-20 #1051648"></div>
                  <div class="form-group"><label>ğŸ¦ Contractor Bond #</label><input type="text" id="settingsBond" placeholder="Ej: Bond #12345678"></div>
                </div>
                <div class="form-group"><label>ğŸ‘¤ Nombre del DueÃ±o / CEO</label><input type="text" id="settingsOwnerName" placeholder="Nombre completo del dueÃ±o"></div>
                <button class="btn-primary btn-sm" onclick="saveSettings()">Guardar ConfiguraciÃ³n</button>
                
                <hr style="margin:20px 0;border-color:var(--border);">
                
                <!-- ===== COMPANY DOCUMENTS ===== -->
                <h4 style="color:var(--primary);margin-bottom:4px;">ğŸ“ Documentos de la Empresa Documents</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">Sube tus documentos legales y de seguros. Estos se incluirÃ¡n automÃ¡ticamente en estimados y facturas cuando el cliente o empresa lo solicite.</p>

                <div id="companyDocsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:16px;">
                  
                  <!-- Workers' Compensation -->
                  <div class="doc-upload-card" id="docCard_workers_comp">
                    <div class="doc-icon">ğŸ›¡ï¸</div>
                    <div class="doc-info">
                      <strong>Workers' Compensation</strong>
                      <small>Certificate of Insurance</small>
                    </div>
                    <div class="doc-status" id="docStatus_workers_comp">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('workers_comp', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('workers_comp')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_workers_comp">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('workers_comp')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_workers_comp">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_workers_comp" onchange="saveDocExpiry('workers_comp')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- General Liability -->
                  <div class="doc-upload-card" id="docCard_general_liability">
                    <div class="doc-icon">ğŸ¢</div>
                    <div class="doc-info">
                      <strong>General Liability Insurance</strong>
                      <small>Certificate of Liability Insurance</small>
                    </div>
                    <div class="doc-status" id="docStatus_general_liability">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('general_liability', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('general_liability')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_general_liability">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('general_liability')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_general_liability">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_general_liability" onchange="saveDocExpiry('general_liability')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- W-9 Form -->
                  <div class="doc-upload-card" id="docCard_w9">
                    <div class="doc-icon">ğŸ“‹</div>
                    <div class="doc-info">
                      <strong>W-9 Form</strong>
                      <small>Request for Taxpayer ID</small>
                    </div>
                    <div class="doc-status" id="docStatus_w9">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('w9', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('w9')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_w9">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('w9')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_w9">âœ•</button>
                    </div>
                  </div>

                  <!-- Contractor License Bond -->
                  <div class="doc-upload-card" id="docCard_bond">
                    <div class="doc-icon">ğŸ’°</div>
                    <div class="doc-info">
                      <strong>Contractor License Bond</strong>
                      <small>Surety Bond Certificate</small>
                    </div>
                    <div class="doc-status" id="docStatus_bond">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('bond', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('bond')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_bond">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('bond')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_bond">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_bond" onchange="saveDocExpiry('bond')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- Contractor License -->
                  <div class="doc-upload-card" id="docCard_contractor_license">
                    <div class="doc-icon">ğŸ›ï¸</div>
                    <div class="doc-info">
                      <strong>Contractor License</strong>
                      <small>State License (CSLB, TDLR, etc.)</small>
                    </div>
                    <div class="doc-status" id="docStatus_contractor_license">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('contractor_license', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('contractor_license')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_contractor_license">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('contractor_license')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_contractor_license">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_contractor_license" onchange="saveDocExpiry('contractor_license')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- EPA Section 608 -->
                  <div class="doc-upload-card" id="docCard_epa_608">
                    <div class="doc-icon">ğŸŒ¿</div>
                    <div class="doc-info">
                      <strong>EPA Section 608</strong>
                      <small>Refrigerant Certification</small>
                    </div>
                    <div class="doc-status" id="docStatus_epa_608">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('epa_608', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('epa_608')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_epa_608">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('epa_608')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_epa_608">âœ•</button>
                    </div>
                  </div>

                  <!-- Vehicle Insurance -->
                  <div class="doc-upload-card" id="docCard_vehicle_insurance">
                    <div class="doc-icon">ğŸš</div>
                    <div class="doc-info">
                      <strong>Vehicle Insurance</strong>
                      <small>Auto Liability Certificate</small>
                    </div>
                    <div class="doc-status" id="docStatus_vehicle_insurance">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('vehicle_insurance', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('vehicle_insurance')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_vehicle_insurance">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('vehicle_insurance')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_vehicle_insurance">âœ•</button>
                    </div>
                    <div class="doc-expiry">
                      <label style="font-size:10px;color:var(--text-muted);">Vence / Expires:</label>
                      <input type="date" id="docExpiry_vehicle_insurance" onchange="saveDocExpiry('vehicle_insurance')" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:4px;">
                    </div>
                  </div>

                  <!-- Other Document -->
                  <div class="doc-upload-card" id="docCard_other">
                    <div class="doc-icon">ğŸ“„</div>
                    <div class="doc-info">
                      <strong>Otro Documento / Other</strong>
                      <small>Cualquier documento adicional</small>
                    </div>
                    <div class="doc-status" id="docStatus_other">
                      <span class="doc-badge doc-missing">No subido</span>
                    </div>
                    <div class="doc-actions">
                      <label class="btn-secondary btn-sm doc-upload-btn">
                        ğŸ“¤ Subir
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadCompanyDoc('other', this)">
                      </label>
                      <button class="btn-sm" onclick="viewCompanyDoc('other')" style="display:none;background:var(--primary);color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" id="docView_other">ğŸ‘ï¸ Ver</button>
                      <button class="btn-sm" onclick="removeCompanyDoc('other')" style="display:none;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;" id="docRemove_other">âœ•</button>
                    </div>
                  </div>

                </div>

                <!-- Include in Estimates toggle -->
                <div style="padding:10px;background:#f0fdf4;border:1px solid #10b981;border-radius:8px;margin-bottom:16px;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                    <input type="checkbox" id="includeDocsInEstimates" checked onchange="saveDocSettings()" style="width:18px;height:18px;accent-color:#10b981;">
                    <span><strong>Incluir documentos en estimados y facturas</strong> â€” El cliente podrÃ¡ ver/descargar Workers' Comp, GL, Bond, License, etc. directamente desde el estimado.</span>
                  </label>
                </div>

                <hr style="margin:20px 0;border-color:var(--border);">
                <h4 style="color:var(--primary);margin-bottom:4px;">ğŸ“‹ ClÃ¡usulas del Contrato / Invoice</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">Personaliza los tÃ©rminos legales que aparecen en tus facturas e invoices. Edita segÃºn las leyes de tu estado.</p>
                
                <div class="form-group">
                  <label>ğŸ‡ºğŸ‡¸ Estado / State</label>
                  <select id="clauseState" onchange="loadDefaultClauses()" style="max-width:300px;">
                    <optgroup label="â”€â”€ Estados Principales â”€â”€">
                      <option value="CA">California</option>
                      <option value="TX">Texas</option>
                      <option value="AZ">Arizona</option>
                      <option value="NV">Nevada</option>
                      <option value="FL">Florida</option>
                      <option value="NY">New York</option>
                    </optgroup>
                    <optgroup label="â”€â”€ Todos los Estados â”€â”€">
                      <option value="AL">Alabama</option>
                      <option value="AK">Alaska</option>
                      <option value="AR">Arkansas</option>
                      <option value="CO">Colorado</option>
                      <option value="CT">Connecticut</option>
                      <option value="DE">Delaware</option>
                      <option value="GA">Georgia</option>
                      <option value="HI">Hawaii</option>
                      <option value="ID">Idaho</option>
                      <option value="IL">Illinois</option>
                      <option value="IN">Indiana</option>
                      <option value="IA">Iowa</option>
                      <option value="KS">Kansas</option>
                      <option value="KY">Kentucky</option>
                      <option value="LA">Louisiana</option>
                      <option value="ME">Maine</option>
                      <option value="MD">Maryland</option>
                      <option value="MA">Massachusetts</option>
                      <option value="MI">Michigan</option>
                      <option value="MN">Minnesota</option>
                      <option value="MS">Mississippi</option>
                      <option value="MO">Missouri</option>
                      <option value="MT">Montana</option>
                      <option value="NE">Nebraska</option>
                      <option value="NH">New Hampshire</option>
                      <option value="NJ">New Jersey</option>
                      <option value="NM">New Mexico</option>
                      <option value="NC">North Carolina</option>
                      <option value="ND">North Dakota</option>
                      <option value="OH">Ohio</option>
                      <option value="OK">Oklahoma</option>
                      <option value="OR">Oregon</option>
                      <option value="PA">Pennsylvania</option>
                      <option value="RI">Rhode Island</option>
                      <option value="SC">South Carolina</option>
                      <option value="SD">South Dakota</option>
                      <option value="TN">Tennessee</option>
                      <option value="UT">Utah</option>
                      <option value="VT">Vermont</option>
                      <option value="VA">Virginia</option>
                      <option value="WA">Washington</option>
                      <option value="WV">West Virginia</option>
                      <option value="WI">Wisconsin</option>
                      <option value="WY">Wyoming</option>
                      <option value="DC">Washington D.C.</option>
                      <option value="PR">Puerto Rico</option>
                    </optgroup>
                  </select>
                  <div id="stateRegSummary" style="margin-top:8px;padding:10px;background:rgba(244,118,33,0.08);border-left:3px solid var(--primary);border-radius:4px;font-size:11px;color:var(--text-muted);display:none;"></div>
                </div>

                <div class="form-group">
                  <label>ğŸ’° TÃ©rminos de Pago / Payment Terms</label>
                  <textarea id="clausePayment" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>âš ï¸ Derecho de CancelaciÃ³n / Right to Cancel</label>
                  <textarea id="clauseCancel" rows="5" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”„ CancelaciÃ³n & Restocking Fee</label>
                  <textarea id="clauseRestock" rows="5" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ›ï¸ Licencia del Contratista / Contractor License Board</label>
                  <textarea id="clauseLicense" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ’µ Enganche / Down Payment Limit</label>
                  <textarea id="clauseDownPayment" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”— Aviso de Liens / Mechanics Lien Warning</label>
                  <textarea id="clauseLien" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ›¡ï¸ GarantÃ­a / GarantÃ­a</label>
                  <textarea id="clauseWarranty" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸŒ¿ EPA / Refrigerants & Environmental</label>
                  <textarea id="clauseEpa" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ“‹ Permisos & Inspecciones / Permits & Inspections</label>
                  <textarea id="clausePermits" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ¦º Seguro & Bonding / Insurance & Bonding</label>
                  <textarea id="clauseInsurance" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ”’ PolÃ­tica de Privacidad / Privacy Policy</label>
                  <textarea id="clausePrivacy" rows="3" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸš« Reserva de Derecho / Right to Refuse Service</label>
                  <textarea id="clauseRefuse" rows="4" style="font-size:12px;"></textarea>
                </div>
                <div class="form-group">
                  <label>ğŸ“ ClÃ¡usula Adicional (Opcional)</label>
                  <textarea id="clauseCustom" rows="3" style="font-size:12px;" placeholder="Agrega cualquier tÃ©rmino adicional aquÃ­..."></textarea>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn-primary btn-sm" onclick="saveClauses()">ğŸ’¾ Guardar ClÃ¡usulas</button>
                  <button class="btn-secondary btn-sm" onclick="loadDefaultClauses()">ğŸ”„ Restaurar Defaults del Estado</button>
                </div>

                <hr style="margin:20px 0;border-color:var(--border);">
                <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ§ª Datos de DemostraciÃ³n</h4>
                <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Crea tÃ©cnicos, clientes, leads y citas de ejemplo para probar el sistema.</p>
                <button class="btn-secondary btn-sm" onclick="seedDemoData()">ğŸ² Crear Datos Demo</button>
              </div>
            </div>
          </div>

          <!-- ===== PIPELINE ===== -->
          <div id="pipeline-section" class="section">
            <div class="card">
              <div class="card-top">
                <h3>ğŸ“ˆ <span data-i18n="pipe_title">Flujo de Ventas</span></h3>
                <div style="display:flex;gap:8px;align-items:center;">
                  <select id="pipeFilterPeriod" class="inline-select" onchange="renderPipelineSection()" style="padding:8px 12px;font-size:12px;">
                    <option value="all" data-i18n="pipe_all">Todos</option>
                    <option value="week" data-i18n="pipe_week">Esta Semana</option>
                    <option value="month" data-i18n="pipe_month">Este Mes</option>
                    <option value="quarter" data-i18n="pipe_quarter">Este Trimestre</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="quickAddAction('estimate')">+ <span data-i18n="pipe_new_est">Nuevo Estimado</span></button>
                </div>
              </div>

              <!-- Pipeline Kanban Board -->
              <div class="pipeline-kanban" id="pipelineKanban">
                <div class="kanban-col kanban-new">
                  <div class="kanban-col-header"><span data-i18n="pipe_new">Nuevos</span> <span class="kanban-count" id="kanbanNewCount">0</span></div>
                  <div class="kanban-items" id="kanbanNew"></div>
                </div>
                <div class="kanban-col kanban-quoted">
                  <div class="kanban-col-header"><span data-i18n="pipe_quoted">Cotizados</span> <span class="kanban-count" id="kanbanQuotedCount">0</span></div>
                  <div class="kanban-items" id="kanbanQuoted"></div>
                </div>
                <div class="kanban-col kanban-approved">
                  <div class="kanban-col-header"><span data-i18n="pipe_approved">Aprobados</span> <span class="kanban-count" id="kanbanApprovedCount">0</span></div>
                  <div class="kanban-items" id="kanbanApproved"></div>
                </div>
                <div class="kanban-col kanban-scheduled">
                  <div class="kanban-col-header"><span data-i18n="pipe_scheduled">Agendados</span> <span class="kanban-count" id="kanbanScheduledCount">0</span></div>
                  <div class="kanban-items" id="kanbanScheduled"></div>
                </div>
                <div class="kanban-col kanban-won">
                  <div class="kanban-col-header"><span data-i18n="pipe_won">Ganados</span> <span class="kanban-count" id="kanbanWonCount">0</span></div>
                  <div class="kanban-items" id="kanbanWon"></div>
                </div>
              </div>

              <!-- Pipeline Stats -->
              <div class="hcp-ytd-grid" style="margin-top:16px;">
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_total_value">VALOR TOTAL</span><span class="hcp-ytd-value" id="pipeTotalValue">$0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_conversion">TASA DE CONVERSIÃ“N</span><span class="hcp-ytd-value" id="pipeConvRate">0%</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_avg_deal">TRATO PROMEDIO</span><span class="hcp-ytd-value" id="pipeAvgDeal">$0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pipe_avg_close">DÃAS PARA CERRAR</span><span class="hcp-ytd-value" id="pipeAvgClose">0</span></div>
              </div>
            </div>
          </div>

          <!-- ===== MY MONEY / MI DINERO ===== -->
          <div id="mymoney-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’µ</span> <span data-i18n="money_income">Ingresos</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#10b981;" id="moneyIncome">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¤</span> <span data-i18n="money_expenses">Gastos</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#ef4444;" id="moneyExpenses">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> <span data-i18n="money_profit">Ganancia Neta</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#3b82f6;" id="moneyProfit">$0.00</span><span class="hcp-sub-amount" data-i18n="money_this_month">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â³</span> <span data-i18n="money_outstanding">Por Cobrar</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="color:#f59e0b;" id="moneyOutstanding">$0.00</span><span class="hcp-sub-amount" data-i18n="money_overdue_invoices">Facturas pendientes</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ’µ <span data-i18n="money_transactions">Transacciones</span></h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showMoneyExpenseForm()" data-i18n="money_add_expense">+ Agregar Gasto</button>
                  <select id="moneyPeriodFilter" class="inline-select" onchange="renderMyMoney()" style="padding:6px 10px;font-size:12px;">
                    <option value="month" data-i18n="money_f_month">Este Mes</option>
                    <option value="quarter" data-i18n="money_f_quarter">Este Trimestre</option>
                    <option value="year" data-i18n="money_f_year">Este AÃ±o</option>
                  </select>
                </div>
              </div>

              <!-- Expense Form -->
              <div id="moneyExpFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="money_new_expense">Nuevo Gasto</h4>
                <form onsubmit="handleMoneyExpCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="money_desc">DescripciÃ³n</label><input type="text" id="moneyExpDesc" required placeholder="Ej: Materiales, Herramientas..."></div>
                    <div class="form-group"><label data-i18n="money_amount">Monto</label><input type="number" id="moneyExpAmount" required min="0" step="0.01" placeholder="0.00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="money_category">CategorÃ­a</label>
                      <select id="moneyExpCat">
                        <option value="materials">Materiales / Parts</option>
                        <option value="tools">Herramientas</option>
                        <option value="fuel">Gasolina / Fuel</option>
                        <option value="vehicle">VehÃ­culo / Vehicle</option>
                        <option value="insurance">Seguros / Insurance</option>
                        <option value="licenses">Licencias / Licenses</option>
                        <option value="marketing">Mercadotecnia / Publicidad</option>
                        <option value="payroll">NÃ³mina / Payroll</option>
                        <option value="rent">Renta / Rent</option>
                        <option value="utilities">Servicios / Utilities</option>
                        <option value="other">Otro / Other</option>
                      </select>
                    </div>
                    <div class="form-group"><label data-i18n="money_date">Fecha</label><input type="date" id="moneyExpDate"></div>
                  </div>
                  <div class="form-group"><label data-i18n="money_notes">Notas</label><textarea id="moneyExpNotes2" rows="2" placeholder="Notas adicionales..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="money_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideMoneyExpenseForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Profit/Loss Chart -->
              <div id="moneyChart" class="pipeline-chart" style="margin-bottom:16px;"></div>

              <!-- Transactions Table -->
              <div id="moneyTransactions"></div>
            </div>
          </div>

          <!-- ===== PAYROLL / NÃ“MINA ===== -->
          <div id="payroll-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ‘·</span> <span data-i18n="pay_employees">Empleados</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payEmployeeCount">0</span><span class="hcp-sub-amount" data-i18n="pay_active">Activos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> <span data-i18n="pay_this_period">Este PerÃ­odo</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payPeriodTotal">$0.00</span><span class="hcp-sub-amount" data-i18n="pay_total_payroll">Total nÃ³mina</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â°</span> <span data-i18n="pay_hours">Horas</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payTotalHours">0</span><span class="hcp-sub-amount" data-i18n="pay_this_week">Esta semana</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“‹</span> <span data-i18n="pay_pending">Pendiente</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="payPending">0</span><span class="hcp-sub-amount" data-i18n="pay_to_process">Por procesar</span></div>
              </div>
            </div>

            <div class="card">
              <div class="card-top">
                <h3>ğŸ§¾ <span data-i18n="pay_title">NÃ³mina</span></h3>
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary btn-sm" onclick="showPayrollEntry()">+ <span data-i18n="pay_add_entry">Agregar Entrada</span></button>
                  <select id="payPeriodFilter" class="inline-select" onchange="renderPayroll()" style="padding:6px 10px;font-size:12px;">
                    <option value="week" data-i18n="pay_f_week">Esta Semana</option>
                    <option value="biweekly" data-i18n="pay_f_biweek">Quincenal</option>
                    <option value="month" data-i18n="pay_f_month">Mensual</option>
                  </select>
                </div>
              </div>

              <div id="payrollFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="pay_new_entry">Nueva Entrada de NÃ³mina</h4>
                <form onsubmit="handlePayrollCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_tech">TÃ©cnico</label><select id="payTechSelect"></select></div>
                    <div class="form-group"><label data-i18n="pay_type">Tipo</label>
                      <select id="payType">
                        <option value="hourly">Por Hora</option>
                        <option value="salary">Salario</option>
                        <option value="commission">ComisiÃ³n</option>
                        <option value="bonus">Bono</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_hours_worked">Horas Trabajadas</label><input type="number" id="payHours" min="0" step="0.5" placeholder="40"></div>
                    <div class="form-group"><label data-i18n="pay_rate">Tarifa ($)</label><input type="number" id="payRate" min="0" step="0.01" placeholder="25.00"></div>
                    <div class="form-group"><label data-i18n="pay_total">Total ($)</label><input type="number" id="payTotal" min="0" step="0.01" placeholder="1000.00"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pay_period_start">Inicio del PerÃ­odo</label><input type="date" id="payStart"></div>
                    <div class="form-group"><label data-i18n="pay_period_end">Fin del PerÃ­odo</label><input type="date" id="payEnd"></div>
                  </div>
                  <div class="form-group"><label data-i18n="pay_notes">Notas</label><textarea id="payNotes" rows="2" placeholder="Tiempo extra, deducciones, notas..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="pay_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hidePayrollEntry()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Payroll Table -->
              <div id="payrollTable"></div>
            </div>

            <!-- ===== PAYROLL PROVIDER MANAGER ===== -->
            <div class="card" style="margin-top:16px;">
              <div class="card-top">
                <h3>ğŸ”— <span data-i18n="pay_provider_title">Proveedor de NÃ³mina</span></h3>
                <span class="badge" id="payProviderStatus" style="background:#f59e0b22;color:#f59e0b;">No conectado</span>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;" data-i18n="pay_provider_desc">Conecta tu proveedor de nÃ³mina para sincronizar horas, pagos y reportes automÃ¡ticamente.</p>

              <!-- Provider Cards -->
              <div class="payroll-providers-grid">
                <div class="payroll-provider-card" id="providerCard_adp" onclick="selectPayrollProvider('adp')">
                  <div class="provider-logo">ADP</div>
                  <div class="provider-info">
                    <strong>ADP Workforce</strong>
                    <small>NÃ³mina completa, impuestos, beneficios</small>
                  </div>
                  <span class="provider-check" id="providerCheck_adp">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_gusto" onclick="selectPayrollProvider('gusto')">
                  <div class="provider-logo" style="background:#f45d48;">Gusto</div>
                  <div class="provider-info">
                    <strong>Gusto</strong>
                    <small>NÃ³mina para pequeÃ±as empresas</small>
                  </div>
                  <span class="provider-check" id="providerCheck_gusto">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_qb" onclick="selectPayrollProvider('qb')">
                  <div class="provider-logo" style="background:#2ca01c;">QB</div>
                  <div class="provider-info">
                    <strong>QuickBooks NÃ³mina</strong>
                    <small>Integrado con contabilidad QB</small>
                  </div>
                  <span class="provider-check" id="providerCheck_qb">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_paychex" onclick="selectPayrollProvider('paychex')">
                  <div class="provider-logo" style="background:#004b87;">PCX</div>
                  <div class="provider-info">
                    <strong>Paychex</strong>
                    <small>NÃ³mina y HR para empresas medianas</small>
                  </div>
                  <span class="provider-check" id="providerCheck_paychex">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_square" onclick="selectPayrollProvider('square')">
                  <div class="provider-logo" style="background:#006aff;">â– </div>
                  <div class="provider-info">
                    <strong>Square NÃ³mina</strong>
                    <small>NÃ³mina + pagos con Square</small>
                  </div>
                  <span class="provider-check" id="providerCheck_square">â—‹</span>
                </div>
                <div class="payroll-provider-card" id="providerCard_manual" onclick="selectPayrollProvider('manual')">
                  <div class="provider-logo" style="background:#64748b;">âœ‹</div>
                  <div class="provider-info">
                    <strong data-i18n="pay_manual">Manual / Sin Proveedor</strong>
                    <small data-i18n="pay_manual_desc">Administra nÃ³mina manualmente en Trade Master</small>
                  </div>
                  <span class="provider-check" id="providerCheck_manual">â—‹</span>
                </div>
              </div>

              <!-- Provider Config (shown after selection) -->
              <div id="providerConfigArea" style="display:none;margin-top:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" id="providerConfigTitle">Configurar Proveedor</h4>
                <div class="form-row">
                  <div class="form-group"><label data-i18n="pay_api_key">API Key / Client ID</label><input type="text" id="providerApiKey" placeholder="Ingresa tu API Key..."></div>
                  <div class="form-group"><label data-i18n="pay_api_secret">API Secret</label><input type="password" id="providerApiSecret" placeholder="Ingresa tu Secret..."></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label data-i18n="pay_company_id">Company ID</label><input type="text" id="providerCompanyId" placeholder="ID de tu empresa en el proveedor"></div>
                  <div class="form-group"><label data-i18n="pay_sync_freq">Frecuencia de Sync</label>
                    <select id="providerSyncFreq">
                      <option value="manual">Manual</option>
                      <option value="daily">Diario</option>
                      <option value="weekly">Semanal</option>
                      <option value="biweekly">Quincenal</option>
                    </select>
                  </div>
                </div>
                <div class="form-row" style="margin-top:8px;">
                  <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="providerSyncHours" checked> <label style="margin:0;font-size:12px;" data-i18n="pay_sync_hours">Sincronizar horas de Entrada/Salida</label>
                  </div>
                  <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="providerSyncRates" checked> <label style="margin:0;font-size:12px;" data-i18n="pay_sync_rates">Sincronizar tarifas de tÃ©cnicos</label>
                  </div>
                </div>
                <div class="form-actions" style="margin-top:12px;">
                  <button class="btn-primary btn-sm" onclick="savePayrollProvider()">ğŸ”— <span data-i18n="pay_connect">Conectar</span></button>
                  <button class="btn-secondary btn-sm" onclick="testPayrollConnection()" data-i18n="pay_test">ğŸ§ª Probar ConexiÃ³n</button>
                  <button class="btn-secondary btn-sm" onclick="syncPayrollNow()" data-i18n="pay_sync_now">ğŸ”„ Sincronizar Ahora</button>
                  <button class="btn-secondary btn-sm" style="color:#ef4444;" onclick="disconnectProvider()" data-i18n="pay_disconnect">âœ• Desconectar</button>
                </div>
                <div id="providerSyncStatus" style="margin-top:10px;font-size:12px;color:var(--text-muted);"></div>
              </div>

              <!-- Sync History -->
              <div style="margin-top:12px;">
                <h4 style="font-size:13px;color:var(--text-muted);margin-bottom:8px;" data-i18n="pay_sync_history">Historial de SincronizaciÃ³n</h4>
                <div id="providerSyncHistory"></div>
              </div>
            </div>
          </div>

          <!-- ===== RECIBOS DE PROVEEDORES ===== -->
          <div id="receipts-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ§¾</span> Total Recibos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptTotal">0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’°</span> Total Gastado</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptTotalSpent">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¦</span> Proveedores</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptProviders">0</span><span class="hcp-sub-amount">Activos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¸</span> Sin Foto</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="rcptNoPhoto">0</span><span class="hcp-sub-amount">Pendientes</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ§¾ Recibos de Proveedores</h3>
                <button class="btn-primary btn-sm" onclick="showReceiptForm()">+ Agregar Recibo</button>
              </div>

              <div id="receiptFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Nuevo Recibo</h4>
                <form onsubmit="handleReceiptCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Proveedor</label>
                      <select id="rcptProvider">
                        <optgroup label="ğŸª Distribuidores HVAC/R">
                          <option value="Ferguson">Ferguson HVAC</option>
                          <option value="Johnstone Supply">Johnstone Supply</option>
                          <option value="Carrier Enterprise">Carrier Enterprise</option>
                          <option value="US Air Conditioning">US Air Conditioning</option>
                          <option value="Gemaire">Gemaire</option>
                          <option value="Grainger">Grainger</option>
                          <option value="SupplyHouse">SupplyHouse.com</option>
                          <option value="Trane Supply">Trane Supply</option>
                          <option value="LennoxPros">LennoxPros</option>
                        </optgroup>
                        <optgroup label="ğŸ  Tiendas Generales">
                          <option value="Home Depot">Home Depot</option>
                          <option value="Lowes">Lowe's</option>
                          <option value="Ace Hardware">Ace Hardware</option>
                          <option value="Harbor Freight">Harbor Freight</option>
                          <option value="Walmart">Walmart</option>
                          <option value="Costco">Costco</option>
                        </optgroup>
                        <optgroup label="ğŸŒ En LÃ­nea">
                          <option value="Amazon">Amazon</option>
                          <option value="eBay">eBay</option>
                        </optgroup>
                        <optgroup label="â›½ Gasolina y VehÃ­culos">
                          <option value="Shell">Shell</option>
                          <option value="Chevron">Chevron</option>
                          <option value="ARCO">ARCO</option>
                          <option value="AutoZone">AutoZone</option>
                          <option value="OReilly">O'Reilly Auto</option>
                        </optgroup>
                        <option value="__other__">âœï¸ Otro proveedor...</option>
                      </select>
                    </div>
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="rcptCategory">
                        <option value="ac_equipment">Equipos de Aire Acondicionado</option>
                        <option value="refrigeration_equipment">Equipos de RefrigeraciÃ³n</option>
                        <option value="heating_equipment">Equipos de CalefacciÃ³n</option>
                        <option value="parts">Partes y Refacciones</option>
                        <option value="refrigerant">Refrigerantes</option>
                        <option value="tools">Herramientas</option>
                        <option value="electrical">Material ElÃ©ctrico</option>
                        <option value="ductwork">Ductos y Accesorios</option>
                        <option value="filters">Filtros</option>
                        <option value="gas_fuel">Gasolina / Combustible</option>
                        <option value="vehicle">VehÃ­culo / Mantenimiento</option>
                        <option value="office">Oficina / PapelerÃ­a</option>
                        <option value="safety">Seguridad / EPP</option>
                        <option value="misc">MiscelÃ¡neo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Monto ($)</label><input type="number" id="rcptAmount" min="0" step="0.01" required placeholder="0.00"></div>
                    <div class="form-group"><label>Impuesto ($)</label><input type="number" id="rcptTax" min="0" step="0.01" placeholder="0.00"></div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="rcptDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label># de Recibo / Invoice</label><input type="text" id="rcptNumber" placeholder="Ej: INV-12345"></div>
                    <div class="form-group"><label>MÃ©todo de Pago</label>
                      <select id="rcptPayMethod">
                        <option value="credit_card">Tarjeta de CrÃ©dito</option>
                        <option value="debit_card">Tarjeta de DÃ©bito</option>
                        <option value="cash">Efectivo</option>
                        <option value="check">Cheque</option>
                        <option value="transfer">Transferencia</option>
                        <option value="account">Cuenta del Proveedor</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Trabajo Relacionado</label>
                      <select id="rcptJobId"><option value="">-- Sin trabajo --</option></select>
                    </div>
                  </div>
                  <div class="form-group"><label>DescripciÃ³n / Items</label><textarea id="rcptDescription" rows="2" placeholder="Ej: 2x Capacitor 45/5 MFD, 1x Contactor 2P 40A"></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“¸ Foto del Recibo</label>
                    <div id="rcptPhotoZone" style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('rcptPhotoInput').click()">
                      <span style="font-size:24px;">ğŸ“·</span>
                      <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic o arrastra la foto del recibo aquÃ­</p>
                      <img id="rcptPhotoPreview" src="" style="display:none;max-width:200px;margin-top:8px;border-radius:6px;">
                    </div>
                    <input type="file" id="rcptPhotoInput" accept="image/*" style="display:none" onchange="previewReceiptPhoto(this)">
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Recibo</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideReceiptForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Filters -->
              <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                <select id="rcptFilterProvider" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todos los Proveedores</option>
                </select>
                <select id="rcptFilterCategory" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todas las CategorÃ­as</option>
                  <option value="ac_equipment">Equipos AC</option>
                  <option value="refrigeration_equipment">Equipos RefrigeraciÃ³n</option>
                  <option value="parts">Partes</option>
                  <option value="tools">Herramientas</option>
                  <option value="gas_fuel">Gasolina</option>
                  <option value="vehicle">VehÃ­culo</option>
                  <option value="misc">MiscelÃ¡neo</option>
                </select>
                <select id="rcptFilterMonth" onchange="renderReceipts()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;">
                  <option value="">Todo el AÃ±o</option>
                  <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                  <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                  <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                  <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                <button class="btn-secondary btn-sm" onclick="exportReceiptsCSV()">ğŸ“¥ Exportar CSV</button>
              </div>

              <div id="receiptsList"></div>
            </div>
          </div>

          <!-- ===== GASTOS DEL NEGOCIO ===== -->
          <div id="expenses-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #ef4444;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ¢</span> Gastos Fijos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expFixed">$0</span><span class="hcp-sub-amount">Mensuales</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ”„</span> Gastos Variables</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expVariable">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“Š</span> Total Gastos</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="expTotal">$0</span><span class="hcp-sub-amount">Este mes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“—</span> QuickBooks</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" style="font-size:16px;">ğŸ”—</span><span class="hcp-sub-amount"><a href="https://quickbooks.intuit.com" target="_blank" style="color:var(--primary);">Ir a QuickBooks</a></span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ¢ Gastos Fijos y Recurrentes del Negocio</h3>
                <button class="btn-primary btn-sm" onclick="showExpenseForm()">+ Agregar Gasto</button>
              </div>

              <div id="expenseFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ’¸ Nuevo Gasto del Negocio</h4>
                <form onsubmit="handleExpenseCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="expCategory">
                        <optgroup label="ğŸ  Local / Oficina">
                          <option value="rent">Renta del Local / Oficina</option>
                          <option value="utilities_electric">Electricidad</option>
                          <option value="utilities_water">Agua</option>
                          <option value="utilities_gas">Gas Natural</option>
                          <option value="internet">Internet / TelÃ©fono</option>
                          <option value="storage">AlmacÃ©n / Bodega</option>
                        </optgroup>
                        <optgroup label="ğŸš VehÃ­culos">
                          <option value="vehicle_insurance">Seguro de VehÃ­culos</option>
                          <option value="vehicle_payment">Pago de VehÃ­culo / Lease</option>
                          <option value="vehicle_gas">Gasolina</option>
                          <option value="vehicle_maintenance">Mantenimiento de VehÃ­culo</option>
                          <option value="vehicle_registration">Registro / Placas</option>
                        </optgroup>
                        <optgroup label="ğŸ›¡ï¸ Seguros">
                          <option value="general_liability">General Liability Insurance</option>
                          <option value="workers_comp">Workers Compensation</option>
                          <option value="bond">Contractor Bond</option>
                          <option value="health_insurance">Seguro MÃ©dico</option>
                          <option value="e_and_o">Errors & Omissions</option>
                        </optgroup>
                        <optgroup label="ğŸ“œ Licencias y Permisos">
                          <option value="contractor_license">Licencia de Contratista</option>
                          <option value="business_license">Licencia de Negocio</option>
                          <option value="epa_cert">Certificaciones EPA / NATE</option>
                          <option value="city_permits">Permisos de la Ciudad</option>
                        </optgroup>
                        <optgroup label="ğŸ’» Software y Servicios">
                          <option value="software_crm">CRM / Software de GestiÃ³n</option>
                          <option value="software_accounting">QuickBooks / Contabilidad</option>
                          <option value="software_marketing">Publicidad / Marketing</option>
                          <option value="website">Sitio Web / Hosting</option>
                          <option value="answering_service">Servicio de ContestaciÃ³n</option>
                        </optgroup>
                        <optgroup label="ğŸ¦ Financiero">
                          <option value="loan_payment">Pago de PrÃ©stamo</option>
                          <option value="equipment_lease">Leasing de Equipos</option>
                          <option value="taxes">Impuestos</option>
                          <option value="accounting">Contador / CPA</option>
                          <option value="bank_fees">Comisiones Bancarias</option>
                        </optgroup>
                        <option value="other">Otro</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Proveedor / A quiÃ©n se paga</label><input type="text" id="expVendor" placeholder="Ej: State Farm, QuickBooks, Landlord"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Monto ($)</label><input type="number" id="expAmount" min="0" step="0.01" required placeholder="0.00"></div>
                    <div class="form-group"><label>Frecuencia</label>
                      <select id="expFrequency">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="semi_annual">Semestral</option>
                        <option value="annual">Anual</option>
                        <option value="one_time">Una sola vez</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Fecha de Pago</label><input type="date" id="expDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Tipo</label>
                      <select id="expType">
                        <option value="fixed">Gasto Fijo</option>
                        <option value="variable">Gasto Variable</option>
                      </select>
                    </div>
                    <div class="form-group"><label>MÃ©todo de Pago</label>
                      <select id="expPayMethod">
                        <option value="ach">ACH / DÃ©bito AutomÃ¡tico</option>
                        <option value="credit_card">Tarjeta de CrÃ©dito</option>
                        <option value="check">Cheque</option>
                        <option value="cash">Efectivo</option>
                        <option value="transfer">Transferencia</option>
                      </select>
                    </div>
                    <div class="form-group"><label># de PÃ³liza / Cuenta</label><input type="text" id="expPolicyNum" placeholder="# de referencia"></div>
                  </div>
                  <div class="form-group"><label>Notas</label><textarea id="expNotes" rows="2" placeholder="Detalles adicionales..."></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“¸ Foto de Factura / Comprobante</label>
                    <div style="display:flex;gap:8px;">
                      <label class="btn-secondary btn-sm" style="cursor:pointer;">ğŸ“· Subir Foto <input type="file" id="expPhotoInput" accept="image/*,.pdf" style="display:none" onchange="previewExpensePhoto(this)"></label>
                      <span id="expPhotoName" style="font-size:11px;color:var(--text-muted);align-self:center;"></span>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar Gasto</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideExpenseForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <div id="expensesList"></div>
            </div>

            <!-- QuickBooks Integration -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“— IntegraciÃ³n con QuickBooks</h3>
              </div>
              <div style="display:flex;gap:16px;flex-wrap:wrap;padding:8px 0;">
                <a href="https://quickbooks.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#2ca01c;">QB</div>
                  <div class="supplier-info"><strong>QuickBooks Online</strong><small>Iniciar sesiÃ³n en tu cuenta</small></div>
                </a>
                <a href="https://selfemployed.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#0077c5;">SE</div>
                  <div class="supplier-info"><strong>QB Self-Employed</strong><small>Para contratistas independientes</small></div>
                </a>
                <a href="https://payroll.intuit.com" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#393185;">QP</div>
                  <div class="supplier-info"><strong>QB Payroll</strong><small>NÃ³mina y impuestos</small></div>
                </a>
                <a href="https://quickbooks.intuit.com/accounting/expenses/" target="_blank" class="supplier-card" style="flex:1;min-width:200px;">
                  <div class="supplier-logo" style="background:#2ca01c;">ğŸ“Š</div>
                  <div class="supplier-info"><strong>QB Expenses</strong><small>Rastreo de gastos</small></div>
                </a>
              </div>
              <p style="font-size:11px;color:var(--text-muted);margin-top:8px;">ğŸ’¡ <strong>Tip:</strong> Exporta tus recibos y gastos como CSV y sÃºbelos a QuickBooks para mantener tu contabilidad al dÃ­a. Tu contador puede acceder directamente a QuickBooks con su propia cuenta.</p>
              <div style="margin-top:8px;display:flex;gap:8px;">
                <button class="btn-primary btn-sm" style="background:#10b981;" onclick="exportReceiptsCSV()">ğŸ§¾ Exportar Recibos CSV</button>
                <button class="btn-primary btn-sm" style="background:#ef4444;" onclick="exportExpensesCSV()">ğŸ¢ Exportar Gastos CSV</button>
              </div>
            </div>
          </div>

          <!-- ===== CORREO DEL NEGOCIO ===== -->
          <div id="mailbox-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¥</span> Entrada</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailInCount">0</span><span class="hcp-sub-amount">Documentos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“¤</span> Salida</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailOutCount">0</span><span class="hcp-sub-amount">Documentos</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">âš ï¸</span> Urgente</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailUrgent">0</span><span class="hcp-sub-amount">Pendientes</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“</span> Archivados</div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mailArchived">0</span><span class="hcp-sub-amount">Total</span></div>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“¬ Correo del Negocio</h3>
                <button class="btn-primary btn-sm" onclick="showMailForm()">+ Agregar Documento</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">El coordinador de despacho puede subir correo fÃ­sico o digital importante del negocio: facturas de proveedores, avisos del gobierno, correspondencia de seguros, etc.</p>

              <div id="mailFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ“„ Nuevo Documento</h4>
                <form onsubmit="handleMailCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label>Tipo</label>
                      <select id="mailType">
                        <option value="incoming">ğŸ“¥ Correo Entrante</option>
                        <option value="outgoing">ğŸ“¤ Correo Saliente</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Prioridad</label>
                      <select id="mailPriority">
                        <option value="normal">Normal</option>
                        <option value="important">â­ Importante</option>
                        <option value="urgent">ğŸ”´ Urgente</option>
                      </select>
                    </div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="mailDate"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>De / Remitente</label><input type="text" id="mailFrom" placeholder="Ej: State Farm, City of San Bernardino"></div>
                    <div class="form-group"><label>CategorÃ­a</label>
                      <select id="mailCategory">
                        <option value="invoice">Factura / Invoice</option>
                        <option value="insurance">Seguros</option>
                        <option value="government">Gobierno / Permisos</option>
                        <option value="tax">Impuestos / IRS / FTB</option>
                        <option value="bank">Banco / Financiero</option>
                        <option value="vendor">Proveedor</option>
                        <option value="legal">Legal / Abogado</option>
                        <option value="warranty">GarantÃ­a</option>
                        <option value="customer">Cliente</option>
                        <option value="other">Otro</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group"><label>Asunto / DescripciÃ³n</label><input type="text" id="mailSubject" required placeholder="Ej: RenovaciÃ³n de pÃ³liza General Liability 2026"></div>
                  <div class="form-group"><label>Notas</label><textarea id="mailNotes" rows="2" placeholder="Detalles importantes, fechas lÃ­mite, acciones requeridas..."></textarea></div>
                  <div class="form-group">
                    <label>ğŸ“ Adjuntar Documento (foto, PDF, scan)</label>
                    <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;background:var(--bg-card);" onclick="document.getElementById('mailFileInput').click()">
                      <span style="font-size:24px;">ğŸ“</span>
                      <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Haz clic para subir foto, PDF o scan del documento</p>
                      <span id="mailFileName" style="font-size:12px;color:var(--primary);display:none;margin-top:6px;"></span>
                    </div>
                    <input type="file" id="mailFileInput" accept="image/*,.pdf,.doc,.docx" style="display:none" onchange="previewMailFile(this)">
                  </div>
                  <div class="form-group">
                    <label><input type="checkbox" id="mailNeedsAction"> âš¡ Requiere AcciÃ³n (aparecerÃ¡ en pendientes)</label>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ Guardar</button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideMailForm()">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Tabs -->
              <div style="display:flex;gap:4px;margin-bottom:12px;">
                <button class="import-tab active" onclick="setMailTab('all')" id="mailTabAll">ğŸ“¬ Todos</button>
                <button class="import-tab" onclick="setMailTab('incoming')" id="mailTabIn">ğŸ“¥ Entrante</button>
                <button class="import-tab" onclick="setMailTab('outgoing')" id="mailTabOut">ğŸ“¤ Saliente</button>
                <button class="import-tab" onclick="setMailTab('urgent')" id="mailTabUrgent">ğŸ”´ Urgente</button>
                <button class="import-tab" onclick="setMailTab('archived')" id="mailTabArchived">ğŸ“ Archivado</button>
              </div>

              <div id="mailList"></div>
            </div>
          </div>

          <!-- ===== MARKETING ===== -->
          <div id="marketing-section" class="section">
            <div class="hcp-summary-grid" style="margin-bottom:16px;">
              <div class="hcp-summary-card" style="border-left:4px solid #3b82f6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">â­</span> <span data-i18n="mkt_reviews">ReseÃ±as</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktReviewCount">0</span><span class="hcp-sub-amount" data-i18n="mkt_avg_rating">Rating promedio</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #10b981;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“§</span> <span data-i18n="mkt_campaigns">CampaÃ±as</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktCampaignCount">0</span><span class="hcp-sub-amount" data-i18n="mkt_active">Activas</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #f59e0b;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“±</span> <span data-i18n="mkt_lead_source">Fuentes de Leads</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktLeadSources">0</span><span class="hcp-sub-amount" data-i18n="mkt_channels">Canales</span></div>
              </div>
              <div class="hcp-summary-card" style="border-left:4px solid #8b5cf6;">
                <div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’¸</span> <span data-i18n="mkt_roi">Retorno de InversiÃ³n</span></div>
                <div class="hcp-summary-body"><span class="hcp-big-num" id="mktROI">0%</span><span class="hcp-sub-amount" data-i18n="mkt_return">Retorno</span></div>
              </div>
            </div>

            <!-- ===== PLATAFORMAS DE GENERACIÃ“N DE LEADS ===== -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ¯ Plataformas de GeneraciÃ³n de Leads</h3>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Accede directamente a tus plataformas para administrar campaÃ±as, responder leads y monitorear resultados.</p>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ“¢ Plataformas de Publicidad y Leads</h5>
              <div class="supplier-grid" style="margin-bottom:16px;">
                <a class="supplier-card" href="https://www.facebook.com/marketplace" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">f</div>
                  <div class="supplier-info"><strong>Facebook Marketplace</strong><small>Publica servicios y genera leads locales</small></div>
                </a>
                <a class="supplier-card" href="https://business.facebook.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">FB</div>
                  <div class="supplier-info"><strong>Facebook Business / Ads</strong><small>Administra campaÃ±as y anuncios pagados</small></div>
                </a>
                <a class="supplier-card" href="https://business.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#4285f4;">G</div>
                  <div class="supplier-info"><strong>Google My Business</strong><small>Perfil de negocio, reseÃ±as, fotos</small></div>
                </a>
                <a class="supplier-card" href="https://ads.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#34a853;">GA</div>
                  <div class="supplier-info"><strong>Google Ads</strong><small>CampaÃ±as de bÃºsqueda y display</small></div>
                </a>
                <a class="supplier-card" href="https://biz.yelp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#d32323;">Y</div>
                  <div class="supplier-info"><strong>Yelp para Negocios</strong><small>ReseÃ±as, fotos, responde a clientes</small></div>
                </a>
                <a class="supplier-card" href="https://www.angi.com/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6153;">AL</div>
                  <div class="supplier-info"><strong>Angi Leads (Angie's List)</strong><small>Leads de proyectos de hogar</small></div>
                </a>
                <a class="supplier-card" href="https://pro.homeadvisor.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#f68b24;">HA</div>
                  <div class="supplier-info"><strong>HomeAdvisor Pro</strong><small>Leads de servicios del hogar</small></div>
                </a>
                <a class="supplier-card" href="https://www.thumbtack.com/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#009fd9;">TT</div>
                  <div class="supplier-info"><strong>Thumbtack Pro</strong><small>Leads de servicios locales</small></div>
                </a>
                <a class="supplier-card" href="https://nextdoor.com/business" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#8ed500;">ND</div>
                  <div class="supplier-info"><strong>Nextdoor Business</strong><small>Recomendaciones del vecindario</small></div>
                </a>
                <a class="supplier-card" href="https://www.bbb.org" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#005a8c;">BB</div>
                  <div class="supplier-info"><strong>Better Business Bureau</strong><small>AcreditaciÃ³n y confianza</small></div>
                </a>
                <a class="supplier-card" href="https://www.bark.com/en/us/pro" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#00c4cc;">BK</div>
                  <div class="supplier-info"><strong>Bark Pro</strong><small>Leads de servicios profesionales</small></div>
                </a>
                <a class="supplier-card" href="https://www.networx.com/contractor" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0073bb;">NX</div>
                  <div class="supplier-info"><strong>Networx</strong><small>Leads de contratistas del hogar</small></div>
                </a>
              </div>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ“± Redes Sociales y Contenido</h5>
              <div class="supplier-grid" style="margin-bottom:16px;">
                <a class="supplier-card" href="https://www.facebook.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1877f2;">f</div>
                  <div class="supplier-info"><strong>Facebook</strong><small>Publica contenido, interactÃºa con clientes</small></div>
                </a>
                <a class="supplier-card" href="https://www.instagram.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);">IG</div>
                  <div class="supplier-info"><strong>Instagram</strong><small>Fotos y reels de trabajos completados</small></div>
                </a>
                <a class="supplier-card" href="https://www.tiktok.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#010101;">TK</div>
                  <div class="supplier-info"><strong>TikTok</strong><small>Videos cortos, tutoriales, tendencias</small></div>
                </a>
                <a class="supplier-card" href="https://www.youtube.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff0000;">YT</div>
                  <div class="supplier-info"><strong>YouTube</strong><small>Videos largos, tutoriales, canal de marca</small></div>
                </a>
                <a class="supplier-card" href="https://www.linkedin.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0a66c2;">in</div>
                  <div class="supplier-info"><strong>LinkedIn</strong><small>Red profesional, comercial e industrial</small></div>
                </a>
                <a class="supplier-card" href="https://x.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#000000;">ğ•</div>
                  <div class="supplier-info"><strong>X (Twitter)</strong><small>Noticias, actualizaciones rÃ¡pidas</small></div>
                </a>
                <a class="supplier-card" href="https://www.pinterest.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e60023;">P</div>
                  <div class="supplier-info"><strong>Pinterest</strong><small>Fotos de proyectos, antes/despuÃ©s</small></div>
                </a>
                <a class="supplier-card" href="https://business.whatsapp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#25d366;">WA</div>
                  <div class="supplier-info"><strong>WhatsApp Business</strong><small>ComunicaciÃ³n directa con clientes</small></div>
                </a>
              </div>

              <h5 style="color:var(--primary);margin-bottom:8px;font-size:12px;">ğŸ› ï¸ Herramientas de Mercadotecnia</h5>
              <div class="supplier-grid">
                <a class="supplier-card" href="https://www.canva.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#7d2ae8;">C</div>
                  <div class="supplier-info"><strong>Canva</strong><small>DiseÃ±a flyers, posts, tarjetas</small></div>
                </a>
                <a class="supplier-card" href="https://mailchimp.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ffe01b;color:#000;"><strong>MC</strong></div>
                  <div class="supplier-info"><strong>Mailchimp</strong><small>Email marketing y automatizaciÃ³n</small></div>
                </a>
                <a class="supplier-card" href="https://analytics.google.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e37400;">ğŸ“Š</div>
                  <div class="supplier-info"><strong>Google Analytics</strong><small>AnalÃ­tica web y trÃ¡fico</small></div>
                </a>
                <a class="supplier-card" href="https://search.google.com/search-console" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#4285f4;">SC</div>
                  <div class="supplier-info"><strong>Google Search Console</strong><small>SEO y posicionamiento web</small></div>
                </a>
                <a class="supplier-card" href="https://www.housecallpro.com/login" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6b35;">HC</div>
                  <div class="supplier-info"><strong>Housecall Pro</strong><small>CRM, reviews, booking online</small></div>
                </a>
                <a class="supplier-card" href="https://www.servicetitan.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1b2a4a;">ST</div>
                  <div class="supplier-info"><strong>ServiceTitan</strong><small>Plataforma de gestiÃ³n de servicios</small></div>
                </a>
              </div>
            </div>

            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“£ <span data-i18n="mkt_title">Mercadotecnia</span></h3>
                <button class="btn-primary btn-sm" onclick="showCampaignForm()">+ <span data-i18n="mkt_new_campaign">Nueva CampaÃ±a</span></button>
              </div>

              <div id="campaignFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="mkt_create_campaign">Crear CampaÃ±a</h4>
                <form onsubmit="handleCampaignCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="mkt_camp_name">Nombre</label><input type="text" id="campName" required placeholder="Ej: Promo Verano AC"></div>
                    <div class="form-group"><label data-i18n="mkt_camp_type">Tipo</label>
                      <select id="campType">
                        <option value="email">Correo ElectrÃ³nico</option>
                        <option value="sms">SMS / Texto</option>
                        <option value="social">Redes Sociales</option>
                        <option value="postcard">Postal / Postcard</option>
                        <option value="referral">Referidos / Referido</option>
                        <option value="google_ads">Google Ads</option>
                        <option value="facebook_ads">Facebook Ads</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="mkt_budget">Presupuesto ($)</label><input type="number" id="campBudget" min="0" step="0.01" placeholder="500.00"></div>
                    <div class="form-group"><label data-i18n="mkt_start">Inicio</label><input type="date" id="campStart"></div>
                    <div class="form-group"><label data-i18n="mkt_end">Fin</label><input type="date" id="campEnd"></div>
                  </div>
                  <div class="form-group"><label data-i18n="mkt_message">Mensaje</label><textarea id="campMessage" rows="3" placeholder="Contenido de la campaÃ±a..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="mkt_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hideCampaignForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Lead Source Breakdown -->
              <h4 style="margin:12px 0 8px;color:var(--text-muted);font-size:13px;" data-i18n="mkt_lead_breakdown">Desglose de Fuentes de Leads</h4>
              <div id="leadSourceChart" class="pipeline-chart" style="margin-bottom:16px;"></div>

              <!-- Campaigns List -->
              <div id="campaignsList"></div>
            </div>

            <!-- Review Request Tool -->
            <div class="card">
              <div class="card-top">
                <h3>â­ <span data-i18n="mkt_review_requests">Solicitar ReseÃ±as</span></h3>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;" data-i18n="mkt_review_desc">EnvÃ­a solicitudes de reseÃ±as a tus clientes satisfechos para mejorar tu presencia en lÃ­nea.</p>
              <div class="form-row">
                <div class="form-group"><label data-i18n="mkt_select_client">Cliente</label><select id="reviewClientSelect"></select></div>
                <div class="form-group"><label data-i18n="mkt_platform">Plataforma</label>
                  <select id="reviewPlatform">
                    <option value="google">Google Business</option>
                    <option value="yelp">Yelp</option>
                    <option value="facebook">Facebook</option>
                    <option value="nextdoor">Nextdoor</option>
                  </select>
                </div>
              </div>
              <button class="btn-primary btn-sm" onclick="sendReviewRequest()" data-i18n="mkt_send_request">ğŸ“§ Enviar Solicitud</button>
              <div id="reviewHistory" style="margin-top:12px;"></div>
            </div>
          </div>

          <!-- ===== PRICE BOOK / LISTA DE PRECIOS ===== -->
          <div id="pricebook-section" class="section">

            <!-- Supplier Quick Links -->
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸª <span data-i18n="pb_suppliers">Proveedores</span></h3>
                <button class="btn-primary btn-sm" onclick="loadDefaultPriceBook()">ğŸ“¦ <span data-i18n="pb_load_catalog">Cargar CatÃ¡logo HVAC Completo</span></button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;" data-i18n="pb_supplier_desc">Busca precios directamente en los distribuidores mÃ¡s usados en HVAC/R. Haz clic para abrir su sitio.</p>
              <div class="supplier-grid">
                <a class="supplier-card" href="https://www.ferguson.com/category/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#003da5;">F</div>
                  <div class="supplier-info"><strong>Ferguson HVAC</strong><small>TuberÃ­a, conexiones, equipos</small></div>
                </a>
                <a class="supplier-card" href="https://www.johnstonewaregroup.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e31837;">JS</div>
                  <div class="supplier-info"><strong>Johnstone Supply</strong><small>Partes AC/CalefacciÃ³n, refrigerantes</small></div>
                </a>
                <a class="supplier-card" href="https://www.carrierenterprise.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0057a0;">CE</div>
                  <div class="supplier-info"><strong>Carrier Enterprise</strong><small>Equipos Carrier, Bryant, Payne</small></div>
                </a>
                <a class="supplier-card" href="https://www.usaircon.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff6b00;">US</div>
                  <div class="supplier-info"><strong>US Air Conditioning</strong><small>Goodman, Daikin, Amana</small></div>
                </a>
                <a class="supplier-card" href="https://www.gemaire.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#1a8c3e;">GE</div>
                  <div class="supplier-info"><strong>Gemaire Distributors</strong><small>Rheem, Ruud, equipos completos</small></div>
                </a>
                <a class="supplier-card" href="https://www.grainger.com/category/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#c8102e;">GR</div>
                  <div class="supplier-info"><strong>Grainger</strong><small>Motores, controles, herramientas</small></div>
                </a>
                <a class="supplier-card" href="https://www.supplyhouse.com/hvac" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#0077c8;">SH</div>
                  <div class="supplier-info"><strong>SupplyHouse</strong><small>Mini-splits, boilers, partes</small></div>
                </a>
                <a class="supplier-card" href="https://www.amazon.com/s?k=hvac+parts" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#ff9900;">AZ</div>
                  <div class="supplier-info"><strong>Amazon HVAC</strong><small>Partes, herramientas, accesorios</small></div>
                </a>
                <a class="supplier-card" href="https://www.homedepot.com/b/Heating-Venting-Cooling/N-5yc1vZc4k8" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#f96302;">HD</div>
                  <div class="supplier-info"><strong>Home Depot Pro</strong><small>Equipos, filtros, ductos</small></div>
                </a>
                <a class="supplier-card" href="https://www.ebay.com/b/HVAC-Parts/41986/bn_1865194" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#e53238;">eB</div>
                  <div class="supplier-info"><strong>eBay HVAC Parts</strong><small>Partes usadas y nuevas, boards</small></div>
                </a>
                <a class="supplier-card" href="https://www.trane.com/commercial/north-america/us/en.html" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#002f6c;">TR</div>
                  <div class="supplier-info"><strong>Trane Supply</strong><small>Equipos y partes Trane/American Standard</small></div>
                </a>
                <a class="supplier-card" href="https://www.lennoxpros.com" target="_blank" rel="noopener">
                  <div class="supplier-logo" style="background:#003087;">LX</div>
                  <div class="supplier-info"><strong>LennoxPros</strong><small>Equipos y partes Lennox</small></div>
                </a>
              </div>
            </div>

            <div class="card">
              <div class="card-top">
                <h3>ğŸ“’ <span data-i18n="pb_title">Lista de Precios</span></h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="text" id="pbSearch" placeholder="ğŸ” Buscar parte, servicio..." oninput="filterPriceBook()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;width:200px;">
                  <select id="pbCategoryFilter" class="inline-select" onchange="filterPriceBook()" style="padding:8px 12px;font-size:12px;">
                    <option value="all" data-i18n="pb_all">Todas las categorÃ­as</option>
                    <option value="ac_parts">Partes de AC</option>
                    <option value="heating_parts">Partes de CalefacciÃ³n</option>
                    <option value="refrigeration">RefrigeraciÃ³n</option>
                    <option value="electrical">ElÃ©ctrico</option>
                    <option value="motors_fans">Motores y Ventiladores</option>
                    <option value="controls">Controles y Termostatos</option>
                    <option value="refrigerants">Refrigerantes</option>
                    <option value="ductwork">Ductos y Accesorios</option>
                    <option value="filters">Filtros</option>
                    <option value="tools">Herramientas</option>
                    <option value="labor">Mano de Obra</option>
                    <option value="equipment">Equipo Nuevo</option>
                    <option value="misc">MiscelÃ¡neos</option>
                  </select>
                  <button class="btn-primary btn-sm" onclick="showPriceBookForm()">+ <span data-i18n="pb_add_item">Agregar ArtÃ­culo</span></button>
                  <button class="btn-secondary btn-sm" onclick="clearPriceBook()" style="color:#ef4444;">ğŸ—‘ï¸</button>
                </div>
              </div>

              <div id="priceBookFormContainer" style="display:none;margin:16px 0;padding:16px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;">
                <h4 style="color:var(--primary);margin-bottom:10px;" data-i18n="pb_new_item">Nuevo ArtÃ­culo</h4>
                <form onsubmit="handlePriceBookCreate(event)">
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_name">Nombre</label><input type="text" id="pbName" required placeholder="Ej: Capacitor 45/5 MFD"></div>
                    <div class="form-group"><label data-i18n="pb_sku">SKU / Part #</label><input type="text" id="pbSku" placeholder="CAP-455"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_category">CategorÃ­a</label>
                      <select id="pbCategory">
                        <option value="ac_parts">Partes de AC</option>
                        <option value="heating_parts">Partes de CalefacciÃ³n</option>
                        <option value="refrigeration">RefrigeraciÃ³n</option>
                        <option value="electrical">ElÃ©ctrico</option>
                        <option value="motors_fans">Motores y Ventiladores</option>
                        <option value="controls">Controles y Termostatos</option>
                        <option value="refrigerants">Refrigerantes</option>
                        <option value="ductwork">Ductos y Accesorios</option>
                        <option value="filters">Filtros</option>
                        <option value="tools">Herramientas</option>
                        <option value="labor">Mano de Obra</option>
                        <option value="equipment">Equipo Nuevo</option>
                        <option value="misc">MiscelÃ¡neos</option>
                      </select>
                    </div>
                    <div class="form-group"><label data-i18n="pb_unit">Unidad</label>
                      <select id="pbUnit">
                        <option value="each">Pieza</option>
                        <option value="hour">Hora</option>
                        <option value="foot">Pie</option>
                        <option value="lb">Libra</option>
                        <option value="flat">Precio Fijo</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label data-i18n="pb_cost">Costo ($)</label><input type="number" id="pbCost" min="0" step="0.01" placeholder="15.00"></div>
                    <div class="form-group"><label data-i18n="pb_price">Precio de Venta ($)</label><input type="number" id="pbPrice" required min="0" step="0.01" placeholder="45.00"></div>
                    <div class="form-group"><label data-i18n="pb_markup">Markup %</label><input type="number" id="pbMarkup" readonly style="background:var(--bg-card);"></div>
                  </div>
                  <div class="form-group"><label data-i18n="pb_description">DescripciÃ³n</label><textarea id="pbDesc" rows="2" placeholder="DescripciÃ³n del artÃ­culo..."></textarea></div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary btn-sm">ğŸ’¾ <span data-i18n="pb_save">Guardar</span></button>
                    <button type="button" class="btn-secondary btn-sm" onclick="hidePriceBookForm()" data-i18n="btn_cancel">Cancelar</button>
                  </div>
                </form>
              </div>

              <!-- Price Book Stats -->
              <div class="hcp-ytd-grid" style="margin:12px 0;">
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_total_items">TOTAL ARTÃCULOS</span><span class="hcp-ytd-value" id="pbTotalItems">0</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_avg_markup">MARKUP PROMEDIO</span><span class="hcp-ytd-value" id="pbAvgMarkup">0%</span></div>
                <div class="hcp-ytd-card"><span class="hcp-ytd-label" data-i18n="pb_categories">CATEGORÃAS</span><span class="hcp-ytd-value" id="pbCategories">0</span></div>
              </div>

              <!-- Price Book Table -->
              <div id="priceBookTable"></div>
            </div>
          </div>

          <!-- ===== REPORTS / REPORTES ===== -->
          <div id="reports-section" class="section">
            <div class="card" style="margin-bottom:16px;">
              <div class="card-top">
                <h3>ğŸ“Š <span data-i18n="rpt_title">Reportes</span></h3>
                <div style="display:flex;gap:8px;">
                  <select id="rptPeriod" class="inline-select" onchange="renderReports()" style="padding:8px 12px;font-size:12px;">
                    <option value="week" data-i18n="rpt_week">Esta Semana</option>
                    <option value="month" selected data-i18n="rpt_month">Este Mes</option>
                    <option value="quarter" data-i18n="rpt_quarter">Este Trimestre</option>
                    <option value="year" data-i18n="rpt_year">Este AÃ±o</option>
                    <option value="custom" data-i18n="rpt_custom">Personalizado</option>
                  </select>
                  <div id="rptCustomRange" style="display:none;gap:8px;">
                    <input type="date" id="rptStart" onchange="renderReports()">
                    <input type="date" id="rptEnd" onchange="renderReports()">
                  </div>
                </div>
              </div>

              <!-- Report Cards Grid -->
              <div class="hcp-summary-grid" style="margin-bottom:16px;">
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ’µ</span> <span data-i18n="rpt_revenue">Ingresos</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptRevenue">$0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“‹</span> <span data-i18n="rpt_jobs_done">Trabajos</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptJobsDone">0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ‘¥</span> <span data-i18n="rpt_new_customers">Nuevos Clientes</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptNewCustomers">0</span></div></div>
                <div class="hcp-summary-card"><div class="hcp-summary-header"><span class="hcp-summary-icon">ğŸ“ˆ</span> <span data-i18n="rpt_close_rate">Tasa de Cierre</span></div><div class="hcp-summary-body"><span class="hcp-big-num" id="rptCloseRate">0%</span></div></div>
              </div>
            </div>

            <!-- Revenue Chart -->
            <div class="card" style="margin-bottom:16px;">
              <h3>ğŸ’° <span data-i18n="rpt_revenue_chart">Ingresos por PerÃ­odo</span></h3>
              <div id="rptRevenueChart" class="pipeline-chart"></div>
            </div>

            <!-- Reports Grid -->
            <div class="cards-row">
              <div class="card">
                <h3>ğŸ”§ <span data-i18n="rpt_by_tech">Por TÃ©cnico</span></h3>
                <div id="rptByTech"></div>
              </div>
              <div class="card">
                <h3>ğŸ“Š <span data-i18n="rpt_by_source">Por Fuente</span></h3>
                <div id="rptBySource"></div>
              </div>
            </div>

            <div class="cards-row" style="margin-top:16px;">
              <div class="card">
                <h3>ğŸ† <span data-i18n="rpt_top_services">Top Servicios</span></h3>
                <div id="rptTopServices"></div>
              </div>
              <div class="card">
                <h3>ğŸ“… <span data-i18n="rpt_by_day">Por DÃ­a de la Semana</span></h3>
                <div id="rptByDay"></div>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>

    <!-- ==================== TECH TRACKING PAGE (separate URL) ==================== -->
    <div id="techTrackingPage" style="display:none;">
      <div class="tracking-container">
        <div class="tracking-header">
          <span>ğŸ”§</span>
          <h2>Trade Master - GPS Tracking</h2>
        </div>
        <h3 id="trackingTechName" style="text-align:center;color:var(--primary);margin-bottom:12px;">TÃ©cnico</h3>
        <div id="trackingStatus" class="tracking-status">Conectando...</div>
        <div id="trackingMap" style="width:100%;height:350px;border-radius:8px;margin:16px 0;"></div>
        <button id="clockInBtn" class="btn-primary" onclick="toggleClockIn()">ğŸŸ¢ Iniciar Jornada (Clock In)</button>
        <button id="trackingBtn" class="btn-primary" onclick="toggleTracking()" style="display:none;margin-top:10px;">â¸ï¸ Pausar Tracking GPS</button>
        <p id="trackingInfo" style="color:#94a3b8;font-size:13px;text-align:center;margin-top:12px;"></p>
        <div class="tracking-hours-info">
          <p>ğŸ“ Tu ubicaciÃ³n se envÃ­a cada 30 segundos mientras estÃ©s en servicio</p>
          <p>ğŸ”´ Al terminar tu jornada, haz Marcar Salida para dejar de compartir ubicaciÃ³n</p>
        </div>
      </div>
    </div>

    <!-- ==================== FLOATING SUPPORT BUTTON ==================== -->
    <div id="supportButton" class="support-fab" onclick="toggleSupportMenu()">
      <span class="support-fab-icon">ğŸ›Ÿ</span>
    </div>
    
    <div id="supportMenu" class="support-menu">
      <div class="support-menu-header">
        <h4>ğŸ›Ÿ Soporte TÃ©cnico</h4>
        <button onclick="toggleSupportMenu()" class="support-close">Ã—</button>
      </div>
      <div class="support-menu-body">
        <p style="margin-bottom:12px;color:#64748b;font-size:13px;">Â¿Necesitas ayuda? Estamos aquÃ­ para ti.</p>
        
        <a href="tel:+19096390448" class="support-option">
          <span class="support-option-icon" style="background:#dcfce7;color:#16a34a;">ğŸ“</span>
          <div>
            <strong>Llamar a Soporte</strong>
            <small>(909) 639-0448</small>
          </div>
        </a>
        
        <a href="/cdn-cgi/l/email-protection#5f2b2d3e3b3a323e2c2b3a2d2c2a2c3e3c2d321f38323e3633713c3032602c2a3d353a3c2b620c302f302d2b3a7a6d6f0b2d3e3b3a7a6d6f123e2c2b3a2d7a6d6f1c0d12" class="support-option">
          <span class="support-option-icon" style="background:#dbeafe;color:#1d4ed8;">ğŸ“§</span>
          <div>
            <strong>Enviar Email</strong>
            <small><span class="__cf_email__" data-cfemail="c1b5b3a0a5a4aca0b2b5a4b3b2b4b2a0a2b3ac81a6aca0a8adefa2aeac">[email&#160;protected]</span></small>
          </div>
        </a>
        
        <a href="https://wa.me/19096390448?text=Hola,%20necesito%20ayuda%20con%20Trade%20Master%20CRM" target="_blank" class="support-option">
          <span class="support-option-icon" style="background:#dcfce7;color:#16a34a;">ğŸ’¬</span>
          <div>
            <strong>WhatsApp</strong>
            <small>Chat en vivo</small>
          </div>
        </a>
        
        <div class="support-divider"></div>
        
        <a href="#" onclick="openForgotPassword();return false;" class="support-option">
          <span class="support-option-icon" style="background:#fef3c7;color:#d97706;">ğŸ”‘</span>
          <div>
            <strong>OlvidÃ© mi ContraseÃ±a</strong>
            <small>Recuperar acceso</small>
          </div>
        </a>
      </div>
      <div class="support-menu-footer">
        <small>Horario: Lun-Vie 8am-6pm PST</small>
      </div>
    </div>
    
    <style>
      /* Support FAB Button */
      .support-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #f97316, #ea580c);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(249,115,22,0.4);
        z-index: 9998;
        transition: all 0.3s ease;
      }
      .support-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(249,115,22,0.5);
      }
      .support-fab-icon {
        font-size: 28px;
      }
      
      /* Support Menu */
      .support-menu {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 300px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 50px rgba(0,0,0,0.2);
        z-index: 9999;
        display: none;
        overflow: hidden;
        animation: slideUp 0.3s ease;
      }
      .support-menu.show {
        display: block;
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .support-menu-header {
        background: linear-gradient(135deg, #1e3a5f, #2d4a6f);
        color: white;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .support-menu-header h4 {
        margin: 0;
        font-size: 16px;
      }
      .support-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        opacity: 0.8;
      }
      .support-close:hover { opacity: 1; }
      .support-menu-body {
        padding: 16px;
      }
      .support-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 10px;
        text-decoration: none;
        color: #1f2937;
        transition: background 0.2s;
        margin-bottom: 8px;
      }
      .support-option:hover {
        background: #f3f4f6;
      }
      .support-option-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .support-option strong {
        display: block;
        font-size: 14px;
      }
      .support-option small {
        color: #64748b;
        font-size: 12px;
      }
      .support-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 12px 0;
      }
      .support-menu-footer {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: center;
        color: #64748b;
        border-top: 1px solid #e5e7eb;
      }
      
      @media (max-width: 480px) {
        .support-fab {
          bottom: 16px;
          right: 16px;
          width: 54px;
          height: 54px;
        }
        .support-menu {
          right: 16px;
          left: 16px;
          width: auto;
          bottom: 86px;
        }
      }
    </style>

    <script src="script.js"></script>
    <script src="ai-demo-engine.js"></script>
    <script>
      // Format phone number as user types
      function formatPhone(input) {
        var phone = input.value.replace(/\D/g, '');
        if (phone.length >= 10) {
          input.value = '(' + phone.slice(0,3) + ') ' + phone.slice(3,6) + '-' + phone.slice(6,10);
        }
      }
      
      // Validate registration form before submit
      function validateRegistration() {
        var phone = document.getElementById('phone').value.replace(/\D/g, '');
        var email = document.getElementById('registerEmail').value;
        var company = document.getElementById('companyName').value.trim();
        var firstName = document.getElementById('firstName').value.trim();
        var lastName = document.getElementById('lastName').value.trim();
        var acceptTerms = document.getElementById('acceptTerms');
        
        if (company.length < 3) {
          alert('âŒ El nombre de la empresa debe tener al menos 3 caracteres');
          return false;
        }
        if (firstName.length < 2 || lastName.length < 2) {
          alert('âŒ Por favor ingresa tu nombre y apellido completos');
          return false;
        }
        if (!email.includes('@') || !email.includes('.')) {
          alert('âŒ Por favor ingresa un email vÃ¡lido');
          return false;
        }
        if (phone.length < 10) {
          alert('âŒ El telÃ©fono debe tener al menos 10 dÃ­gitos\n\nNecesitamos tu nÃºmero para poder contactarte y darte soporte.');
          return false;
        }
        if (!acceptTerms || !acceptTerms.checked) {
          alert('âŒ Debes aceptar los TÃ©rminos de Servicio y PolÃ­tica de Privacidad para continuar.\n\nYou must accept the Terms of Service and Privacy Policy to continue.');
          return false;
        }
        return true;
      }
      
      // Validate login terms acceptance
      function validateLoginTerms() {
        var acceptTermsLogin = document.getElementById('acceptTermsLogin');
        if (!acceptTermsLogin || !acceptTermsLogin.checked) {
          alert('âŒ Debes aceptar los TÃ©rminos de Servicio, PolÃ­tica de Privacidad, FacturaciÃ³n y NDA para iniciar sesiÃ³n.\n\nYou must accept the Terms of Service, Privacy Policy, Billing Policy and NDA to login.');
          return false;
        }
        return true;
      }
      
      // Override form submission to add validation
      document.addEventListener('DOMContentLoaded', function() {
        // Register form validation
        var form = document.getElementById('registerFormEl');
        if (form) {
          var originalSubmit = form.onsubmit;
          form.onsubmit = function(e) {
            if (!validateRegistration()) {
              e.preventDefault();
              return false;
            }
            if (originalSubmit) return originalSubmit(e);
          };
        }
        
        // Login form validation - intercept login to check terms
        var loginForm = document.querySelector('#loginForm form');
        if (loginForm) {
          var originalLoginSubmit = loginForm.onsubmit;
          loginForm.onsubmit = function(e) {
            if (!validateLoginTerms()) {
              e.preventDefault();
              return false;
            }
            if (originalLoginSubmit) return originalLoginSubmit(e);
          };
        }
      });
      
      // Support Menu Toggle
      function toggleSupportMenu() {
        var menu = document.getElementById('supportMenu');
        menu.classList.toggle('show');
      }
      
      // Close support menu when clicking outside
      document.addEventListener('click', function(e) {
        var menu = document.getElementById('supportMenu');
        var fab = document.getElementById('supportButton');
        if (menu && fab && !menu.contains(e.target) && !fab.contains(e.target)) {
          menu.classList.remove('show');
        }
      });
      
      // Forgot Password Function - 100% AutomÃ¡tico
      function openForgotPassword() {
        toggleSupportMenu();
        showForgotPassword();
      }
      
      function showForgotPassword() {
        // Crear modal para forgot password
        var modal = document.createElement('div');
        modal.id = 'forgotPasswordModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = `
          <div style="background:white;border-radius:16px;padding:24px;max-width:400px;width:100%;box-shadow:0 25px 50px rgba(0,0,0,0.25);">
            <h3 style="margin:0 0 8px 0;color:#1e3a5f;">ğŸ”‘ Recuperar ContraseÃ±a</h3>
            <p style="margin:0 0 20px 0;color:#64748b;font-size:14px;">Ingresa tu email y te ayudaremos a recuperar tu acceso.</p>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Email</label>
              <input type="email" id="forgotEmail" placeholder="tu@email.com" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Tu Nombre</label>
              <input type="text" id="forgotName" placeholder="Tu nombre completo" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
            </div>
            <div style="margin-bottom:20px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Mensaje (opcional)</label>
              <textarea id="forgotMessage" placeholder="Describe tu problema o agrega informaciÃ³n adicional..." rows="3" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit;resize:none;"></textarea>
            </div>
            <div style="display:flex;gap:10px;">
              <button onclick="closeForgotModal()" style="flex:1;padding:12px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancelar</button>
              <button onclick="submitForgotPassword()" style="flex:1;padding:12px;background:#1e3a5f;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ“¤ Enviar Solicitud</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('forgotEmail').focus();
      }
      
      function closeForgotModal() {
        var modal = document.getElementById('forgotPasswordModal');
        if (modal) modal.remove();
      }
      
      async function submitForgotPassword() {
        var email = document.getElementById('forgotEmail').value.trim().toLowerCase();
        var name = document.getElementById('forgotName').value.trim();
        var message = document.getElementById('forgotMessage').value.trim();
        
        if (!email || !email.includes('@')) {
          alert('Por favor ingresa un email vÃ¡lido');
          return;
        }
        
        if (!name) {
          alert('Por favor ingresa tu nombre');
          return;
        }
        
        try {
          // Buscar si existe en companies
          var companyRes = await sbClient.from('companies').select('id, name').eq('email', email).single();
          var companyId = companyRes.data ? companyRes.data.id : null;
          var companyName = companyRes.data ? companyRes.data.name : null;
          var userType = 'company_owner';
          
          // Si no estÃ¡ en companies, buscar en team_users
          if (!companyId) {
            var teamRes = await sbClient.from('team_users').select('id, company_id, companies(name)').eq('email', email).single();
            if (teamRes.data) {
              companyId = teamRes.data.company_id;
              companyName = teamRes.data.companies ? teamRes.data.companies.name : null;
              userType = 'team_user';
            }
          }
          
          // Si no estÃ¡ en team_users, buscar en technicians
          if (!companyId) {
            var techRes = await sbClient.from('technicians').select('id, company_id, companies(name)').eq('email', email).single();
            if (techRes.data) {
              companyId = techRes.data.company_id;
              companyName = techRes.data.companies ? techRes.data.companies.name : null;
              userType = 'technician';
            }
          }
          
          // Crear solicitud de reset
          var insertRes = await sbClient.from('password_reset_requests').insert({
            user_type: userType,
            user_email: email,
            user_name: name,
            company_id: companyId,
            company_name: companyName,
            status: 'pending',
            notes: message || null
          });
          
          if (insertRes.error) {
            console.error('Error:', insertRes.error);
            alert('âŒ Error al enviar solicitud. Intenta de nuevo.');
            return;
          }

                      // Enviar email de reset via Supabase Auth

                      var redirectUrl = window.location.origin + window.location.pathname;
                      await sbClient.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
          closeForgotModal();
                      alert('âœ… Â¡Email enviado!\n\nTe hemos enviado un enlace para restablecer tu contraseÃ±a.\n\nğŸ“§ Revisa tu bandeja de entrada y sigue el enlace.');
          
        } catch (err) {
          console.error('Error:', err);
          alert('âŒ Error de conexiÃ³n. Recarga la pÃ¡gina e intenta de nuevo.');
        }
      }
      
      // Check if user came from password reset link
      window.addEventListener('load', function() {
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reset') === 'true' || window.location.hash.includes('type=recovery')) {
            setTimeout(function() {
                showResetPasswordForm();
            }, 1000);
        }
      });
      
      function showResetPasswordForm() {
        var newPass = prompt('Ingresa tu NUEVA contraseÃ±a (mÃ­nimo 6 caracteres):');
        if (newPass && newPass.length >= 6) {
            var confirmPass = prompt('Confirma tu nueva contraseÃ±a:');
            if (newPass === confirmPass) {
                if (typeof sbClient !== 'undefined') { var h = window.location.hash; if (h && h.includes('access_token')) { var params = new URLSearchParams(h.replace(/#/g, '&').substring(1)); var at = params.get('access_token'); var rt = params.get('refresh_token'); if (at && rt) { sbClient.auth.setSession({ access_token: at, refresh_token: rt }); } }
                    sbClient.auth.updateUser({ password: newPass }).then(function(result) {
                        if (result.error) {
                            alert('âŒ Error: ' + result.error.message);
                        } else {
                            alert('âœ… Â¡ContraseÃ±a actualizada!\n\nYa puedes iniciar sesiÃ³n con tu nueva contraseÃ±a.');
                            window.location.href = window.location.origin + window.location.pathname;
                        }
                    });
                }
            } else {
                alert('âŒ Las contraseÃ±as no coinciden');
            }
        }
      }

      // ========== CLIENT LIMITS SYSTEM ==========
      // Plan limits
      var PLAN_LIMITS = {
        'free': 10,
        'profesional': 50,
        'enterprise': Infinity
      };

      // Check if user can add more clients
      async function canAddClient() {
        if (!currentCompany || !currentCompany.id) return true;
        
        var plan = currentCompany.plan || 'free';
        var limit = PLAN_LIMITS[plan] || 10;
        
        // Count current clients
        var res = await sbClient.from('customers').select('id', { count: 'exact' }).eq('company_id', currentCompany.id);
        var currentCount = res.count || 0;
        
        return {
          canAdd: currentCount < limit,
          currentCount: currentCount,
          limit: limit,
          plan: plan
        };
      }

      // Show upgrade modal when limit reached
      function showUpgradeModal(currentCount, limit, plan) {
        var nextPlan = plan === 'free' ? 'Professional ($149.99/mes)' : 'Enterprise ($299/mes)';
        var nextPlanId = plan === 'free' ? 'profesional' : 'enterprise';
        
        var modal = document.createElement('div');
        modal.id = 'upgradeModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = `
          <div style="background:white;border-radius:16px;padding:0;max-width:450px;width:100%;box-shadow:0 25px 50px rgba(0,0,0,0.3);overflow:hidden;">
            <div style="background:linear-gradient(135deg,#f97316,#ea580c);padding:24px;text-align:center;color:white;">
              <div style="font-size:48px;margin-bottom:8px;">ğŸš€</div>
              <h2 style="margin:0;font-size:1.5rem;">Â¡Has alcanzado tu lÃ­mite!</h2>
              <p style="margin:8px 0 0 0;opacity:0.9;">You've reached your limit!</p>
            </div>
            <div style="padding:24px;">
              <div style="background:#fef3c7;border-radius:8px;padding:16px;margin-bottom:20px;text-align:center;">
                <p style="margin:0;font-size:2rem;font-weight:700;color:#92400e;">${currentCount} / ${limit}</p>
                <p style="margin:4px 0 0 0;color:#92400e;font-size:0.9rem;">Clientes registrados</p>
              </div>
              <p style="text-align:center;color:#4b5563;margin-bottom:20px;">
                Tu plan <strong>${plan.toUpperCase()}</strong> permite hasta <strong>${limit} clientes</strong>.<br>
                Para agregar mÃ¡s clientes, actualiza a <strong>${nextPlan}</strong>.
              </p>
              <div style="display:flex;gap:12px;">
                <button onclick="closeUpgradeModal()" style="flex:1;padding:14px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">
                  Cancelar
                </button>
                <button onclick="redirectToUpgrade('${nextPlanId}')" style="flex:1;padding:14px;background:linear-gradient(135deg,#1e3a5f,#0f172a);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">
                  â¬†ï¸ Actualizar Plan
                </button>
              </div>
              <p style="text-align:center;margin-top:16px;font-size:0.8rem;color:#9ca3af;">
                <a href="billing.html" target="_blank" style="color:#1e3a5f;">Ver polÃ­tica de facturaciÃ³n</a>
              </p>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function closeUpgradeModal() {
        var modal = document.getElementById('upgradeModal');
        if (modal) modal.remove();
      }

      function redirectToUpgrade(planId) {
        closeUpgradeModal();
        // Show settings section and subscription tab
        if (typeof showSection === 'function') {
          showSection('settings');
        }
        alert('ğŸ“§ Para actualizar tu plan, contacta a soporte:\n\nsupport@acvolttech.com\n\nO llama a Technical Support.');
      }

      // Override client save function to check limits
      var originalSaveClient = typeof saveClient === 'function' ? saveClient : null;
      
      window.checkClientLimitBeforeSave = async function() {
        var result = await canAddClient();
        if (!result.canAdd) {
          showUpgradeModal(result.currentCount, result.limit, result.plan);
          return false;
        }
        return true;
      };

      // Global function to check limit (can be called from script.js)
      window.clientLimitCheck = canAddClient;
      window.showClientUpgradeModal = showUpgradeModal;

      // ============================================================
      // CLIENT LIMITS SYSTEM - COMPLETE INTEGRATION
      // ============================================================

      // Plan client limits configuration
      var CLIENT_LIMITS = {
        'free': 10,
        'profesional': 50,
        'enterprise': Infinity
      };

      // Check if current company can add more clients
      async function checkClientLimit() {
        try {
          var companyId = localStorage.getItem('companyId') || (typeof currentCompany !== 'undefined' ? currentCompany?.id : null);
          if (!companyId) return { canAdd: true, currentCount: 0, limit: 10, plan: 'free' };
          
          var companyRes = await sbClient.from('companies').select('plan').eq('id', companyId).single();
          var plan = companyRes.data?.plan || 'free';
          var limit = CLIENT_LIMITS[plan] || 10;
          
          var countRes = await sbClient.from('customers').select('id', { count: 'exact', head: true }).eq('company_id', companyId);
          var currentCount = countRes.count || 0;
          
          return {
            canAdd: currentCount < limit,
            currentCount: currentCount,
            limit: limit,
            plan: plan,
            remaining: Math.max(0, limit - currentCount)
          };
        } catch (error) {
          console.error('Error checking client limit:', error);
          return { canAdd: true, currentCount: 0, limit: 10, plan: 'free' };
        }
      }

      // Show upgrade modal when limit is reached (enhanced version)
      function showUpgradePlanModal(info) {
        var currentCount = info.currentCount;
        var limit = info.limit;
        var plan = info.plan;
        var nextPlan = plan === 'free' ? 'Professional' : 'Enterprise';
        var nextPrice = plan === 'free' ? '$149.99/mes' : '$299/mes';
        var nextLimit = plan === 'free' ? '50 clientes' : 'Ilimitados';
        
        var existingModal = document.getElementById('clientLimitModal');
        if (existingModal) existingModal.remove();
        
        var modal = document.createElement('div');
        modal.id = 'clientLimitModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
        
        modal.innerHTML = `
          <div style="background:white;border-radius:20px;max-width:480px;width:100%;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,0.3);">
            <div style="background:linear-gradient(135deg,#f97316 0%,#ea580c 100%);padding:30px;text-align:center;color:white;">
              <div style="font-size:60px;margin-bottom:10px;">ğŸš€</div>
              <h2 style="margin:0;font-size:1.6rem;font-weight:700;">Â¡LÃ­mite de Clientes Alcanzado!</h2>
              <p style="margin:8px 0 0 0;opacity:0.9;font-size:0.95rem;">Client Limit Reached!</p>
            </div>
            <div style="padding:30px;">
              <div style="background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border-radius:12px;padding:20px;text-align:center;margin-bottom:24px;border:2px solid #f59e0b;">
                <div style="font-size:3rem;font-weight:800;color:#92400e;">${currentCount} / ${limit}</div>
                <div style="color:#b45309;font-weight:600;margin-top:4px;">Clientes Registrados</div>
              </div>
              <div style="text-align:center;margin-bottom:24px;">
                <p style="color:#4b5563;font-size:1rem;line-height:1.6;margin:0;">
                  Tu plan <strong style="color:#1e3a5f;text-transform:uppercase;">${plan}</strong> permite hasta 
                  <strong style="color:#ea580c;">${limit} clientes</strong>.
                </p>
                <p style="color:#6b7280;font-size:0.9rem;margin-top:12px;">
                  Actualiza a <strong style="color:#1e3a5f;">${nextPlan}</strong> para agregar hasta 
                  <strong>${nextLimit}</strong>.
                </p>
              </div>
              <div style="background:#f8fafc;border-radius:12px;padding:16px;margin-bottom:24px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0;">
                  <span style="color:#64748b;">Plan ${nextPlan}</span>
                  <span style="font-weight:700;color:#1e3a5f;">${nextPrice}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;">
                  <span style="color:#64748b;">LÃ­mite de clientes</span>
                  <span style="font-weight:700;color:#22c55e;">${nextLimit}</span>
                </div>
              </div>
              <div style="display:flex;gap:12px;">
                <button onclick="closeClientLimitModal()" style="flex:1;padding:16px;background:#f1f5f9;color:#475569;border:none;border-radius:12px;font-weight:600;font-size:1rem;cursor:pointer;">
                  Cancelar
                </button>
                <button onclick="contactForUpgrade()" style="flex:1;padding:16px;background:linear-gradient(135deg,#1e3a5f 0%,#0f172a 100%);color:white;border:none;border-radius:12px;font-weight:600;font-size:1rem;cursor:pointer;">
                  â¬†ï¸ Actualizar Plan
                </button>
              </div>
              <p style="text-align:center;margin-top:20px;font-size:0.8rem;">
                <a href="billing.html" target="_blank" style="color:#6b7280;text-decoration:none;">ğŸ“„ Ver PolÃ­tica de FacturaciÃ³n</a>
              </p>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeClientLimitModal();
        });
      }

      function closeClientLimitModal() {
        var modal = document.getElementById('clientLimitModal');
        if (modal) modal.remove();
      }

      function contactForUpgrade() {
        closeClientLimitModal();
        alert('ğŸ“ Para actualizar tu plan, contacta a Soporte TÃ©cnico:\n\nğŸ“§ Email: support@acvolttech.com\n\nğŸŒ Website: acvolttech.com\n\nNuestro equipo te ayudarÃ¡ a actualizar tu plan inmediatamente.');
      }

      // Show remaining clients status in dashboard
      async function showClientLimitStatus() {
        var info = await checkClientLimit();
        var statusHtml = '<div id="clientLimitStatus" style="background:' + (info.remaining <= 2 ? '#fef3c7' : '#dcfce7') + ';border:1px solid ' + (info.remaining <= 2 ? '#f59e0b' : '#22c55e') + ';border-radius:8px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">' +
          '<div><span style="font-weight:600;color:#374151;">Clientes:</span> ' +
          '<span style="color:' + (info.remaining <= 2 ? '#b45309' : '#166534') + ';font-weight:700;">' + info.currentCount + ' / ' + (info.limit === Infinity ? 'âˆ' : info.limit) + '</span></div>' +
          (info.remaining <= 5 && info.limit !== Infinity ? '<span style="font-size:0.8rem;color:#b45309;">âš ï¸ ' + info.remaining + ' restantes</span>' : '') +
          '</div>';
        
        var existingStatus = document.getElementById('clientLimitStatus');
        if (existingStatus) existingStatus.remove();
        
        var clientsSection = document.getElementById('clientsSection');
        if (clientsSection) {
          var header = clientsSection.querySelector('.section-header, h2');
          if (header) {
            header.insertAdjacentHTML('afterend', statusHtml);
          }
        }
      }

      // Export functions for global access
      window.checkClientLimit = checkClientLimit;
      window.showUpgradePlanModal = showUpgradePlanModal;
      window.closeClientLimitModal = closeClientLimitModal;
      window.showClientLimitStatus = showClientLimitStatus;
      window.contactForUpgrade = contactForUpgrade;

      console.log('âœ… Trade Master CRM - Client Limits System loaded');
    </script>
  <script src="i18n-patch.js"></script>

  <!-- Floating Demo Button -->
  <div id="floatingDemoBtn" onclick="launchDemoManual()" style="display:none;position:fixed;bottom:24px;right:24px;z-index:9990;width:56px;height:56px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:50%;cursor:pointer;box-shadow:0 4px 20px rgba(249,115,22,.4);align-items:center;justify-content:center;font-size:24px;transition:all .2s;animation:floatPulse 2s ease infinite" title="Tour AI / Demo">
    ğŸ¬
    <style>
      @keyframes floatPulse{0%,100%{box-shadow:0 4px 20px rgba(249,115,22,.4)}50%{box-shadow:0 4px 30px rgba(249,115,22,.6)}}
      #floatingDemoBtn:hover{transform:scale(1.1)}
    </style>
  </div>
  <script>
    // Show floating demo button after dashboard loads (not in demo mode)
    (function(){
      if(new URLSearchParams(location.search).get('demo')==='true')return;
      var checkBtn=setInterval(function(){
        if(document.getElementById('dashboardPage')&&document.getElementById('dashboardPage').style.display!=='none'){
          var fb=document.getElementById('floatingDemoBtn');
          if(fb)fb.style.display='flex';
          clearInterval(checkBtn);
        }
      },1000);
    })();
  </script>
  </body>
</html>
