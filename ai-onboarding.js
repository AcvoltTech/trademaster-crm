// TRADE MASTER CRM - AI ONBOARDING + VOZ CLONADA BILINGUE
// Anthropic Claude via Supabase Edge Function
// ElevenLabs TTS "Maestro Mario" ES/EN
// Web Speech API STT
(function(){
  'use strict';
  var C={supabaseUrl:'https://ucowlcrddzukykbaitzt.supabase.co',chat:'/functions/v1/ai-onboarding-chat',tts:'/functions/v1/ai-onboarding-tts',voices:{es:'fUe0t5dpNRW7lCYZkO0L',en:'1aCQzGhqyQpy8eBAtokW'},stt:{es:'es-MX',en:'en-US'}};
  var KB={dashboard:{es:{t:'Tablero Principal',d:'Centro de mando. Resumen HVACR: metricas, mapa tecnicos, pipeline, trabajos, citas.',tip:'Revisa cada manana.',acts:'Metricas|Mapa|Personal|Pipeline|Materiales|Importar'},en:{t:'Dashboard',d:'Command center. HVACR overview: metrics, tech map, pipeline, jobs, appointments.',tip:'Check every morning.',acts:'Metrics|Map|Staff|Pipeline|Materials|Import'}},inbox:{es:{t:'Bandeja',d:'Comunicaciones con clientes: llamadas, emails, mensajes.',tip:'Registra todo para historial.',acts:'Registrar|Filtrar|Historial'},en:{t:'Inbox',d:'Client communications: calls, emails, messages.',tip:'Log everything for history.',acts:'Log|Filter|History'}},calendar:{es:{t:'Calendario',d:'Citas de servicio e instalaciones. Mes, Semana, Dia.',tip:'Vista Semana para rutas.',acts:'Crear cita|Cambiar vista|Citas del dia'},en:{t:'Calendar',d:'Service appointments. Month, Week, Day view.',tip:'Week view for routes.',acts:'Create|Change view|Today'}},clients:{es:{t:'Clientes',d:'Base de datos. Agrega, importa de HCP, exporta CSV.',tip:'Direccion completa para mapa.',acts:'Agregar|Importar HCP|Exportar|Perfil|Buscar'},en:{t:'Clients',d:'Database. Add, import from HCP, export CSV.',tip:'Full address for map.',acts:'Add|Import HCP|Export|Profile|Search'}},leads:{es:{t:'Prospectos',d:'Leads interesados. Asigna a vendedores.',tip:'Asigna rapido.',acts:'Registrar|Asignar|Mapa|Filtrar'},en:{t:'Leads',d:'Interested prospects. Assign to reps.',tip:'Assign quickly.',acts:'Register|Assign|Map|Filter'}},pipeline:{es:{t:'Flujo de Ventas',d:'Embudo: abiertos a pagados.',tip:'Mejora seguimiento.',acts:'Pipeline|Estimado|Conversion'},en:{t:'Pipeline',d:'Funnel: open to paid.',tip:'Improve follow-up.',acts:'Pipeline|Estimate|Conversion'}},servicecalls:{es:{t:'Llamadas de Servicio',d:'Registra llamadas. Problema, urgencia.',tip:'Registra aqui, luego crea trabajo.',acts:'Registrar|Mapa|Convertir'},en:{t:'Service Calls',d:'Log calls. Problem, urgency.',tip:'Log here, then create job.',acts:'Log|Map|Convert'}},dispatch:{es:{t:'Despacho',d:'Asigna trabajos a tecnicos. Mapa tiempo real.',tip:'Tu torre de control.',acts:'Tecnicos|Asignar|Mapa'},en:{t:'Dispatch',d:'Assign jobs to techs. Real-time map.',tip:'Your control tower.',acts:'Techs|Assign|Map'}},jobs:{es:{t:'Trabajos y Estimados',d:'Crea estimados: AC, Heat Pump, Furnace, Mini Split. PDF.',tip:'Estimados profesionales cierran mas.',acts:'Crear|Equipo|PDF|Presentar'},en:{t:'Jobs & Estimates',d:'Create estimates: AC, Heat Pump, Furnace, Mini Split. PDF.',tip:'Professional estimates close more.',acts:'Create|Equipment|PDF|Present'}},technicians:{es:{t:'Tecnicos',d:'Info, credenciales EPA/NATE, ID Card.',tip:'Credenciales actualizadas.',acts:'Agregar|Foto|Credenciales|ID Card'},en:{t:'Technicians',d:'Info, EPA/NATE credentials, ID Card.',tip:'Keep credentials updated.',acts:'Add|Photo|Credentials|ID Card'}},advisors:{es:{t:'Asesores del Hogar',d:'Ventas. Leads, comisiones sobre ganancia.',tip:'Comisiones sobre ganancia.',acts:'Equipo|Leads|Venta|Comisiones'},en:{t:'Home Advisors',d:'Sales. Leads, profit-based commissions.',tip:'Commissions on profit.',acts:'Team|Leads|Sale|Commissions'}},invoices:{es:{t:'Facturacion',d:'Facturas profesionales. Vincula a cliente y trabajo.',tip:'Siempre vincula.',acts:'Crear|Lineas|Detalle|Buscar'},en:{t:'Invoicing',d:'Professional invoices. Link to client and job.',tip:'Always link.',acts:'Create|Lines|Details|Search'}},collections:{es:{t:'Cobranza',d:'Pagos pendientes.',tip:'Revisa semanalmente.',acts:'Pendientes|Contactar|Pago'},en:{t:'Collections',d:'Pending payments.',tip:'Review weekly.',acts:'Pending|Contact|Payment'}},receipts:{es:{t:'Recibos',d:'Recibos de proveedores.',tip:'Foto al momento.',acts:'Agregar|Foto|CSV'},en:{t:'Receipts',d:'Vendor receipts.',tip:'Photo immediately.',acts:'Add|Photo|CSV'}},expenses:{es:{t:'Gastos',d:'Gastos fijos. QuickBooks.',tip:'Registra todo.',acts:'Registrar|QuickBooks|CSV'},en:{t:'Expenses',d:'Fixed expenses. QuickBooks.',tip:'Log everything.',acts:'Log|QuickBooks|CSV'}},mymoney:{es:{t:'Mi Dinero',d:'Transacciones personales.',tip:'Separa personal de negocio.',acts:'Gasto|Transacciones'},en:{t:'My Money',d:'Personal transactions.',tip:'Keep separate.',acts:'Expense|Transactions'}},payroll:{es:{t:'Nomina',d:'Nomina. ADP, Gusto.',tip:'Sincroniza con clock-in.',acts:'Entrada|Proveedor|Sincronizar'},en:{t:'Payroll',d:'Payroll. ADP, Gusto.',tip:'Sync with clock-in.',acts:'Entry|Provider|Sync'}},mailbox:{es:{t:'Correo',d:'Documentos, contratos, permisos.',tip:'Archivo digital.',acts:'Agregar|Filtrar|Urgente'},en:{t:'Mail',d:'Documents, contracts, permits.',tip:'Digital archive.',acts:'Add|Filter|Urgent'}},marketing:{es:{t:'Mercadotecnia',d:'Campanas y leads.',tip:'Resenas Google = oro.',acts:'Campana|Fuentes|Resena'},en:{t:'Marketing',d:'Campaigns and leads.',tip:'Google reviews = gold.',acts:'Campaign|Sources|Review'}},pricebook:{es:{t:'Precios',d:'Catalogo HVAC para estimados.',tip:'Carga completo.',acts:'Cargar|Agregar|Proveedores'},en:{t:'Price Book',d:'HVAC catalog for estimates.',tip:'Load all at once.',acts:'Load|Add|Vendors'}},reports:{es:{t:'Reportes',d:'Ingresos, tecnicos, fuentes.',tip:'Revisa mensualmente.',acts:'Ingresos|Tecnico|Fuente'},en:{t:'Reports',d:'Revenue, techs, sources.',tip:'Review monthly.',acts:'Revenue|Tech|Source'}},team:{es:{t:'Equipo',d:'Accesos, roles, permisos.',tip:'No des admin a todos.',acts:'Agregar|Roles|Sesiones'},en:{t:'Team',d:'Access, roles, permissions.',tip:'Don\'t give admin to all.',acts:'Add|Roles|Sessions'}},hr:{es:{t:'Recursos Humanos',d:'Documentos, contratos, write-ups.',tip:'California = estricto.',acts:'Documentos|Contrato|Write-ups'},en:{t:'HR',d:'Documents, contracts, write-ups.',tip:'California = strict.',acts:'Documents|Contract|Write-ups'}},settings:{es:{t:'Configuracion',d:'Datos empresa, logo, clausulas.',tip:'Lo primero.',acts:'Empresa|Logo|Clausulas'},en:{t:'Settings',d:'Company data, logo, clauses.',tip:'First thing to do.',acts:'Company|Logo|Clauses'}}};

 var STEPS={es:[{s:'settings',m:'Bienvenido a Trade Master! Primero configura tu empresa: nombre, telefono, email, direccion y logo.'},{s:'dashboard',m:'Tu centro de mando. Revisa cada manana: metricas, mapa de tecnicos y trabajos del dia.'},{s:'clients',m:'Base de datos de clientes. Agrega uno por uno o importa de Housecall Pro.'},{s:'technicians',m:'Registra tecnicos con foto y certificaciones EPA/NATE. Genera ID Card.'},{s:'leads',m:'Leads de Google, Yelp o llamadas. Asigna al vendedor rapido.'},{s:'servicecalls',m:'Registra llamadas de servicio. Captura problema y urgencia.'},{s:'dispatch',m:'Torre de control. Asigna trabajos y coordina rutas en mapa.'},{s:'jobs',m:'Crea estimados: AC, Heat Pump, Furnace, Mini Split. Genera PDF.'},{s:'invoices',m:'Facturas profesionales vinculadas a trabajo y cliente.'},{s:'collections',m:'Cobranza. Ve quien debe y desde cuando.'},{s:'pipeline',m:'Flujo de ventas visual. Abiertos, aprobados, facturados, pagados.'},{s:'pricebook',m:'Catalogo HVAC. Carga completo y ajusta despues.'},{s:'marketing',m:'Campanas y resenas Google. Oro para HVAC.'},{s:'reports',m:'Reportes de ingresos, tecnicos y fuentes.'},{s:'team',m:'Control de acceso. Tecnicos solo ven sus trabajos.'},{s:'hr',m:'Recursos Humanos. Contratos y write-ups.'},{s:'calendar',m:'Calendario de citas. Vista semana para rutas.'},{s:'payroll',m:'Nomina. Conecta Gusto o ADP.'},{s:'dashboard',m:'Felicidades! Ya conoces Trade Master. Preguntame lo que quieras!'}],en:[{s:'settings',m:'Welcome to Trade Master! First set up your company: name, phone, email, address and logo.'},{s:'dashboard',m:'Your command center. Check every morning: metrics, tech map and today\'s jobs.'},{s:'clients',m:'Client database. Add one by one or import from Housecall Pro.'},{s:'technicians',m:'Register techs with photo and EPA/NATE certifications. Generate ID Card.'},{s:'leads',m:'Leads from Google, Yelp or calls. Assign to rep quickly.'},{s:'servicecalls',m:'Log service calls. Capture problem and urgency.'},{s:'dispatch',m:'Control tower. Assign jobs and coordinate routes on map.'},{s:'jobs',m:'Create estimates: AC, Heat Pump, Furnace, Mini Split. Generate PDF.'},{s:'invoices',m:'Professional invoices linked to job and client.'},{s:'collections',m:'Collections. See who owes and since when.'},{s:'pipeline',m:'Visual sales funnel. Open, approved, invoiced, paid.'},{s:'pricebook',m:'HVAC catalog. Load all and adjust later.'},{s:'marketing',m:'Campaigns and Google reviews. Gold for HVAC.'},{s:'reports',m:'Revenue, tech and source reports.'},{s:'team',m:'Access control. Techs only see their jobs.'},{s:'hr',m:'HR. Contracts and write-ups.'},{s:'calendar',m:'Appointment calendar. Week view for routes.'},{s:'payroll',m:'Payroll. Connect Gusto or ADP.'},{s:'dashboard',m:'Congratulations! You know Trade Master. Ask me anything!'}]};
  var S={open:false,ob:false,step:0,msgs:[],rec:false,recog:null,aud:null,spk:false,proc:false};
  function L(){return window.currentLang||'es';}
  function T(e,n){return L()==='en'?n:e;}
  function sec(){var el=document.querySelector('.section.active');return el?el.id.replace('-section',''):'dashboard';}
  function akey(){return window.SUPABASE_ANON_KEY||'';}

 function buildUI(){var f=document.createElement('button');f.className='ai-fab';f.id='aiFab';f.innerHTML='<span class="ai-fab-icon">\uD83E\uDD16</span><span class="ai-badge">AI</span>';f.addEventListener('click',toggle);var p=document.createElement('div');p.className='ai-panel';p.id='aiPanel';p.innerHTML='<div class="ai-panel-header"><div class="ai-avatar">\uD83E\uDD16</div><div class="ai-header-info"><h4>Maestro Mario AI</h4><span id="aiSub">'+T('Tu asistente de Trade Master','Your Trade Master Assistant')+'</span></div><button class="ai-close-btn" id="aiX">\u2715</button></div><div class="ai-progress-wrap" id="aiProg" style="display:none"><span id="aiPLbl">1/19</span><div class="ai-progress-track"><div class="ai-progress-fill" id="aiPF"></div></div><button class="ai-tt-skip" id="aiSk" style="font-size:10px;padding:2px 8px;border-radius:6px">'+T('Saltar','Skip')+'</button></div><div class="ai-quick-actions" id="aiQB"><button class="ai-quick-btn" id="aqT">\uD83C\uDF93 '+T('Tour Guiado','Guided Tour')+'</button><button class="ai-quick-btn" id="aqW">\u2753 '+T('Que es esto?','What is this?')+'</button><button class="ai-quick-btn" id="aqC">\uD83D\uDC65 '+T('Agregar Cliente','Add Client')+'</button><button class="ai-quick-btn" id="aqE">\uD83D\uDD27 '+T('Crear Estimado','Create Estimate')+'</button><button class="ai-quick-btn" id="aqI">\uD83D\uDCC4 '+T('Facturar','Invoice')+'</button></div><div class="ai-messages" id="aiM"></div><div class="ai-input-area"><button class="ai-mic-btn" id="aiMic">\uD83C\uDFA4</button><input type="text" id="aiIn" placeholder="'+T('Escribe o habla...','Type or speak...')+'" /><button class="ai-send-btn" id="aiSnd">\u27A4</button></div>';var o=document.createElement('div');o.className='ai-highlight-overlay';o.id='aiOv';document.body.appendChild(f);document.body.appendChild(p);document.body.appendChild(o);document.getElementById('aiX').addEventListener('click',toggle);document.getElementById('aiMic').addEventListener('click',toggleVoice);document.getElementById('aiSnd').addEventListener('click',send);document.getElementById('aiIn').addEventListener('keydown',function(e){if(e.key==='Enter')send();});document.getElementById('aqT').addEventListener('click',startOB);document.getElementById('aqW').addEventListener('click',aboutSec);document.getElementById('aqC').addEventListener('click',function(){qAsk(T('Como agrego un cliente','How do I add a client'));});document.getElementById('aqE').addEventListener('click',function(){qAsk(T('Como creo un estimado','How do I create an estimate'));});document.getElementById('aqI').addEventListener('click',function(){qAsk(T('Como facturo','How do I invoice'));});document.getElementById('aiSk').addEventListener('click',endOB);}

 function toggle(){S.open=!S.open;var p=document.getElementById('aiPanel');if(S.open){p.classList.add('open');if(S.msgs.length===0){addMsg('a',T('Hola! Soy tu asistente de Trade Master con la voz de Maestro Mario. Toca Tour Guiado para que te ensene todo, o preguntame lo que quieras.','Hi! I\'m your Trade Master assistant with Maestro Mario\'s voice. Tap Guided Tour for a walkthrough, or ask me anything.'));speak(T('Hola, soy tu asistente de Trade Master. Quieres un tour guiado o prefieres explorar?','Hi, I\'m your Trade Master assistant. Want a guided tour or prefer to explore?'));}}else{p.classList.remove('open');stopAud();}}
  function addMsg(r,t){S.msgs.push({role:r==='a'?'assistant':'user',content:t});var c=document.getElementById('aiM');var d=document.createElement('div');d.className='ai-msg '+(r==='a'?'assistant':'user');d.textContent=t;c.appendChild(d);c.scrollTop=c.scrollHeight;return d;}
  function showTyp(){var c=document.getElementById('aiM');var d=document.createElement('div');d.className='ai-msg assistant';d.id='aiTy';d.innerHTML='<div class="ai-typing"><span></span><span></span><span></span></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
  function hideTyp(){var e=document.getElementById('aiTy');if(e)e.remove();}
  function send(){var i=document.getElementById('aiIn');var t=i.value.trim();if(!t||S.proc)return;i.value='';addMsg('u',t);process(t);}
  function qAsk(t){if(!S.open)toggle();addMsg('u',t);process(t);}
  function aboutSec(){if(!S.open)toggle();var s=sec();var info=KB[s];if(!info)return;var l=L();var d=info[l];var r=d.t+'\n\n'+d.d+'\n\n'+T('Tip: ','Tip: ')+d.tip+'\n\n'+T('Acciones: ','Actions: ')+d.acts.replace(/\|/g,', ');addMsg('a',r);speak(d.d+'. '+d.tip);hlSec(s);}

 function process(text){S.proc=true;showTyp();var s=sec();var info=KB[s];var l=L();var ctx=info?info[l]:{t:'',d:'',tip:'',acts:''};var sys=T('Eres Maestro Mario, instructor HVAC experto que ayuda a usar el CRM Trade Master. Responde en espanol, claro y directo. El usuario esta en "'+ctx.t+'": '+ctx.d+'. Acciones: '+ctx.acts+'. Tip: '+ctx.tip+'. Maximo 3 oraciones. Si preguntan como hacer algo, da pasos numerados.','You are Maestro Mario, expert HVAC instructor helping use Trade Master CRM. Respond in English, clear and direct. User is in "'+ctx.t+'": '+ctx.d+'. Actions: '+ctx.acts+'. Tip: '+ctx.tip+'. Max 3 sentences. If asked how, give numbered steps.');var hist=S.msgs.slice(-6).map(function(m){return{role:m.role,content:m.content};});fetch(C.supabaseUrl+C.chat,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+akey(),'apikey':akey()},body:JSON.stringify({system:sys,messages:hist,language:l})}).then(function(r){return r.json();}).then(function(d){hideTyp();S.proc=false;var reply=d.reply||d.content||T('Error, intenta de nuevo.','Error, try again.');addMsg('a',reply);speak(reply);}).catch(function(err){hideTyp();S.proc=false;console.error('AI err:',err);var fb=localAns(text,s);addMsg('a',fb);speak(fb);});}

 function localAns(text,s){var l=L();var lo=text.toLowerCase();var ks=Object.keys(KB);for(var i=0;i<ks.length;i++){var k=ks[i];var ki=KB[k][l];if(lo.indexOf(k)>-1||lo.indexOf(ki.t.toLowerCase())>-1)return ki.t+': '+ki.d+'\n'+ki.tip;}if(lo.match(/client|agregar/))return T('Para agregar cliente:\n1. Ve a Clientes\n2. Toca + Nuevo Cliente\n3. Llena datos y direccion\n4. Guarda','To add client:\n1. Go to Clients\n2. Tap + New Client\n3. Fill info and address\n4. Save');if(lo.match(/estimad|estimate|cotiz/))return T('Para crear estimado:\n1. Ve a Trabajos\n2. Selecciona equipo (AC, Heat Pump, etc)\n3. Agrega materiales\n4. Genera PDF','To create estimate:\n1. Go to Jobs\n2. Select equipment (AC, Heat Pump, etc)\n3. Add materials\n4. Generate PDF');if(lo.match(/factura|invoice|cobr|bill/))return T('Para facturar:\n1. Ve a Facturas\n2. Toca + Nueva Factura\n3. Selecciona cliente y trabajo\n4. Agrega lineas\n5. Guarda','To invoice:\n1. Go to Invoices\n2. Tap + New Invoice\n3. Select client and job\n4. Add lines\n5. Save');if(lo.match(/tecnico|technician|tech/))return T('Para registrar tecnico:\n1. Ve a Tecnicos\n2. Toca + Agregar\n3. Sube foto y credenciales\n4. Genera ID Card','To register tech:\n1. Go to Technicians\n2. Tap + Add\n3. Upload photo and credentials\n4. Generate ID Card');if(lo.match(/despacho|dispatch|asign/))return T('Para despachar:\n1. Ve a Despacho\n2. Ve tecnicos disponibles\n3. Asigna trabajo al mas cercano','To dispatch:\n1. Go to Dispatch\n2. See available techs\n3. Assign job to nearest');var info=KB[s]?KB[s][l]:null;if(info)return info.t+': '+info.d+'\n'+info.tip;return T('Preguntame sobre cualquier seccion del CRM.','Ask me about any CRM section.');}

 function speak(text){if(!text)return;stopAud();var vid=C.voices[L()];if(!vid)return;S.spk=true;showAI(true);fetch(C.supabaseUrl+C.tts,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+akey(),'apikey':akey()},body:JSON.stringify({text:text,voice_id:vid,language:L()})}).then(function(r){if(!r.ok)throw new Error('TTS fail');return r.blob();}).then(function(b){var u=URL.createObjectURL(b);S.aud=new Audio(u);S.aud.play();S.aud.onended=function(){S.spk=false;showAI(false);URL.revokeObjectURL(u);};S.aud.onerror=function(){S.spk=false;showAI(false);};}).catch(function(e){console.error('TTS:',e);S.spk=false;showAI(false);bSpeak(text);});}
  function bSpeak(t){if(!window.speechSynthesis)return;var u=new SpeechSynthesisUtterance(t);u.lang=L()==='en'?'en-US':'es-MX';u.rate=0.95;speechSynthesis.speak(u);}
  function stopAud(){if(S.aud){try{S.aud.pause();S.aud.currentTime=0;}catch(e){}}if(window.speechSynthesis)speechSynthesis.cancel();S.spk=false;showAI(false);}
  function showAI(show){var ms=document.querySelectorAll('.ai-msg.assistant');if(!ms.length)return;var last=ms[ms.length-1];var ex=last.querySelector('.ai-audio-indicator');if(show&&!ex){var d=document.createElement('div');d.className='ai-audio-indicator';d.innerHTML='<div class="ai-audio-bar"></div><div class="ai-audio-bar"></div><div class="ai-audio-bar"></div><div class="ai-audio-bar"></div><div class="ai-audio-bar"></div>';last.appendChild(d);}else if(!show&&ex){ex.remove();}}

 function toggleVoice(){if(S.rec){stopRec();}else{startRec();}}
  function startRec(){if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){addMsg('a',T('Tu navegador no soporta voz. Usa Chrome.','Browser doesn\'t support voice. Use Chrome.'));return;}var SR=window.SpeechRecognition||window.webkitSpeechRecognition;S.recog=new SR();S.recog.lang=C.stt[L()];S.recog.interimResults=false;S.recog.maxAlternatives=1;S.recog.onresult=function(e){var t=e.results[0][0].transcript;document.getElementById('aiIn').value=t;send();};S.recog.onerror=function(){S.rec=false;document.getElementById('aiMic').classList.remove('recording');};S.recog.onend=function(){S.rec=false;document.getElementById('aiMic').classList.remove('recording');};S.recog.start();S.rec=true;document.getElementById('aiMic').classList.add('recording');}
  function stopRec(){if(S.recog)try{S.recog.stop();}catch(e){}S.rec=false;document.getElementById('aiMic').classList.remove('recording');}

 function startOB(){S.ob=true;S.step=0;document.getElementById('aiProg').style.display='flex';document.getElementById('aiQB').style.display='none';runStep();}
  function runStep(){var steps=STEPS[L()];if(S.step>=steps.length){endOB();return;}var st=steps[S.step];var total=steps.length;document.getElementById('aiPLbl').textContent=(S.step+1)+'/'+total;document.getElementById('aiPF').style.width=((S.step+1)/total*100)+'%';if(typeof window.showSection==='function')window.showSection(st.s);var info=KB[st.s]?KB[st.s][L()]:null;var title=info?info.t:st.s;addMsg('a','['+title+'] '+st.m);speak(st.m);hlSec(st.s);S.step++;setTimeout(function(){if(S.ob&&S.step<steps.length){var ov=document.getElementById('aiOv');ov.classList.remove('active');document.querySelectorAll('.ai-highlighted').forEach(function(el){el.classList.remove('ai-highlighted');});runStep();}else if(S.ob){endOB();}},12000);}
  function endOB(){S.ob=false;S.step=0;document.getElementById('aiProg').style.display='none';document.getElementById('aiQB').style.display='flex';var ov=document.getElementById('aiOv');ov.classList.remove('active');document.querySelectorAll('.ai-highlighted').forEach(function(el){el.classList.remove('ai-highlighted');});addMsg('a',T('Tour terminado! Preguntame lo que quieras.','Tour finished! Ask me anything.'));}
  function hlSec(s){var ov=document.getElementById('aiOv');ov.classList.add('active');document.querySelectorAll('.ai-highlighted').forEach(function(el){el.classList.remove('ai-highlighted');});var secEl=document.getElementById(s+'-section');if(secEl){secEl.classList.add('ai-highlighted');var first=secEl.querySelector('button[onclick],h2,h3');if(first)first.classList.add('ai-highlighted');}}

 // INIT - wait for DOM and login
 function init(){buildUI();var obs=new MutationObserver(function(){var dash=document.getElementById('dashboardPage');if(dash&&dash.style.display!=='none'){document.getElementById('aiFab').classList.add('visible');var done=localStorage.getItem('tm_onboard_done');if(!done){setTimeout(function(){toggle();addMsg('a',T('Parece que es tu primera vez aqui! Quieres que te de un tour guiado por todo el CRM?','Looks like your first time here! Want a guided tour of the entire CRM?'));speak(T('Bienvenido! Parece que es tu primera vez. Quieres que te de un tour guiado?','Welcome! Looks like your first time. Want a guided tour?'));},2000);}obs.disconnect();}});obs.observe(document.body,{attributes:true,subtree:true,attributeFilter:['style']});}
  window.TMAssistant={toggle:toggle,startOB:startOB,endOB:endOB,aboutSec:aboutSec,qAsk:qAsk,send:send,toggleVoice:toggleVoice};
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
})();
