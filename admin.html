<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master Admin CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1e40af;--accent:#f97316;--success:#22c55e;--warning:#eab308;--danger:#ef4444;--dark:#1f2937;--gray:#6b7280;--light:#f3f4f6;--sidebar-w:240px}
        body{font-family:'Inter',sans-serif;background:var(--light);min-height:100vh}
        
        /* LOGIN */
        .login-box{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#0f172a,#1e3a8a)}
        .login-box.hidden{display:none}
        .login-card{background:white;padding:2.5rem;border-radius:1rem;width:100%;max-width:400px;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .login-card h1{text-align:center;font-size:1.75rem;color:var(--primary);margin-bottom:0.5rem}
        .login-card h1 span{color:var(--accent)}
        .login-card>p{text-align:center;color:var(--gray);margin-bottom:2rem}
        .form-group{margin-bottom:1.25rem}
        .form-group label{display:block;margin-bottom:0.5rem;font-weight:500;font-size:0.9rem}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:0.75rem 1rem;border:2px solid #e5e7eb;border-radius:0.5rem;font-size:1rem;font-family:inherit;transition:border .2s}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary)}
        .btn{display:block;width:100%;padding:0.875rem;border:none;border-radius:0.5rem;font-size:1rem;font-weight:600;cursor:pointer;background:var(--primary);color:white;transition:all 0.2s}
        .btn:hover{background:#1e3a8a;transform:translateY(-1px)}
        .error{background:#fee2e2;color:#dc2626;padding:0.75rem;border-radius:0.5rem;margin-bottom:1rem;display:none;font-size:0.9rem}
        .error.show{display:block}
        
        /* LAYOUT */
        .dashboard{display:none}
        .dashboard.active{display:flex;min-height:100vh}
        
        /* SIDEBAR */
        .sidebar{width:var(--sidebar-w);background:#0f172a;color:#94a3b8;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
        .sidebar-brand{padding:1.25rem;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px}
        .sidebar-brand h2{font-size:1.1rem;color:#fff;font-weight:700}
        .sidebar-brand h2 span{color:var(--accent)}
        .sidebar-nav{flex:1;padding:0.75rem 0;overflow-y:auto}
        .nav-group{padding:0.5rem 1rem;font-size:0.65rem;text-transform:uppercase;font-weight:700;letter-spacing:1px;color:#475569;margin-top:0.5rem}
        .nav-item{display:flex;align-items:center;gap:10px;padding:0.7rem 1.25rem;color:#94a3b8;text-decoration:none;font-size:0.85rem;font-weight:500;cursor:pointer;transition:all .15s;border-left:3px solid transparent}
        .nav-item:hover{background:#1e293b;color:#e2e8f0}
        .nav-item.active{background:#1e293b;color:#fff;border-left-color:var(--accent)}
        .nav-item .nav-badge{background:var(--danger);color:#fff;font-size:0.6rem;padding:2px 6px;border-radius:10px;margin-left:auto}
        .sidebar-footer{padding:1rem;border-top:1px solid #1e293b;font-size:0.75rem}
        
        /* MAIN */
        .main{flex:1;margin-left:var(--sidebar-w);display:flex;flex-direction:column}
        .topbar{background:#fff;padding:0.75rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:50}
        .topbar-left{display:flex;align-items:center;gap:1rem}
        .topbar-left h1{font-size:1.1rem;color:var(--dark)}
        .topbar-right{display:flex;align-items:center;gap:0.75rem}
        .main-content{flex:1;padding:1.5rem;overflow-y:auto}
        
        /* STATS */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:#fff;padding:1.25rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;align-items:center;gap:1rem;cursor:pointer;transition:all .2s;border:1px solid #e5e7eb}
        .stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
        .stat-info h3{font-size:1.5rem;color:var(--dark);font-weight:800;line-height:1}
        .stat-info p{color:var(--gray);font-size:0.75rem;margin-top:2px}
        .stat-info small{font-size:0.7rem;font-weight:600}
        .stat-up{color:var(--success)}
        .stat-down{color:var(--danger)}
        
        /* CARDS */
        .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid #e5e7eb;margin-bottom:1.5rem;overflow:hidden}
        .card-head{padding:1rem 1.25rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem}
        .card-head h2{font-size:1rem;display:flex;align-items:center;gap:0.5rem}
        .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1.5rem}
        
        /* TABLE */
        .wrap{overflow-x:auto}
        .tbl{width:100%;border-collapse:collapse}
        .tbl th{text-align:left;padding:0.75rem 1rem;background:var(--light);font-size:0.7rem;text-transform:uppercase;font-weight:700;letter-spacing:0.5px;color:var(--gray)}
        .tbl td{padding:0.75rem 1rem;border-bottom:1px solid #f3f4f6;font-size:0.85rem}
        .tbl tr:hover{background:#fafbfc}
        .tbl tr{cursor:pointer}
        
        /* BADGES */
        .badge{display:inline-flex;align-items:center;gap:4px;padding:0.25rem 0.6rem;border-radius:2rem;font-size:0.7rem;font-weight:600}
        .b-green{background:#dcfce7;color:#16a34a}.b-yellow{background:#fef3c7;color:#d97706}.b-gray{background:#f3f4f6;color:#6b7280}
        .b-purple{background:#f3e8ff;color:#9333ea}.b-blue{background:#dbeafe;color:#1d4ed8}.b-red{background:#fee2e2;color:#dc2626}
        .b-orange{background:#ffedd5;color:#ea580c}.b-teal{background:#ccfbf1;color:#0d9488}.b-pink{background:#fce7f3;color:#db2777}
        
        /* BUTTONS */
        .btn-sm{padding:0.4rem 0.85rem;font-size:0.8rem;border-radius:0.5rem;border:none;cursor:pointer;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:4px}
        .btn-sm:hover{opacity:0.9;transform:translateY(-1px)}
        .btn-primary{background:var(--primary);color:white}
        .btn-success{background:var(--success);color:white}
        .btn-danger{background:var(--danger);color:white}
        .btn-warning{background:var(--warning);color:white}
        .btn-ghost{background:transparent;color:var(--gray);border:1px solid #e5e7eb}
        .btn-ghost:hover{background:var(--light)}
        .btn-accent{background:var(--accent);color:white}
        
        .actions{display:flex;gap:4px}
        .act{width:32px;height:32px;border:none;background:var(--light);border-radius:8px;cursor:pointer;font-size:0.85rem;display:flex;align-items:center;justify-content:center;transition:all .15s}
        .act:hover{background:var(--primary);color:white}
        .act.danger:hover{background:var(--danger)}
        
        /* SEARCH */
        .search-box{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--light);border-radius:8px;border:1px solid #e5e7eb}
        .search-box input{border:none;background:none;outline:none;width:200px;font-size:0.85rem}
        
        /* FILTER PILLS */
        .filter-bar{display:flex;gap:0.4rem;flex-wrap:wrap;padding:0.75rem 1.25rem;border-bottom:1px solid #e5e7eb}
        .pill{padding:0.35rem 0.85rem;border-radius:2rem;font-size:0.75rem;font-weight:600;cursor:pointer;border:1px solid #e5e7eb;background:#fff;color:var(--gray);transition:all .15s}
        .pill:hover{border-color:var(--primary);color:var(--primary)}
        .pill.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        
        /* USER CARD */
        .user-card{display:flex;align-items:center;gap:0.75rem}
        .avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;color:#fff;background:var(--primary)}
        .user-card h4{font-weight:600;font-size:0.85rem}
        .user-card small{color:var(--gray);font-size:0.75rem}
        
        /* MODAL */
        .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;backdrop-filter:blur(4px)}
        .modal-bg.show{display:flex}
        .modal{background:white;border-radius:16px;width:100%;max-width:700px;max-height:90vh;overflow:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .modal-head{padding:1.25rem 1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}
        .modal-head h3{font-size:1.1rem;display:flex;align-items:center;gap:0.5rem}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray);width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center}
        .modal-close:hover{background:var(--light)}
        .modal-body{padding:1.5rem}
        .modal-foot{padding:1rem 1.5rem;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:0.5rem}
        
        /* DETAIL GRID */
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;font-size:0.85rem}
        .detail-grid .full{grid-column:1/-1}
        .detail-item{padding:0.75rem;background:var(--light);border-radius:8px}
        .detail-item label{font-size:0.7rem;text-transform:uppercase;font-weight:700;color:var(--gray);display:block;margin-bottom:2px}
        .detail-item span{font-weight:600;color:var(--dark)}
        
        /* TIMELINE */
        .timeline{position:relative;padding-left:24px}
        .timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:#e5e7eb}
        .timeline-item{position:relative;padding-bottom:1.25rem}
        .timeline-item::before{content:'';position:absolute;left:-20px;top:4px;width:12px;height:12px;border-radius:50%;background:var(--primary);border:2px solid #fff;box-shadow:0 0 0 2px var(--primary)}
        .timeline-item.success::before{background:var(--success);box-shadow:0 0 0 2px var(--success)}
        .timeline-item.warning::before{background:var(--warning);box-shadow:0 0 0 2px var(--warning)}
        .timeline-item.danger::before{background:var(--danger);box-shadow:0 0 0 2px var(--danger)}
        .timeline-item h5{font-size:0.85rem;margin-bottom:2px}
        .timeline-item p{font-size:0.75rem;color:var(--gray)}
        
        /* TABS inside cards */
        .tab-bar{display:flex;border-bottom:1px solid #e5e7eb}
        .tab-btn{padding:0.75rem 1.25rem;border:none;background:none;font-size:0.8rem;font-weight:600;cursor:pointer;color:var(--gray);border-bottom:2px solid transparent;transition:all .15s}
        .tab-btn:hover{color:var(--primary)}
        .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-pane{display:none;padding:1.25rem}
        .tab-pane.active{display:block}
        
        /* TICKET */
        .ticket-card{border:1px solid #e5e7eb;border-radius:10px;padding:1rem;margin-bottom:0.75rem;cursor:pointer;transition:all .2s}
        .ticket-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .ticket-card.urgent{border-left:4px solid var(--danger)}
        .ticket-card.high{border-left:4px solid var(--warning)}
        .ticket-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem}
        .ticket-meta{display:flex;gap:1rem;font-size:0.78rem;color:var(--gray)}
        
        /* CHAT */
        .chat-container{max-height:350px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:8px}
        .chat-msg{margin-bottom:1rem;display:flex;gap:0.75rem}
        .chat-msg.admin{flex-direction:row-reverse}
        .chat-bubble{max-width:80%;padding:0.75rem 1rem;border-radius:12px;font-size:0.85rem}
        .chat-msg.user .chat-bubble{background:white;border:1px solid #e5e7eb;border-bottom-left-radius:4px}
        .chat-msg.admin .chat-bubble{background:var(--primary);color:white;border-bottom-right-radius:4px}
        .chat-sender{font-size:0.7rem;color:var(--gray);margin-bottom:2px}
        .chat-time{font-size:0.65rem;opacity:0.6;margin-top:4px}
        
        /* STRIPE PANEL */
        .stripe-header{background:linear-gradient(135deg,#635bff,#7c3aed);color:#fff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between}
        .stripe-header h2{display:flex;align-items:center;gap:0.5rem;font-size:1.2rem}
        .stripe-connected{display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;background:rgba(255,255,255,.2);padding:0.4rem 1rem;border-radius:2rem}
        
        /* NOTIF */
        .notif-wrap{position:relative}
        .notif-btn{background:var(--light);border:none;width:38px;height:38px;border-radius:10px;font-size:1.15rem;cursor:pointer;position:relative}
        .notif-badge{position:absolute;top:-2px;right:-2px;background:var(--danger);color:white;font-size:0.55rem;min-width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
        .notif-badge.hidden{display:none}
        .notif-dropdown{position:absolute;top:46px;right:0;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);width:350px;max-height:400px;overflow:auto;display:none;z-index:100;border:1px solid #e5e7eb}
        .notif-dropdown.show{display:block}
        .notif-item{padding:0.75rem 1rem;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;gap:0.75rem;font-size:0.85rem}
        .notif-item:hover{background:#fafbfc}
        .notif-item.unread{background:#eff6ff}
        
        /* CURRENT USER */
        .current-user{display:flex;align-items:center;gap:0.75rem;padding:0.4rem 0.75rem;background:var(--light);border-radius:10px;cursor:pointer}
        .current-user-info{text-align:right}
        .current-user-info h4{font-size:0.78rem;font-weight:600}
        .current-user-info p{font-size:0.62rem;color:var(--gray)}
        
        /* ROLE BADGES */
        .role-super{background:linear-gradient(135deg,#f97316,#ea580c);color:white}
        .role-admin{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
        .role-gerente{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white}
        .role-vendedor{background:linear-gradient(135deg,#f59e0b,#d97706);color:white}
        .role-marketing{background:linear-gradient(135deg,#ec4899,#db2777);color:white}
        .role-contador{background:linear-gradient(135deg,#14b8a6,#0d9488);color:white}
        .role-support{background:linear-gradient(135deg,#22c55e,#16a34a);color:white}
        
        /* STRIPE CONNECT CARD */
        .stripe-key-card{background:linear-gradient(135deg,#635bff 0%,#7c3aed 100%);color:#fff;padding:2rem;border-radius:16px;text-align:center;max-width:500px;margin:2rem auto}
        .stripe-key-card h3{font-size:1.2rem;margin-bottom:0.5rem}
        .stripe-key-card p{font-size:0.85rem;opacity:0.8;margin-bottom:1.5rem}
        .stripe-key-card input{width:100%;padding:0.85rem;border:2px solid rgba(255,255,255,.3);border-radius:10px;background:rgba(255,255,255,.15);color:#fff;font-size:0.9rem;font-family:monospace;text-align:center}
        .stripe-key-card input::placeholder{color:rgba(255,255,255,.5)}
        .stripe-key-card input:focus{outline:none;border-color:#fff}
        .stripe-key-card button{margin-top:1rem;padding:0.75rem 2rem;background:#fff;color:#635bff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer}
        
        /* CHART CONTAINER */
        .chart-container{position:relative;height:280px;padding:1rem}
        
        /* QUICK ACTIONS */
        .quick-actions{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem}
        .quick-action{padding:0.4rem 0.85rem;background:white;border:1px solid #e5e7eb;border-radius:2rem;font-size:0.78rem;cursor:pointer;display:flex;align-items:center;gap:4px;font-weight:500;transition:all .15s}
        .quick-action:hover{border-color:var(--primary);color:var(--primary)}
        
        .empty{text-align:center;padding:2rem;color:var(--gray);font-size:0.9rem}
        
        /* Health Score */
        .health-bar{width:60px;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:6px}
        .health-fill{height:100%;border-radius:4px;transition:width .3s}
        .health-score{font-weight:800;font-size:0.85rem;display:inline-flex;align-items:center;gap:4px}
        
        /* Lifecycle stages */
        .lifecycle{display:inline-flex;align-items:center;gap:4px;padding:0.25rem 0.6rem;border-radius:2rem;font-size:0.7rem;font-weight:700}
        .lc-onboarding{background:#f3e8ff;color:#7c3aed}
        .lc-active{background:#dcfce7;color:#16a34a}
        .lc-at-risk{background:#fef3c7;color:#d97706}
        .lc-overdue{background:#fee2e2;color:#dc2626}
        .lc-churned{background:#f3f4f6;color:#6b7280;text-decoration:line-through}
        .lc-never{background:#fce7f3;color:#db2777}
        
        /* Onboarding pipeline columns */
        .ob-col{background:var(--light);border-radius:10px;padding:0.75rem;min-height:120px}
        .ob-col h4{font-size:0.75rem;text-transform:uppercase;font-weight:700;color:var(--gray);margin-bottom:0.75rem;display:flex;justify-content:space-between}
        .ob-col h4 span{background:var(--primary);color:#fff;font-size:0.6rem;padding:2px 8px;border-radius:10px}
        .ob-card{background:#fff;padding:0.6rem;border-radius:8px;margin-bottom:0.5rem;border:1px solid #e5e7eb;font-size:0.8rem;cursor:pointer;transition:all .15s}
        .ob-card:hover{border-color:var(--primary);box-shadow:0 2px 6px rgba(0,0,0,.08)}
        .ob-card h5{font-size:0.8rem;margin-bottom:2px}
        .ob-card small{color:var(--gray);font-size:0.7rem}
        
        /* Follow-up cards */
        .fu-card{display:flex;gap:0.75rem;padding:0.75rem;border-bottom:1px solid #f3f4f6;align-items:flex-start;cursor:pointer;transition:background .15s}
        .fu-card:hover{background:#fafbfc}
        .fu-card.overdue{background:#fff5f5}
        .fu-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
        .fu-card h5{font-size:0.85rem;margin-bottom:2px}
        .fu-card p{font-size:0.75rem;color:var(--gray)}
        .fu-card .fu-date{font-size:0.7rem;font-weight:700}
        
        /* RESPONSIVE */
        .menu-toggle{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer}
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%)}
            .sidebar.open{transform:translateX(0)}
            .main{margin-left:0}
            .menu-toggle{display:block}
            .stats-grid{grid-template-columns:1fr 1fr}
            .detail-grid{grid-template-columns:1fr}
            .search-box input{width:120px}
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-box" id="login">
    <div class="login-card">
        <h1>ğŸ” Trade<span>Master</span></h1>
        <p>Admin CRM Panel</p>
        <div class="error" id="err"></div>
        <div class="form-group"><label>ğŸ“§ Email</label><input type="email" id="em" placeholder="tu@email.com"></div>
        <div class="form-group"><label>ğŸ”‘ ContraseÃ±a</label><input type="password" id="pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')doLogin()"></div>
        <button class="btn" onclick="doLogin()">Entrar â†’</button>
        <p style="text-align:center;margin-top:1.5rem"><a href="#" onclick="showAdminForgotPassword();return false" style="color:var(--accent);text-decoration:none;font-size:0.85rem">ğŸ”‘ Â¿Olvidaste tu contraseÃ±a?</a></p>
    </div>
</div>

<!-- DASHBOARD LAYOUT -->
<div class="dashboard" id="dash">
    
    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <span style="font-size:1.5rem">ğŸ”§</span>
            <h2>Trade<span>Master</span></h2>
        </div>
        <div class="sidebar-nav">
            <div class="nav-group">Principal</div>
            <div class="nav-item active" onclick="showSec('dashboard',this)">ğŸ“Š Dashboard</div>
            <div class="nav-item" onclick="showSec('empresas',this)">ğŸ¢ Empresas CRM</div>
            <div class="nav-item" onclick="showSec('success',this)">ğŸ¯ Customer Success <span class="nav-badge" id="csBadge" style="display:none">0</span></div>
            <div class="nav-item" onclick="showSec('stripe',this)">ğŸ’³ Stripe Pagos</div>
            
            <div class="nav-group">Soporte</div>
            <div class="nav-item" onclick="showSec('tickets',this)">ğŸ« Tickets <span class="nav-badge" id="ticketsBadge" style="display:none">0</span></div>
            <div class="nav-item" onclick="showSec('passwords',this)">ğŸ”‘ Passwords</div>
            
            <div class="nav-group">Finanzas</div>
            <div class="nav-item" onclick="showSec('revenue',this)">ğŸ“ˆ Revenue</div>
            <div class="nav-item" onclick="showSec('pagos',this)">ğŸ’° Historial Pagos</div>
            
            <div class="nav-group">Ventas & Marketing</div>
            <div class="nav-item" onclick="showSec('vendedores',this)">ğŸ¤ Vendedores</div>
            <div class="nav-item" onclick="showSec('marketing',this)">ğŸ“£ Marketing & ROI</div>
            <div class="nav-item" onclick="showSec('embajadores',this)">ğŸŒŸ Embajadores</div>
            <div class="nav-item" onclick="showSec('demotools',this)">ğŸ¬ Demo & Onboarding</div>
            
            <div class="nav-group">Sistema</div>
            <div class="nav-item" onclick="showSec('admins',this)" id="navAdmins">ğŸ‘¤ Admins</div>
            <div class="nav-item" onclick="showSec('logs',this)">ğŸ“‹ Logs</div>
            <div class="nav-item" onclick="showSec('settings',this)">âš™ï¸ Config</div>
        </div>
        <div class="sidebar-footer">
            <div style="display:flex;align-items:center;gap:8px">
                <div class="avatar" id="sideAv" style="width:32px;height:32px;font-size:0.7rem">M</div>
                <div><div style="font-size:0.8rem;font-weight:600;color:#fff" id="sideName">Admin</div><div style="font-size:0.65rem;color:#64748b" id="sideRole">Role</div></div>
            </div>
        </div>
    </nav>
    
    <!-- MAIN AREA -->
    <div class="main">
        <header class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
                <h1 id="pageTitle">ğŸ“Š Dashboard</h1>
            </div>
            <div class="topbar-right">
                <div class="notif-wrap">
                    <button class="notif-btn" onclick="toggleNotifications()">ğŸ””<span class="notif-badge" id="notifBadge">0</span></button>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div style="padding:1rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
                            <h4 style="font-size:0.9rem">Notificaciones</h4>
                            <button class="btn-sm btn-ghost" onclick="markAllRead()" style="font-size:0.7rem">Marcar leÃ­das</button>
                        </div>
                        <div id="notifList"><div class="empty" style="padding:1.5rem">Sin notificaciones</div></div>
                    </div>
                </div>
                <button class="btn-sm btn-ghost" onclick="refreshAll()">ğŸ”„</button>
                <div class="current-user" onclick="showSec('admins',document.getElementById('navAdmins'))">
                    <div class="current-user-info"><h4 id="currentUserName">User</h4><p id="currentUserRole">Role</p></div>
                    <div class="avatar" id="av">M</div>
                </div>
                <button class="btn-sm btn-danger" onclick="doLogout()">Salir</button>
            </div>
        </header>
        
        <div class="main-content">
            
<!-- ============ SECTION: DASHBOARD ============ -->
<div class="section active" id="secDashboard">
    <div class="stats-grid">
        <div class="stat-card" onclick="showSec('empresas')"><div class="stat-icon" style="background:#dbeafe">ğŸ¢</div><div class="stat-info"><h3 id="s1">0</h3><p>Total Empresas</p></div></div>
        <div class="stat-card" onclick="showSec('empresas')"><div class="stat-icon" style="background:#dcfce7">âœ…</div><div class="stat-info"><h3 id="s2">0</h3><p>Suscripciones Activas</p></div></div>
        <div class="stat-card" onclick="showSec('revenue')"><div class="stat-icon" style="background:#f3e8ff">ğŸ’°</div><div class="stat-info"><h3 id="s3">$0</h3><p>MRR</p></div></div>
        <div class="stat-card" onclick="showSec('tickets')"><div class="stat-icon" style="background:#fee2e2">ğŸ«</div><div class="stat-info"><h3 id="s6">0</h3><p>Tickets Abiertos</p></div></div>
        <div class="stat-card" onclick="showSec('empresas')"><div class="stat-icon" style="background:#fef3c7">â³</div><div class="stat-info"><h3 id="sTrial">0</h3><p>En Trial</p></div></div>
        <div class="stat-card" onclick="showSec('stripe')"><div class="stat-icon" style="background:#ccfbf1">ğŸ“Š</div><div class="stat-info"><h3 id="sChurn">0%</h3><p>Churn Rate</p></div></div>
    </div>
    <div class="card-grid">
        <div class="card">
            <div class="card-head"><h2>ğŸ“ˆ Revenue (6 meses)</h2></div>
            <div class="chart-container"><canvas id="revenueChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-head"><h2>ğŸ¢ Empresas por Plan</h2></div>
            <div class="chart-container"><canvas id="planChart"></canvas></div>
        </div>
    </div>
    <div class="card-grid">
        <div class="card">
            <div class="card-head"><h2>ğŸ• Actividad Reciente</h2></div>
            <div id="recentActivity" style="padding:1rem;max-height:300px;overflow-y:auto"><p class="empty">Cargando...</p></div>
        </div>
        <div class="card">
            <div class="card-head"><h2>ğŸ†• Ãšltimas Empresas</h2><button class="btn-sm btn-ghost" onclick="showSec('empresas')">Ver todas â†’</button></div>
            <div class="wrap"><table class="tbl"><thead><tr><th>#</th><th>Empresa</th><th>Plan</th><th>Registro</th></tr></thead><tbody id="recentCompanies"></tbody></table></div>
        </div>
    </div>
</div>

<!-- ============ SECTION: EMPRESAS CRM ============ -->
<div class="section" id="secEmpresas">
    <div class="card">
        <div class="card-head">
            <h2>ğŸ¢ Empresas CRM</h2>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <div class="search-box"><span>ğŸ”</span><input type="text" placeholder="Buscar empresa..." id="q" oninput="doSearch()"></div>
                <button class="btn-sm btn-primary" onclick="exportCompaniesCSV()">ğŸ“¥ CSV</button>
            </div>
        </div>
        <div class="filter-bar">
            <div class="pill active" onclick="filterCompanies('all',this)">Todos</div>
            <div class="pill" onclick="filterCompanies('free',this)">ğŸ†“ Free</div>
            <div class="pill" onclick="filterCompanies('profesional',this)">â­ Pro</div>
            <div class="pill" onclick="filterCompanies('enterprise',this)">ğŸ’ Enterprise</div>
            <div class="pill" onclick="filterCompanies('active',this)">âœ… Activos</div>
            <div class="pill" onclick="filterCompanies('canceled',this)">âŒ Cancelados</div>
            <div class="pill" onclick="filterCompanies('trial',this)">â³ Trial</div>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>#</th><th>Empresa</th><th>TelÃ©fono</th><th>Registrado</th><th>Plan</th><th>Status</th><th>Stripe</th><th>Empleados</th><th>Acciones</th>
        </tr></thead><tbody id="tbody"></tbody></table></div>
    </div>
</div>

<!-- ============ SECTION: CUSTOMER SUCCESS ============ -->
<div class="section" id="secSuccess">
    <!-- Health Overview KPIs -->
    <div class="stats-grid">
        <div class="stat-card" style="border-left:4px solid var(--success)"><div class="stat-icon" style="background:#dcfce7">ğŸ’š</div><div class="stat-info"><h3 id="csHealthy">0</h3><p>Healthy (Pagando)</p></div></div>
        <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-icon" style="background:#fef3c7">âš ï¸</div><div class="stat-info"><h3 id="csAtRisk">0</h3><p>At Risk</p></div></div>
        <div class="stat-card" style="border-left:4px solid var(--danger)"><div class="stat-icon" style="background:#fee2e2">ğŸ”´</div><div class="stat-info"><h3 id="csOverdue">0</h3><p>Pago Vencido</p></div></div>
        <div class="stat-card" style="border-left:4px solid var(--gray)"><div class="stat-icon" style="background:#f3f4f6">ğŸ‘»</div><div class="stat-info"><h3 id="csNeverPaid">0</h3><p>Nunca Pagaron</p></div></div>
        <div class="stat-card" style="border-left:4px solid #8b5cf6"><div class="stat-icon" style="background:#f3e8ff">ğŸ†•</div><div class="stat-info"><h3 id="csOnboarding">0</h3><p>En Onboarding</p></div></div>
        <div class="stat-card" style="border-left:4px solid #ec4899"><div class="stat-icon" style="background:#fce7f3">ğŸ’€</div><div class="stat-info"><h3 id="csChurned">0</h3><p>Churned</p></div></div>
    </div>

    <!-- Filter Bar -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ¯ Customer Success â€” Lifecycle Tracker</h2>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <div class="search-box"><span>ğŸ”</span><input type="text" placeholder="Buscar..." id="csSearch" oninput="filterCS()"></div>
                <button class="btn-sm btn-primary" onclick="exportCSReport()">ğŸ“¥ Export</button>
            </div>
        </div>
        <div class="filter-bar" id="csFilters">
            <div class="pill active" onclick="filterCSStatus('all',this)">ğŸ“‹ Todos</div>
            <div class="pill" onclick="filterCSStatus('healthy',this)" style="border-color:#22c55e">ğŸ’š Healthy</div>
            <div class="pill" onclick="filterCSStatus('at_risk',this)" style="border-color:#eab308">âš ï¸ At Risk</div>
            <div class="pill" onclick="filterCSStatus('overdue',this)" style="border-color:#ef4444">ğŸ”´ Vencido</div>
            <div class="pill" onclick="filterCSStatus('never_paid',this)" style="border-color:#6b7280">ğŸ‘» Nunca PagÃ³</div>
            <div class="pill" onclick="filterCSStatus('onboarding',this)" style="border-color:#8b5cf6">ğŸ†• Onboarding</div>
            <div class="pill" onclick="filterCSStatus('churned',this)" style="border-color:#ec4899">ğŸ’€ Churned</div>
        </div>
        <div class="wrap">
            <table class="tbl">
                <thead><tr>
                    <th>#</th>
                    <th>Empresa</th>
                    <th>Health</th>
                    <th>Lifecycle</th>
                    <th>Plan</th>
                    <th>Ãšltimo Pago</th>
                    <th>DÃ­as sin Pagar</th>
                    <th>Total Pagado</th>
                    <th>Registro</th>
                    <th>Acciones</th>
                </tr></thead>
                <tbody id="csTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Follow-up Tasks -->
    <div class="card-grid">
        <div class="card">
            <div class="card-head">
                <h2>ğŸ“ Follow-Ups Pendientes</h2>
                <button class="btn-sm btn-success" onclick="openAddFollowUp()">â• Nuevo</button>
            </div>
            <div id="followUpList" style="padding:1rem;max-height:400px;overflow-y:auto"><p class="empty">Sin follow-ups</p></div>
        </div>
        <div class="card">
            <div class="card-head"><h2>ğŸ“Š Health Distribution</h2></div>
            <div class="chart-container"><canvas id="csHealthChart"></canvas></div>
        </div>
    </div>

    <!-- Onboarding Pipeline -->
    <div class="card">
        <div class="card-head"><h2>ğŸš€ Onboarding Pipeline</h2></div>
        <div style="padding:1.25rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem" id="onboardingPipeline">
        </div>
    </div>
</div>

<!-- ============ SECTION: STRIPE ============ -->
<div class="section" id="secStripe">
    <div id="stripeNotConnected">
        <div class="stripe-key-card">
            <div style="font-size:3rem;margin-bottom:1rem">ğŸ’³</div>
            <h3>Conectar Stripe</h3>
            <p>Ingresa tu Stripe Secret Key para ver clientes, pagos y hacer reembolsos en tiempo real.</p>
            <input type="password" id="stripeKeyInput" placeholder="sk_live_... o sk_test_...">
            <br><button onclick="connectStripe()">ğŸ”— Conectar</button>
            <p style="font-size:0.7rem;opacity:0.6;margin-top:1rem">La key se guarda solo en tu navegador (localStorage)</p>
        </div>
    </div>
    <div id="stripeConnected" style="display:none">
        <div class="stripe-header">
            <h2>ğŸ’³ Stripe Dashboard</h2>
            <div style="display:flex;align-items:center;gap:1rem">
                <div class="stripe-connected">ğŸŸ¢ Conectado</div>
                <button class="btn-sm" style="background:rgba(255,255,255,.2);color:#fff" onclick="disconnectStripe()">Desconectar</button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon" style="background:#f3e8ff">ğŸ’°</div><div class="stat-info"><h3 id="stripeBalance">$0</h3><p>Balance Disponible</p></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#dcfce7">ğŸ‘¥</div><div class="stat-info"><h3 id="stripeCust">0</h3><p>Clientes Stripe</p></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#dbeafe">ğŸ”„</div><div class="stat-info"><h3 id="stripeSubs">0</h3><p>Suscripciones Activas</p></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#fef3c7">ğŸ“…</div><div class="stat-info"><h3 id="stripeMonth">$0</h3><p>Ingresos Este Mes</p></div></div>
        </div>
        <div class="card">
            <div class="card-head">
                <h2>ğŸ’³ Clientes & Pagos Stripe</h2>
                <div style="display:flex;gap:0.5rem">
                    <button class="btn-sm btn-ghost" onclick="loadStripeData()">ğŸ”„ Refresh</button>
                </div>
            </div>
            <div class="tab-bar">
                <button class="tab-btn active" onclick="showStripeTab('customers',this)">ğŸ‘¥ Clientes</button>
                <button class="tab-btn" onclick="showStripeTab('payments',this)">ğŸ’° Pagos</button>
                <button class="tab-btn" onclick="showStripeTab('subscriptions',this)">ğŸ”„ Suscripciones</button>
                <button class="tab-btn" onclick="showStripeTab('refunds',this)">â†©ï¸ Reembolsos</button>
            </div>
            <div class="tab-pane active" id="stripeTabCustomers">
                <div class="wrap"><table class="tbl"><thead><tr><th>Cliente</th><th>Email</th><th>Creado</th><th>SuscripciÃ³n</th><th>Total Pagado</th><th>Acciones</th></tr></thead><tbody id="stripeCustomersTable"></tbody></table></div>
            </div>
            <div class="tab-pane" id="stripeTabPayments">
                <div class="wrap"><table class="tbl"><thead><tr><th>Fecha</th><th>Cliente</th><th>Monto</th><th>Estado</th><th>ID</th><th>Acciones</th></tr></thead><tbody id="stripePaymentsTable"></tbody></table></div>
            </div>
            <div class="tab-pane" id="stripeTabSubscriptions">
                <div class="wrap"><table class="tbl"><thead><tr><th>Cliente</th><th>Plan</th><th>Monto</th><th>Status</th><th>PrÃ³ximo Cobro</th><th>Acciones</th></tr></thead><tbody id="stripeSubsTable"></tbody></table></div>
            </div>
            <div class="tab-pane" id="stripeTabRefunds">
                <div class="wrap"><table class="tbl"><thead><tr><th>Fecha</th><th>Cliente</th><th>Monto</th><th>RazÃ³n</th><th>Estado</th></tr></thead><tbody id="stripeRefundsTable"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<!-- ============ SECTION: TICKETS ============ -->
<div class="section" id="secTickets">
    <div class="quick-actions">
        <button class="quick-action" onclick="filterTickets('all')">ğŸ“‹ Todos</button>
        <button class="quick-action" onclick="filterTickets('open')">ğŸŸ¢ Abiertos</button>
        <button class="quick-action" onclick="filterTickets('in_progress')">ğŸŸ¡ En Progreso</button>
        <button class="quick-action" onclick="filterTickets('waiting_response')">ğŸŸ  Esperando</button>
        <button class="quick-action" onclick="filterTickets('resolved')">âœ… Resueltos</button>
    </div>
    <div class="card">
        <div class="card-head">
            <h2>ğŸ« Tickets de Soporte</h2>
            <div class="search-box"><span>ğŸ”</span><input type="text" placeholder="Buscar ticket..." oninput="searchTickets(this.value)"></div>
        </div>
        <div style="padding:1rem" id="ticketsList"><p class="empty">Cargando tickets...</p></div>
    </div>
</div>

<!-- ============ SECTION: PASSWORDS ============ -->
<div class="section" id="secPasswords">
    <div class="card">
        <div class="card-head"><h2>ğŸ”‘ Reset Requests</h2><button class="btn-sm btn-success" onclick="openManualResetModal()">â• Reset Manual</button></div>
        <div class="wrap"><table class="tbl"><thead><tr><th>Usuario</th><th>Email</th><th>Empresa</th><th>Solicitado</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="passwordResets"></tbody></table></div>
    </div>
    <div class="card">
        <div class="card-head"><h2>âš¡ Reset RÃ¡pido</h2></div>
        <div style="padding:1.25rem">
            <p style="font-size:0.85rem;color:var(--gray);margin-bottom:1rem">Busca por email para resetear contraseÃ±a o enviar magic link.</p>
            <div style="display:flex;gap:0.5rem">
                <input type="email" id="quickResetEmail" placeholder="email@empresa.com" style="flex:1;padding:0.75rem;border:2px solid #e5e7eb;border-radius:8px">
                <button class="btn-sm btn-primary" onclick="quickSearchUser()">ğŸ” Buscar</button>
            </div>
            <div id="quickResetResult" style="margin-top:1rem"></div>
        </div>
    </div>
</div>

<!-- ============ SECTION: REVENUE ============ -->
<div class="section" id="secRevenue">
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon" style="background:#dcfce7">ğŸ’µ</div><div class="stat-info"><h3 id="totalRevenue">$0</h3><p>Ingresos Totales</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#dbeafe">ğŸ“…</div><div class="stat-info"><h3 id="monthlyRevenue">$0</h3><p>Este Mes</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#f3e8ff">ğŸ“Š</div><div class="stat-info"><h3 id="avgRevenue">$0</h3><p>Promedio/Empresa</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#fef3c7">â†©ï¸</div><div class="stat-info"><h3 id="totalRefunds">$0</h3><p>Total Reembolsos</p></div></div>
    </div>
    <div class="card">
        <div class="card-head"><h2>ğŸ“ˆ Revenue por Mes</h2></div>
        <div class="chart-container"><canvas id="revDetailChart"></canvas></div>
    </div>
    <div class="card">
        <div class="card-head"><h2>ğŸ’° Historial de Pagos</h2><button class="btn-sm btn-success" onclick="openAddPaymentModal()">â• Registrar Pago</button></div>
        <div class="wrap"><table class="tbl"><thead><tr><th>Fecha</th><th>Empresa</th><th>Plan</th><th>Monto</th><th>MÃ©todo</th><th>Estado</th></tr></thead><tbody id="paymentsTable"></tbody></table></div>
    </div>
</div>

<!-- ============ SECTION: PAGOS (Historial) ============ -->
<div class="section" id="secPagos">
    <div class="card">
        <div class="card-head"><h2>ğŸ’³ Todos los Pagos</h2><button class="btn-sm btn-success" onclick="openAddPaymentModal()">â• Registrar Pago</button></div>
        <div class="wrap"><table class="tbl"><thead><tr><th>Fecha</th><th>Empresa</th><th>Plan</th><th>Monto</th><th>MÃ©todo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="allPaymentsTable"></tbody></table></div>
    </div>
</div>

<!-- ============ SECTION: VENDEDORES ============ -->
<div class="section" id="secVendedores">
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon" style="background:#dbeafe">ğŸ¤</div><div class="stat-info"><h3 id="svTotal">0</h3><p>Vendedores Activos</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#dcfce7">ğŸ†</div><div class="stat-info"><h3 id="svDeals">0</h3><p>Ventas Cerradas</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#f3e8ff">ğŸ’°</div><div class="stat-info"><h3 id="svRevenue">$0</h3><p>Revenue por Ventas</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#fef3c7">ğŸ’¸</div><div class="stat-info"><h3 id="svComm">$0</h3><p>Comisiones Pagadas</p></div></div>
    </div>

    <!-- Vendedores List -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ¤ Equipo de Ventas</h2>
            <button class="btn-sm btn-success" onclick="openAddSalesRep()">â• Nuevo Vendedor</button>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>Vendedor</th><th>Contacto</th><th>Tipo ComisiÃ³n</th><th>Ventas</th><th>Revenue</th><th>ComisiÃ³n Ganada</th><th>Status</th><th>Acciones</th>
        </tr></thead><tbody id="salesRepsTable"></tbody></table></div>
    </div>

    <!-- Ventas Cerradas -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ† Ventas Cerradas</h2>
            <div style="display:flex;gap:0.5rem">
                <select id="dealsFilterRep" onchange="filterDeals()" style="padding:0.4rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                    <option value="all">Todos los vendedores</option>
                </select>
                <select id="dealsFilterChannel" onchange="filterDeals()" style="padding:0.4rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                    <option value="all">Todos los canales</option>
                    <option value="visita">ğŸš¶ Visita</option>
                    <option value="llamada">ğŸ“ Llamada</option>
                    <option value="facebook">ğŸ“˜ Facebook</option>
                    <option value="instagram">ğŸ“¸ Instagram</option>
                    <option value="google_ads">ğŸ” Google Ads</option>
                    <option value="referido">ğŸ—£ï¸ Referido</option>
                    <option value="website">ğŸŒ Website</option>
                    <option value="otro">ğŸ“‹ Otro</option>
                </select>
                <button class="btn-sm btn-success" onclick="openAddDeal()">â• Registrar Venta</button>
            </div>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>Fecha</th><th>Vendedor</th><th>Empresa</th><th>Canal</th><th>Plan</th><th>Monto</th><th>ComisiÃ³n</th><th>Notas</th>
        </tr></thead><tbody id="dealsTable"></tbody></table></div>
    </div>

    <!-- Channel Breakdown -->
    <div class="card-grid">
        <div class="card">
            <div class="card-head"><h2>ğŸ“Š Ventas por Canal</h2></div>
            <div class="chart-container"><canvas id="channelChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-head"><h2>ğŸ… Top Vendedores</h2></div>
            <div id="topSalesReps" style="padding:1rem"><p class="empty">Sin datos</p></div>
        </div>
    </div>
</div>

<!-- ============ SECTION: MARKETING ============ -->
<div class="section" id="secMarketing">
    <div class="stats-grid">
        <div class="stat-card" style="border-left:4px solid #3b82f6"><div class="stat-icon" style="background:#dbeafe">ğŸ“£</div><div class="stat-info"><h3 id="mkTotal">0</h3><p>CampaÃ±as Activas</p></div></div>
        <div class="stat-card" style="border-left:4px solid #ef4444"><div class="stat-icon" style="background:#fee2e2">ğŸ’¸</div><div class="stat-info"><h3 id="mkSpent">$0</h3><p>Total Invertido</p></div></div>
        <div class="stat-card" style="border-left:4px solid #22c55e"><div class="stat-icon" style="background:#dcfce7">ğŸ’°</div><div class="stat-info"><h3 id="mkRevenue">$0</h3><p>Revenue Generado</p></div></div>
        <div class="stat-card" style="border-left:4px solid #8b5cf6"><div class="stat-icon" style="background:#f3e8ff">ğŸ“ˆ</div><div class="stat-info"><h3 id="mkROI">0%</h3><p>ROI General</p></div></div>
        <div class="stat-card" style="border-left:4px solid #f97316"><div class="stat-icon" style="background:#ffedd5">ğŸ‘¥</div><div class="stat-info"><h3 id="mkLeads">0</h3><p>Leads Generados</p></div></div>
        <div class="stat-card" style="border-left:4px solid #ec4899"><div class="stat-icon" style="background:#fce7f3">ğŸ¯</div><div class="stat-info"><h3 id="mkConv">0%</h3><p>Tasa ConversiÃ³n</p></div></div>
    </div>

    <!-- Campaigns -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ“£ CampaÃ±as de Marketing</h2>
            <button class="btn-sm btn-success" onclick="openAddCampaign()">â• Nueva CampaÃ±a</button>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>CampaÃ±a</th><th>Plataforma</th><th>Invertido</th><th>Leads</th><th>Conversiones</th><th>Revenue</th><th>ROI</th><th>Status</th><th>Acciones</th>
        </tr></thead><tbody id="campaignsTable"></tbody></table></div>
    </div>

    <!-- Marketing Expenses -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ’¸ Gastos de Marketing</h2>
            <button class="btn-sm btn-success" onclick="openAddMkExpense()">â• Registrar Gasto</button>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>Fecha</th><th>CampaÃ±a</th><th>Concepto</th><th>Monto</th><th>Plataforma</th><th>Notas</th>
        </tr></thead><tbody id="mkExpensesTable"></tbody></table></div>
    </div>

    <!-- Charts -->
    <div class="card-grid">
        <div class="card">
            <div class="card-head"><h2>ğŸ“Š ROI por Plataforma</h2></div>
            <div class="chart-container"><canvas id="roiChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-head"><h2>ğŸ’° InversiÃ³n vs Revenue</h2></div>
            <div class="chart-container"><canvas id="mkRevenueChart"></canvas></div>
        </div>
    </div>
</div>

<!-- ============ SECTION: ADMINS ============ -->
<!-- ============ SECTION: EMBAJADORES ============ -->
<div class="section" id="secEmbajadores">
    <div class="stats-grid">
        <div class="stat-card" style="border-left:4px solid #f97316"><div class="stat-icon" style="background:#fff7ed">ğŸŒŸ</div><div class="stat-info"><h3 id="ambTotalRefs">0</h3><p>Total Referidos</p></div></div>
        <div class="stat-card" style="border-left:4px solid #22c55e"><div class="stat-icon" style="background:#dcfce7">âœ…</div><div class="stat-info"><h3 id="ambTotalConverted">0</h3><p>Convertidos</p></div></div>
        <div class="stat-card" style="border-left:4px solid #3b82f6"><div class="stat-icon" style="background:#dbeafe">ğŸ¢</div><div class="stat-info"><h3 id="ambActiveAmbassadors">0</h3><p>Embajadores Activos</p></div></div>
        <div class="stat-card" style="border-left:4px solid #8b5cf6"><div class="stat-icon" style="background:#f3e8ff">ğŸ’°</div><div class="stat-info"><h3 id="ambTotalPaid">$0</h3><p>Comisiones Pagadas</p></div></div>
        <div class="stat-card" style="border-left:4px solid #ef4444"><div class="stat-icon" style="background:#fee2e2">ğŸ’¸</div><div class="stat-info"><h3 id="ambTotalPending">$0</h3><p>Comisiones Pendientes</p></div></div>
        <div class="stat-card" style="border-left:4px solid #14b8a6"><div class="stat-icon" style="background:#ccfbf1">ğŸ“ˆ</div><div class="stat-info"><h3 id="ambMonthlyRecurring">$0</h3><p>Comisiones Recurrentes/Mes</p></div></div>
    </div>

    <!-- All Referrals -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ“‹ Todos los Referidos</h2>
            <div style="display:flex;gap:0.5rem">
                <select id="ambFilterStatus" onchange="filterAmbRefs()" style="padding:0.4rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                    <option value="all">Todos</option>
                    <option value="pending">â³ Pendientes</option>
                    <option value="registered">ğŸ“ Registrados</option>
                    <option value="converted">âœ… Convertidos</option>
                    <option value="active">ğŸŸ¢ Activos</option>
                    <option value="cancelled">âŒ Cancelados</option>
                </select>
                <button class="btn-sm btn-success" onclick="openAddReferral()">â• Referido Manual</button>
            </div>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>Embajador (QuiÃ©n RefiriÃ³)</th><th>Negocio Referido</th><th>Fecha</th><th>Plan</th><th>Status</th><th>ComisiÃ³n/Mes</th><th>Acciones</th>
        </tr></thead><tbody id="ambRefsTable"></tbody></table></div>
    </div>

    <!-- Payout Management -->
    <div class="card">
        <div class="card-head">
            <h2>ğŸ’¸ Pagos de Comisiones</h2>
            <button class="btn-sm btn-success" onclick="openPayAmbassador()">ğŸ’µ Pagar ComisiÃ³n</button>
        </div>
        <div class="wrap"><table class="tbl"><thead><tr>
            <th>Embajador</th><th>Monto</th><th>Fecha</th><th>MÃ©todo</th><th>Status</th><th>Notas</th>
        </tr></thead><tbody id="ambPayoutsTable"></tbody></table></div>
    </div>

    <!-- Top Ambassadors -->
    <div class="card">
        <div class="card-head"><h2>ğŸ† Top Embajadores</h2></div>
        <div id="topAmbassadors" style="padding:1rem"><p class="empty">Sin datos</p></div>
    </div>
</div>

<!-- ============ SECTION: DEMO & ONBOARDING TOOLS ============ -->
<div class="section" id="secDemotools">
    <!-- Hero -->
    <div class="card" style="background:linear-gradient(135deg,#1e3a5f 0%,#2d5a8e 100%);color:#fff;margin-bottom:1.5rem;border:none">
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
            <span style="font-size:48px">ğŸ¬</span>
            <div style="flex:1">
                <h2 style="margin:0;font-size:1.2rem">Demo AI & Herramientas de Onboarding</h2>
                <p style="margin:4px 0 0;font-size:0.8rem;opacity:.8">QR codes, business cards, links compartibles y email templates para cerrar ventas</p>
            </div>
            <a href="https://acvolttech.github.io/trademaster-crm/?demo=true" target="_blank" style="background:#f97316;color:#fff;padding:10px 20px;border-radius:10px;text-decoration:none;font-weight:700;font-size:0.85rem">â–¶ï¸ Ver Demo en Vivo</a>
        </div>
    </div>

    <!-- Demo Link + QR -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <!-- Link Section -->
        <div class="card">
            <div class="card-head"><h2>ğŸ”— Link del Demo</h2></div>
            <div style="padding:1rem">
                <p style="font-size:0.8rem;color:var(--gray);margin-bottom:1rem">Este link abre el CRM con la demo AI de Brenda/Danielle. El cliente ve todo el CRM funcionando con datos reales y narraciÃ³n de voz.</p>
                <div style="background:#f1f5f9;border:2px solid #e2e8f0;border-radius:10px;padding:12px;font-family:monospace;font-size:0.8rem;word-break:break-all;margin-bottom:1rem" id="demoLinkDisplay">https://acvolttech.github.io/trademaster-crm/?demo=true</div>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                    <button class="btn-sm btn-success" onclick="copyDemoLink()">ğŸ“‹ Copiar Link</button>
                    <button class="btn-sm" style="background:#25d366;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="shareDemoWhatsApp()">ğŸ’¬ WhatsApp</button>
                    <button class="btn-sm" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="shareDemoEmail()">ğŸ“§ Email</button>
                    <button class="btn-sm" style="background:#000;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="shareDemoSMS()">ğŸ“± Texto</button>
                </div>
                <div style="margin-top:1rem;background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:10px;font-size:0.72rem;color:#92400e">
                    <strong>ğŸ’¡ Tip para vendedores:</strong> Manda este link por WhatsApp con un mensaje como: "Mira este sistema que maneja todo tu negocio en un solo lugar. Dale play y Brenda te muestra todo ğŸ¬"
                </div>
            </div>
        </div>

        <!-- QR Code -->
        <div class="card">
            <div class="card-head"><h2>ğŸ“± QR Code del Demo</h2></div>
            <div style="padding:1rem;text-align:center">
                <p style="font-size:0.8rem;color:var(--gray);margin-bottom:1rem">Escanear = Abre el demo automÃ¡ticamente. Perfecto para tarjetas, flyers y presentaciones.</p>
                <div id="demoQRCode" style="margin:0 auto 1rem;width:220px;height:220px;background:#f3f4f6;border-radius:12px;display:flex;align-items:center;justify-content:center">
                    <img src="" id="demoQRImg" style="width:220px;height:220px;border-radius:12px" alt="QR">
                </div>
                <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap">
                    <button class="btn-sm btn-success" onclick="downloadDemoQR()">â¬‡ï¸ Descargar QR</button>
                    <button class="btn-sm" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="downloadDemoQRHD()">â¬‡ï¸ QR HD (grande)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Cards & Pamphlets -->
    <div class="card" style="margin-bottom:1.5rem">
        <div class="card-head"><h2>ğŸªª Tarjetas & Material Imprimible</h2></div>
        <div style="padding:1rem">
            <p style="font-size:0.8rem;color:var(--gray);margin-bottom:1rem">Imprime tarjetas profesionales con QR para tus vendedores. El cliente escanea â†’ ve el demo â†’ se registra.</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem">
                <!-- Business Card Preview -->
                <div style="border:2px solid #e5e7eb;border-radius:12px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1e3a5f,#2d5a8e);padding:16px;color:#fff">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="font-size:14px;font-weight:900">ğŸ—ï¸ TRADE MASTER CRM</div>
                                <div style="font-size:9px;opacity:.7;margin-top:2px">#1 HVAC & Contractor Management</div>
                            </div>
                            <div style="width:50px;height:50px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center"><img src="" class="demoQRMini" style="width:46px;height:46px;border-radius:4px" alt="QR"></div>
                        </div>
                        <div style="margin-top:10px;font-size:10px;opacity:.9">
                            âœ… Clientes & Trabajos &nbsp;âœ… GPS & Despacho<br>
                            âœ… Facturas & Cobros &nbsp;âœ… NÃ³mina & Reportes
                        </div>
                    </div>
                    <div style="padding:12px;background:#fff;text-align:center">
                        <div style="font-size:11px;font-weight:800;color:#f97316;margin-bottom:4px">ğŸ“± ESCANEA PARA VER DEMO EN VIVO</div>
                        <div style="font-size:9px;color:#6b7280">trademaster-crm.com â€¢ Free para 10 clientes</div>
                    </div>
                </div>
                <!-- Flyer Preview -->
                <div style="border:2px solid #e5e7eb;border-radius:12px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#f97316,#ea580c);padding:16px;color:#fff;text-align:center">
                        <div style="font-size:16px;font-weight:900">Â¿TODAVÃA USAS PAPEL?</div>
                        <div style="font-size:11px;margin-top:4px;opacity:.9">Maneja TODO tu negocio desde el celular ğŸ“±</div>
                    </div>
                    <div style="padding:16px;background:#fff;text-align:center">
                        <div style="width:80px;height:80px;margin:0 auto 8px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center"><img src="" class="demoQRMini" style="width:76px;height:76px;border-radius:6px" alt="QR"></div>
                        <div style="font-size:12px;font-weight:800;color:#1e293b">ESCANEA â†’ VE EL DEMO â†’ REGÃSTRATE</div>
                        <div style="font-size:9px;color:#6b7280;margin-top:4px">Trade Master CRM â€” Gratis para empezar</div>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap">
                <button class="btn-sm btn-success" onclick="printBusinessCards()">ğŸ–¨ï¸ Imprimir Tarjetas (8 por pÃ¡gina)</button>
                <button class="btn-sm" style="background:#8b5cf6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="printFlyers()">ğŸ–¨ï¸ Imprimir Flyers (4 por pÃ¡gina)</button>
            </div>
        </div>
    </div>

    <!-- Email Marketing Templates -->
    <div class="card" style="margin-bottom:1.5rem">
        <div class="card-head"><h2>ğŸ“§ Templates de Email Marketing</h2></div>
        <div style="padding:1rem">
            <p style="font-size:0.8rem;color:var(--gray);margin-bottom:1rem">Emails listos para enviar a compaÃ±Ã­as de construcciÃ³n, HVAC, plomerÃ­a y electricidad.</p>
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                <button class="btn-sm" style="background:#f97316;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer;font-weight:700" onclick="showEmailTemplate('cold')">ğŸ¥¶ Cold Outreach</button>
                <button class="btn-sm" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer;font-weight:700" onclick="showEmailTemplate('followup')">ğŸ”„ Follow Up</button>
                <button class="btn-sm" style="background:#22c55e;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer;font-weight:700" onclick="showEmailTemplate('referral')">ğŸ¤ Para Referidos</button>
                <button class="btn-sm" style="background:#8b5cf6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer;font-weight:700" onclick="showEmailTemplate('construction')">ğŸ—ï¸ ConstrucciÃ³n</button>
            </div>
            <div id="emailTemplatePreview" style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;padding:16px;min-height:200px">
                <div style="text-align:center;color:#9ca3af;padding:20px;font-size:0.85rem">ğŸ‘† Selecciona un template arriba</div>
            </div>
            <div style="display:flex;gap:0.5rem;margin-top:1rem">
                <button class="btn-sm btn-success" onclick="copyEmailTemplate()">ğŸ“‹ Copiar Email</button>
                <button class="btn-sm" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.75rem;cursor:pointer" onclick="openEmailTemplate()">ğŸ“§ Abrir en Email</button>
            </div>
        </div>
    </div>

    <!-- Vendedor Kit -->
    <div class="card">
        <div class="card-head"><h2>ğŸ’ Kit del Vendedor</h2></div>
        <div style="padding:1rem">
            <p style="font-size:0.8rem;color:var(--gray);margin-bottom:1rem">Todo lo que necesita tu equipo de ventas para cerrar.</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem">
                <div style="background:#fff7ed;border:2px solid #fed7aa;border-radius:12px;padding:16px;text-align:center;cursor:pointer" onclick="copyDemoLink()">
                    <div style="font-size:28px;margin-bottom:6px">ğŸ”—</div>
                    <div style="font-size:0.8rem;font-weight:700">Link del Demo</div>
                    <div style="font-size:0.7rem;color:var(--gray)">Click para copiar</div>
                </div>
                <div style="background:#eff6ff;border:2px solid #bfdbfe;border-radius:12px;padding:16px;text-align:center;cursor:pointer" onclick="downloadDemoQR()">
                    <div style="font-size:28px;margin-bottom:6px">ğŸ“±</div>
                    <div style="font-size:0.8rem;font-weight:700">QR Code</div>
                    <div style="font-size:0.7rem;color:var(--gray)">Click para descargar</div>
                </div>
                <div style="background:#f0fdf4;border:2px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center;cursor:pointer" onclick="printBusinessCards()">
                    <div style="font-size:28px;margin-bottom:6px">ğŸªª</div>
                    <div style="font-size:0.8rem;font-weight:700">Tarjetas</div>
                    <div style="font-size:0.7rem;color:var(--gray)">Click para imprimir</div>
                </div>
                <div style="background:#fdf4ff;border:2px solid #f5d0fe;border-radius:12px;padding:16px;text-align:center;cursor:pointer" onclick="copySalesScript()">
                    <div style="font-size:28px;margin-bottom:6px">ğŸ“</div>
                    <div style="font-size:0.8rem;font-weight:700">Script de Venta</div>
                    <div style="font-size:0.7rem;color:var(--gray)">Click para copiar</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section" id="secAdmins">
    <!-- KPIs -->
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon" style="background:#dbeafe">ğŸ‘¥</div><div class="stat-info"><h3 id="adTotal">0</h3><p>Total Equipo</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#dcfce7">ğŸŸ¢</div><div class="stat-info"><h3 id="adCheckedIn">0</h3><p>Checked In Hoy</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#fef3c7">â°</div><div class="stat-info"><h3 id="adHoursToday">0h</h3><p>Horas Hoy</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#f3e8ff">ğŸ’°</div><div class="stat-info"><h3 id="adPayroll">$0</h3><p>NÃ³mina Mensual</p></div></div>
    </div>

    <!-- Sub-tabs -->
    <div class="card">
        <div class="tab-bar" id="adminTabs">
            <button class="tab-btn active" onclick="showAdminTab('team',this)">ğŸ‘¥ Equipo</button>
            <button class="tab-btn" onclick="showAdminTab('checkin',this)">â° Check In/Out</button>
            <button class="tab-btn" onclick="showAdminTab('payroll',this)">ğŸ’° NÃ³mina</button>
        </div>

        <!-- Team Tab -->
        <div class="tab-pane active" id="adminTabTeam">
            <div class="card-head" style="padding:0.75rem 1.25rem"><h2>ğŸ‘¤ Usuarios del Equipo</h2><button class="btn-sm btn-success" onclick="openAddAdminModal()" id="btnAddAdmin">â• Nuevo</button></div>
            <div class="wrap"><table class="tbl"><thead><tr><th>Usuario</th><th>Contacto</th><th>Rol</th><th>Salario</th><th>Ãšltimo Login</th><th>Hoy</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="adminsTable"></tbody></table></div>
        </div>

        <!-- Check In/Out Tab -->
        <div class="tab-pane" id="adminTabCheckin">
            <div class="card-head" style="padding:0.75rem 1.25rem">
                <h2>â° Control de Asistencia</h2>
                <div style="display:flex;gap:0.5rem;align-items:center">
                    <input type="date" id="checkinDateFilter" onchange="loadCheckins()" style="padding:0.4rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                    <button class="btn-sm btn-primary" onclick="exportCheckins()">ğŸ“¥ Export</button>
                </div>
            </div>
            <div class="wrap"><table class="tbl"><thead><tr><th>Empleado</th><th>Rol</th><th>Check In</th><th>Check Out</th><th>Horas</th><th>Status</th><th>Notas</th></tr></thead><tbody id="checkinsTable"></tbody></table></div>
        </div>

        <!-- Payroll Tab -->
        <div class="tab-pane" id="adminTabPayroll">
            <div class="card-head" style="padding:0.75rem 1.25rem">
                <h2>ğŸ’° NÃ³mina y Pagos</h2>
                <div style="display:flex;gap:0.5rem">
                    <select id="payrollMonth" onchange="loadPayroll()" style="padding:0.4rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem"></select>
                    <button class="btn-sm btn-success" onclick="openRegisterPayment()">ğŸ’µ Registrar Pago</button>
                </div>
            </div>
            <div class="wrap"><table class="tbl"><thead><tr><th>Empleado</th><th>Rol</th><th>Tipo Pago</th><th>Salario</th><th>Horas (mes)</th><th>Pagado Este Mes</th><th>Pendiente</th><th>Acciones</th></tr></thead><tbody id="payrollTable"></tbody></table></div>
        </div>
    </div>
</div>

<!-- ============ SECTION: LOGS ============ -->
<div class="section" id="secLogs">
    <div class="card">
        <div class="card-head">
            <h2>ğŸ“‹ Actividad</h2>
            <select id="logFilter" onchange="filterLogs()" style="padding:0.4rem 0.75rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                <option value="all">Todas</option><option value="login">Logins</option><option value="create">Creaciones</option><option value="update">Ediciones</option><option value="delete">Eliminaciones</option>
            </select>
        </div>
        <div id="logsContainer" style="max-height:600px;overflow-y:auto"><p class="empty">Cargando...</p></div>
    </div>
</div>

<!-- ============ SECTION: SETTINGS ============ -->
<div class="section" id="secSettings">
    <div class="card">
        <div class="card-head"><h2>âš™ï¸ ConfiguraciÃ³n</h2></div>
        <div style="padding:1.5rem">
            <div class="form-group"><label>ğŸ”‘ Stripe Secret Key</label><input type="password" id="settingsStripeKey" placeholder="sk_live_..." value=""><button class="btn-sm btn-primary" onclick="saveStripeKey()" style="margin-top:0.5rem">ğŸ’¾ Guardar Key</button></div>
            <hr style="margin:1.5rem 0;border:none;border-top:1px solid #e5e7eb">
            <div class="form-group"><label>ğŸ“§ Email de Soporte</label><input type="email" id="settingsSupportEmail" placeholder="soporte@trademaster.com"></div>
            <div class="form-group"><label>ğŸ¢ Nombre del Producto</label><input type="text" id="settingsProductName" value="Trade Master CRM"></div>
        </div>
    </div>
</div>

        </div><!-- /main-content -->
    </div><!-- /main -->
</div><!-- /dashboard -->

<!-- ============ MODALS ============ -->

<!-- Modal: Company Detail CRM -->
<div class="modal-bg" id="modalCompany">
    <div class="modal" style="max-width:900px">
        <div class="modal-head">
            <h3 id="modalCompanyTitle">ğŸ¢ Empresa</h3>
            <div style="display:flex;align-items:center;gap:0.5rem">
                <span class="badge b-blue" style="font-size:0.8rem;font-family:monospace;font-weight:800" id="companyNumber">TM-0000</span>
                <button class="btn-sm btn-accent" id="btnEnterCRM" onclick="enterCompanyCRM()" style="font-weight:700">ğŸš€ Entrar al CRM</button>
                <button class="modal-close" onclick="closeModal('modalCompany')">Ã—</button>
            </div>
        </div>
        <div class="modal-body" style="padding:0">
            <div class="tab-bar" id="companyTabs">
                <button class="tab-btn active" onclick="showCompanyTab('info',this)">ğŸ“‹ Info</button>
                <button class="tab-btn" onclick="showCompanyTab('crmdata',this)">ğŸ—„ï¸ Su CRM</button>
                <button class="tab-btn" onclick="showCompanyTab('payments',this)">ğŸ’³ Pagos</button>
                <button class="tab-btn" onclick="showCompanyTab('timeline',this)">ğŸ• Timeline</button>
                <button class="tab-btn" onclick="showCompanyTab('actions',this)">âš¡ Acciones</button>
            </div>
            <div class="tab-pane active" id="compTabInfo"><div id="companyDetails"></div></div>
            <div class="tab-pane" id="compTabCrmdata"><div id="companyCRMData"></div></div>
            <div class="tab-pane" id="compTabPayments"><div id="companyPayments"></div></div>
            <div class="tab-pane" id="compTabTimeline"><div id="companyTimeline"></div></div>
            <div class="tab-pane" id="compTabActions"><div id="companyActions"></div></div>
        </div>
    </div>
</div>

<!-- Modal: Ticket -->
<div class="modal-bg" id="modalTicket">
    <div class="modal" style="max-width:700px">
        <div class="modal-head"><h3 id="ticketTitle">Ticket</h3><button class="modal-close" onclick="closeModal('modalTicket')">Ã—</button></div>
        <div class="modal-body">
            <div id="ticketInfo" style="margin-bottom:1rem"></div>
            <div class="chat-container" id="ticketChat"></div>
            <div style="margin-top:1rem">
                <textarea id="ticketReply" rows="3" placeholder="Escribe tu respuesta..." style="width:100%;padding:0.75rem;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:0.85rem"></textarea>
                <div style="display:flex;justify-content:space-between;margin-top:0.5rem">
                    <select id="ticketStatus" style="padding:0.5rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.8rem">
                        <option value="in_progress">ğŸŸ¡ En Progreso</option><option value="waiting_response">ğŸŸ  Esperando</option><option value="resolved">âœ… Resuelto</option>
                    </select>
                    <button class="btn-sm btn-primary" onclick="sendTicketReply()">ğŸ“¤ Enviar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Reset Password -->
<div class="modal-bg" id="modalReset">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3>ğŸ”‘ Resetear ContraseÃ±a</h3><button class="modal-close" onclick="closeModal('modalReset')">Ã—</button></div>
        <div class="modal-body">
            <div id="resetUserInfo" style="padding:1rem;background:var(--light);border-radius:8px;margin-bottom:1rem"></div>
            <div class="form-group"><label>Nueva ContraseÃ±a:</label><div style="display:flex;gap:0.5rem"><input type="text" id="newPassword" placeholder="MÃ­nimo 6 caracteres" style="flex:1"><button class="btn-sm btn-ghost" onclick="generatePassword()">ğŸ²</button></div></div>
            <div style="display:flex;gap:0.5rem;margin-top:1rem">
                <button class="btn-sm btn-success" onclick="confirmResetPassword()" style="flex:1">ğŸ”‘ Resetear</button>
                <button class="btn-sm btn-primary" onclick="sendMagicLink()" style="flex:1">âœ‰ï¸ Magic Link</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Admin -->
<div class="modal-bg" id="modalAddAdmin">
    <div class="modal" style="max-width:550px">
        <div class="modal-head"><h3>â• Nuevo Usuario</h3><button class="modal-close" onclick="closeModal('modalAddAdmin')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Nombre</label><input type="text" id="newAdminName"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Email</label><input type="email" id="newAdminEmail"></div>
                <div class="form-group"><label>TelÃ©fono</label><input type="text" id="newAdminPhone"></div>
            </div>
            <div class="form-group"><label>ContraseÃ±a</label><input type="text" id="newAdminPass"><button class="btn-sm btn-ghost" onclick="document.getElementById('newAdminPass').value=generatePass()" style="margin-top:0.5rem">ğŸ² Generar</button></div>
            <div class="form-group"><label>Rol</label><select id="newAdminRole">
                <option value="super_admin">ğŸ‘‘ Super Admin</option>
                <option value="admin">âš™ï¸ Admin</option>
                <option value="gerente_ops">ğŸ¦ Gerente de Operaciones</option>
                <option value="vendedor">ğŸ¤ Vendedor</option>
                <option value="marketing">ğŸ“£ Marketing</option>
                <option value="contador">ğŸ“Š Contador</option>
                <option value="support" selected>ğŸ‘ï¸ Soporte</option>
            </select></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>ğŸ’° Salario/Pago ($)</label><input type="number" id="newAdminSalary" step="0.01" placeholder="0.00"></div>
                <div class="form-group"><label>Tipo Pago</label><select id="newAdminPayType">
                    <option value="monthly">ğŸ“… Mensual</option>
                    <option value="biweekly">ğŸ“… Quincenal</option>
                    <option value="weekly">ğŸ“… Semanal</option>
                    <option value="hourly">â° Por Hora</option>
                    <option value="commission">ğŸ’° ComisiÃ³n</option>
                </select></div>
            </div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalAddAdmin')">Cancelar</button><button class="btn-sm btn-success" onclick="saveNewAdmin()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Add Payment -->
<div class="modal-bg" id="modalAddPayment">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3>â• Registrar Pago</h3><button class="modal-close" onclick="closeModal('modalAddPayment')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Empresa</label><select id="payCompany"></select></div>
            <div class="form-group"><label>Monto ($)</label><input type="number" id="payAmount" step="0.01" value="149.99"></div>
            <div class="form-group"><label>Plan</label><select id="payPlan"><option value="profesional">Profesional ($149.99)</option><option value="enterprise">Enterprise ($299)</option></select></div>
            <div class="form-group"><label>MÃ©todo</label><select id="payMethod"><option value="stripe">Stripe</option><option value="paypal">PayPal</option><option value="manual">Manual</option></select></div>
            <div class="form-group"><label>Notas</label><textarea id="payNotes" rows="2"></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalAddPayment')">Cancelar</button><button class="btn-sm btn-success" onclick="savePayment()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Stripe Refund -->
<div class="modal-bg" id="modalRefund">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3>â†©ï¸ Reembolso Stripe</h3><button class="modal-close" onclick="closeModal('modalRefund')">Ã—</button></div>
        <div class="modal-body">
            <div id="refundInfo" style="padding:1rem;background:var(--light);border-radius:8px;margin-bottom:1rem"></div>
            <div class="form-group"><label>Monto a Reembolsar ($)</label><input type="number" id="refundAmount" step="0.01"></div>
            <div class="form-group"><label>RazÃ³n</label><select id="refundReason"><option value="requested_by_customer">Solicitado por cliente</option><option value="duplicate">Pago duplicado</option><option value="fraudulent">Fraude</option></select></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalRefund')">Cancelar</button><button class="btn-sm btn-danger" onclick="confirmRefund()">â†©ï¸ Reembolsar</button></div>
    </div>
</div>

<!-- Modal: Follow-Up -->
<div class="modal-bg" id="modalFollowUp">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3>ğŸ“ Nuevo Follow-Up</h3><button class="modal-close" onclick="closeModal('modalFollowUp')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Empresa</label><select id="fuCompany"></select></div>
            <div class="form-group"><label>Tipo</label><select id="fuType"><option value="call">ğŸ“ Llamada</option><option value="email">ğŸ“§ Email</option><option value="whatsapp">ğŸ’¬ WhatsApp</option><option value="onboarding">ğŸš€ Onboarding</option><option value="renewal">ğŸ”„ RenovaciÃ³n</option><option value="payment">ğŸ’° Cobro</option></select></div>
            <div class="form-group"><label>Fecha Programada</label><input type="date" id="fuDate"></div>
            <div class="form-group"><label>Prioridad</label><select id="fuPriority"><option value="low">ğŸŸ¢ Baja</option><option value="medium">ğŸŸ¡ Media</option><option value="high">ğŸ”´ Alta</option></select></div>
            <div class="form-group"><label>Notas</label><textarea id="fuNotes" rows="3" placeholder="Notas del follow-up..."></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalFollowUp')">Cancelar</button><button class="btn-sm btn-success" onclick="saveFollowUp()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Add Sales Rep -->
<div class="modal-bg" id="modalSalesRep">
    <div class="modal" style="max-width:550px">
        <div class="modal-head"><h3 id="salesRepModalTitle">â• Nuevo Vendedor</h3><button class="modal-close" onclick="closeModal('modalSalesRep')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Nombre Completo</label><input type="text" id="srName" placeholder="Juan PÃ©rez"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Email</label><input type="email" id="srEmail" placeholder="juan@email.com"></div>
                <div class="form-group"><label>TelÃ©fono</label><input type="text" id="srPhone" placeholder="+1 555-1234"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Tipo de ComisiÃ³n</label><select id="srCommType">
                    <option value="percentage">ğŸ“Š Porcentaje</option>
                    <option value="fixed">ğŸ’µ Monto Fijo</option>
                </select></div>
                <div class="form-group"><label>Valor ComisiÃ³n</label><input type="number" id="srCommValue" step="0.01" placeholder="15 (% o $)"></div>
            </div>
            <div class="form-group"><label>Zona / Territorio</label><input type="text" id="srZone" placeholder="San Diego, CA"></div>
            <div class="form-group"><label>Notas</label><textarea id="srNotes" rows="2" placeholder="Notas sobre el vendedor..."></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalSalesRep')">Cancelar</button><button class="btn-sm btn-success" id="btnSaveSalesRep" onclick="saveSalesRep()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Register Deal -->
<div class="modal-bg" id="modalDeal">
    <div class="modal" style="max-width:600px">
        <div class="modal-head"><h3>ğŸ† Registrar Venta Cerrada</h3><button class="modal-close" onclick="closeModal('modalDeal')">Ã—</button></div>
        <div class="modal-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Vendedor</label><select id="dealRep"></select></div>
                <div class="form-group"><label>Empresa (Cliente)</label><select id="dealCompany"></select></div>
            </div>
            <div class="form-group"><label>ğŸ“Œ Â¿CÃ³mo cerrÃ³ la venta?</label><select id="dealChannel">
                <option value="visita">ğŸš¶ VisitÃ³ el negocio en persona</option>
                <option value="llamada">ğŸ“ Llamada telefÃ³nica</option>
                <option value="facebook">ğŸ“˜ Facebook / Messenger</option>
                <option value="instagram">ğŸ“¸ Instagram / DM</option>
                <option value="google_ads">ğŸ” Google Ads (lead)</option>
                <option value="referido">ğŸ—£ï¸ Referido / Boca a boca</option>
                <option value="website">ğŸŒ Website / Formulario</option>
                <option value="email_mkt">ğŸ“§ Email Marketing</option>
                <option value="evento">ğŸª Evento / Feria</option>
                <option value="otro">ğŸ“‹ Otro</option>
            </select></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Plan Vendido</label><select id="dealPlan" onchange="updateDealAmount()">
                    <option value="profesional" data-amount="149.99">Profesional ($149.99/mo)</option>
                    <option value="enterprise" data-amount="299">Enterprise ($299/mo)</option>
                </select></div>
                <div class="form-group"><label>Monto de Venta ($)</label><input type="number" id="dealAmount" step="0.01" value="149.99"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>ComisiÃ³n a Pagar ($)</label><input type="number" id="dealComm" step="0.01"></div>
                <div class="form-group"><label>Fecha</label><input type="date" id="dealDate"></div>
            </div>
            <div class="form-group"><label>CampaÃ±a Marketing (si aplica)</label><select id="dealCampaign"><option value="">â€” Ninguna â€”</option></select></div>
            <div class="form-group"><label>Notas</label><textarea id="dealNotes" rows="2" placeholder="Detalles de cÃ³mo se cerrÃ³ la venta..."></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalDeal')">Cancelar</button><button class="btn-sm btn-success" onclick="saveDeal()">ğŸ† Registrar Venta</button></div>
    </div>
</div>

<!-- Modal: Campaign -->
<div class="modal-bg" id="modalCampaign">
    <div class="modal" style="max-width:550px">
        <div class="modal-head"><h3 id="campaignModalTitle">â• Nueva CampaÃ±a</h3><button class="modal-close" onclick="closeModal('modalCampaign')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Nombre de CampaÃ±a</label><input type="text" id="campName" placeholder="Facebook Ads - Enero 2026"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Plataforma</label><select id="campPlatform">
                    <option value="facebook">ğŸ“˜ Facebook Ads</option>
                    <option value="instagram">ğŸ“¸ Instagram Ads</option>
                    <option value="google_ads">ğŸ” Google Ads</option>
                    <option value="tiktok">ğŸµ TikTok Ads</option>
                    <option value="youtube">â–¶ï¸ YouTube Ads</option>
                    <option value="linkedin">ğŸ’¼ LinkedIn Ads</option>
                    <option value="seo">ğŸ” SEO</option>
                    <option value="email">ğŸ“§ Email Marketing</option>
                    <option value="flyers">ğŸ“„ Flyers / Print</option>
                    <option value="radio">ğŸ“» Radio</option>
                    <option value="evento">ğŸª Eventos</option>
                    <option value="referidos">ğŸ—£ï¸ Programa Referidos</option>
                    <option value="otro">ğŸ“‹ Otro</option>
                </select></div>
                <div class="form-group"><label>Status</label><select id="campStatus">
                    <option value="active">ğŸŸ¢ Activa</option>
                    <option value="paused">ğŸŸ¡ Pausada</option>
                    <option value="ended">âš« Finalizada</option>
                </select></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Presupuesto Total ($)</label><input type="number" id="campBudget" step="0.01" placeholder="500"></div>
                <div class="form-group"><label>Gastado ($)</label><input type="number" id="campSpent" step="0.01" placeholder="0"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Fecha Inicio</label><input type="date" id="campStart"></div>
                <div class="form-group"><label>Fecha Fin</label><input type="date" id="campEnd"></div>
            </div>
            <div class="form-group"><label>Notas / Objetivo</label><textarea id="campNotes" rows="2" placeholder="Objetivo de la campaÃ±a..."></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalCampaign')">Cancelar</button><button class="btn-sm btn-success" id="btnSaveCampaign" onclick="saveCampaign()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Marketing Expense -->
<div class="modal-bg" id="modalMkExpense">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3>ğŸ’¸ Registrar Gasto Marketing</h3><button class="modal-close" onclick="closeModal('modalMkExpense')">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group"><label>CampaÃ±a</label><select id="mkeCampaign"></select></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group"><label>Monto ($)</label><input type="number" id="mkeAmount" step="0.01" placeholder="100"></div>
                <div class="form-group"><label>Fecha</label><input type="date" id="mkeDate"></div>
            </div>
            <div class="form-group"><label>Concepto</label><input type="text" id="mkeConcept" placeholder="Ads, diseÃ±o, contenido..."></div>
            <div class="form-group"><label>Plataforma de Pago</label><select id="mkePlatform">
                <option value="facebook">ğŸ“˜ Facebook/Meta</option>
                <option value="google">ğŸ” Google</option>
                <option value="stripe">ğŸ’³ Stripe</option>
                <option value="paypal">ğŸ’° PayPal</option>
                <option value="cash">ğŸ’µ Efectivo</option>
                <option value="transfer">ğŸ¦ Transferencia</option>
                <option value="otro">ğŸ“‹ Otro</option>
            </select></div>
            <div class="form-group"><label>Notas</label><textarea id="mkeNotes" rows="2"></textarea></div>
        </div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalMkExpense')">Cancelar</button><button class="btn-sm btn-success" onclick="saveMkExpense()">ğŸ’¾ Guardar</button></div>
    </div>
</div>

<!-- Modal: Delete -->
<div class="modal-bg" id="modalDelete">
    <div class="modal" style="max-width:400px">
        <div class="modal-head"><h3>âš ï¸ Confirmar</h3><button class="modal-close" onclick="closeModal('modalDelete')">Ã—</button></div>
        <div class="modal-body"><p>Â¿Eliminar <strong id="deleteName"></strong>?</p><p style="font-size:0.85rem;color:var(--gray);margin-top:0.5rem">Esta acciÃ³n no se puede deshacer.</p></div>
        <div class="modal-foot"><button class="btn-sm btn-ghost" onclick="closeModal('modalDelete')">Cancelar</button><button class="btn-sm btn-danger" onclick="confirmDelete()">ğŸ—‘ï¸ Eliminar</button></div>
    </div>
</div>

<script>
// ==========================================
// CONFIG
// ==========================================
var SUPABASE_URL = 'https://ucowlcrddzukykbaitzt.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjb3dsY3JkZHp1a3lrYmFpdHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDY4MDUsImV4cCI6MjA4NTg4MjgwNX0.SMZ6VA4jOfT120nUZm0U19dGE2j2MQ2sn_gGjv-oPes';

var db, currentAdmin, companies=[], tickets=[], payments=[], adminUsers=[], logs=[], notifications=[], resetRequests=[];
var selectedTicket=null, selectedResetUser=null, deleteTarget=null, selectedCompany=null;
var employeeCounts={};
var STRIPE_KEY = localStorage.getItem('tm_stripe_key')||'';
var stripeCustomers=[], stripePayments=[], stripeSubs=[], stripeRefunds=[];

document.addEventListener('DOMContentLoaded', function(){
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    document.addEventListener('click', function(e){if(!e.target.closest('.notif-wrap'))document.getElementById('notifDropdown').classList.remove('show');});
    if(STRIPE_KEY) document.getElementById('settingsStripeKey').value = STRIPE_KEY;
});

// ==========================================
// AUTH
// ==========================================
async function doLogin(){
    var email=$('em').value.trim().toLowerCase(), pass=$('pw').value;
    if(!email||!pass){showError('Ingresa email y contraseÃ±a');return;}
    var res=await db.from('admin_users').select('*').eq('email',email).eq('is_active',true).single();
    if(res.error||!res.data){showError('Email no autorizado');return;}
    if(pass.length<4){showError('ContraseÃ±a incorrecta');return;}
    currentAdmin=res.data;
    await db.from('admin_users').update({last_login:new Date().toISOString(),login_count:(currentAdmin.login_count||0)+1}).eq('id',currentAdmin.id);
    await logActivity('login');
    $('login').classList.add('hidden');$('dash').classList.add('active');
    $('av').textContent=initials(currentAdmin.name);$('sideAv').textContent=initials(currentAdmin.name);
    $('currentUserName').textContent=currentAdmin.name;$('sideName').textContent=currentAdmin.name;
    $('currentUserRole').textContent=getRoleName(currentAdmin.role);$('sideRole').textContent=getRoleName(currentAdmin.role);
    if(currentAdmin.role!=='super_admin')$('navAdmins').style.display='none';
    refreshAll();startPolling();
    try{$('checkinDateFilter').value=new Date().toISOString().slice(0,10);}catch(e){}
}
function showAdminForgotPassword(){var email=$('em').value.trim();var d=document.createElement('div');d.className='modal-bg show';d.id='modalAdminForgot';d.innerHTML='<div class="modal" style="max-width:450px"><div class="modal-head"><h3>ğŸ”‘ Recuperar ContraseÃ±a</h3><button class="modal-close" onclick="closeModal(\'modalAdminForgot\');this.closest(\'.modal-bg\').remove()">Ã—</button></div><div class="modal-body"><p style="color:var(--gray);margin-bottom:1rem">Ingresa tu email para recibir un enlace de recuperaciÃ³n.</p><div class="form-group"><label>ğŸ“§ Email</label><input type="email" id="adminForgotEmail" value="'+email+'"></div><button class="btn-sm btn-primary" onclick="submitAdminForgot()" style="width:100%">ğŸ“§ Enviar Enlace</button></div></div>';document.body.appendChild(d);}
async function submitAdminForgot(){var email=$('adminForgotEmail').value.trim();if(!email){alert('Ingresa email');return;}try{await db.auth.resetPasswordForEmail(email,{redirectTo:location.origin+location.pathname.replace('admin.html','')});document.getElementById('modalAdminForgot').remove();alert('âœ… Email enviado');}catch(e){alert('âŒ '+e.message);}}
function showError(msg){var e=$('err');e.textContent=msg;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},3000);}
function doLogout(){logActivity('logout');currentAdmin=null;$('login').classList.remove('hidden');$('dash').classList.remove('active');}

// ==========================================
// DATA LOADING
// ==========================================
async function refreshAll(){
    await Promise.all([loadCompanies(),loadTickets(),loadPayments(),loadAdmins(),loadLogs(),loadResetRequests(),loadNotifications()]);
    try{await loadTodayCheckins();}catch(e){}
    computeCSData();renderCS();
    try{await loadFollowUps();}catch(e){}
    try{await Promise.all([loadSalesReps(),loadDeals(),loadCampaigns(),loadMkExpenses()]);}catch(e){}
    try{await loadAmbassadorAdmin();}catch(e){}
    try{initDemoTools();}catch(e){}
    updateDashboard();
    if(STRIPE_KEY)loadStripeData();
}
async function loadCompanies(){var r=await db.from('companies').select('*').order('created_at',{ascending:false});companies=r.data||[];await loadEmployeeCounts();renderCompanies(companies);renderRecentCompanies();}
async function loadEmployeeCounts(){employeeCounts={};var r1=await db.from('technicians').select('company_id');if(r1.data)r1.data.forEach(function(t){if(t.company_id)employeeCounts[t.company_id]=(employeeCounts[t.company_id]||0)+1;});var r2=await db.from('team_users').select('company_id');if(r2.data)r2.data.forEach(function(u){if(u.company_id)employeeCounts[u.company_id]=(employeeCounts[u.company_id]||0)+1;});}
async function loadTickets(){var r=await db.from('support_tickets').select('*').order('created_at',{ascending:false});tickets=r.data||[];var open=tickets.filter(function(t){return t.status==='open'||t.status==='in_progress'}).length;$('s6').textContent=open;var b=$('ticketsBadge');if(open>0){b.textContent=open;b.style.display='inline';}else b.style.display='none';renderTickets(tickets);}
async function loadPayments(){var r=await db.from('payment_history').select('*').order('created_at',{ascending:false});payments=r.data||[];renderPayments();}
async function loadAdmins(){var r=await db.from('admin_users').select('*').order('created_at');adminUsers=r.data||[];renderAdmins();}
async function loadLogs(){var r=await db.from('admin_activity_logs').select('*').order('created_at',{ascending:false}).limit(200);logs=r.data||[];renderLogs(logs);}
async function loadResetRequests(){var r=await db.from('password_reset_requests').select('*').order('requested_at',{ascending:false});resetRequests=r.data||[];$('s7')||null;renderResetRequests();}
async function loadNotifications(){if(!currentAdmin)return;var r=await db.from('admin_notifications').select('*').eq('admin_user_id',currentAdmin.id).order('created_at',{ascending:false}).limit(50);notifications=r.data||[];renderNotifications();}
function startPolling(){setInterval(loadNotifications,30000);setInterval(loadTickets,60000);}

// ==========================================
// DASHBOARD
// ==========================================
function updateDashboard(){
    $('s1').textContent=companies.length;
    var active=companies.filter(function(c){return c.subscription_status==='active'&&c.plan!=='free'});
    $('s2').textContent=active.length;
    var mrr=0;companies.forEach(function(c){if(c.subscription_status==='active'){if(c.plan==='profesional')mrr+=149.99;if(c.plan==='enterprise')mrr+=299;}});
    $('s3').textContent='$'+Math.round(mrr);
    var trial=companies.filter(function(c){return c.plan==='free'||c.subscription_status==='trialing'});
    $('sTrial').textContent=trial.length;
    var canceled=companies.filter(function(c){return c.subscription_status==='canceled'}).length;
    var churn=companies.length>0?Math.round(canceled/companies.length*100):0;
    $('sChurn').textContent=churn+'%';
    var total=payments.reduce(function(s,p){return s+(p.amount||0)},0);
    var thisMonth=payments.filter(function(p){return new Date(p.created_at).getMonth()===new Date().getMonth()}).reduce(function(s,p){return s+(p.amount||0)},0);
    $('totalRevenue').textContent='$'+total.toFixed(2);
    $('monthlyRevenue').textContent='$'+thisMonth.toFixed(2);
    $('avgRevenue').textContent=companies.length?'$'+(total/companies.length).toFixed(2):'$0';
    $('totalRefunds').textContent='$0';
    renderRecentActivity();renderCharts();
}

// ==========================================
// CHARTS
// ==========================================
var revenueChartInst=null, planChartInst=null, revDetailInst=null;
function renderCharts(){
    // Revenue chart
    var months=[],rev=[];
    for(var i=5;i>=0;i--){var d=new Date();d.setMonth(d.getMonth()-i);var m=d.toLocaleString('es',{month:'short'});months.push(m);var mRev=payments.filter(function(p){var pd=new Date(p.created_at);return pd.getMonth()===d.getMonth()&&pd.getFullYear()===d.getFullYear()}).reduce(function(s,p){return s+(p.amount||0)},0);rev.push(mRev);}
    if(revenueChartInst)revenueChartInst.destroy();
    var ctx=$('revenueChart');if(ctx)revenueChartInst=new Chart(ctx,{type:'bar',data:{labels:months,datasets:[{label:'Revenue',data:rev,backgroundColor:'#3b82f6',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:function(v){return'$'+v}}}}}});
    // Plan chart
    var free=companies.filter(function(c){return!c.plan||c.plan==='free'}).length;
    var pro=companies.filter(function(c){return c.plan==='profesional'}).length;
    var ent=companies.filter(function(c){return c.plan==='enterprise'}).length;
    if(planChartInst)planChartInst.destroy();
    var ctx2=$('planChart');if(ctx2)planChartInst=new Chart(ctx2,{type:'doughnut',data:{labels:['Free','Pro','Enterprise'],datasets:[{data:[free,pro,ent],backgroundColor:['#94a3b8','#f59e0b','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false}});
    // Revenue detail
    if(revDetailInst)revDetailInst.destroy();
    var ctx3=$('revDetailChart');if(ctx3)revDetailInst=new Chart(ctx3,{type:'line',data:{labels:months,datasets:[{label:'Revenue',data:rev,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:function(v){return'$'+v}}}}}});
}

// ==========================================
// RENDER FUNCTIONS
// ==========================================
function renderCompanies(list){
    var tb=$('tbody');if(!list.length){tb.innerHTML='<tr><td colspan="9" class="empty">No hay empresas</td></tr>';return;}
    // Sort all companies by created_at for stable numbering
    var sorted=companies.slice().sort(function(a,b){return new Date(a.created_at)-new Date(b.created_at)});
    tb.innerHTML=list.map(function(c){
        var emp=employeeCounts[c.id]||0;
        var days=Math.floor((Date.now()-new Date(c.created_at).getTime())/(86400000));
        var statusBadge=c.subscription_status==='active'?'b-green':c.subscription_status==='canceled'?'b-red':c.subscription_status==='trialing'?'b-yellow':'b-gray';
        var idx=sorted.findIndex(function(x){return x.id===c.id});
        var compNum='TM-'+String(idx+1).padStart(4,'0');
        return '<tr onclick="viewCompany(\''+c.id+'\')">'+
        '<td><span class="badge b-blue" style="font-family:monospace;font-weight:800;font-size:0.75rem">'+compNum+'</span></td>'+
        '<td><div class="user-card"><div class="avatar">'+initials(c.name)+'</div><div><h4>'+(c.name||'Sin nombre')+'</h4><small>'+(c.email||'')+'</small></div></div></td>'+
        '<td>'+(c.phone||'-')+'</td>'+
        '<td>'+fmtDate(c.created_at)+'<br><small style="color:var(--gray)">'+days+'d</small></td>'+
        '<td><span class="badge '+planClass(c.plan)+'">'+(c.plan||'free')+'</span></td>'+
        '<td><span class="badge '+statusBadge+'">'+(c.subscription_status||'free')+'</span></td>'+
        '<td style="font-size:0.7rem;font-family:monospace">'+(c.stripe_customer_id?c.stripe_customer_id.slice(0,12)+'â€¦':'â€”')+'</td>'+
        '<td><span class="badge b-blue">ğŸ‘· '+emp+'</span></td>'+
        '<td><div class="actions" onclick="event.stopPropagation()">'+
        '<button class="act" onclick="viewCompany(\''+c.id+'\')" title="Ver CRM" style="background:#dbeafe">ğŸ‘</button>'+
        '<button class="act" onclick="enterCompanyCRMById(\''+c.id+'\')" title="Entrar a su CRM" style="background:#ffedd5">ğŸš€</button>'+
        '<button class="act" onclick="openResetForCompany(\''+c.id+'\')" title="Reset Pass">ğŸ”‘</button>'+
        '<button class="act danger" onclick="openDelete(\'company\',\''+c.id+'\',\''+c.name+'\')" title="Eliminar">ğŸ—‘ï¸</button>'+
        '</div></td></tr>';
    }).join('');
}

function renderRecentCompanies(){
    var sorted=companies.slice().sort(function(a,b){return new Date(a.created_at)-new Date(b.created_at)});
    $('recentCompanies').innerHTML=companies.slice(0,5).map(function(c){var idx=sorted.findIndex(function(x){return x.id===c.id});var num='TM-'+String(idx+1).padStart(4,'0');return'<tr onclick="viewCompany(\''+c.id+'\')"><td><span class="badge b-blue" style="font-family:monospace;font-weight:800;font-size:0.7rem">'+num+'</span></td><td><div class="user-card"><div class="avatar">'+initials(c.name)+'</div><div><h4>'+(c.name||'?')+'</h4></div></div></td><td><span class="badge '+planClass(c.plan)+'">'+(c.plan||'free')+'</span></td><td>'+fmtDate(c.created_at)+'</td></tr>'}).join('')||'<tr><td colspan="4" class="empty">Sin empresas</td></tr>';
}

function renderTickets(list){
    var ct=$('ticketsList');if(!list.length){ct.innerHTML='<p class="empty">No hay tickets</p>';return;}
    ct.innerHTML=list.map(function(t){return'<div class="ticket-card '+(t.priority||'')+'" onclick="viewTicket(\''+t.id+'\')"><div class="ticket-header"><h4>'+(t.ticket_number||'#')+' - '+t.subject+'</h4><span class="badge '+statusClass(t.status)+'">'+statusText(t.status)+'</span></div><div class="ticket-meta"><span>ğŸ‘¤ '+(t.user_name||t.user_email)+'</span><span>ğŸ¢ '+(t.company_name||'N/A')+'</span><span>ğŸ“… '+fmtDateTime(t.created_at)+'</span></div></div>'}).join('');
}

function renderPayments(){
    var tb=$('paymentsTable');var tb2=$('allPaymentsTable');
    var html=payments.length?payments.map(function(p){return'<tr><td>'+fmtDate(p.created_at)+'</td><td>'+(p.company_name||'N/A')+'</td><td><span class="badge '+planClass(p.plan)+'">'+(p.plan||'-')+'</span></td><td style="font-weight:700;color:var(--success)">$'+(p.amount||0).toFixed(2)+'</td><td>'+(p.payment_method||'-')+'</td><td><span class="badge '+(p.status==='completed'?'b-green':'b-yellow')+'">'+(p.status||'pending')+'</span></td></tr>'}).join(''):'<tr><td colspan="6" class="empty">No hay pagos</td></tr>';
    if(tb)tb.innerHTML=html;
    if(tb2)tb2.innerHTML=payments.length?payments.map(function(p){return'<tr><td>'+fmtDate(p.created_at)+'</td><td>'+(p.company_name||'N/A')+'</td><td><span class="badge '+planClass(p.plan)+'">'+(p.plan||'-')+'</span></td><td style="font-weight:700;color:var(--success)">$'+(p.amount||0).toFixed(2)+'</td><td>'+(p.payment_method||'-')+'</td><td><span class="badge '+(p.status==='completed'?'b-green':'b-yellow')+'">'+(p.status||'pending')+'</span></td><td></td></tr>'}).join(''):'<tr><td colspan="7" class="empty">No hay pagos</td></tr>';
}

function renderAdmins(){
    var today=new Date().toISOString().slice(0,10);
    $('adminsTable').innerHTML=adminUsers.map(function(u){
        var todayCheckin=checkins.find(function(c){return c.user_id===u.id&&c.check_date===today});
        var isIn=todayCheckin&&todayCheckin.check_in&&!todayCheckin.check_out;
        var hrs=todayCheckin&&todayCheckin.hours_worked?todayCheckin.hours_worked.toFixed(1)+'h':'â€”';
        var payLabel=u.pay_type==='hourly'?'$'+((u.salary||0).toFixed(2))+'/hr':u.pay_type==='commission'?'ComisiÃ³n':'$'+((u.salary||0).toFixed(2))+'/'+(u.pay_type==='weekly'?'sem':u.pay_type==='biweekly'?'qna':'mes');
        return'<tr>'+
            '<td><div class="user-card"><div class="avatar '+roleClass(u.role)+'">'+initials(u.name)+'</div><div><h4>'+u.name+'</h4></div></div></td>'+
            '<td><div style="font-size:0.8rem">'+u.email+'</div><small style="color:var(--gray)">'+(u.phone||'')+'</small></td>'+
            '<td><span class="badge '+roleClass(u.role)+'">'+getRoleName(u.role)+'</span></td>'+
            '<td style="font-size:0.8rem;font-weight:600">'+payLabel+'</td>'+
            '<td style="font-size:0.75rem">'+(u.last_login?fmtDateTime(u.last_login):'Nunca')+'</td>'+
            '<td>'+(isIn?'<span class="badge b-green">ğŸŸ¢ In '+fmtTime(todayCheckin.check_in)+'</span>':todayCheckin?'<span class="badge b-gray">âœ… '+hrs+'</span>':'<span class="badge b-red">âš« No</span>')+'</td>'+
            '<td><span class="badge '+(u.is_active?'b-green':'b-red')+'">'+(u.is_active?'Activo':'Inactivo')+'</span></td>'+
            '<td><div class="actions">'+
                (!isIn?'<button class="act" onclick="doCheckIn(\''+u.id+'\',\''+u.name+'\')" title="Check In" style="background:#dcfce7">ğŸŸ¢</button>':'<button class="act" onclick="doCheckOut(\''+u.id+'\')" title="Check Out" style="background:#fee2e2">ğŸ”´</button>')+
                (currentAdmin&&currentAdmin.role==='super_admin'?'<button class="act" onclick="editAdmin(\''+u.id+'\')">âœï¸</button>':'')+
            '</div></td></tr>';
    }).join('');
    // KPIs
    $('adTotal').textContent=adminUsers.filter(function(u){return u.is_active!==false}).length;
    var todayIns=checkins.filter(function(c){return c.check_date===today&&c.check_in});
    $('adCheckedIn').textContent=todayIns.length;
    var totalHrs=checkins.filter(function(c){return c.check_date===today}).reduce(function(s,c){return s+(c.hours_worked||0)},0);
    $('adHoursToday').textContent=totalHrs.toFixed(1)+'h';
    var monthPay=adminUsers.reduce(function(s,u){return s+(u.salary||0)},0);
    $('adPayroll').textContent='$'+monthPay.toFixed(0);
}
function fmtTime(t){if(!t)return'';try{return new Date(t).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}catch(e){return t.slice(11,16);}}
function showAdminTab(name,el){
    document.querySelectorAll('#adminTabs .tab-btn').forEach(function(b){b.classList.remove('active')});
    document.querySelectorAll('#secAdmins .tab-pane').forEach(function(p){p.classList.remove('active')});
    if(el)el.classList.add('active');
    var pane=$('adminTab'+name.charAt(0).toUpperCase()+name.slice(1));
    if(pane)pane.classList.add('active');
    if(name==='checkin')loadCheckins();
    if(name==='payroll')loadPayroll();
}

function renderLogs(list){var ct=$('logsContainer');if(!list.length){ct.innerHTML='<p class="empty">No hay logs</p>';return;}ct.innerHTML=list.map(function(l){return'<div style="display:flex;gap:0.75rem;padding:0.6rem 1rem;border-bottom:1px solid #f3f4f6"><div style="width:32px;height:32px;border-radius:8px;background:'+actionColor(l.action)+';display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0">'+actionIcon(l.action)+'</div><div style="flex:1"><strong style="font-size:0.8rem">'+actionText(l.action)+'</strong>'+(l.entity_name?' - '+l.entity_name:'')+'<p style="font-size:0.72rem;color:var(--gray)">'+(l.admin_name||'Sistema')+' â€¢ '+fmtDateTime(l.created_at)+'</p></div></div>'}).join('');}

function renderResetRequests(){var tb=$('passwordResets');if(!resetRequests.length){tb.innerHTML='<tr><td colspan="6" class="empty">No hay solicitudes</td></tr>';return;}tb.innerHTML=resetRequests.map(function(r){return'<tr><td>'+(r.user_name||'N/A')+'</td><td>'+r.user_email+'</td><td>'+(r.company_name||'-')+'</td><td>'+fmtDateTime(r.requested_at)+'</td><td><span class="badge '+(r.status==='pending'?'b-yellow':r.status==='completed'?'b-green':'b-gray')+'">'+r.status+'</span></td><td><div class="actions">'+(r.status==='pending'?'<button class="act" onclick="handleReset(\''+r.id+'\')">ğŸ”‘</button>':'')+'</div></td></tr>'}).join('');}

function renderNotifications(){var unread=notifications.filter(function(n){return!n.is_read}).length;var b=$('notifBadge');b.textContent=unread;b.classList.toggle('hidden',unread===0);var list=$('notifList');if(!notifications.length){list.innerHTML='<div class="empty" style="padding:1.5rem">Sin notificaciones</div>';return;}list.innerHTML=notifications.slice(0,20).map(function(n){return'<div class="notif-item '+(n.is_read?'':'unread')+'" onclick="handleNotification(\''+n.id+'\',\''+n.entity_type+'\',\''+n.entity_id+'\')"><div style="width:32px;height:32px;border-radius:8px;background:'+notifColor(n.type)+';display:flex;align-items:center;justify-content:center;flex-shrink:0">'+notifIcon(n.type)+'</div><div><strong style="font-size:0.8rem">'+n.title+'</strong><p style="font-size:0.72rem;color:var(--gray)">'+(n.message||'')+'</p></div></div>'}).join('');}

function renderRecentActivity(){var a=logs.slice(0,10);$('recentActivity').innerHTML=a.length?a.map(function(l){return'<div style="display:flex;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid #f3f4f6"><span style="font-size:1rem">'+actionIcon(l.action)+'</span><div><strong style="font-size:0.8rem">'+actionText(l.action)+'</strong>'+(l.entity_name?' - '+l.entity_name:'')+'<p style="font-size:0.72rem;color:var(--gray)">'+fmtDateTime(l.created_at)+'</p></div></div>'}).join(''):'<p class="empty">Sin actividad</p>';}

// ==========================================
// SECTIONS / NAVIGATION
// ==========================================
function showSec(name,el){
    document.querySelectorAll('.nav-item').forEach(function(n){n.classList.remove('active')});
    document.querySelectorAll('.section').forEach(function(s){s.classList.remove('active')});
    if(el)el.classList.add('active');
    var sec=$('sec'+name.charAt(0).toUpperCase()+name.slice(1));
    if(sec)sec.classList.add('active');
    var titles={dashboard:'ğŸ“Š Dashboard',empresas:'ğŸ¢ Empresas CRM',success:'ğŸ¯ Customer Success',stripe:'ğŸ’³ Stripe Pagos',tickets:'ğŸ« Soporte',passwords:'ğŸ”‘ Passwords',revenue:'ğŸ“ˆ Revenue',pagos:'ğŸ’° Historial Pagos',vendedores:'ğŸ¤ Vendedores',marketing:'ğŸ“£ Marketing & ROI',embajadores:'ğŸŒŸ Programa Embajadores',demotools:'ğŸ¬ Demo & Onboarding',admins:'ğŸ‘¤ Admins',logs:'ğŸ“‹ Logs',settings:'âš™ï¸ ConfiguraciÃ³n'};
    $('pageTitle').textContent=titles[name]||name;
    document.getElementById('sidebar').classList.remove('open');
    if(name==='stripe'&&STRIPE_KEY)loadStripeData();
}

// ==========================================
// COMPANY CRM DETAIL
// ==========================================
function getCompanyNumber(c){
    var idx=companies.slice().sort(function(a,b){return new Date(a.created_at)-new Date(b.created_at)}).findIndex(function(x){return x.id===c.id});
    return 'TM-'+String(idx+1).padStart(4,'0');
}

async function viewCompany(id){
    var c=companies.find(function(x){return x.id===id});if(!c)return;
    selectedCompany=c;
    var compNum=getCompanyNumber(c);
    $('modalCompanyTitle').textContent='ğŸ¢ '+c.name;
    $('companyNumber').textContent=compNum;
    
    // Info tab
    var days=Math.floor((Date.now()-new Date(c.created_at).getTime())/(86400000));
    $('companyDetails').innerHTML='<div style="padding:1.25rem"><div class="detail-grid">'+
        '<div class="detail-item full" style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff;text-align:center;padding:1rem"><label style="color:rgba(255,255,255,.7)">NÃºmero de Empresa</label><span style="font-size:1.5rem;font-family:monospace;font-weight:800;color:#fff">'+compNum+'</span></div>'+
        '<div class="detail-item"><label>Empresa</label><span>'+c.name+'</span></div>'+
        '<div class="detail-item"><label>Email</label><span>'+c.email+'</span></div>'+
        '<div class="detail-item"><label>TelÃ©fono</label><span>'+(c.phone||'N/A')+'</span></div>'+
        '<div class="detail-item"><label>DirecciÃ³n</label><span>'+(c.address||'N/A')+'</span></div>'+
        '<div class="detail-item"><label>Plan</label><span class="badge '+planClass(c.plan)+'" style="font-size:0.85rem">'+(c.plan||'free')+'</span></div>'+
        '<div class="detail-item"><label>Status SuscripciÃ³n</label><span class="badge '+(c.subscription_status==='active'?'b-green':c.subscription_status==='canceled'?'b-red':'b-yellow')+'">'+(c.subscription_status||'free')+'</span></div>'+
        '<div class="detail-item"><label>Fecha Registro</label><span>'+fmtDateTime(c.created_at)+'</span></div>'+
        '<div class="detail-item"><label>AntigÃ¼edad</label><span>'+days+' dÃ­as</span></div>'+
        '<div class="detail-item"><label>Stripe Customer ID</label><span style="font-family:monospace;font-size:0.75rem">'+(c.stripe_customer_id||'No conectado')+'</span></div>'+
        '<div class="detail-item"><label>Stripe Sub ID</label><span style="font-family:monospace;font-size:0.75rem">'+(c.stripe_subscription_id||'â€”')+'</span></div>'+
        '<div class="detail-item"><label>DueÃ±o</label><span>'+(c.owner_name||c.name)+'</span></div>'+
        '<div class="detail-item"><label>ContraseÃ±a</label><span style="font-family:monospace">'+(c.password?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':'â€”')+'</span> <button class="btn-sm btn-ghost" onclick="openResetForCompany(\''+c.id+'\');closeModal(\'modalCompany\')" style="margin-left:4px;font-size:0.7rem">ğŸ”‘ Reset</button></div>'+
    '</div></div>';
    
    // CRM Data tab â€” load their actual data from Supabase
    $('companyCRMData').innerHTML='<div style="padding:1.5rem;text-align:center"><p>â³ Cargando datos del CRM...</p></div>';
    loadCompanyCRMData(c.id);
    
    // Payments tab
    var cPay=payments.filter(function(p){return p.company_id===c.id||p.company_name===c.name});
    $('companyPayments').innerHTML='<div style="padding:1.25rem">'+(cPay.length?'<table class="tbl"><thead><tr><th>Fecha</th><th>Monto</th><th>Plan</th><th>MÃ©todo</th><th>Estado</th></tr></thead><tbody>'+cPay.map(function(p){return'<tr><td>'+fmtDate(p.created_at)+'</td><td style="font-weight:700;color:var(--success)">$'+(p.amount||0).toFixed(2)+'</td><td><span class="badge '+planClass(p.plan)+'">'+(p.plan||'-')+'</span></td><td>'+(p.payment_method||'-')+'</td><td><span class="badge '+(p.status==='completed'?'b-green':'b-yellow')+'">'+p.status+'</span></td></tr>'}).join('')+'</tbody></table>':'<p class="empty">Sin pagos registrados â€” <strong style="color:var(--danger)">Nunca ha pagado</strong></p>')+'</div>';
    
    // Timeline tab
    var events=[];
    events.push({date:c.created_at,text:'Empresa registrada â€” '+compNum,type:'success',icon:'ğŸ¢'});
    if(c.subscription_status==='active')events.push({date:c.updated_at||c.created_at,text:'SuscripciÃ³n activada â€” '+c.plan,type:'success',icon:'âœ…'});
    if(c.subscription_status==='canceled')events.push({date:c.updated_at||c.created_at,text:'SuscripciÃ³n cancelada',type:'danger',icon:'âŒ'});
    cPay.forEach(function(p){events.push({date:p.created_at,text:'Pago $'+(p.amount||0).toFixed(2)+' via '+(p.payment_method||'?'),type:'',icon:'ğŸ’³'})});
    var cTickets=tickets.filter(function(t){return t.company_name===c.name||t.company_id===c.id});
    cTickets.forEach(function(t){events.push({date:t.created_at,text:'Ticket: '+t.subject+' ('+statusText(t.status)+')',type:'warning',icon:'ğŸ«'})});
    events.sort(function(a,b){return new Date(b.date)-new Date(a.date)});
    $('companyTimeline').innerHTML='<div style="padding:1.25rem">'+(events.length?'<div class="timeline">'+events.map(function(e){return'<div class="timeline-item '+(e.type||'')+'"><h5>'+e.icon+' '+e.text+'</h5><p>'+fmtDateTime(e.date)+'</p></div>'}).join('')+'</div>':'<p class="empty">Sin actividad</p>')+'</div>';
    
    // Actions tab
    $('companyActions').innerHTML='<div style="padding:1.25rem;display:grid;gap:0.75rem">'+
        '<div style="background:linear-gradient(135deg,#f97316,#ea580c);border-radius:12px;padding:1.25rem;color:#fff;text-align:center"><h3 style="margin-bottom:0.5rem">ğŸš€ Entrar al CRM de '+c.name+'</h3><p style="font-size:0.85rem;opacity:0.9;margin-bottom:1rem">Abre su CRM como admin para ayudar a agregar, editar o borrar datos</p><button class="btn-sm" onclick="enterCompanyCRM()" style="background:#fff;color:#ea580c;padding:0.75rem 2rem;font-size:0.95rem;font-weight:700">ğŸš€ Entrar Ahora</button></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">'+
            '<button class="btn-sm btn-primary" onclick="openResetForCompany(\''+c.id+'\');closeModal(\'modalCompany\')" style="padding:0.75rem;font-size:0.85rem">ğŸ”‘ Resetear ContraseÃ±a</button>'+
            '<button class="btn-sm" style="padding:0.75rem;font-size:0.85rem;background:#635bff;color:#fff" onclick="sendLoginLink(\''+c.id+'\')">ğŸ“§ Enviar Link de Login</button>'+
            (c.plan!=='free'?'<button class="btn-sm btn-warning" onclick="changePlan(\''+c.id+'\',\'free\')" style="padding:0.75rem;font-size:0.85rem">â¬‡ï¸ Downgrade Free</button>':'<button class="btn-sm btn-success" onclick="changePlan(\''+c.id+'\',\'profesional\')" style="padding:0.75rem;font-size:0.85rem">â¬†ï¸ Upgrade Pro</button>')+
            (c.stripe_customer_id&&STRIPE_KEY?'<button class="btn-sm btn-accent" onclick="openStripeCustomer(\''+c.stripe_customer_id+'\')" style="padding:0.75rem;font-size:0.85rem">ğŸ’³ Stripe</button>':'<button class="btn-sm btn-ghost" disabled style="padding:0.75rem;font-size:0.85rem">ğŸ’³ Sin Stripe</button>')+
        '</div>'+
        '<button class="btn-sm btn-danger" onclick="closeModal(\'modalCompany\');openDelete(\'company\',\''+c.id+'\',\''+c.name+'\')" style="padding:0.75rem;font-size:0.85rem">ğŸ—‘ï¸ Eliminar Empresa Completa</button>'+
    '</div>';
    
    showCompanyTab('info',document.querySelector('#companyTabs .tab-btn'));
    openModal('modalCompany');
    logActivity('view','company',c.id,c.name);
}

// ====== LOAD COMPANY CRM DATA (sync) ======
async function loadCompanyCRMData(companyId){
    var html='<div style="padding:1.25rem">';
    try{
        // Load all company data in parallel
        var [clients,techs,jobs,invoices,expenses,teamUsers]=await Promise.all([
            db.from('clients').select('*').eq('company_id',companyId).order('created_at',{ascending:false}).limit(50),
            db.from('technicians').select('*').eq('company_id',companyId).order('created_at',{ascending:false}),
            db.from('jobs').select('*').eq('company_id',companyId).order('created_at',{ascending:false}).limit(50),
            db.from('invoices').select('*').eq('company_id',companyId).order('created_at',{ascending:false}).limit(50),
            db.from('expenses').select('*').eq('company_id',companyId).order('created_at',{ascending:false}).limit(30),
            db.from('team_users').select('*').eq('company_id',companyId)
        ]);
        var cl=clients.data||[],tc=techs.data||[],jb=jobs.data||[],inv=invoices.data||[],exp=expenses.data||[],tu=teamUsers.data||[];
        var totalInv=inv.reduce(function(s,i){return s+(i.total||i.amount||0)},0);
        var totalExp=exp.reduce(function(s,e){return s+(e.amount||0)},0);
        
        // Summary KPIs
        html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;margin-bottom:1.25rem">'+
            '<div style="background:#dbeafe;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#1d4ed8">'+cl.length+'</div><div style="font-size:0.7rem;font-weight:600;color:#3b82f6">Clientes</div></div>'+
            '<div style="background:#dcfce7;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#16a34a">'+tc.length+'</div><div style="font-size:0.7rem;font-weight:600;color:#22c55e">TÃ©cnicos</div></div>'+
            '<div style="background:#fef3c7;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#d97706">'+jb.length+'</div><div style="font-size:0.7rem;font-weight:600;color:#eab308">Trabajos</div></div>'+
            '<div style="background:#f3e8ff;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#7c3aed">'+inv.length+'</div><div style="font-size:0.7rem;font-weight:600;color:#8b5cf6">Facturas</div></div>'+
            '<div style="background:#ccfbf1;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#0d9488">$'+totalInv.toFixed(0)+'</div><div style="font-size:0.7rem;font-weight:600;color:#14b8a6">Facturado</div></div>'+
            '<div style="background:#fce7f3;padding:0.75rem;border-radius:10px;text-align:center"><div style="font-size:1.4rem;font-weight:800;color:#db2777">'+tu.length+'</div><div style="font-size:0.7rem;font-weight:600;color:#ec4899">Team Users</div></div>'+
        '</div>';
        
        // Clients table
        html+='<details style="margin-bottom:1rem"><summary style="cursor:pointer;font-weight:700;font-size:0.9rem;padding:0.5rem;background:var(--light);border-radius:8px">ğŸ‘¥ Clientes ('+cl.length+')</summary>';
        if(cl.length){
            html+='<table class="tbl" style="margin-top:0.5rem"><thead><tr><th>Nombre</th><th>Email</th><th>TelÃ©fono</th><th>Tipo</th><th>Creado</th></tr></thead><tbody>';
            cl.forEach(function(x){html+='<tr><td><strong>'+(x.name||'?')+'</strong></td><td>'+(x.email||'-')+'</td><td>'+(x.phone||'-')+'</td><td><span class="badge b-blue">'+(x.property_type||'-')+'</span></td><td>'+fmtDate(x.created_at)+'</td></tr>';});
            html+='</tbody></table>';
        }else html+='<p class="empty">Sin clientes</p>';
        html+='</details>';
        
        // Technicians table
        html+='<details style="margin-bottom:1rem"><summary style="cursor:pointer;font-weight:700;font-size:0.9rem;padding:0.5rem;background:var(--light);border-radius:8px">ğŸ‘· TÃ©cnicos ('+tc.length+')</summary>';
        if(tc.length){
            html+='<table class="tbl" style="margin-top:0.5rem"><thead><tr><th>Nombre</th><th>Email</th><th>TelÃ©fono</th><th>Especialidad</th><th>VehÃ­culo</th></tr></thead><tbody>';
            tc.forEach(function(x){html+='<tr><td><strong>'+(x.name||'?')+'</strong></td><td>'+(x.email||'-')+'</td><td>'+(x.phone||'-')+'</td><td><span class="badge b-teal">'+(x.specialty||'-')+'</span></td><td>'+(x.vehicle||'-')+'</td></tr>';});
            html+='</tbody></table>';
        }else html+='<p class="empty">Sin tÃ©cnicos</p>';
        html+='</details>';
        
        // Jobs table
        html+='<details style="margin-bottom:1rem"><summary style="cursor:pointer;font-weight:700;font-size:0.9rem;padding:0.5rem;background:var(--light);border-radius:8px">ğŸ”§ Trabajos ('+jb.length+')</summary>';
        if(jb.length){
            html+='<table class="tbl" style="margin-top:0.5rem"><thead><tr><th>TÃ­tulo</th><th>Estado</th><th>TÃ©cnico</th><th>DirecciÃ³n</th><th>Fecha</th></tr></thead><tbody>';
            jb.forEach(function(x){var stColor=x.status==='completed'?'b-green':x.status==='in_progress'?'b-yellow':'b-blue';html+='<tr><td><strong>'+(x.title||'?')+'</strong></td><td><span class="badge '+stColor+'">'+(x.status||'-')+'</span></td><td>'+(x.tech_name||'-')+'</td><td style="font-size:0.75rem">'+(x.address||'-')+'</td><td>'+fmtDate(x.date||x.created_at)+'</td></tr>';});
            html+='</tbody></table>';
        }else html+='<p class="empty">Sin trabajos</p>';
        html+='</details>';
        
        // Invoices table
        html+='<details style="margin-bottom:1rem"><summary style="cursor:pointer;font-weight:700;font-size:0.9rem;padding:0.5rem;background:var(--light);border-radius:8px">ğŸ“„ Facturas ('+inv.length+') â€” Total: $'+totalInv.toFixed(2)+'</summary>';
        if(inv.length){
            html+='<table class="tbl" style="margin-top:0.5rem"><thead><tr><th>#</th><th>Cliente</th><th>Total</th><th>Pagado</th><th>Balance</th><th>Estado</th></tr></thead><tbody>';
            inv.forEach(function(x){var stColor=x.status==='paid'?'b-green':x.status==='sent'?'b-yellow':'b-gray';html+='<tr><td style="font-family:monospace;font-size:0.75rem">'+(x.invoice_number||'-')+'</td><td>'+(x.client_name||'-')+'</td><td style="font-weight:700">$'+(x.total||0).toFixed(2)+'</td><td>$'+(x.amount_paid||0).toFixed(2)+'</td><td style="font-weight:700;color:'+(x.balance_due>0?'var(--danger)':'var(--success)')+'">$'+(x.balance_due||0).toFixed(2)+'</td><td><span class="badge '+stColor+'">'+(x.status||'draft')+'</span></td></tr>';});
            html+='</tbody></table>';
        }else html+='<p class="empty">Sin facturas</p>';
        html+='</details>';
        
        // Team Users
        html+='<details style="margin-bottom:1rem"><summary style="cursor:pointer;font-weight:700;font-size:0.9rem;padding:0.5rem;background:var(--light);border-radius:8px">ğŸ‘¤ Team Users ('+tu.length+')</summary>';
        if(tu.length){
            html+='<table class="tbl" style="margin-top:0.5rem"><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Ãšltimo Login</th></tr></thead><tbody>';
            tu.forEach(function(x){html+='<tr><td><strong>'+(x.name||'?')+'</strong></td><td>'+(x.email||'-')+'</td><td><span class="badge b-purple">'+(x.role||'-')+'</span></td><td>'+fmtDateTime(x.last_login||x.created_at)+'</td></tr>';});
            html+='</tbody></table>';
        }else html+='<p class="empty">Sin team users</p>';
        html+='</details>';
        
    }catch(e){
        html+='<div style="background:#fee2e2;padding:1rem;border-radius:8px;color:#dc2626"><strong>âš ï¸ Error cargando datos:</strong> '+e.message+'<br><small>Algunas tablas podrÃ­an no existir aÃºn para esta empresa.</small></div>';
    }
    html+='</div>';
    $('companyCRMData').innerHTML=html;
}

// ====== ENTER COMPANY CRM (admin access) ======
function enterCompanyCRM(){
    if(!selectedCompany){alert('No hay empresa seleccionada');return;}
    enterCompanyCRMById(selectedCompany.id);
}
async function enterCompanyCRMById(companyId){
    var c=companies.find(function(x){return x.id===companyId});if(!c){alert('Empresa no encontrada');return;}
    
    // Store admin impersonation session in localStorage
    // The CRM will detect this and auto-login as this company
    var adminSession={
        company_id:c.id,
        company_name:c.name,
        company_email:c.email||'',
        company_phone:c.phone||'',
        company_address:c.address||'',
        company_plan:c.plan||'free',
        admin_id:currentAdmin.id,
        admin_name:currentAdmin.name,
        admin_role:currentAdmin.role,
        timestamp:Date.now()
    };
    localStorage.setItem('tm_admin_access',JSON.stringify(adminSession));
    
    // Open the CRM
    var baseUrl=location.origin+location.pathname.replace(/admin[^/]*\.html/,'index.html');
    window.open(baseUrl,'_blank');
    
    await logActivity('view','crm_access',c.id,'Admin entered CRM: '+c.name);
    alert('ğŸš€ Abriendo CRM de "'+c.name+'" en nueva pestaÃ±a.\n\nâš ï¸ EstÃ¡s en modo ADMIN â€” verÃ¡s una barra naranja arriba.\nTodo lo que hagas queda registrado.');
}

async function sendLoginLink(companyId){
    var c=companies.find(function(x){return x.id===companyId});
    if(!c||!c.email){alert('Sin email');return;}
    try{
        await db.auth.resetPasswordForEmail(c.email,{redirectTo:location.origin+location.pathname.replace('admin.html','')});
        await logActivity('create','login_link',c.id,c.name);
        alert('ğŸ“§ Link de login enviado a: '+c.email);
    }catch(e){alert('âŒ '+e.message);}
}

async function changePlan(id,newPlan){
    if(!confirm('Â¿Cambiar plan a '+newPlan+'?'))return;
    await db.from('companies').update({plan:newPlan,subscription_status:newPlan==='free'?'free':'active'}).eq('id',id);
    await logActivity('update','company',id,'Plan â†’ '+newPlan);
    closeModal('modalCompany');refreshAll();alert('âœ… Plan actualizado');
}

function showCompanyTab(name,el){
    document.querySelectorAll('#companyTabs .tab-btn').forEach(function(b){b.classList.remove('active')});
    document.querySelectorAll('#modalCompany .tab-pane').forEach(function(p){p.classList.remove('active')});
    if(el)el.classList.add('active');
    var pane=$('compTab'+name.charAt(0).toUpperCase()+name.slice(1));
    if(pane)pane.classList.add('active');
}

// ==========================================
// STRIPE INTEGRATION
// ==========================================
function connectStripe(){
    var key=$('stripeKeyInput').value.trim();
    if(!key||!key.startsWith('sk_')){alert('Key invÃ¡lida. Debe empezar con sk_live_ o sk_test_');return;}
    STRIPE_KEY=key;localStorage.setItem('tm_stripe_key',key);
    $('stripeNotConnected').style.display='none';$('stripeConnected').style.display='block';
    loadStripeData();
}
function disconnectStripe(){STRIPE_KEY='';localStorage.removeItem('tm_stripe_key');$('stripeNotConnected').style.display='block';$('stripeConnected').style.display='none';}
function saveStripeKey(){var key=$('settingsStripeKey').value.trim();if(key&&key.startsWith('sk_')){STRIPE_KEY=key;localStorage.setItem('tm_stripe_key',key);alert('âœ… Key guardada');}else alert('Key invÃ¡lida');}

async function stripeAPI(endpoint,method,body){
    var r=await fetch('https://api.stripe.com/v1/'+endpoint,{
        method:method||'GET',
        headers:{'Authorization':'Bearer '+STRIPE_KEY,'Content-Type':'application/x-www-form-urlencoded'},
        body:body||undefined
    });
    return r.json();
}

async function loadStripeData(){
    if(!STRIPE_KEY)return;
    $('stripeNotConnected').style.display='none';$('stripeConnected').style.display='block';
    try{
        var [bal,cust,subs,charges,refunds]=await Promise.all([
            stripeAPI('balance'),
            stripeAPI('customers?limit=100'),
            stripeAPI('subscriptions?limit=100&status=all'),
            stripeAPI('charges?limit=100'),
            stripeAPI('refunds?limit=50')
        ]);
        $('stripeBalance').textContent='$'+((bal.available?bal.available[0].amount:0)/100).toFixed(2);
        stripeCustomers=cust.data||[];$('stripeCust').textContent=stripeCustomers.length;
        stripeSubs=subs.data||[];$('stripeSubs').textContent=stripeSubs.filter(function(s){return s.status==='active'}).length;
        stripePayments=charges.data||[];
        var thisMonth=stripePayments.filter(function(p){return p.status==='succeeded'&&new Date(p.created*1000).getMonth()===new Date().getMonth()}).reduce(function(s,p){return s+p.amount},0);
        $('stripeMonth').textContent='$'+(thisMonth/100).toFixed(2);
        stripeRefunds=refunds.data||[];
        renderStripeCustomers();renderStripePayments();renderStripeSubs();renderStripeRefunds();
    }catch(e){console.error('Stripe error:',e);alert('Error conectando a Stripe: '+e.message);}
}

function renderStripeCustomers(){$('stripeCustomersTable').innerHTML=stripeCustomers.length?stripeCustomers.map(function(c){var sub=stripeSubs.find(function(s){return s.customer===c.id&&s.status==='active'});var totalPaid=stripePayments.filter(function(p){return p.customer===c.id&&p.status==='succeeded'}).reduce(function(s,p){return s+p.amount},0);return'<tr><td><div class="user-card"><div class="avatar" style="background:#635bff">'+initials(c.name||c.email||'?')+'</div><div><h4>'+(c.name||'Sin nombre')+'</h4></div></div></td><td>'+(c.email||'-')+'</td><td>'+new Date(c.created*1000).toLocaleDateString()+'</td><td>'+(sub?'<span class="badge b-green">Activa</span>':'<span class="badge b-gray">â€”</span>')+'</td><td style="font-weight:700">$'+(totalPaid/100).toFixed(2)+'</td><td><div class="actions"><button class="act" onclick="openStripeCustomer(\''+c.id+'\')" title="Ver">ğŸ‘</button></div></td></tr>'}).join(''):'<tr><td colspan="6" class="empty">Sin clientes</td></tr>';}

function renderStripePayments(){$('stripePaymentsTable').innerHTML=stripePayments.length?stripePayments.slice(0,50).map(function(p){return'<tr><td>'+new Date(p.created*1000).toLocaleDateString()+'</td><td>'+(p.billing_details?.name||p.customer||'-')+'</td><td style="font-weight:700;color:'+(p.status==='succeeded'?'var(--success)':'var(--gray)')+'">$'+(p.amount/100).toFixed(2)+'</td><td><span class="badge '+(p.status==='succeeded'?'b-green':p.refunded?'b-red':'b-yellow')+'">'+p.status+(p.refunded?' (refunded)':'')+'</span></td><td style="font-family:monospace;font-size:0.7rem">'+p.id.slice(0,16)+'â€¦</td><td><div class="actions">'+(p.status==='succeeded'&&!p.refunded?'<button class="act" onclick="openRefund(\''+p.id+'\','+(p.amount/100)+',\''+(p.billing_details?.name||'')+'\')" title="Reembolso">â†©ï¸</button>':'')+'</div></td></tr>'}).join(''):'<tr><td colspan="6" class="empty">Sin pagos</td></tr>';}

function renderStripeSubs(){$('stripeSubsTable').innerHTML=stripeSubs.length?stripeSubs.map(function(s){var cust=stripeCustomers.find(function(c){return c.id===s.customer});return'<tr><td>'+(cust?cust.name||cust.email:s.customer)+'</td><td>'+(s.items?.data[0]?.price?.nickname||s.items?.data[0]?.price?.id||'-')+'</td><td style="font-weight:700">$'+((s.items?.data[0]?.price?.unit_amount||0)/100).toFixed(2)+'/'+((s.items?.data[0]?.price?.recurring?.interval)||'mo')+'</td><td><span class="badge '+(s.status==='active'?'b-green':s.status==='canceled'?'b-red':'b-yellow')+'">'+s.status+'</span></td><td>'+(s.current_period_end?new Date(s.current_period_end*1000).toLocaleDateString():'â€”')+'</td><td><div class="actions">'+(s.status==='active'?'<button class="act danger" onclick="cancelStripeSub(\''+s.id+'\')" title="Cancelar">âŒ</button>':'')+'</div></td></tr>'}).join(''):'<tr><td colspan="6" class="empty">Sin suscripciones</td></tr>';}

function renderStripeRefunds(){$('stripeRefundsTable').innerHTML=stripeRefunds.length?stripeRefunds.map(function(r){return'<tr><td>'+new Date(r.created*1000).toLocaleDateString()+'</td><td>'+(r.charge||'-')+'</td><td style="font-weight:700;color:var(--danger)">$'+(r.amount/100).toFixed(2)+'</td><td>'+(r.reason||'-')+'</td><td><span class="badge '+(r.status==='succeeded'?'b-green':'b-yellow')+'">'+r.status+'</span></td></tr>'}).join(''):'<tr><td colspan="5" class="empty">Sin reembolsos</td></tr>';}

function showStripeTab(name,el){
    document.querySelectorAll('#secStripe .tab-btn').forEach(function(b){b.classList.remove('active')});
    document.querySelectorAll('#secStripe .tab-pane').forEach(function(p){p.classList.remove('active')});
    if(el)el.classList.add('active');
    var pane=$('stripeTab'+name.charAt(0).toUpperCase()+name.slice(1));
    if(pane)pane.classList.add('active');
}

function openRefund(chargeId,amount,name){
    $('refundInfo').innerHTML='<p><strong>Cargo:</strong> '+chargeId+'</p><p><strong>Cliente:</strong> '+name+'</p><p><strong>Monto original:</strong> $'+amount.toFixed(2)+'</p>';
    $('refundAmount').value=amount.toFixed(2);$('refundAmount').max=amount;
    selectedRefundCharge=chargeId;
    openModal('modalRefund');
}
var selectedRefundCharge=null;
async function confirmRefund(){
    if(!selectedRefundCharge||!STRIPE_KEY)return;
    var amount=Math.round(parseFloat($('refundAmount').value)*100);
    var reason=$('refundReason').value;
    if(!amount||amount<=0){alert('Monto invÃ¡lido');return;}
    if(!confirm('Â¿Confirmar reembolso de $'+(amount/100).toFixed(2)+'?'))return;
    try{
        var r=await stripeAPI('refunds','POST','charge='+selectedRefundCharge+'&amount='+amount+'&reason='+reason);
        if(r.id){alert('âœ… Reembolso exitoso: '+r.id);closeModal('modalRefund');loadStripeData();
            await logActivity('create','refund',r.id,'$'+(amount/100).toFixed(2));
        }else{alert('âŒ Error: '+(r.error?.message||'Unknown'));}
    }catch(e){alert('âŒ '+e.message);}
}

async function cancelStripeSub(subId){
    if(!confirm('Â¿Cancelar esta suscripciÃ³n?'))return;
    try{var r=await stripeAPI('subscriptions/'+subId,'DELETE');
        if(r.status==='canceled'){alert('âœ… SuscripciÃ³n cancelada');loadStripeData();await logActivity('update','subscription',subId,'Cancelada');}
        else alert('âŒ '+(r.error?.message||'Error'));
    }catch(e){alert('âŒ '+e.message);}
}

async function openStripeCustomer(custId){
    window.open('https://dashboard.stripe.com/customers/'+custId,'_blank');
}

// ==========================================
// TICKETS
// ==========================================
async function viewTicket(id){selectedTicket=tickets.find(function(t){return t.id===id});if(!selectedTicket)return;$('ticketTitle').textContent=(selectedTicket.ticket_number||'#')+' - '+selectedTicket.subject;$('ticketInfo').innerHTML='<div class="detail-grid"><div class="detail-item"><label>Usuario</label><span>'+(selectedTicket.user_name||'N/A')+'</span></div><div class="detail-item"><label>Email</label><span>'+selectedTicket.user_email+'</span></div><div class="detail-item"><label>Empresa</label><span>'+(selectedTicket.company_name||'N/A')+'</span></div><div class="detail-item"><label>CategorÃ­a</label><span>'+selectedTicket.category+'</span></div></div>';$('ticketStatus').value=selectedTicket.status;var r=await db.from('support_messages').select('*').eq('ticket_id',id).order('created_at');var msgs=r.data||[];$('ticketChat').innerHTML=msgs.map(function(m){return'<div class="chat-msg '+m.sender_type+'"><div class="chat-bubble"><div class="chat-sender">'+(m.sender_name||m.sender_email)+'</div>'+m.message+'<div class="chat-time">'+fmtDateTime(m.created_at)+'</div></div></div>'}).join('')||'<p class="empty">Sin mensajes</p>';openModal('modalTicket');}
async function sendTicketReply(){if(!selectedTicket)return;var msg=$('ticketReply').value.trim();var st=$('ticketStatus').value;if(!msg){alert('Escribe un mensaje');return;}await db.from('support_messages').insert({ticket_id:selectedTicket.id,sender_type:'admin',sender_name:currentAdmin.name,admin_user_id:currentAdmin.id,message:msg});await db.from('support_tickets').update({status:st,updated_at:new Date().toISOString()}).eq('id',selectedTicket.id);await logActivity('update','ticket',selectedTicket.id,selectedTicket.ticket_number);$('ticketReply').value='';viewTicket(selectedTicket.id);loadTickets();}
function filterTickets(s){if(s==='all')renderTickets(tickets);else renderTickets(tickets.filter(function(t){return t.status===s}));}
function searchTickets(q){q=q.toLowerCase();renderTickets(tickets.filter(function(t){return(t.ticket_number||'').toLowerCase().includes(q)||(t.subject||'').toLowerCase().includes(q)||(t.user_email||'').toLowerCase().includes(q)}));}

// ==========================================
// PASSWORD RESET
// ==========================================
async function quickSearchUser(){var email=$('quickResetEmail').value.trim().toLowerCase();if(!email)return;var result=$('quickResetResult');result.innerHTML='<p>Buscando...</p>';var r1=await db.from('team_users').select('*, companies(name)').eq('email',email).single();if(r1.data){selectedResetUser={type:'team_user',...r1.data,company_name:r1.data.companies?.name};result.innerHTML='<div style="padding:1rem;background:#dcfce7;border-radius:8px"><p><strong>âœ… Team User encontrado</strong></p><p>ğŸ‘¤ '+r1.data.name+'</p><p>ğŸ¢ '+(r1.data.companies?.name||'N/A')+'</p><button class="btn-sm btn-primary" onclick="openResetModal()" style="margin-top:0.5rem">ğŸ”‘ Resetear</button></div>';return;}var r2=await db.from('technicians').select('*, companies(name)').eq('email',email).single();if(r2.data){selectedResetUser={type:'technician',...r2.data,company_name:r2.data.companies?.name};result.innerHTML='<div style="padding:1rem;background:#dcfce7;border-radius:8px"><p><strong>âœ… TÃ©cnico encontrado</strong></p><p>ğŸ‘¤ '+r2.data.name+'</p><button class="btn-sm btn-primary" onclick="openResetModal()" style="margin-top:0.5rem">ğŸ”‘ Resetear</button></div>';return;}var r3=await db.from('companies').select('*').eq('email',email).single();if(r3.data){selectedResetUser={type:'company_owner',...r3.data,company_name:r3.data.name};result.innerHTML='<div style="padding:1rem;background:#dcfce7;border-radius:8px"><p><strong>âœ… DueÃ±o encontrado</strong></p><p>ğŸ¢ '+r3.data.name+'</p><button class="btn-sm btn-primary" onclick="openResetModal()" style="margin-top:0.5rem">ğŸ”‘ Resetear</button></div>';return;}result.innerHTML='<div style="padding:1rem;background:#fee2e2;border-radius:8px">âŒ No encontrado</div>';}
function openResetModal(){if(!selectedResetUser)return;$('resetUserInfo').innerHTML='<p><strong>ğŸ‘¤ '+(selectedResetUser.name||selectedResetUser.email)+'</strong></p><p>ğŸ“§ '+selectedResetUser.email+'</p><p>ğŸ¢ '+(selectedResetUser.company_name||'N/A')+'</p>';$('newPassword').value=generatePass();openModal('modalReset');}
function openManualResetModal(){selectedResetUser=null;openResetModal();}
async function confirmResetPassword(){if(!selectedResetUser)return;var np=$('newPassword').value;if(np.length<6){alert('MÃ­nimo 6 caracteres');return;}var table=selectedResetUser.type==='team_user'?'team_users':selectedResetUser.type==='technician'?'technicians':'companies';await db.from(table).update({password:np}).eq('id',selectedResetUser.id);await logActivity('update','password_reset',selectedResetUser.id,selectedResetUser.email);await db.from('password_reset_requests').update({status:'completed',completed_at:new Date().toISOString(),completed_by:currentAdmin.id}).eq('user_email',selectedResetUser.email).eq('status','pending');try{await db.auth.resetPasswordForEmail(selectedResetUser.email,{redirectTo:location.origin+location.pathname.replace('admin.html','')});}catch(e){}closeModal('modalReset');alert('âœ… ContraseÃ±a: '+np);loadResetRequests();}
async function sendMagicLink(){if(!selectedResetUser)return;try{await db.auth.resetPasswordForEmail(selectedResetUser.email,{redirectTo:location.origin+location.pathname.replace('admin.html','')});alert('ğŸ“§ Email enviado a: '+selectedResetUser.email);}catch(e){alert('âŒ '+e.message);}closeModal('modalReset');}
async function handleReset(id){var req=resetRequests.find(function(r){return r.id===id});if(!req)return;selectedResetUser={type:req.user_type,id:req.user_id,email:req.user_email,name:req.user_name,company_name:req.company_name};openResetModal();}
function openResetForCompany(cid){var c=companies.find(function(x){return x.id===cid});if(!c||!c.email){alert('Sin email');return;}selectedResetUser={type:'company_owner',id:c.id,email:c.email,name:c.name,company_name:c.name};openResetModal();}

// ==========================================
// PAYMENTS
// ==========================================
function openAddPaymentModal(){$('payCompany').innerHTML=companies.map(function(c){return'<option value="'+c.id+'" data-name="'+c.name+'">'+c.name+'</option>'}).join('');$('payAmount').value='149.99';openModal('modalAddPayment');}
async function savePayment(){var cid=$('payCompany').value;var cname=$('payCompany').selectedOptions[0]?.dataset.name||'';var amt=parseFloat($('payAmount').value)||0;var plan=$('payPlan').value;var method=$('payMethod').value;var notes=$('payNotes').value;await db.from('payment_history').insert({company_id:cid,company_name:cname,amount:amt,plan:plan,payment_method:method,status:'completed',notes:notes});await logActivity('create','payment',null,cname+' - $'+amt);closeModal('modalAddPayment');loadPayments();updateDashboard();alert('âœ… Pago registrado');}

// ==========================================
// ADMINS
// ==========================================
function openAddAdminModal(){$('newAdminName').value='';$('newAdminEmail').value='';$('newAdminPhone').value='';$('newAdminPass').value=generatePass();$('newAdminRole').value='support';$('newAdminSalary').value='';$('newAdminPayType').value='monthly';openModal('modalAddAdmin');}
async function saveNewAdmin(){var name=$('newAdminName').value.trim();var email=$('newAdminEmail').value.trim().toLowerCase();var pass=$('newAdminPass').value;var role=$('newAdminRole').value;var phone=$('newAdminPhone').value.trim();var salary=parseFloat($('newAdminSalary').value)||0;var payType=$('newAdminPayType').value;if(!name||!email||!pass){alert('Completa todos los campos');return;}await db.from('admin_users').insert({name:name,email:email,phone:phone,password_hash:pass,role:role,salary:salary,pay_type:payType,is_active:true,created_by:currentAdmin.id});await logActivity('create','admin_user',null,name+' ('+getRoleName(role)+')');closeModal('modalAddAdmin');loadAdmins();alert('âœ… Usuario creado');}
function editAdmin(id){var a=adminUsers.find(function(x){return x.id===id});if(!a)return;var d=document.createElement('div');d.className='modal-bg show';d.id='modalEditAdmin';d.innerHTML='<div class="modal" style="max-width:550px"><div class="modal-head"><h3>âœï¸ Editar Usuario</h3><button class="modal-close" onclick="document.getElementById(\'modalEditAdmin\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Nombre</label><input type="text" id="editAdminName" value="'+a.name+'"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>Email</label><input type="email" id="editAdminEmail" value="'+a.email+'"></div><div class="form-group"><label>TelÃ©fono</label><input type="text" id="editAdminPhone" value="'+(a.phone||'')+'"></div></div><div class="form-group"><label>Nueva ContraseÃ±a</label><input type="text" id="editAdminPass" placeholder="Dejar vacÃ­o para no cambiar"></div><div class="form-group"><label>Rol</label><select id="editAdminRole">'+getRoleOptions(a.role)+'</select></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>ğŸ’° Salario ($)</label><input type="number" id="editAdminSalary" value="'+(a.salary||0)+'" step="0.01"></div><div class="form-group"><label>Tipo Pago</label><select id="editAdminPayType"><option value="monthly" '+(a.pay_type==='monthly'?'selected':'')+'>ğŸ“… Mensual</option><option value="biweekly" '+(a.pay_type==='biweekly'?'selected':'')+'>ğŸ“… Quincenal</option><option value="weekly" '+(a.pay_type==='weekly'?'selected':'')+'>ğŸ“… Semanal</option><option value="hourly" '+(a.pay_type==='hourly'?'selected':'')+'>â° Por Hora</option><option value="commission" '+(a.pay_type==='commission'?'selected':'')+'>ğŸ’° ComisiÃ³n</option></select></div></div><div class="form-group"><label>Estado</label><select id="editAdminStatus"><option value="true" '+(a.is_active?'selected':'')+'>âœ… Activo</option><option value="false" '+(!a.is_active?'selected':'')+'>â›” Inactivo</option></select></div></div><div class="modal-foot"><button class="btn-sm btn-ghost" onclick="document.getElementById(\'modalEditAdmin\').remove()">Cancelar</button><button class="btn-sm btn-success" onclick="saveEditAdmin(\''+a.id+'\')">ğŸ’¾ Guardar</button></div></div>';document.body.appendChild(d);}
async function saveEditAdmin(id){var name=$('editAdminName').value.trim();var email=$('editAdminEmail').value.trim().toLowerCase();var pass=$('editAdminPass').value;var role=$('editAdminRole').value;var active=$('editAdminStatus').value==='true';var phone=$('editAdminPhone').value.trim();var salary=parseFloat($('editAdminSalary').value)||0;var payType=$('editAdminPayType').value;var upd={name:name,email:email,phone:phone,role:role,salary:salary,pay_type:payType,is_active:active};if(pass&&pass.length>=4)upd.password_hash=pass;await db.from('admin_users').update(upd).eq('id',id);await logActivity('update','admin_user',id,name);document.getElementById('modalEditAdmin').remove();loadAdmins();if(currentAdmin&&currentAdmin.id===id){currentAdmin.name=name;currentAdmin.role=role;$('currentUserName').textContent=name;$('sideName').textContent=name;$('currentUserRole').textContent=getRoleName(role);$('sideRole').textContent=getRoleName(role);}alert('âœ… Actualizado');}

// ==========================================
// CUSTOMER SUCCESS
// ==========================================
var followUps=[];
var csData=[];// computed customer success records

function computeCSData(){
    csData=companies.map(function(c){
        var cPay=payments.filter(function(p){return p.company_id===c.id||p.company_name===c.name});
        var totalPaid=cPay.reduce(function(s,p){return s+(p.amount||0)},0);
        var lastPay=cPay.length?cPay.sort(function(a,b){return new Date(b.created_at)-new Date(a.created_at)})[0]:null;
        var daysSincePayment=lastPay?Math.floor((Date.now()-new Date(lastPay.created_at).getTime())/86400000):9999;
        var daysRegistered=Math.floor((Date.now()-new Date(c.created_at).getTime())/86400000);
        var empCount=employeeCounts[c.id]||0;
        var cTickets=tickets.filter(function(t){return t.company_name===c.name||t.company_id===c.id}).length;
        
        // Compute lifecycle stage
        var lifecycle='onboarding';
        if(c.subscription_status==='canceled')lifecycle='churned';
        else if(totalPaid===0&&daysRegistered>14)lifecycle='never_paid';
        else if(totalPaid===0&&daysRegistered<=14)lifecycle='onboarding';
        else if(daysSincePayment>45)lifecycle='overdue';
        else if(daysSincePayment>30||c.subscription_status==='past_due')lifecycle='at_risk';
        else if(totalPaid>0&&c.subscription_status==='active')lifecycle='active';
        else if(daysRegistered<=7)lifecycle='onboarding';
        
        // Health score 0-100
        var health=50;
        if(lifecycle==='active')health=85;
        if(lifecycle==='onboarding')health=60;
        if(lifecycle==='at_risk')health=35;
        if(lifecycle==='overdue')health=15;
        if(lifecycle==='never_paid')health=20;
        if(lifecycle==='churned')health=0;
        // Bonuses
        if(totalPaid>500)health=Math.min(100,health+5);
        if(empCount>3)health=Math.min(100,health+5);
        if(cTickets>3)health=Math.max(0,health-10);
        if(c.plan==='enterprise')health=Math.min(100,health+5);
        
        return{
            id:c.id,name:c.name,email:c.email,phone:c.phone,
            plan:c.plan||'free',status:c.subscription_status||'free',
            stripe_id:c.stripe_customer_id,
            created_at:c.created_at,
            daysRegistered:daysRegistered,
            totalPaid:totalPaid,
            lastPayDate:lastPay?lastPay.created_at:null,
            daysSincePayment:daysSincePayment,
            paymentCount:cPay.length,
            empCount:empCount,
            ticketCount:cTickets,
            lifecycle:lifecycle,
            health:health
        };
    });
    csData.sort(function(a,b){return a.health-b.health});// worst first
}

function renderCS(list){
    if(!list)list=csData;
    var tb=$('csTable');
    if(!list.length){tb.innerHTML='<tr><td colspan="10" class="empty">No hay empresas</td></tr>';return;}
    var sorted=companies.slice().sort(function(a,b){return new Date(a.created_at)-new Date(b.created_at)});
    tb.innerHTML=list.map(function(c){
        var hColor=c.health>=70?'#22c55e':c.health>=40?'#eab308':'#ef4444';
        var lcClass={onboarding:'lc-onboarding',active:'lc-active',at_risk:'lc-at-risk',overdue:'lc-overdue',churned:'lc-churned',never_paid:'lc-never'}[c.lifecycle]||'';
        var lcText={onboarding:'ğŸ†• Onboarding',active:'âœ… Activo',at_risk:'âš ï¸ At Risk',overdue:'ğŸ”´ Vencido',churned:'ğŸ’€ Churned',never_paid:'ğŸ‘» Nunca PagÃ³'}[c.lifecycle]||c.lifecycle;
        var daysTxt=c.daysSincePayment===9999?'<span style="color:var(--danger);font-weight:700">Nunca</span>':(c.daysSincePayment+'d');
        var daysColor=c.daysSincePayment>45?'var(--danger)':c.daysSincePayment>30?'var(--warning)':'var(--success)';
        var idx=sorted.findIndex(function(x){return x.id===c.id});
        var compNum='TM-'+String(idx+1).padStart(4,'0');
        return'<tr onclick="viewCompany(\''+c.id+'\')">'+
            '<td><span class="badge b-blue" style="font-family:monospace;font-weight:800;font-size:0.7rem">'+compNum+'</span></td>'+
            '<td><div class="user-card"><div class="avatar">'+initials(c.name)+'</div><div><h4>'+(c.name||'?')+'</h4><small>'+(c.email||'')+'</small></div></div></td>'+
            '<td><span class="health-score" style="color:'+hColor+'">'+c.health+'</span><div class="health-bar"><div class="health-fill" style="width:'+c.health+'%;background:'+hColor+'"></div></div></td>'+
            '<td><span class="lifecycle '+lcClass+'">'+lcText+'</span></td>'+
            '<td><span class="badge '+planClass(c.plan)+'">'+c.plan+'</span></td>'+
            '<td>'+(c.lastPayDate?fmtDate(c.lastPayDate):'<span style="color:var(--gray)">â€”</span>')+'</td>'+
            '<td style="font-weight:700;color:'+daysColor+'">'+daysTxt+'</td>'+
            '<td style="font-weight:700">$'+c.totalPaid.toFixed(2)+'</td>'+
            '<td>'+fmtDate(c.created_at)+'<br><small style="color:var(--gray)">'+c.daysRegistered+'d</small></td>'+
            '<td><div class="actions" onclick="event.stopPropagation()">'+
                '<button class="act" onclick="viewCompany(\''+c.id+'\')" title="Ver CRM" style="background:#dbeafe">ğŸ‘</button>'+
                '<button class="act" onclick="enterCompanyCRMById(\''+c.id+'\')" title="Entrar a su CRM" style="background:#ffedd5">ğŸš€</button>'+
                '<button class="act" onclick="openAddFollowUpFor(\''+c.id+'\',\''+c.name+'\')" title="Follow-up">ğŸ“</button>'+
                (c.lifecycle==='overdue'||c.lifecycle==='never_paid'?'<button class="act danger" onclick="sendPaymentReminder(\''+c.id+'\')" title="Recordatorio pago">ğŸ’°</button>':'')+
            '</div></td></tr>';
    }).join('');
    
    // Update KPI cards
    var healthy=csData.filter(function(c){return c.lifecycle==='active'}).length;
    var atRisk=csData.filter(function(c){return c.lifecycle==='at_risk'}).length;
    var overdue=csData.filter(function(c){return c.lifecycle==='overdue'}).length;
    var neverPaid=csData.filter(function(c){return c.lifecycle==='never_paid'}).length;
    var onboarding=csData.filter(function(c){return c.lifecycle==='onboarding'}).length;
    var churned=csData.filter(function(c){return c.lifecycle==='churned'}).length;
    $('csHealthy').textContent=healthy;
    $('csAtRisk').textContent=atRisk;
    $('csOverdue').textContent=overdue;
    $('csNeverPaid').textContent=neverPaid;
    $('csOnboarding').textContent=onboarding;
    $('csChurned').textContent=churned;
    
    // Badge for nav
    var urgent=atRisk+overdue;
    var badge=$('csBadge');
    if(urgent>0){badge.textContent=urgent;badge.style.display='inline';}else badge.style.display='none';
    
    renderCSChart();
    renderOnboardingPipeline();
}

var csChartInst=null;
function renderCSChart(){
    var counts={active:0,at_risk:0,overdue:0,never_paid:0,onboarding:0,churned:0};
    csData.forEach(function(c){counts[c.lifecycle]=(counts[c.lifecycle]||0)+1;});
    if(csChartInst)csChartInst.destroy();
    var ctx=$('csHealthChart');if(!ctx)return;
    csChartInst=new Chart(ctx,{type:'doughnut',data:{
        labels:['âœ… Activo','âš ï¸ At Risk','ğŸ”´ Vencido','ğŸ‘» Nunca PagÃ³','ğŸ†• Onboarding','ğŸ’€ Churned'],
        datasets:[{data:[counts.active,counts.at_risk,counts.overdue,counts.never_paid,counts.onboarding,counts.churned],
            backgroundColor:['#22c55e','#eab308','#ef4444','#ec4899','#8b5cf6','#94a3b8']}]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11}}}}}});
}

function renderOnboardingPipeline(){
    var stages=[
        {key:'registered',label:'ğŸ“ Registrado',filter:function(c){return c.daysRegistered<=3&&c.lifecycle==='onboarding'}},
        {key:'exploring',label:'ğŸ” Explorando',filter:function(c){return c.daysRegistered>3&&c.daysRegistered<=7&&c.lifecycle==='onboarding'}},
        {key:'trial',label:'â³ Trial (7-14d)',filter:function(c){return c.daysRegistered>7&&c.daysRegistered<=14&&(c.lifecycle==='onboarding'||c.lifecycle==='never_paid')}},
        {key:'converting',label:'ğŸ”¥ Convertir',filter:function(c){return c.daysRegistered>14&&c.lifecycle==='never_paid'}},
        {key:'active',label:'âœ… Activo',filter:function(c){return c.lifecycle==='active'}}
    ];
    $('onboardingPipeline').innerHTML=stages.map(function(s){
        var items=csData.filter(s.filter);
        return'<div class="ob-col"><h4>'+s.label+' <span>'+items.length+'</span></h4>'+
            items.slice(0,8).map(function(c){return'<div class="ob-card" onclick="viewCompany(\''+c.id+'\')"><h5>'+c.name+'</h5><small>'+c.daysRegistered+'d Â· '+(c.plan||'free')+(c.empCount?' Â· ğŸ‘·'+c.empCount:'')+'</small></div>'}).join('')+
            (items.length>8?'<small style="color:var(--gray)">+'+(items.length-8)+' mÃ¡s</small>':'')+
        '</div>';
    }).join('');
}

function filterCSStatus(status,el){
    if(el){document.querySelectorAll('#csFilters .pill').forEach(function(p){p.classList.remove('active')});el.classList.add('active');}
    if(status==='all')renderCS(csData);
    else if(status==='healthy')renderCS(csData.filter(function(c){return c.lifecycle==='active'}));
    else renderCS(csData.filter(function(c){return c.lifecycle===status}));
}

function filterCS(){
    var q=$('csSearch').value.toLowerCase();
    renderCS(csData.filter(function(c){return(c.name||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q)}));
}

function exportCSReport(){
    var csv='Empresa,Email,Health,Lifecycle,Plan,Ãšltimo Pago,DÃ­as sin Pagar,Total Pagado,Empleados,Registro\n';
    csData.forEach(function(c){csv+='"'+c.name+'",'+c.email+','+c.health+','+c.lifecycle+','+c.plan+','+(c.lastPayDate||'nunca')+','+c.daysSincePayment+','+c.totalPaid.toFixed(2)+','+c.empCount+','+fmtDate(c.created_at)+'\n';});
    var a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='customer_success_'+new Date().toISOString().slice(0,10)+'.csv';a.click();
}

// ==========================================
// FOLLOW-UPS
// ==========================================
async function loadFollowUps(){
    var r=await db.from('cs_follow_ups').select('*').order('due_date',{ascending:true});
    followUps=r.data||[];
    renderFollowUps();
}

function renderFollowUps(){
    var ct=$('followUpList');
    var pending=followUps.filter(function(f){return f.status!=='done'});
    if(!pending.length){ct.innerHTML='<p class="empty">Sin follow-ups pendientes ğŸ‰</p>';return;}
    var today=new Date().toISOString().slice(0,10);
    ct.innerHTML=pending.map(function(f){
        var isOverdue=f.due_date<today;
        var typeIcon={call:'ğŸ“',email:'ğŸ“§',whatsapp:'ğŸ’¬',onboarding:'ğŸš€',renewal:'ğŸ”„',payment:'ğŸ’°'}[f.type]||'ğŸ“‹';
        var prioColor={high:'#fee2e2',medium:'#fef3c7',low:'#dcfce7'}[f.priority]||'#f3f4f6';
        return'<div class="fu-card '+(isOverdue?'overdue':'')+'">'+
            '<div class="fu-icon" style="background:'+prioColor+'">'+typeIcon+'</div>'+
            '<div style="flex:1"><h5>'+(f.company_name||'?')+' â€” '+typeIcon+' '+(f.type||'')+'</h5><p>'+(f.notes||'Sin notas')+'</p><span class="fu-date" style="color:'+(isOverdue?'var(--danger)':'var(--gray)')+'">ğŸ“… '+f.due_date+(isOverdue?' âš ï¸ VENCIDO':'')+'</span></div>'+
            '<div class="actions"><button class="act" onclick="completeFollowUp(\''+f.id+'\')" title="Completar">âœ…</button><button class="act danger" onclick="deleteFollowUp(\''+f.id+'\')" title="Eliminar">ğŸ—‘ï¸</button></div>'+
        '</div>';
    }).join('');
}

function openAddFollowUp(){
    $('fuCompany').innerHTML=companies.map(function(c){return'<option value="'+c.id+'" data-name="'+(c.name||'')+'">'+c.name+'</option>'}).join('');
    $('fuDate').value=new Date(Date.now()+86400000).toISOString().slice(0,10);
    $('fuNotes').value='';
    openModal('modalFollowUp');
}

function openAddFollowUpFor(cid,cname){
    openAddFollowUp();
    var sel=$('fuCompany');
    for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===cid){sel.selectedIndex=i;break;}}
}

async function saveFollowUp(){
    var cid=$('fuCompany').value;
    var cname=$('fuCompany').selectedOptions[0]?.dataset.name||'';
    var type=$('fuType').value;
    var date=$('fuDate').value;
    var priority=$('fuPriority').value;
    var notes=$('fuNotes').value;
    if(!cid||!date){alert('Completa los campos');return;}
    
    // Try Supabase table, fallback to local
    try{
        await db.from('cs_follow_ups').insert({company_id:cid,company_name:cname,type:type,due_date:date,priority:priority,notes:notes,status:'pending',created_by:currentAdmin?currentAdmin.id:null});
    }catch(e){
        // Table might not exist, store locally
        followUps.push({id:'fu_'+Date.now(),company_id:cid,company_name:cname,type:type,due_date:date,priority:priority,notes:notes,status:'pending'});
    }
    closeModal('modalFollowUp');
    loadFollowUps();
    await logActivity('create','follow_up',null,cname+' - '+type);
}

async function completeFollowUp(id){
    try{await db.from('cs_follow_ups').update({status:'done',completed_at:new Date().toISOString()}).eq('id',id);}catch(e){followUps=followUps.filter(function(f){return f.id!==id});}
    loadFollowUps();
}

async function deleteFollowUp(id){
    if(!confirm('Â¿Eliminar este follow-up?'))return;
    try{await db.from('cs_follow_ups').delete().eq('id',id);}catch(e){followUps=followUps.filter(function(f){return f.id!==id});}
    loadFollowUps();
}

async function sendPaymentReminder(cid){
    var c=companies.find(function(x){return x.id===cid});
    if(!c){alert('Empresa no encontrada');return;}
    if(!confirm('Â¿Enviar recordatorio de pago a '+c.name+' ('+c.email+')?'))return;
    // Log the action - actual email would go through Supabase function
    await logActivity('create','payment_reminder',c.id,c.name);
    alert('âœ… Recordatorio registrado para '+c.name+'\nğŸ“§ '+c.email);
}

// ==========================================
// NOTIFICATIONS / DELETE / LOGS / SEARCH
// ==========================================
function toggleNotifications(){$('notifDropdown').classList.toggle('show');}
async function handleNotification(id,et,eid){await db.from('admin_notifications').update({is_read:true}).eq('id',id);loadNotifications();if(et==='ticket'){showSec('tickets');setTimeout(function(){viewTicket(eid)},100);}else if(et==='company')showSec('empresas');}
async function markAllRead(){if(!currentAdmin)return;await db.from('admin_notifications').update({is_read:true}).eq('admin_user_id',currentAdmin.id);loadNotifications();}
function openDelete(type,id,name){deleteTarget={type:type,id:id};$('deleteName').textContent=name;openModal('modalDelete');}
async function confirmDelete(){if(!deleteTarget)return;var t=deleteTarget.type;var id=deleteTarget.id;var name=$('deleteName').textContent;if(t==='company'){await db.from('companies').delete().eq('id',id);}else if(t==='sales_rep'){await db.from('sales_reps').delete().eq('id',id);}else if(t==='campaign'){await db.from('marketing_campaigns').delete().eq('id',id);}await logActivity('delete',t,id,name);closeModal('modalDelete');deleteTarget=null;refreshAll();}
async function logActivity(action,et,eid,en,details){if(!currentAdmin)return;await db.from('admin_activity_logs').insert({admin_user_id:currentAdmin.id,admin_name:currentAdmin.name,action:action,entity_type:et,entity_id:eid,entity_name:en,details:details});}
function filterLogs(){var f=$('logFilter').value;if(f==='all')renderLogs(logs);else renderLogs(logs.filter(function(l){return l.action===f}));}
function doSearch(){var q=$('q').value.toLowerCase();renderCompanies(companies.filter(function(c){return(c.name||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q)||(c.phone||'').includes(q)}));}
function filterCompanies(plan,el){if(el){document.querySelectorAll('.filter-bar .pill').forEach(function(p){p.classList.remove('active')});el.classList.add('active');}if(plan==='all')renderCompanies(companies);else if(plan==='active')renderCompanies(companies.filter(function(c){return c.subscription_status==='active'}));else if(plan==='canceled')renderCompanies(companies.filter(function(c){return c.subscription_status==='canceled'}));else if(plan==='trial')renderCompanies(companies.filter(function(c){return!c.plan||c.plan==='free'||c.subscription_status==='trialing'}));else renderCompanies(companies.filter(function(c){return(c.plan||'free')===plan}));}
function exportCompaniesCSV(){var csv='Nombre,Email,Telefono,Plan,Status,Registro,Stripe ID\n';companies.forEach(function(c){csv+='"'+(c.name||'')+'",'+(c.email||'')+','+(c.phone||'')+','+(c.plan||'free')+','+(c.subscription_status||'-')+','+fmtDate(c.created_at)+','+(c.stripe_customer_id||'')+'\n';});var a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='empresas_'+new Date().toISOString().slice(0,10)+'.csv';a.click();}

// ==========================================
// VENDEDORES (SALES REPS)
// ==========================================
var salesReps=[],deals=[],campaigns=[],mkExpenses=[];
var editingSalesRepId=null,editingCampaignId=null;

async function loadSalesReps(){try{var r=await db.from('sales_reps').select('*').order('created_at',{ascending:false});salesReps=r.data||[];}catch(e){salesReps=[];}renderSalesReps();}
async function loadDeals(){try{var r=await db.from('sales_deals').select('*').order('deal_date',{ascending:false});deals=r.data||[];}catch(e){deals=[];}renderDeals();}
async function loadCampaigns(){try{var r=await db.from('marketing_campaigns').select('*').order('created_at',{ascending:false});campaigns=r.data||[];}catch(e){campaigns=[];}renderCampaigns();}
async function loadMkExpenses(){try{var r=await db.from('marketing_expenses').select('*').order('expense_date',{ascending:false});mkExpenses=r.data||[];}catch(e){mkExpenses=[];}renderMkExpenses();}

function renderSalesReps(){
    var tb=$('salesRepsTable');if(!salesReps.length){tb.innerHTML='<tr><td colspan="8" class="empty">No hay vendedores â€” agrega el primero</td></tr>';updateSalesKPIs();return;}
    tb.innerHTML=salesReps.map(function(s){
        var sDeals=deals.filter(function(d){return d.rep_id===s.id});
        var totalRev=sDeals.reduce(function(sum,d){return sum+(d.amount||0)},0);
        var totalComm=sDeals.reduce(function(sum,d){return sum+(d.commission||0)},0);
        return'<tr>'+
            '<td><div class="user-card"><div class="avatar" style="background:linear-gradient(135deg,#f97316,#ea580c)">'+initials(s.name)+'</div><div><h4>'+s.name+'</h4><small>'+(s.zone||'')+'</small></div></div></td>'+
            '<td><div>'+s.email+'</div><small style="color:var(--gray)">'+(s.phone||'')+'</small></td>'+
            '<td><span class="badge '+(s.commission_type==='percentage'?'b-purple':'b-blue')+'">'+(s.commission_type==='percentage'?s.commission_value+'%':'$'+s.commission_value)+'</span></td>'+
            '<td style="font-weight:700">'+sDeals.length+'</td>'+
            '<td style="font-weight:700;color:var(--success)">$'+totalRev.toFixed(2)+'</td>'+
            '<td style="font-weight:700;color:#8b5cf6">$'+totalComm.toFixed(2)+'</td>'+
            '<td><span class="badge '+(s.is_active?'b-green':'b-red')+'">'+(s.is_active!==false?'Activo':'Inactivo')+'</span></td>'+
            '<td><div class="actions">'+
                '<button class="act" onclick="editSalesRep(\''+s.id+'\')" title="Editar">âœï¸</button>'+
                '<button class="act danger" onclick="openDelete(\'sales_rep\',\''+s.id+'\',\''+s.name+'\')" title="Eliminar">ğŸ—‘ï¸</button>'+
            '</div></td></tr>';
    }).join('');
    updateSalesKPIs();renderTopSalesReps();
}

function renderDeals(){
    var tb=$('dealsTable');
    var list=getFilteredDeals();
    if(!list.length){tb.innerHTML='<tr><td colspan="8" class="empty">No hay ventas cerradas</td></tr>';return;}
    tb.innerHTML=list.map(function(d){
        var chIcon={visita:'ğŸš¶',llamada:'ğŸ“',facebook:'ğŸ“˜',instagram:'ğŸ“¸',google_ads:'ğŸ”',referido:'ğŸ—£ï¸',website:'ğŸŒ',email_mkt:'ğŸ“§',evento:'ğŸª',otro:'ğŸ“‹'}[d.channel]||'ğŸ“‹';
        var chText={visita:'Visita',llamada:'Llamada',facebook:'Facebook',instagram:'Instagram',google_ads:'Google Ads',referido:'Referido',website:'Website',email_mkt:'Email',evento:'Evento',otro:'Otro'}[d.channel]||d.channel;
        return'<tr>'+
            '<td>'+fmtDate(d.deal_date||d.created_at)+'</td>'+
            '<td><strong>'+(d.rep_name||'â€”')+'</strong></td>'+
            '<td>'+(d.company_name||'â€”')+'</td>'+
            '<td><span class="badge b-blue">'+chIcon+' '+chText+'</span></td>'+
            '<td><span class="badge '+planClass(d.plan)+'">'+(d.plan||'-')+'</span></td>'+
            '<td style="font-weight:700;color:var(--success)">$'+(d.amount||0).toFixed(2)+'</td>'+
            '<td style="font-weight:700;color:#8b5cf6">$'+(d.commission||0).toFixed(2)+'</td>'+
            '<td style="font-size:0.75rem;color:var(--gray)">'+(d.notes||'')+'</td></tr>';
    }).join('');
    // Update filter dropdown
    var sel=$('dealsFilterRep');var current=sel.value;
    sel.innerHTML='<option value="all">Todos los vendedores</option>'+salesReps.map(function(s){return'<option value="'+s.id+'">'+s.name+'</option>'}).join('');
    sel.value=current;
    renderChannelChart();
}

function getFilteredDeals(){
    var rep=$('dealsFilterRep').value;var ch=$('dealsFilterChannel').value;
    return deals.filter(function(d){return(rep==='all'||d.rep_id===rep)&&(ch==='all'||d.channel===ch)});
}
function filterDeals(){renderDeals();}

function updateSalesKPIs(){
    $('svTotal').textContent=salesReps.filter(function(s){return s.is_active!==false}).length;
    $('svDeals').textContent=deals.length;
    $('svRevenue').textContent='$'+deals.reduce(function(s,d){return s+(d.amount||0)},0).toFixed(2);
    $('svComm').textContent='$'+deals.reduce(function(s,d){return s+(d.commission||0)},0).toFixed(2);
}

function renderTopSalesReps(){
    var ranked=salesReps.map(function(s){
        var sDeals=deals.filter(function(d){return d.rep_id===s.id});
        return{name:s.name,deals:sDeals.length,revenue:sDeals.reduce(function(sum,d){return sum+(d.amount||0)},0)};
    }).sort(function(a,b){return b.revenue-a.revenue}).slice(0,5);
    $('topSalesReps').innerHTML=ranked.length?ranked.map(function(r,i){
        var medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
        return'<div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0;border-bottom:1px solid #f3f4f6"><span style="font-size:1.2rem;width:30px;text-align:center">'+(medal||(i+1)+'.')+'</span><div style="flex:1"><strong style="font-size:0.85rem">'+r.name+'</strong><p style="font-size:0.72rem;color:var(--gray)">'+r.deals+' ventas</p></div><span style="font-weight:800;color:var(--success)">$'+r.revenue.toFixed(0)+'</span></div>'
    }).join(''):'<p class="empty">Sin datos</p>';
}

var channelChartInst=null;
function renderChannelChart(){
    var channels={};deals.forEach(function(d){var ch=d.channel||'otro';channels[ch]=(channels[ch]||0)+1;});
    var labels=Object.keys(channels);var data=Object.values(channels);
    var colors=['#3b82f6','#f97316','#22c55e','#8b5cf6','#ef4444','#eab308','#ec4899','#14b8a6','#64748b','#6366f1'];
    if(channelChartInst)channelChartInst.destroy();
    var ctx=$('channelChart');if(!ctx)return;
    channelChartInst=new Chart(ctx,{type:'doughnut',data:{labels:labels.map(function(l){return{visita:'ğŸš¶ Visita',llamada:'ğŸ“ Llamada',facebook:'ğŸ“˜ Facebook',instagram:'ğŸ“¸ Instagram',google_ads:'ğŸ” Google',referido:'ğŸ—£ï¸ Referido',website:'ğŸŒ Website',email_mkt:'ğŸ“§ Email',evento:'ğŸª Evento'}[l]||l}),datasets:[{data:data,backgroundColor:colors.slice(0,data.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11}}}}}});
}

// Sales Rep CRUD
function openAddSalesRep(){editingSalesRepId=null;$('salesRepModalTitle').textContent='â• Nuevo Vendedor';$('srName').value='';$('srEmail').value='';$('srPhone').value='';$('srCommType').value='percentage';$('srCommValue').value='15';$('srZone').value='';$('srNotes').value='';openModal('modalSalesRep');}
function editSalesRep(id){var s=salesReps.find(function(x){return x.id===id});if(!s)return;editingSalesRepId=id;$('salesRepModalTitle').textContent='âœï¸ Editar Vendedor';$('srName').value=s.name;$('srEmail').value=s.email||'';$('srPhone').value=s.phone||'';$('srCommType').value=s.commission_type||'percentage';$('srCommValue').value=s.commission_value||15;$('srZone').value=s.zone||'';$('srNotes').value=s.notes||'';openModal('modalSalesRep');}

async function saveSalesRep(){
    var data={name:$('srName').value.trim(),email:$('srEmail').value.trim(),phone:$('srPhone').value.trim(),commission_type:$('srCommType').value,commission_value:parseFloat($('srCommValue').value)||0,zone:$('srZone').value.trim(),notes:$('srNotes').value,is_active:true};
    if(!data.name){alert('Ingresa el nombre');return;}
    if(editingSalesRepId){await db.from('sales_reps').update(data).eq('id',editingSalesRepId);await logActivity('update','sales_rep',editingSalesRepId,data.name);}
    else{await db.from('sales_reps').insert(data);await logActivity('create','sales_rep',null,data.name);}
    closeModal('modalSalesRep');editingSalesRepId=null;loadSalesReps();
}

// Deals
function openAddDeal(){
    $('dealRep').innerHTML=salesReps.map(function(s){return'<option value="'+s.id+'" data-name="'+s.name+'" data-commtype="'+s.commission_type+'" data-commval="'+s.commission_value+'">'+s.name+'</option>'}).join('');
    $('dealCompany').innerHTML='<option value="">â€” Nuevo cliente â€”</option>'+companies.map(function(c){return'<option value="'+c.id+'" data-name="'+c.name+'">'+c.name+'</option>'}).join('');
    $('dealCampaign').innerHTML='<option value="">â€” Ninguna â€”</option>'+campaigns.map(function(c){return'<option value="'+c.id+'" data-name="'+c.name+'">'+c.name+'</option>'}).join('');
    $('dealDate').value=new Date().toISOString().slice(0,10);
    $('dealChannel').value='visita';$('dealNotes').value='';
    updateDealAmount();updateDealComm();
    $('dealRep').onchange=updateDealComm;
    openModal('modalDeal');
}
function updateDealAmount(){var sel=$('dealPlan');var opt=sel.selectedOptions[0];$('dealAmount').value=opt?opt.dataset.amount:'149.99';updateDealComm();}
function updateDealComm(){var rep=$('dealRep').selectedOptions[0];if(!rep)return;var type=rep.dataset.commtype;var val=parseFloat(rep.dataset.commval)||0;var amount=parseFloat($('dealAmount').value)||0;$('dealComm').value=type==='percentage'?(amount*val/100).toFixed(2):val.toFixed(2);}

async function saveDeal(){
    var repId=$('dealRep').value;var repName=$('dealRep').selectedOptions[0]?.dataset.name||'';
    var compId=$('dealCompany').value;var compName=$('dealCompany').selectedOptions[0]?.dataset.name||'';
    var campId=$('dealCampaign').value;var campName=$('dealCampaign').selectedOptions[0]?.dataset.name||'';
    var data={rep_id:repId,rep_name:repName,company_id:compId||null,company_name:compName,channel:$('dealChannel').value,plan:$('dealPlan').value,amount:parseFloat($('dealAmount').value)||0,commission:parseFloat($('dealComm').value)||0,deal_date:$('dealDate').value,campaign_id:campId||null,campaign_name:campName,notes:$('dealNotes').value};
    if(!data.rep_id){alert('Selecciona vendedor');return;}
    await db.from('sales_deals').insert(data);
    await logActivity('create','deal',null,repName+' â†’ '+(compName||'nuevo')+' $'+data.amount);
    // Update campaign conversions if linked
    if(campId){var camp=campaigns.find(function(c){return c.id===campId});if(camp){await db.from('marketing_campaigns').update({conversions:(camp.conversions||0)+1,revenue_generated:(camp.revenue_generated||0)+data.amount}).eq('id',campId);}}
    closeModal('modalDeal');loadDeals();loadCampaigns();
}

// ==========================================
// MARKETING & ROI
// ==========================================
function renderCampaigns(){
    var tb=$('campaignsTable');if(!campaigns.length){tb.innerHTML='<tr><td colspan="9" class="empty">No hay campaÃ±as</td></tr>';updateMkKPIs();return;}
    tb.innerHTML=campaigns.map(function(c){
        var spent=c.amount_spent||0;var rev=c.revenue_generated||0;
        var roi=spent>0?Math.round((rev-spent)/spent*100):0;
        var roiColor=roi>100?'var(--success)':roi>0?'var(--warning)':'var(--danger)';
        var platIcon={facebook:'ğŸ“˜',instagram:'ğŸ“¸',google_ads:'ğŸ”',tiktok:'ğŸµ',youtube:'â–¶ï¸',linkedin:'ğŸ’¼',seo:'ğŸ”',email:'ğŸ“§',flyers:'ğŸ“„',radio:'ğŸ“»',evento:'ğŸª',referidos:'ğŸ—£ï¸',otro:'ğŸ“‹'}[c.platform]||'ğŸ“‹';
        var stBadge=c.status==='active'?'b-green':c.status==='paused'?'b-yellow':'b-gray';
        return'<tr>'+
            '<td><strong>'+c.name+'</strong><br><small style="color:var(--gray)">'+fmtDate(c.start_date)+' â†’ '+(c.end_date?fmtDate(c.end_date):'â€”')+'</small></td>'+
            '<td><span class="badge b-blue">'+platIcon+' '+(c.platform||'')+'</span></td>'+
            '<td style="font-weight:700;color:var(--danger)">$'+spent.toFixed(2)+'</td>'+
            '<td>'+(c.leads_generated||0)+'</td>'+
            '<td>'+(c.conversions||0)+'</td>'+
            '<td style="font-weight:700;color:var(--success)">$'+rev.toFixed(2)+'</td>'+
            '<td style="font-weight:800;color:'+roiColor+'">'+roi+'%</td>'+
            '<td><span class="badge '+stBadge+'">'+({active:'ğŸŸ¢ Activa',paused:'ğŸŸ¡ Pausada',ended:'âš« Fin'}[c.status]||c.status)+'</span></td>'+
            '<td><div class="actions">'+
                '<button class="act" onclick="editCampaign(\''+c.id+'\')" title="Editar">âœï¸</button>'+
                '<button class="act danger" onclick="openDelete(\'campaign\',\''+c.id+'\',\''+c.name+'\')" title="Eliminar">ğŸ—‘ï¸</button>'+
            '</div></td></tr>';
    }).join('');
    updateMkKPIs();renderROIChart();renderMkRevenueChart();
}

function renderMkExpenses(){
    var tb=$('mkExpensesTable');if(!mkExpenses.length){tb.innerHTML='<tr><td colspan="6" class="empty">No hay gastos</td></tr>';return;}
    tb.innerHTML=mkExpenses.map(function(e){
        return'<tr><td>'+fmtDate(e.expense_date||e.created_at)+'</td><td>'+(e.campaign_name||'â€”')+'</td><td>'+(e.concept||'â€”')+'</td><td style="font-weight:700;color:var(--danger)">$'+(e.amount||0).toFixed(2)+'</td><td>'+(e.platform||'')+'</td><td style="font-size:0.75rem;color:var(--gray)">'+(e.notes||'')+'</td></tr>';
    }).join('');
}

function updateMkKPIs(){
    var active=campaigns.filter(function(c){return c.status==='active'}).length;
    var totalSpent=campaigns.reduce(function(s,c){return s+(c.amount_spent||0)},0)+mkExpenses.reduce(function(s,e){return s+(e.amount||0)},0);
    var totalRev=campaigns.reduce(function(s,c){return s+(c.revenue_generated||0)},0);
    var roi=totalSpent>0?Math.round((totalRev-totalSpent)/totalSpent*100):0;
    var totalLeads=campaigns.reduce(function(s,c){return s+(c.leads_generated||0)},0);
    var totalConv=campaigns.reduce(function(s,c){return s+(c.conversions||0)},0);
    var convRate=totalLeads>0?Math.round(totalConv/totalLeads*100):0;
    $('mkTotal').textContent=active;$('mkSpent').textContent='$'+totalSpent.toFixed(0);
    $('mkRevenue').textContent='$'+totalRev.toFixed(0);$('mkROI').textContent=roi+'%';
    $('mkLeads').textContent=totalLeads;$('mkConv').textContent=convRate+'%';
}

var roiChartInst=null,mkRevChartInst=null;
function renderROIChart(){
    var platforms={};campaigns.forEach(function(c){var p=c.platform||'otro';if(!platforms[p])platforms[p]={spent:0,rev:0};platforms[p].spent+=(c.amount_spent||0);platforms[p].rev+=(c.revenue_generated||0);});
    var labels=Object.keys(platforms);var spentData=labels.map(function(l){return platforms[l].spent});var revData=labels.map(function(l){return platforms[l].rev});
    if(roiChartInst)roiChartInst.destroy();
    var ctx=$('roiChart');if(!ctx)return;
    roiChartInst=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Invertido',data:spentData,backgroundColor:'#ef4444'},{label:'Revenue',data:revData,backgroundColor:'#22c55e'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,ticks:{callback:function(v){return'$'+v}}}}}});
}
function renderMkRevenueChart(){
    var months=[],spent=[],rev=[];
    for(var i=5;i>=0;i--){var d=new Date();d.setMonth(d.getMonth()-i);var m=d.toLocaleString('es',{month:'short'});months.push(m);
        var mSpent=mkExpenses.filter(function(e){var ed=new Date(e.expense_date||e.created_at);return ed.getMonth()===d.getMonth()&&ed.getFullYear()===d.getFullYear()}).reduce(function(s,e){return s+(e.amount||0)},0);
        var mRev=deals.filter(function(dl){var dd=new Date(dl.deal_date||dl.created_at);return dd.getMonth()===d.getMonth()&&dd.getFullYear()===d.getFullYear()&&dl.campaign_id}).reduce(function(s,dl){return s+(dl.amount||0)},0);
        spent.push(mSpent);rev.push(mRev);}
    if(mkRevChartInst)mkRevChartInst.destroy();
    var ctx=$('mkRevenueChart');if(!ctx)return;
    mkRevChartInst=new Chart(ctx,{type:'line',data:{labels:months,datasets:[{label:'Invertido',data:spent,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',fill:true},{label:'Revenue Marketing',data:rev,borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,.1)',fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:function(v){return'$'+v}}}}}});
}

// Campaign CRUD
function openAddCampaign(){editingCampaignId=null;$('campaignModalTitle').textContent='â• Nueva CampaÃ±a';$('campName').value='';$('campPlatform').value='facebook';$('campStatus').value='active';$('campBudget').value='';$('campSpent').value='0';$('campStart').value=new Date().toISOString().slice(0,10);$('campEnd').value='';$('campNotes').value='';openModal('modalCampaign');}
function editCampaign(id){var c=campaigns.find(function(x){return x.id===id});if(!c)return;editingCampaignId=id;$('campaignModalTitle').textContent='âœï¸ Editar CampaÃ±a';$('campName').value=c.name;$('campPlatform').value=c.platform||'facebook';$('campStatus').value=c.status||'active';$('campBudget').value=c.budget||'';$('campSpent').value=c.amount_spent||0;$('campStart').value=c.start_date||'';$('campEnd').value=c.end_date||'';$('campNotes').value=c.notes||'';openModal('modalCampaign');}

async function saveCampaign(){
    var data={name:$('campName').value.trim(),platform:$('campPlatform').value,status:$('campStatus').value,budget:parseFloat($('campBudget').value)||0,amount_spent:parseFloat($('campSpent').value)||0,start_date:$('campStart').value||null,end_date:$('campEnd').value||null,notes:$('campNotes').value};
    if(!data.name){alert('Nombre requerido');return;}
    if(editingCampaignId){await db.from('marketing_campaigns').update(data).eq('id',editingCampaignId);await logActivity('update','campaign',editingCampaignId,data.name);}
    else{data.leads_generated=0;data.conversions=0;data.revenue_generated=0;await db.from('marketing_campaigns').insert(data);await logActivity('create','campaign',null,data.name);}
    closeModal('modalCampaign');editingCampaignId=null;loadCampaigns();
}

// Marketing Expenses
function openAddMkExpense(){$('mkeCampaign').innerHTML=campaigns.map(function(c){return'<option value="'+c.id+'" data-name="'+c.name+'">'+c.name+'</option>'}).join('');$('mkeAmount').value='';$('mkeDate').value=new Date().toISOString().slice(0,10);$('mkeConcept').value='';$('mkeNotes').value='';openModal('modalMkExpense');}

async function saveMkExpense(){
    var campId=$('mkeCampaign').value;var campName=$('mkeCampaign').selectedOptions[0]?.dataset.name||'';
    var data={campaign_id:campId,campaign_name:campName,amount:parseFloat($('mkeAmount').value)||0,expense_date:$('mkeDate').value,concept:$('mkeConcept').value,platform:$('mkePlatform').value,notes:$('mkeNotes').value};
    if(!data.amount){alert('Monto requerido');return;}
    await db.from('marketing_expenses').insert(data);
    // Update campaign spent
    if(campId){var camp=campaigns.find(function(c){return c.id===campId});if(camp){await db.from('marketing_campaigns').update({amount_spent:(camp.amount_spent||0)+data.amount}).eq('id',campId);}}
    await logActivity('create','mk_expense',null,campName+' $'+data.amount);
    closeModal('modalMkExpense');loadMkExpenses();loadCampaigns();
}

// ==========================================
// DEMO & ONBOARDING TOOLS
// ==========================================
var DEMO_URL='https://acvolttech.github.io/trademaster-crm/?demo=true';
var DEMO_QR_URL='https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl='+encodeURIComponent(DEMO_URL)+'&choe=UTF-8&chld=H|2';
var DEMO_QR_HD='https://chart.googleapis.com/chart?chs=600x600&cht=qr&chl='+encodeURIComponent(DEMO_URL)+'&choe=UTF-8&chld=H|2';

function initDemoTools(){
    var img=$('demoQRImg');if(img)img.src=DEMO_QR_URL;
    document.querySelectorAll('.demoQRMini').forEach(function(m){m.src=DEMO_QR_URL;});
}

function copyDemoLink(){
    navigator.clipboard.writeText(DEMO_URL).then(function(){alert('âœ… Link copiado: '+DEMO_URL);}).catch(function(){
        var t=document.createElement('textarea');t.value=DEMO_URL;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);alert('âœ… Link copiado');
    });
}

function shareDemoWhatsApp(){
    var msg='ğŸ¬ Â¡Mira este sistema que maneja TODO tu negocio de HVAC en un solo lugar!\n\nDale play y nuestra AI Brenda te muestra cada funciÃ³n con voz en vivo:\nâœ… Clientes y trabajos\nâœ… Despacho GPS de tÃ©cnicos\nâœ… Facturas y cobros\nâœ… NÃ³mina y reportes\n\nğŸ‘‰ '+DEMO_URL+'\n\nÂ¡Es GRATIS para empezar! ğŸš€';
    window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}

function shareDemoSMS(){
    var msg='ğŸ¬ Mira este CRM para HVAC â€” nuestra AI te da un tour completo con voz! '+DEMO_URL+' Â¡Gratis para empezar!';
    window.open('sms:?&body='+encodeURIComponent(msg));
}

function shareDemoEmail(){
    var subj='ğŸ¬ Demo en Vivo â€” Trade Master CRM para tu negocio';
    var body='Â¡Hola!\n\nTe invito a ver una demostraciÃ³n en vivo de Trade Master CRM, el sistema #1 para negocios de HVAC y contratistas.\n\nNuestra asistente AI Brenda te guiarÃ¡ por cada funciÃ³n con narraciÃ³n de voz:\n\nâœ… Manejo de clientes y trabajos\nâœ… Despacho GPS de tÃ©cnicos en tiempo real\nâœ… FacturaciÃ³n y cobros instantÃ¡neos\nâœ… NÃ³mina y reportes financieros\nâœ… Marketing y mÃ¡s\n\nğŸ‘‰ Ver Demo: '+DEMO_URL+'\n\nÂ¡Es GRATIS para empezar con hasta 10 clientes!\n\nSaludos,\nTrade Master CRM Team';
    window.open('mailto:?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body));
}

function downloadDemoQR(){var a=document.createElement('a');a.href=DEMO_QR_URL;a.download='TradeMaster-Demo-QR.png';a.click();}
function downloadDemoQRHD(){var a=document.createElement('a');a.href=DEMO_QR_HD;a.download='TradeMaster-Demo-QR-HD.png';a.click();}

function printBusinessCards(){
    var qr=DEMO_QR_URL;
    var w=window.open('','_blank','width=800,height=1100');
    w.document.write('<!DOCTYPE html><html><head><title>Trade Master - Business Cards</title><style>'+
        '@page{margin:0.5in}body{font-family:Arial,sans-serif;margin:0;padding:0}'+
        '.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0.5in}'+
        '.card{width:3.35in;height:2in;border:1px solid #ccc;border-radius:10px;overflow:hidden;page-break-inside:avoid}'+
        '.card-top{background:linear-gradient(135deg,#1e3a5f,#2d5a8e);padding:10px 12px;color:#fff;display:flex;justify-content:space-between;align-items:center}'+
        '.card-bot{padding:8px 12px;background:#fff;text-align:center}'+
        '.logo{font-size:12px;font-weight:900}.tag{font-size:7px;opacity:.7;margin-top:2px}'+
        '.feats{font-size:8px;opacity:.85;margin-top:8px;line-height:1.5}'+
        '.qr{width:55px;height:55px;border-radius:6px;background:#fff;padding:2px}'+
        '.qr img{width:100%;height:100%;border-radius:4px}'+
        '.cta{font-size:10px;font-weight:800;color:#f97316}.sub{font-size:7px;color:#666;margin-top:3px}'+
    '</style></head><body><div class="grid">');
    for(var i=0;i<8;i++){
        w.document.write('<div class="card"><div class="card-top"><div><div class="logo">ğŸ—ï¸ TRADE MASTER CRM</div><div class="tag">#1 HVAC & Contractor Management</div><div class="feats">âœ… Clientes & Trabajos &nbsp;&nbsp;âœ… GPS & Despacho<br>âœ… Facturas & Cobros &nbsp;&nbsp;âœ… NÃ³mina & Reportes</div></div><div class="qr"><img src="'+qr+'" alt="QR"></div></div><div class="card-bot"><div class="cta">ğŸ“± ESCANEA PARA VER DEMO EN VIVO</div><div class="sub">trademaster-crm.com â€¢ Gratis para 10 clientes</div></div></div>');
    }
    w.document.write('</div></body></html>');w.document.close();setTimeout(function(){w.print();},700);
}

function printFlyers(){
    var qr=DEMO_QR_HD;
    var w=window.open('','_blank','width=800,height=1100');
    w.document.write('<!DOCTYPE html><html><head><title>Trade Master - Flyers</title><style>'+
        '@page{margin:0.25in}body{font-family:Arial,sans-serif;margin:0;padding:0.25in}'+
        '.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}'+
        '.flyer{border:2px solid #e5e7eb;border-radius:14px;overflow:hidden;page-break-inside:avoid}'+
        '.fly-top{background:linear-gradient(135deg,#f97316,#ea580c);padding:20px;color:#fff;text-align:center}'+
        '.fly-title{font-size:22px;font-weight:900}.fly-sub{font-size:12px;margin-top:4px;opacity:.9}'+
        '.fly-mid{padding:20px;background:#fff;text-align:center}'+
        '.fly-qr{width:150px;height:150px;margin:0 auto 12px}'+
        '.fly-qr img{width:100%;height:100%;border-radius:8px}'+
        '.fly-cta{font-size:16px;font-weight:900;color:#1e293b}.fly-info{font-size:10px;color:#6b7280;margin-top:6px}'+
        '.fly-feats{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px;font-size:10px;text-align:left}'+
        '.fly-feat{background:#f0fdf4;padding:6px 8px;border-radius:6px;color:#166534}'+
    '</style></head><body><div class="grid">');
    for(var i=0;i<4;i++){
        w.document.write('<div class="flyer"><div class="fly-top"><div class="fly-title">Â¿TODAVÃA USAS PAPEL? ğŸ“‹</div><div class="fly-sub">Maneja TODO tu negocio desde el celular ğŸ“±</div></div><div class="fly-mid"><div class="fly-qr"><img src="'+qr+'" alt="QR"></div><div class="fly-cta">ESCANEA â†’ VE EL DEMO â†’ REGÃSTRATE</div><div class="fly-info">Trade Master CRM â€” El Sistema #1 para Contratistas</div><div class="fly-feats"><div class="fly-feat">âœ… Clientes & CRM</div><div class="fly-feat">âœ… GPS TÃ©cnicos</div><div class="fly-feat">âœ… Facturas & Cobros</div><div class="fly-feat">âœ… NÃ³mina & Reportes</div><div class="fly-feat">âœ… Marketing</div><div class="fly-feat">âœ… App MÃ³vil</div></div><div style="margin-top:12px;font-size:9px;color:#9ca3af">Gratis para empezar â€¢ trademaster-crm.com</div></div></div>');
    }
    w.document.write('</div></body></html>');w.document.close();setTimeout(function(){w.print();},700);
}

var emailTemplates={
    cold:{
        subject:'Â¿TodavÃ­a manejas tu negocio con papel? ğŸ“‹ Mira esto',
        body:'Â¡Hola!\n\nSoy [TU NOMBRE] de Trade Master CRM.\n\nÂ¿SabÃ­as que el 73% de los contratistas pierden dinero por no tener un sistema organizado? Clientes olvidados, facturas sin cobrar, tÃ©cnicos sin direcciÃ³n...\n\nTrade Master CRM resuelve TODO eso en UNA sola plataforma:\n\nâœ… Maneja clientes, trabajos y estimados\nâœ… Despacha tÃ©cnicos con GPS en tiempo real\nâœ… Crea facturas profesionales y cobra al instante\nâœ… NÃ³mina, reportes financieros y marketing\nâœ… App mÃ³vil para tu equipo\n\nğŸ¬ VE LA DEMO EN VIVO (nuestra AI te muestra todo en 10 min):\nğŸ‘‰ DEMO_URL\n\nEs GRATIS para empezar con hasta 10 clientes.\n\nÂ¿Tienes 10 minutos esta semana para una llamada rÃ¡pida?\n\nSaludos,\n[TU NOMBRE]\nTrade Master CRM\nğŸ“ [TU TELÃ‰FONO]'
    },
    followup:{
        subject:'Seguimiento â€” Demo de Trade Master CRM ğŸ¬',
        body:'Â¡Hola de nuevo!\n\nTe escribÃ­ la semana pasada sobre Trade Master CRM. SÃ© que estÃ¡s ocupado manejando tu negocio â€” Â¡por eso creamos este sistema!\n\nSolo querÃ­a recordarte que puedes ver una demo completa con narraciÃ³n AI en menos de 10 minutos:\n\nğŸ¬ DEMO_URL\n\nNuestra asistente Brenda te muestra paso a paso cÃ³mo:\nâ€¢ Agregar un cliente en 30 segundos\nâ€¢ Despachar un tÃ©cnico desde el mapa\nâ€¢ Crear una factura y cobrar al instante\nâ€¢ Y mucho mÃ¡s...\n\nSin compromiso, sin tarjeta de crÃ©dito. Gratis para empezar.\n\nÂ¿Te late agendar 15 minutos esta semana?\n\nSaludos,\n[TU NOMBRE]'
    },
    referral:{
        subject:'ğŸ’° Gana $50 por cada negocio que refieras a Trade Master CRM',
        body:'Â¡Hola!\n\nÂ¿Conoces a otros dueÃ±os de negocios de HVAC, plomerÃ­a o electricidad?\n\nTrade Master CRM tiene un Programa de Embajadores donde puedes GANAR $50 por cada negocio que refieras y se active.\n\nAsÃ­ funciona:\n1ï¸âƒ£ Comparte el link del demo\n2ï¸âƒ£ Ellos ven la demo y se registran\n3ï¸âƒ£ Cuando activan su plan, tÃº ganas $50\n4ï¸âƒ£ Sin lÃ­mite â€” mientras mÃ¡s refieras, mÃ¡s ganas\n\nğŸ¬ Link del Demo para compartir:\nğŸ‘‰ DEMO_URL\n\nÂ¿Interesado? Responde este email y te damos tu cÃ³digo de embajador.\n\nSaludos,\nTrade Master CRM Team'
    },
    construction:{
        subject:'Para empresas de construcciÃ³n: el CRM que manejan los pros ğŸ—ï¸',
        body:'Â¡Hola!\n\nSi manejas una empresa de construcciÃ³n, HVAC, plomerÃ­a o electricidad, esto es para ti.\n\nTrade Master CRM es el sistema TODO-EN-UNO diseÃ±ado especÃ­ficamente para contratistas:\n\nğŸ—ï¸ PARA TU OFICINA:\nâ€¢ CRM completo con clientes y prospectos\nâ€¢ Estimados profesionales con firma electrÃ³nica\nâ€¢ FacturaciÃ³n y cobros automÃ¡ticos\nâ€¢ Reportes financieros en tiempo real\n\nğŸšš PARA TU EQUIPO EN CAMPO:\nâ€¢ Despacho de tÃ©cnicos con mapa GPS en vivo\nâ€¢ App mÃ³vil para tu equipo\nâ€¢ Check-in/out con geolocalizaciÃ³n\nâ€¢ Fotos antes/despuÃ©s de cada trabajo\n\nğŸ’° PARA TU BOLSILLO:\nâ€¢ Cobra mÃ¡s rÃ¡pido con pagos por link\nâ€¢ Reduce trabajo administrativo 80%\nâ€¢ Nunca olvides un follow-up\nâ€¢ Gratis para empezar\n\nğŸ¬ VE LA DEMO COMPLETA (10 minutos):\nğŸ‘‰ DEMO_URL\n\nMÃ¡s de [X] contratistas ya usan Trade Master. Â¿CuÃ¡ndo empiezas tÃº?\n\nSaludos,\n[TU NOMBRE]\nTrade Master CRM'
    }
};

var currentEmailTemplate='';

function showEmailTemplate(type){
    var tmpl=emailTemplates[type];if(!tmpl)return;
    currentEmailTemplate=type;
    var body=tmpl.body.replace(/DEMO_URL/g,DEMO_URL);
    var subj=tmpl.subject;
    var labels={cold:'ğŸ¥¶ Cold Outreach',followup:'ğŸ”„ Follow Up',referral:'ğŸ¤ Para Referidos',construction:'ğŸ—ï¸ ConstrucciÃ³n'};
    var el=$('emailTemplatePreview');
    el.innerHTML='<div style="margin-bottom:12px"><span style="background:#f97316;color:#fff;padding:3px 10px;border-radius:8px;font-size:0.72rem;font-weight:700">'+labels[type]+'</span></div>'+
        '<div style="margin-bottom:8px"><strong style="font-size:0.75rem;color:var(--gray)">Asunto:</strong> <span style="font-size:0.85rem;font-weight:600">'+subj+'</span></div>'+
        '<div style="border-top:1px solid #e5e7eb;padding-top:12px;white-space:pre-wrap;font-size:0.8rem;line-height:1.6;color:#374151">'+body.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</div>';
}

function copyEmailTemplate(){
    if(!currentEmailTemplate){alert('Selecciona un template primero');return;}
    var tmpl=emailTemplates[currentEmailTemplate];
    var text='Asunto: '+tmpl.subject+'\n\n'+tmpl.body.replace(/DEMO_URL/g,DEMO_URL);
    navigator.clipboard.writeText(text).then(function(){alert('âœ… Email copiado al portapapeles');}).catch(function(){alert('Error copiando');});
}

function openEmailTemplate(){
    if(!currentEmailTemplate){alert('Selecciona un template primero');return;}
    var tmpl=emailTemplates[currentEmailTemplate];
    var body=tmpl.body.replace(/DEMO_URL/g,DEMO_URL);
    window.open('mailto:?subject='+encodeURIComponent(tmpl.subject)+'&body='+encodeURIComponent(body));
}

function copySalesScript(){
    var script='ğŸ“ SCRIPT DE VENTA â€” TRADE MASTER CRM\n'+
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+
        '1ï¸âƒ£ APERTURA:\n'+
        '"Â¡Hola [NOMBRE]! Soy [TU NOMBRE] de Trade Master CRM. Te llamo porque trabajamos con empresas de HVAC como la tuya y querÃ­a preguntarte â€” Â¿cÃ³mo manejas tus clientes y trabajos actualmente?"\n\n'+
        '2ï¸âƒ£ DOLOR:\n'+
        '"Â¿Alguna vez has perdido un cliente porque se te olvidÃ³ darle seguimiento? Â¿O un tÃ©cnico llegÃ³ a la direcciÃ³n equivocada? Â¿Facturas sin cobrar?"\n\n'+
        '3ï¸âƒ£ SOLUCIÃ“N:\n'+
        '"Trade Master CRM resuelve exactamente eso. Es UN solo sistema donde manejas clientes, despachas tÃ©cnicos con GPS, creas facturas y cobras â€” todo desde tu celular."\n\n'+
        '4ï¸âƒ£ DEMO:\n'+
        '"Te voy a mandar un link donde nuestra AI Brenda te da un tour de 10 minutos. Vas a ver exactamente cÃ³mo funciona con datos reales. Â¿A quÃ© nÃºmero te lo mando por WhatsApp?"\n\n'+
        '5ï¸âƒ£ CIERRE:\n'+
        '"Es GRATIS para empezar con 10 clientes. No necesitas tarjeta. Â¿Lo probamos esta semana?"\n\n'+
        'ğŸ“± Link del Demo: '+DEMO_URL;
    navigator.clipboard.writeText(script).then(function(){alert('âœ… Script de venta copiado');}).catch(function(){alert('Error');});
}

// ==========================================
// PROGRAMA EMBAJADORES (ADMIN)
// ==========================================
var ambReferrals=[],ambPayouts=[];

async function loadAmbassadorAdmin(){
    try{var r=await db.from('ambassador_referrals').select('*').order('created_at',{ascending:false});ambReferrals=r.data||[];}catch(e){ambReferrals=[];}
    try{var r2=await db.from('ambassador_payouts').select('*').order('created_at',{ascending:false});ambPayouts=r2.data||[];}catch(e){ambPayouts=[];}
    renderAmbAdmin();
}

function renderAmbAdmin(){
    // KPIs
    var totalRefs=ambReferrals.length;
    var converted=ambReferrals.filter(function(r){return r.status==='converted'||r.status==='active'}).length;
    var uniqueAmb=[...new Set(ambReferrals.map(function(r){return r.referrer_company_id}))].length;
    var totalPaid=ambPayouts.filter(function(p){return p.status==='paid'}).reduce(function(s,p){return s+(p.amount||0)},0);
    var totalPending=ambPayouts.filter(function(p){return p.status==='pending'}).reduce(function(s,p){return s+(p.amount||0)},0);
    var monthlyRecurring=ambReferrals.filter(function(r){return r.status==='active'}).reduce(function(s,r){return s+(r.plan==='enterprise'?50:25)},0);
    
    $('ambTotalRefs').textContent=totalRefs;
    $('ambTotalConverted').textContent=converted;
    $('ambActiveAmbassadors').textContent=uniqueAmb;
    $('ambTotalPaid').textContent='$'+totalPaid.toFixed(0);
    $('ambTotalPending').textContent='$'+totalPending.toFixed(0);
    $('ambMonthlyRecurring').textContent='$'+monthlyRecurring.toFixed(0)+'/mes';
    
    // Referrals table
    renderAmbRefsTable();
    
    // Payouts table
    renderAmbPayoutsTable();
    
    // Top ambassadors
    renderTopAmbassadors();
}

function renderAmbRefsTable(){
    var filter=$('ambFilterStatus').value;
    var list=filter==='all'?ambReferrals:ambReferrals.filter(function(r){return r.status===filter});
    var tb=$('ambRefsTable');
    if(!list.length){tb.innerHTML='<tr><td colspan="7" class="empty">No hay referidos</td></tr>';return;}
    tb.innerHTML=list.map(function(r){
        var stBadge={pending:'<span class="badge b-yellow">â³ Pendiente</span>',registered:'<span class="badge b-blue">ğŸ“ Registrado</span>',converted:'<span class="badge b-green">âœ… Convertido</span>',active:'<span class="badge b-green">ğŸŸ¢ Activo</span>',cancelled:'<span class="badge b-red">âŒ Cancelado</span>'}[r.status]||r.status;
        var comm=(r.status==='active'||r.status==='converted')?(r.plan==='enterprise'?'$50':'$25'):'â€”';
        var commStyle=comm!=='â€”'?'font-weight:700;color:var(--success)':'color:var(--gray)';
        return'<tr>'+
            '<td><strong>'+(r.referrer_name||'â€”')+'</strong><br><small style="color:var(--gray)">'+(r.referrer_code||'')+'</small></td>'+
            '<td><strong>'+(r.referred_name||'Pendiente')+'</strong><br><small style="color:var(--gray)">'+(r.referred_email||'')+'</small></td>'+
            '<td>'+fmtDate(r.created_at)+'</td>'+
            '<td><span class="badge '+(r.plan==='enterprise'?'b-purple':'b-blue')+'">'+(r.plan||'Trial')+'</span></td>'+
            '<td>'+stBadge+'</td>'+
            '<td style="'+commStyle+'">'+comm+'</td>'+
            '<td><div class="actions">'+
                '<select onchange="updateAmbStatus(\''+r.id+'\',this.value)" style="padding:2px 6px;font-size:0.7rem;border:1px solid #e5e7eb;border-radius:6px">'+
                    '<option value="" disabled selected>Cambiar</option>'+
                    '<option value="pending">â³ Pendiente</option>'+
                    '<option value="registered">ğŸ“ Registrado</option>'+
                    '<option value="converted">âœ… Convertido</option>'+
                    '<option value="active">ğŸŸ¢ Activo</option>'+
                    '<option value="cancelled">âŒ Cancelado</option>'+
                '</select>'+
            '</div></td></tr>';
    }).join('');
}

function filterAmbRefs(){renderAmbRefsTable();}

function renderAmbPayoutsTable(){
    var tb=$('ambPayoutsTable');
    if(!ambPayouts.length){tb.innerHTML='<tr><td colspan="6" class="empty">No hay pagos</td></tr>';return;}
    tb.innerHTML=ambPayouts.map(function(p){
        var stBadge=p.status==='paid'?'<span class="badge b-green">âœ… Pagado</span>':'<span class="badge b-yellow">â³ Pendiente</span>';
        var method={transfer:'ğŸ¦ Transferencia',zelle:'âš¡ Zelle',venmo:'ğŸ’œ Venmo',paypal:'ğŸ’° PayPal',check:'ğŸ“‹ Cheque',credit:'ğŸ« CrÃ©dito CRM',cash:'ğŸ’µ Efectivo'}[p.method]||p.method||'â€”';
        return'<tr>'+
            '<td><strong>'+(p.company_name||'â€”')+'</strong></td>'+
            '<td style="font-weight:700;color:var(--success)">$'+(p.amount||0).toFixed(2)+'</td>'+
            '<td>'+fmtDate(p.payout_date||p.created_at)+'</td>'+
            '<td>'+method+'</td>'+
            '<td>'+stBadge+'</td>'+
            '<td style="font-size:0.75rem;color:var(--gray)">'+(p.notes||'')+'</td></tr>';
    }).join('');
}

function renderTopAmbassadors(){
    var ambassadors={};
    ambReferrals.forEach(function(r){
        var key=r.referrer_company_id||'unknown';
        if(!ambassadors[key])ambassadors[key]={name:r.referrer_name||'â€”',code:r.referrer_code||'',refs:0,active:0,earned:0};
        ambassadors[key].refs++;
        if(r.status==='active'||r.status==='converted')ambassadors[key].active++;
    });
    ambPayouts.filter(function(p){return p.status==='paid'}).forEach(function(p){
        var key=p.company_id||'unknown';
        if(ambassadors[key])ambassadors[key].earned+=(p.amount||0);
    });
    var ranked=Object.values(ambassadors).sort(function(a,b){return b.active-a.active||b.refs-a.refs}).slice(0,10);
    var el=$('topAmbassadors');
    if(!ranked.length){el.innerHTML='<p class="empty">Sin embajadores aÃºn</p>';return;}
    el.innerHTML=ranked.map(function(a,i){
        var medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
        return'<div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0;border-bottom:1px solid #f3f4f6"><span style="font-size:1.2rem;width:30px;text-align:center">'+(medal||(i+1)+'.')+'</span><div style="flex:1"><strong style="font-size:0.85rem">'+a.name+'</strong><p style="font-size:0.72rem;color:var(--gray)">CÃ³digo: '+a.code+' â€¢ '+a.refs+' referidos â€¢ '+a.active+' activos</p></div><span style="font-weight:800;color:var(--success)">$'+a.earned.toFixed(0)+'</span></div>';
    }).join('');
}

async function updateAmbStatus(refId,newStatus){
    if(!newStatus)return;
    await db.from('ambassador_referrals').update({status:newStatus}).eq('id',refId);
    await logActivity('update','ambassador_referral',refId,'Status â†’ '+newStatus);
    loadAmbassadorAdmin();
}

function openAddReferral(){
    var d=document.createElement('div');d.className='modal-bg show';d.id='modalAddRef';
    d.innerHTML='<div class="modal" style="max-width:550px"><div class="modal-head"><h3>â• Referido Manual</h3><button class="modal-close" onclick="document.getElementById(\'modalAddRef\').remove()">Ã—</button></div><div class="modal-body">'+
        '<div class="form-group"><label>Empresa que Refiere (Embajador)</label><select id="refAmbassador">'+companies.map(function(c){return'<option value="'+c.id+'" data-name="'+c.name+'" data-code="'+(c.ambassador_code||c.company_number||'')+'">'+c.name+' ('+(c.ambassador_code||c.company_number||'')+')</option>'}).join('')+'</select></div>'+
        '<div class="form-group"><label>Nombre del Negocio Referido</label><input type="text" id="refName" placeholder="HVAC Pro LLC"></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>Email</label><input type="email" id="refEmail" placeholder="info@hvacpro.com"></div><div class="form-group"><label>TelÃ©fono</label><input type="text" id="refPhone"></div></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>Plan</label><select id="refPlan"><option value="trial">Trial</option><option value="profesional">Profesional ($149.99)</option><option value="enterprise">Enterprise ($299)</option></select></div><div class="form-group"><label>Status</label><select id="refStatus"><option value="pending">â³ Pendiente</option><option value="registered">ğŸ“ Registrado</option><option value="converted">âœ… Convertido</option><option value="active">ğŸŸ¢ Activo</option></select></div></div>'+
        '<div class="form-group"><label>Notas</label><textarea id="refNotes" rows="2"></textarea></div>'+
    '</div><div class="modal-foot"><button class="btn-sm btn-ghost" onclick="document.getElementById(\'modalAddRef\').remove()">Cancelar</button><button class="btn-sm btn-success" onclick="saveAddReferral()">ğŸ’¾ Guardar</button></div></div>';
    document.body.appendChild(d);
}

async function saveAddReferral(){
    var sel=$('refAmbassador').selectedOptions[0];
    var data={referrer_company_id:$('refAmbassador').value,referrer_name:sel?sel.dataset.name:'',referrer_code:sel?sel.dataset.code:'',referred_name:$('refName').value.trim(),referred_email:$('refEmail').value.trim(),referred_phone:$('refPhone').value.trim(),plan:$('refPlan').value,status:$('refStatus').value,notes:$('refNotes').value};
    if(!data.referred_name){alert('Nombre requerido');return;}
    await db.from('ambassador_referrals').insert(data);
    await logActivity('create','ambassador_referral',null,data.referrer_name+' â†’ '+data.referred_name);
    document.getElementById('modalAddRef').remove();loadAmbassadorAdmin();
}

function openPayAmbassador(){
    // Get ambassadors who have active referrals
    var ambs={};ambReferrals.filter(function(r){return r.status==='active'||r.status==='converted'}).forEach(function(r){
        var key=r.referrer_company_id;if(!ambs[key])ambs[key]={id:key,name:r.referrer_name,refs:0,monthly:0};ambs[key].refs++;ambs[key].monthly+=(r.plan==='enterprise'?50:25);
    });
    var ambList=Object.values(ambs);
    var d=document.createElement('div');d.className='modal-bg show';d.id='modalPayAmb';
    d.innerHTML='<div class="modal" style="max-width:500px"><div class="modal-head"><h3>ğŸ’µ Pagar ComisiÃ³n Embajador</h3><button class="modal-close" onclick="document.getElementById(\'modalPayAmb\').remove()">Ã—</button></div><div class="modal-body">'+
        '<div class="form-group"><label>Embajador</label><select id="payAmbSel" onchange="updatePayAmbAmount()">'+ambList.map(function(a){return'<option value="'+a.id+'" data-name="'+a.name+'" data-monthly="'+a.monthly+'">'+a.name+' ('+a.refs+' activos = $'+a.monthly+'/mes)</option>'}).join('')+'</select></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>Monto ($)</label><input type="number" id="payAmbAmount" step="0.01"></div><div class="form-group"><label>Fecha</label><input type="date" id="payAmbDate" value="'+new Date().toISOString().slice(0,10)+'"></div></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>MÃ©todo</label><select id="payAmbMethod"><option value="zelle">âš¡ Zelle</option><option value="transfer">ğŸ¦ Transferencia</option><option value="venmo">ğŸ’œ Venmo</option><option value="paypal">ğŸ’° PayPal</option><option value="check">ğŸ“‹ Cheque</option><option value="credit">ğŸ« CrÃ©dito CRM</option><option value="cash">ğŸ’µ Efectivo</option></select></div><div class="form-group"><label>Status</label><select id="payAmbStatus"><option value="paid">âœ… Pagado</option><option value="pending">â³ Pendiente</option></select></div></div>'+
        '<div class="form-group"><label>Notas</label><textarea id="payAmbNotes" rows="2" placeholder="Pago mensual por referidos activos..."></textarea></div>'+
    '</div><div class="modal-foot"><button class="btn-sm btn-ghost" onclick="document.getElementById(\'modalPayAmb\').remove()">Cancelar</button><button class="btn-sm btn-success" onclick="savePayAmbassador()">ğŸ’µ Pagar</button></div></div>';
    document.body.appendChild(d);
    setTimeout(updatePayAmbAmount,100);
}

function updatePayAmbAmount(){var sel=$('payAmbSel');if(!sel)return;var opt=sel.selectedOptions[0];if(opt)$('payAmbAmount').value=opt.dataset.monthly||0;}

async function savePayAmbassador(){
    var sel=$('payAmbSel').selectedOptions[0];
    var data={company_id:$('payAmbSel').value,company_name:sel?sel.dataset.name:'',amount:parseFloat($('payAmbAmount').value)||0,payout_date:$('payAmbDate').value,method:$('payAmbMethod').value,status:$('payAmbStatus').value,notes:$('payAmbNotes').value};
    if(!data.amount){alert('Monto requerido');return;}
    await db.from('ambassador_payouts').insert(data);
    await logActivity('create','ambassador_payout',null,data.company_name+' $'+data.amount.toFixed(2));
    document.getElementById('modalPayAmb').remove();loadAmbassadorAdmin();alert('âœ… Pago registrado');
}

// ==========================================
// CHECK IN / CHECK OUT
// ==========================================
var checkins=[],payrollData=[];

async function loadTodayCheckins(){
    var today=new Date().toISOString().slice(0,10);
    try{var r=await db.from('admin_checkins').select('*').eq('check_date',today);checkins=r.data||[];}catch(e){checkins=[];}
}

async function loadCheckins(){
    var date=$('checkinDateFilter').value||new Date().toISOString().slice(0,10);
    try{var r=await db.from('admin_checkins').select('*').eq('check_date',date).order('check_in',{ascending:true});var list=r.data||[];}catch(e){var list=[];}
    var tb=$('checkinsTable');
    if(!list.length){tb.innerHTML='<tr><td colspan="7" class="empty">No hay registros para esta fecha</td></tr>';return;}
    tb.innerHTML=list.map(function(c){
        var hrs=c.hours_worked?c.hours_worked.toFixed(2):'â€”';
        var isIn=c.check_in&&!c.check_out;
        return'<tr>'+
            '<td><strong>'+c.user_name+'</strong></td>'+
            '<td><span class="badge '+roleClass(c.user_role||'support')+'">'+getRoleName(c.user_role)+'</span></td>'+
            '<td style="font-weight:600;color:var(--success)">'+(c.check_in?fmtTime(c.check_in):'â€”')+'</td>'+
            '<td style="font-weight:600;color:var(--danger)">'+(c.check_out?fmtTime(c.check_out):(isIn?'<span class="badge b-green">ğŸŸ¢ Trabajando</span>':'â€”'))+'</td>'+
            '<td style="font-weight:700">'+hrs+'</td>'+
            '<td>'+(c.check_out?'<span class="badge b-gray">Completado</span>':isIn?'<span class="badge b-green">Activo</span>':'<span class="badge b-red">Incompleto</span>')+'</td>'+
            '<td style="font-size:0.75rem;color:var(--gray)">'+(c.notes||'')+'</td></tr>';
    }).join('');
}

async function doCheckIn(userId,userName){
    var today=new Date().toISOString().slice(0,10);
    var existing=checkins.find(function(c){return c.user_id===userId&&c.check_date===today});
    if(existing&&existing.check_in&&!existing.check_out){alert(userName+' ya hizo check-in');return;}
    if(existing&&existing.check_out){alert(userName+' ya completÃ³ su turno hoy');return;}
    var u=adminUsers.find(function(x){return x.id===userId});
    await db.from('admin_checkins').insert({user_id:userId,user_name:userName,user_role:u?u.role:'',check_date:today,check_in:new Date().toISOString()});
    await logActivity('create','checkin',userId,userName+' check-in');
    await loadTodayCheckins();renderAdmins();
}

async function doCheckOut(userId){
    var today=new Date().toISOString().slice(0,10);
    var rec=checkins.find(function(c){return c.user_id===userId&&c.check_date===today&&c.check_in&&!c.check_out});
    if(!rec){alert('No hay check-in activo');return;}
    var now=new Date();var inTime=new Date(rec.check_in);
    var hours=(now-inTime)/3600000;
    await db.from('admin_checkins').update({check_out:now.toISOString(),hours_worked:Math.round(hours*100)/100}).eq('id',rec.id);
    var u=adminUsers.find(function(x){return x.id===userId});
    await logActivity('update','checkout',userId,(u?u.name:'?')+' check-out ('+hours.toFixed(1)+'h)');
    await loadTodayCheckins();renderAdmins();
}

function exportCheckins(){
    var date=$('checkinDateFilter').value||new Date().toISOString().slice(0,10);
    var csv='Empleado,Rol,Check In,Check Out,Horas,Fecha\n';
    var rows=document.querySelectorAll('#checkinsTable tr');
    rows.forEach(function(r){var cells=r.querySelectorAll('td');if(cells.length>1)csv+='"'+cells[0].textContent+'","'+cells[1].textContent+'","'+cells[2].textContent+'","'+cells[3].textContent+'","'+cells[4].textContent+'","'+date+'"\n';});
    var a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='checkins_'+date+'.csv';a.click();
}

// ==========================================
// PAYROLL (NÃ“MINA)
// ==========================================
async function loadPayroll(){
    var sel=$('payrollMonth');
    if(!sel.options.length){for(var i=0;i<6;i++){var d=new Date();d.setMonth(d.getMonth()-i);sel.innerHTML+='<option value="'+d.toISOString().slice(0,7)+'">'+d.toLocaleString('es',{month:'long',year:'numeric'})+'</option>';}}
    var month=sel.value||new Date().toISOString().slice(0,7);
    var startDate=month+'-01';var endD=new Date(parseInt(month.slice(0,4)),parseInt(month.slice(5,7)),0);var endDate=month+'-'+endD.getDate();
    // Load checkins for the month
    var monthCheckins=[];
    try{var r=await db.from('admin_checkins').select('*').gte('check_date',startDate).lte('check_date',endDate);monthCheckins=r.data||[];}catch(e){}
    // Load payments for the month
    var monthPayments=[];
    try{var r2=await db.from('admin_payments').select('*').gte('payment_date',startDate).lte('payment_date',endDate);monthPayments=r2.data||[];}catch(e){}
    
    var tb=$('payrollTable');
    tb.innerHTML=adminUsers.filter(function(u){return u.is_active!==false}).map(function(u){
        var uCheckins=monthCheckins.filter(function(c){return c.user_id===u.id});
        var totalHrs=uCheckins.reduce(function(s,c){return s+(c.hours_worked||0)},0);
        var uPayments=monthPayments.filter(function(p){return p.user_id===u.id});
        var totalPaid=uPayments.reduce(function(s,p){return s+(p.amount||0)},0);
        var owed=u.pay_type==='hourly'?(u.salary||0)*totalHrs:(u.salary||0);
        var pending=Math.max(0,owed-totalPaid);
        var payLabel=u.pay_type==='hourly'?'â° Por Hora':u.pay_type==='commission'?'ğŸ’° ComisiÃ³n':u.pay_type==='weekly'?'ğŸ“… Semanal':u.pay_type==='biweekly'?'ğŸ“… Quincenal':'ğŸ“… Mensual';
        return'<tr>'+
            '<td><div class="user-card"><div class="avatar '+roleClass(u.role)+'">'+initials(u.name)+'</div><div><h4>'+u.name+'</h4></div></div></td>'+
            '<td><span class="badge '+roleClass(u.role)+'">'+getRoleName(u.role)+'</span></td>'+
            '<td>'+payLabel+'</td>'+
            '<td style="font-weight:700">$'+(u.salary||0).toFixed(2)+'</td>'+
            '<td>'+totalHrs.toFixed(1)+'h <small>('+uCheckins.length+' dÃ­as)</small></td>'+
            '<td style="font-weight:700;color:var(--success)">$'+totalPaid.toFixed(2)+'</td>'+
            '<td style="font-weight:700;color:'+(pending>0?'var(--danger)':'var(--success)')+'">$'+pending.toFixed(2)+'</td>'+
            '<td><button class="btn-sm btn-success" onclick="registerPaymentFor(\''+u.id+'\',\''+u.name+'\','+pending+')" style="font-size:0.75rem"'+(pending<=0?' disabled':'')+'>ğŸ’µ Pagar</button></td></tr>';
    }).join('');
}

function openRegisterPayment(){
    var d=document.createElement('div');d.className='modal-bg show';d.id='modalPayEmp';
    d.innerHTML='<div class="modal" style="max-width:500px"><div class="modal-head"><h3>ğŸ’µ Registrar Pago</h3><button class="modal-close" onclick="document.getElementById(\'modalPayEmp\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Empleado</label><select id="payEmpUser">'+adminUsers.filter(function(u){return u.is_active!==false}).map(function(u){return'<option value="'+u.id+'" data-name="'+u.name+'">'+u.name+' ('+getRoleName(u.role)+')</option>'}).join('')+'</select></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div class="form-group"><label>Monto ($)</label><input type="number" id="payEmpAmount" step="0.01"></div><div class="form-group"><label>Fecha</label><input type="date" id="payEmpDate" value="'+new Date().toISOString().slice(0,10)+'"></div></div><div class="form-group"><label>MÃ©todo</label><select id="payEmpMethod"><option value="transfer">ğŸ¦ Transferencia</option><option value="cash">ğŸ’µ Efectivo</option><option value="check">ğŸ“‹ Cheque</option><option value="zelle">âš¡ Zelle</option><option value="venmo">ğŸ’œ Venmo</option></select></div><div class="form-group"><label>Notas</label><textarea id="payEmpNotes" rows="2"></textarea></div></div><div class="modal-foot"><button class="btn-sm btn-ghost" onclick="document.getElementById(\'modalPayEmp\').remove()">Cancelar</button><button class="btn-sm btn-success" onclick="saveEmpPayment()">ğŸ’µ Registrar Pago</button></div></div>';
    document.body.appendChild(d);
}
function registerPaymentFor(userId,userName,amount){
    openRegisterPayment();
    setTimeout(function(){
        var sel=$('payEmpUser');
        for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===userId){sel.selectedIndex=i;break;}}
        $('payEmpAmount').value=amount.toFixed(2);
    },100);
}
async function saveEmpPayment(){
    var userId=$('payEmpUser').value;var userName=$('payEmpUser').selectedOptions[0]?.dataset.name||'';
    var amount=parseFloat($('payEmpAmount').value)||0;var date=$('payEmpDate').value;var method=$('payEmpMethod').value;var notes=$('payEmpNotes').value;
    if(!amount){alert('Monto requerido');return;}
    await db.from('admin_payments').insert({user_id:userId,user_name:userName,amount:amount,payment_date:date,method:method,notes:notes});
    await logActivity('create','employee_payment',userId,userName+' $'+amount.toFixed(2));
    document.getElementById('modalPayEmp').remove();loadPayroll();alert('âœ… Pago registrado: $'+amount.toFixed(2)+' a '+userName);
}

// ==========================================
// UTILITIES
// ==========================================
function $(id){return document.getElementById(id);}
function openModal(id){$(id).classList.add('show');}
function closeModal(id){$(id).classList.remove('show');}
function initials(n){return n?n.split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2):'?';}
function fmtDate(d){return d?d.slice(0,10):'-';}
function fmtDateTime(d){return d?new Date(d).toLocaleString():'-';}
function generatePass(){var c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';var p='';for(var i=0;i<10;i++)p+=c[Math.floor(Math.random()*c.length)];return p;}
function generatePassword(){$('newPassword').value=generatePass();}
function planClass(p){return p==='enterprise'?'b-purple':p==='profesional'?'b-yellow':'b-gray';}
function statusClass(s){return s==='open'?'b-blue':s==='in_progress'?'b-yellow':s==='waiting_response'?'b-orange':s==='resolved'?'b-green':'b-gray';}
function statusText(s){return{open:'Abierto',in_progress:'En Progreso',waiting_response:'Esperando',resolved:'Resuelto',closed:'Cerrado'}[s]||s;}
function roleClass(r){return{super_admin:'role-super',admin:'role-admin',gerente_ops:'role-gerente',vendedor:'role-vendedor',marketing:'role-marketing',contador:'role-contador',support:'role-support'}[r]||'role-support';}
function getRoleName(r){return{super_admin:'ğŸ‘‘ Super Admin',admin:'âš™ï¸ Admin',gerente_ops:'ğŸ¦ Gerente de Operaciones',vendedor:'ğŸ¤ Vendedor',marketing:'ğŸ“£ Marketing',contador:'ğŸ“Š Contador',support:'ğŸ‘ï¸ Soporte'}[r]||r;}
function getRoleOptions(selected){return[['super_admin','ğŸ‘‘ Super Admin'],['admin','âš™ï¸ Admin'],['gerente_ops','ğŸ¦ Gerente de Operaciones'],['vendedor','ğŸ¤ Vendedor'],['marketing','ğŸ“£ Marketing'],['contador','ğŸ“Š Contador'],['support','ğŸ‘ï¸ Soporte']].map(function(o){return'<option value="'+o[0]+'" '+(selected===o[0]?'selected':'')+'>'+o[1]+'</option>'}).join('');}
function actionIcon(a){return{login:'ğŸ”‘',logout:'ğŸšª',view:'ğŸ‘',create:'â•',update:'âœï¸',delete:'ğŸ—‘ï¸'}[a]||'ğŸ“‹';}
function actionColor(a){return{login:'#dcfce7',logout:'#f3f4f6',view:'#dbeafe',create:'#dcfce7',update:'#fef3c7',delete:'#fee2e2'}[a]||'#f3f4f6';}
function actionText(a){return{login:'Login',logout:'Logout',view:'Vista',create:'CreaciÃ³n',update:'EdiciÃ³n',delete:'EliminaciÃ³n'}[a]||a;}
function notifIcon(t){return{new_ticket:'ğŸ«',new_message:'ğŸ’¬',new_company:'ğŸ¢',payment:'ğŸ’³',password_reset:'ğŸ”‘'}[t]||'ğŸ””';}
function notifColor(t){return{new_ticket:'#fee2e2',new_message:'#dbeafe',new_company:'#dcfce7',payment:'#f3e8ff',password_reset:'#fef3c7'}[t]||'#f3f4f6';}
</script>
</body>
</html>
