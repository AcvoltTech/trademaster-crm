-- =============================================
-- TRADE MASTER — Roles, Check In/Out, Nómina
-- Pega en Supabase > SQL Editor > Run
-- =============================================

-- 1. COLUMNAS NUEVAS en admin_users
DO $$ BEGIN ALTER TABLE admin_users ADD COLUMN IF NOT EXISTS phone TEXT; EXCEPTION WHEN OTHERS THEN NULL; END $$;
DO $$ BEGIN ALTER TABLE admin_users ADD COLUMN IF NOT EXISTS salary DECIMAL(10,2) DEFAULT 0; EXCEPTION WHEN OTHERS THEN NULL; END $$;
DO $$ BEGIN ALTER TABLE admin_users ADD COLUMN IF NOT EXISTS pay_type TEXT DEFAULT 'monthly'; EXCEPTION WHEN OTHERS THEN NULL; END $$;

-- 2. CHECK IN / CHECK OUT
CREATE TABLE IF NOT EXISTS admin_checkins (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES admin_users(id) ON DELETE CASCADE,
    user_name TEXT,
    user_role TEXT,
    check_date DATE NOT NULL DEFAULT CURRENT_DATE,
    check_in TIMESTAMPTZ,
    check_out TIMESTAMPTZ,
    hours_worked DECIMAL(6,2) DEFAULT 0,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_checkins_user ON admin_checkins(user_id);
CREATE INDEX IF NOT EXISTS idx_checkins_date ON admin_checkins(check_date);

-- 3. PAGOS A EMPLEADOS (Nómina)
CREATE TABLE IF NOT EXISTS admin_payments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES admin_users(id) ON DELETE CASCADE,
    user_name TEXT,
    amount DECIMAL(10,2) DEFAULT 0,
    payment_date DATE DEFAULT CURRENT_DATE,
    method TEXT DEFAULT 'transfer',  -- transfer, cash, check, zelle, venmo
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_payments_user ON admin_payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_date ON admin_payments(payment_date);

-- 4. RLS POLICIES
ALTER TABLE admin_checkins ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "checkins_all" ON admin_checkins;
CREATE POLICY "checkins_all" ON admin_checkins FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE admin_payments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "emp_payments_all" ON admin_payments;
CREATE POLICY "emp_payments_all" ON admin_payments FOR ALL USING (true) WITH CHECK (true);

-- ✅ LISTO
