<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1e40af;--accent:#f97316;--success:#22c55e;--warning:#eab308;--danger:#ef4444;--dark:#1f2937;--gray:#6b7280;--light:#f3f4f6}
        body{font-family:'Inter',sans-serif;background:var(--light);min-height:100vh}
        .login-box{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),#1e3a8a)}
        .login-box.hidden{display:none}
        .login-card{background:white;padding:2.5rem;border-radius:1rem;width:100%;max-width:400px;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .login-card h1{text-align:center;font-size:1.75rem;color:var(--primary);margin-bottom:0.5rem}
        .login-card h1 span{color:var(--accent)}
        .login-card>p{text-align:center;color:var(--gray);margin-bottom:2rem}
        .form-group{margin-bottom:1.25rem}
        .form-group label{display:block;margin-bottom:0.5rem;font-weight:500}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:0.75rem 1rem;border:2px solid #e5e7eb;border-radius:0.5rem;font-size:1rem;font-family:inherit}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary)}
        .btn{display:block;width:100%;padding:0.875rem;border:none;border-radius:0.5rem;font-size:1rem;font-weight:600;cursor:pointer;background:var(--primary);color:white}
        .btn:hover{background:#1e3a8a}
        .btn:disabled{background:#ccc;cursor:not-allowed}
        .error{background:#fee2e2;color:#dc2626;padding:0.75rem;border-radius:0.5rem;margin-bottom:1rem;display:none}
        .error.show{display:block}
        .hint{text-align:center;margin-top:1.5rem;color:var(--gray);font-size:0.8rem}
        .dashboard{display:none}
        .dashboard.active{display:block}
        .header{background:white;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);flex-wrap:wrap;gap:1rem}
        .header h1{font-size:1.5rem;color:var(--primary)}
        .header h1 span{color:var(--accent)}
        .header-right{display:flex;align-items:center;gap:1rem}
        .status{font-size:0.75rem;padding:0.25rem 0.75rem;border-radius:1rem;background:#fef3c7;color:#d97706}
        .status.ok{background:#dcfce7;color:#16a34a}
        .status.err{background:#fee2e2;color:#dc2626}
        .avatar{width:36px;height:36px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
        .btn-sm{padding:0.5rem 1rem;font-size:0.875rem;border-radius:0.5rem;border:none;cursor:pointer}
        .btn-refresh{background:var(--light)}
        .btn-danger{background:var(--danger);color:white}
        .btn-success{background:var(--success);color:white}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1.5rem;padding:2rem}
        .stat{background:white;padding:1.5rem;border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .stat-icon{width:48px;height:48px;border-radius:0.75rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:0.75rem}
        .stat h3{font-size:2rem;color:var(--dark)}
        .stat p{color:var(--gray);font-size:0.875rem}
        .content{padding:0 2rem 2rem}
        .card{background:white;border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:1.5rem}
        .card-head{padding:1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .card-head h2{font-size:1.25rem}
        .search{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--light);border-radius:0.5rem}
        .search input{border:none;background:none;outline:none;width:200px}
        .filters{display:flex;gap:0.5rem;padding:1rem 1.5rem;flex-wrap:wrap}
        .filter{padding:0.5rem 1rem;border:1px solid #e5e7eb;background:white;border-radius:2rem;font-size:0.8rem;cursor:pointer}
        .filter:hover,.filter.on{background:var(--primary);color:white;border-color:var(--primary)}
        .tbl{width:100%;border-collapse:collapse;min-width:600px}
        .tbl th{text-align:left;padding:1rem 1.5rem;background:var(--light);font-size:0.75rem;text-transform:uppercase;font-weight:600}
        .tbl td{padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb}
        .tbl tr:hover{background:#f9fafb}
        .user{display:flex;align-items:center;gap:0.75rem}
        .user .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--accent))}
        .user h4{font-weight:500}
        .user small{color:var(--gray);font-size:0.8rem}
        .badge{display:inline-block;padding:0.375rem 0.75rem;border-radius:2rem;font-size:0.75rem;font-weight:600}
        .b-green{background:#dcfce7;color:#16a34a}
        .b-yellow{background:#fef3c7;color:#d97706}
        .b-gray{background:#f3f4f6;color:#6b7280}
        .b-purple{background:#f3e8ff;color:#9333ea}
        .b-blue{background:#dbeafe;color:#1d4ed8}
        .b-red{background:#fee2e2;color:#dc2626}
        .actions{display:flex;gap:0.5rem}
        .act{width:32px;height:32px;border:none;background:var(--light);border-radius:0.375rem;cursor:pointer;font-size:0.9rem}
        .act:hover{background:var(--primary);color:white}
        .act.danger:hover{background:var(--danger)}
        .empty{text-align:center;padding:3rem;color:var(--gray)}
        .wrap{overflow-x:auto}
        @media(max-width:768px){.stats,.content{padding:1rem}.header{padding:1rem}}
        
        /* Modal */
        .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem}
        .modal-bg.show{display:flex}
        .modal{background:white;border-radius:1rem;width:100%;max-width:600px;max-height:90vh;overflow:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .modal-head{padding:1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .modal-head h3{font-size:1.25rem}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray)}
        .modal-body{padding:1.5rem}
        .modal-foot{padding:1rem 1.5rem;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:0.5rem}
        .modal-foot .btn{width:auto;padding:0.75rem 1.5rem}
        
        /* Notifications bell */
        .notif-wrap{position:relative}
        .notif-btn{background:var(--light);border:none;width:40px;height:40px;border-radius:50%;font-size:1.25rem;cursor:pointer;position:relative}
        .notif-badge{position:absolute;top:-2px;right:-2px;background:var(--danger);color:white;font-size:0.65rem;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
        .notif-badge.hidden{display:none}
        .notif-dropdown{position:absolute;top:50px;right:0;background:white;border-radius:0.75rem;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:320px;max-height:400px;overflow:auto;display:none;z-index:100}
        .notif-dropdown.show{display:block}
        .notif-item{padding:1rem;border-bottom:1px solid #e5e7eb;cursor:pointer}
        .notif-item:hover{background:#f9fafb}
        .notif-item.unread{background:#eff6ff}
        .notif-item h4{font-size:0.875rem;margin-bottom:0.25rem}
        .notif-item p{font-size:0.75rem;color:var(--gray)}
        .notif-empty{padding:2rem;text-align:center;color:var(--gray)}
        
        /* Tabs */
        .tabs{display:flex;gap:0;border-bottom:2px solid #e5e7eb;padding:0 1.5rem}
        .tab{padding:1rem 1.5rem;border:none;background:none;font-size:0.9rem;font-weight:500;cursor:pointer;color:var(--gray);border-bottom:2px solid transparent;margin-bottom:-2px}
        .tab:hover{color:var(--primary)}
        .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-content{display:none;padding:1.5rem}
        .tab-content.active{display:block}
        
        /* Employee list */
        .emp-list{display:grid;gap:0.75rem}
        .emp-item{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--light);border-radius:0.5rem}
        .emp-item .avatar{width:44px;height:44px}
        .emp-info{flex:1}
        .emp-info h4{font-size:0.9rem}
        .emp-info p{font-size:0.8rem;color:var(--gray)}
        
        /* Payment list */
        .pay-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e5e7eb}
        .pay-item:last-child{border-bottom:none}
        .pay-amount{font-weight:700;color:var(--success)}
        .pay-date{font-size:0.8rem;color:var(--gray)}
    </style>
</head>
<body>
    <div class="login-box" id="login">
        <div class="login-card">
            <h1>üîê Trade<span>Masters</span></h1>
            <p>Panel de Administraci√≥n</p>
            <div class="error" id="err"></div>
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="em" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn" id="loginBtn">Entrar ‚Üí</button>
            <p class="hint">Solo acceso autorizado</p>
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;">
              <a href="#" onclick="forgotPassword()" style="color:var(--primary);text-decoration:none;font-size:14px;">üîë ¬øOlvidaste tu contrase√±a?</a>
            </div>
        </div>
    </div>

    <div class="dashboard" id="dash">
        <header class="header">
            <h1>üîê Trade<span>Masters</span> Admin</h1>
            <div class="header-right">
                <span class="status" id="status">‚è≥ Cargando...</span>
                <div class="notif-wrap">
                    <button class="notif-btn" id="notifBtn">üîî<span class="notif-badge hidden" id="notifBadge">0</span></button>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div id="notifList"><div class="notif-empty">Sin notificaciones</div></div>
                    </div>
                </div>
                <button class="btn-sm btn-refresh" id="refreshBtn">üîÑ</button>
                <div class="avatar" id="av">M</div>
                <button class="btn-sm btn-danger" id="logoutBtn">Salir</button>
            </div>
        </header>
        <div class="stats">
            <div class="stat"><div class="stat-icon" style="background:#dbeafe">üë•</div><h3 id="s1">0</h3><p>Total Empresas</p></div>
            <div class="stat"><div class="stat-icon" style="background:#dcfce7">üí≥</div><h3 id="s2">0</h3><p>Suscripciones Activas</p></div>
            <div class="stat"><div class="stat-icon" style="background:#ffedd5">üí∞</div><h3 id="s3">$0</h3><p>Ingresos Mensuales</p></div>
            <div class="stat"><div class="stat-icon" style="background:#f3e8ff">üÜì</div><h3 id="s4">0</h3><p>Free / Trial</p></div>
            <div class="stat"><div class="stat-icon" style="background:#fef3c7">üë∑</div><h3 id="s5">0</h3><p>Total Empleados</p></div>
        </div>
        <div class="content">
            <div class="card">
                <div class="card-head">
                    <h2>üë• Empresas Registradas</h2>
                    <div class="search"><span>üîç</span><input type="text" placeholder="Buscar..." id="q"></div>
                </div>
                <div class="filters">
                    <button class="filter on" data-f="all">Todos</button>
                    <button class="filter" data-f="free">Free</button>
                    <button class="filter" data-f="profesional">Profesional</button>
                    <button class="filter" data-f="enterprise">Enterprise</button>
                </div>
                <div class="wrap"><table class="tbl"><thead><tr><th>Empresa</th><th>Tel√©fono</th><th>Registro</th><th>Plan</th><th>Empleados</th><th>Acciones</th></tr></thead><tbody id="tbody"><tr><td colspan="6" class="empty">Cargando...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Empresa -->
    <div class="modal-bg" id="modalView">
        <div class="modal">
            <div class="modal-head">
                <h3 id="modalTitle">Detalles de Empresa</h3>
                <button class="modal-close" onclick="closeModal('modalView')">√ó</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('info')">üìã Info</button>
                <button class="tab" onclick="switchTab('employees')">üë∑ Empleados</button>
                <button class="tab" onclick="switchTab('payments')">üí≥ Pagos</button>
            </div>
            <div class="tab-content active" id="tab-info">
                <div id="companyInfo"></div>
            </div>
            <div class="tab-content" id="tab-employees">
                <div id="employeesList"></div>
            </div>
            <div class="tab-content" id="tab-payments">
                <div id="paymentsList"></div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-sm" style="background:var(--light);color:var(--dark)" onclick="closeModal('modalView')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Enviar Email -->
    <div class="modal-bg" id="modalEmail">
        <div class="modal">
            <div class="modal-head">
                <h3>üìß Enviar Email</h3>
                <button class="modal-close" onclick="closeModal('modalEmail')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Para:</label>
                    <input type="text" id="emailTo" readonly>
                </div>
                <div class="form-group">
                    <label>Asunto:</label>
                    <input type="text" id="emailSubject" placeholder="Asunto del email">
                </div>
                <div class="form-group">
                    <label>Mensaje:</label>
                    <textarea id="emailBody" rows="6" placeholder="Escribe tu mensaje..."></textarea>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-sm" style="background:var(--light);color:var(--dark)" onclick="closeModal('modalEmail')">Cancelar</button>
                <button class="btn btn-sm btn-success" onclick="sendEmail()">üì§ Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reset Password -->
    <div class="modal-bg" id="modalReset">
        <div class="modal" style="max-width:500px">
            <div class="modal-head">
                <h3>üîë Resetear Contrase√±a</h3>
                <button class="modal-close" onclick="closeModal('modalReset')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="resetUserInfo" style="padding:1rem;background:var(--light);border-radius:0.5rem;margin-bottom:1rem"></div>
                <div class="form-group">
                    <label>Nueva Contrase√±a:</label>
                    <input type="text" id="newPassword" placeholder="M√≠nimo 6 caracteres">
                    <small style="color:var(--gray);font-size:0.75rem">La contrase√±a ser√° visible para que puedas compartirla con el usuario</small>
                </div>
                <button class="btn-sm" style="background:var(--light);margin-top:0.5rem" onclick="generatePassword()">üé≤ Generar Contrase√±a Segura</button>
            </div>
            <div class="modal-foot">
                <button class="btn btn-sm" style="background:var(--light);color:var(--dark)" onclick="closeModal('modalReset')">Cancelar</button>
                <button class="btn btn-sm btn-success" onclick="confirmResetPassword()">üîë Resetear</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Todos los Usuarios de Empresa -->
    <div class="modal-bg" id="modalUsers">
        <div class="modal">
            <div class="modal-head">
                <h3>üë• Usuarios de la Empresa</h3>
                <button class="modal-close" onclick="closeModal('modalUsers')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--gray);font-size:0.85rem">Haz clic en üîë para resetear la contrase√±a de cualquier usuario</p>
                <div id="allUsersList"></div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-sm" style="background:var(--light);color:var(--dark)" onclick="closeModal('modalUsers')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminar -->
    <div class="modal-bg" id="modalDelete">
        <div class="modal" style="max-width:400px">
            <div class="modal-head">
                <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('modalDelete')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:1rem">¬øEst√°s seguro de eliminar esta empresa?</p>
                <p style="font-weight:600;color:var(--danger)" id="deleteCompanyName"></p>
                <p style="margin-top:1rem;font-size:0.85rem;color:var(--gray)">Esta acci√≥n eliminar√° todos los datos asociados (clientes, trabajos, t√©cnicos, etc.) y no se puede deshacer.</p>
            </div>
            <div class="modal-foot">
                <button class="btn btn-sm" style="background:var(--light);color:var(--dark)" onclick="closeModal('modalDelete')">Cancelar</button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete()">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

<script>
(function(){
    var SUPABASE_URL = 'https://ucowlcrddzukykbaitzt.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjb3dsY3JkZHp1a3lrYmFpdHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDY4MDUsImV4cCI6MjA4NTg4MjgwNX0.SMZ6VA4jOfT120nUZm0U19dGE2j2MQ2sn_gGjv-oPes';
    var VALID_EMAILS = ['floresmario30@gmail.com','admin@trademastersusa.org','acvoltelectrical@gmail.com'];
    
    var db = null;
    var companies = [];
    var employees = {};
    var notifications = [];
    var curFilter = 'all';
    var selectedCompany = null;
    var deleteCompanyId = null;
    var lastCheckTime = null;

    function init() {
        db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase ready');
        
        document.getElementById('loginBtn').onclick = doLogin;
        document.getElementById('logoutBtn').onclick = doLogout;
        document.getElementById('refreshBtn').onclick = fetchData;
        document.getElementById('q').oninput = doSearch;
        document.getElementById('notifBtn').onclick = toggleNotifications;
        
        document.querySelectorAll('.filter').forEach(function(btn){
            btn.onclick = function(){ doFilter(btn.dataset.f, btn); };
        });
        
        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.notif-wrap')) {
                document.getElementById('notifDropdown').classList.remove('show');
            }
        });
        
        // Load last check time
        lastCheckTime = localStorage.getItem('adminLastCheck') || new Date(Date.now() - 86400000).toISOString();
    }

    function doLogin() {
        var email = document.getElementById('em').value;
        var pass = document.getElementById('pw').value;
        
        if (VALID_EMAILS.indexOf(email.toLowerCase()) >= 0 && pass.length >= 4) {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('dash').classList.add('active');
            document.getElementById('av').textContent = email[0].toUpperCase();
            fetchData();
            checkNewRegistrations();
        } else {
            document.getElementById('err').textContent = 'Email no autorizado o contrase√±a corta (min 4)';
            document.getElementById('err').classList.add('show');
        }
    }

    function doLogout() {
        document.getElementById('login').classList.remove('hidden');
        document.getElementById('dash').classList.remove('active');
        document.getElementById('em').value = '';
        document.getElementById('pw').value = '';
    }

    function fetchData() {
        var st = document.getElementById('status');
        st.textContent = '‚è≥ Cargando...';
        st.className = 'status';

        // Fetch companies
        db.from('companies').select('*').order('created_at', {ascending: false}).then(function(res){
            if (res.error) {
                st.textContent = 'üî¥ Error';
                st.className = 'status err';
                document.getElementById('tbody').innerHTML = '<tr><td colspan="6" class="empty">Error: '+res.error.message+'</td></tr>';
                return;
            }
            
            companies = res.data || [];
            console.log('Loaded:', companies.length);
            
            st.textContent = 'üü¢ Conectado';
            st.className = 'status ok';
            
            // Fetch all employees
            fetchAllEmployees();
            
            render(companies);
            updateStats(companies);
        });
    }
    
    function fetchAllEmployees() {
        // Fetch technicians
        db.from('technicians').select('*').then(function(res) {
            if (res.data) {
                res.data.forEach(function(t) {
                    if (!employees[t.company_id]) employees[t.company_id] = [];
                    t.type = 'technician';
                    employees[t.company_id].push(t);
                });
            }
        });
        
        // Fetch team_users
        db.from('team_users').select('*').then(function(res) {
            if (res.data) {
                res.data.forEach(function(u) {
                    if (!employees[u.company_id]) employees[u.company_id] = [];
                    u.type = 'user';
                    employees[u.company_id].push(u);
                });
                updateStats(companies);
            }
        });
    }
    
    function checkNewRegistrations() {
        db.from('companies').select('*').gt('created_at', lastCheckTime).order('created_at', {ascending: false}).then(function(res) {
            if (res.data && res.data.length > 0) {
                notifications = res.data.map(function(c) {
                    return {
                        id: c.id,
                        title: 'üÜï Nueva empresa registrada',
                        message: c.name + ' - ' + (c.email || 'Sin email'),
                        time: c.created_at,
                        read: false
                    };
                });
                updateNotificationBadge();
                renderNotifications();
            }
        });
        
        // Update last check time
        lastCheckTime = new Date().toISOString();
        localStorage.setItem('adminLastCheck', lastCheckTime);
    }
    
    function updateNotificationBadge() {
        var unread = notifications.filter(function(n) { return !n.read; }).length;
        var badge = document.getElementById('notifBadge');
        if (unread > 0) {
            badge.textContent = unread;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    function renderNotifications() {
        var list = document.getElementById('notifList');
        if (notifications.length === 0) {
            list.innerHTML = '<div class="notif-empty">Sin notificaciones nuevas</div>';
            return;
        }
        list.innerHTML = notifications.map(function(n) {
            return '<div class="notif-item '+(n.read?'':'unread')+'" onclick="markRead(\''+n.id+'\')">' +
                '<h4>'+n.title+'</h4>' +
                '<p>'+n.message+'</p>' +
                '<p style="margin-top:4px;font-size:0.7rem;">'+fmtDateTime(n.time)+'</p>' +
            '</div>';
        }).join('');
    }
    
    window.markRead = function(id) {
        notifications.forEach(function(n) {
            if (n.id === id) n.read = true;
        });
        updateNotificationBadge();
        renderNotifications();
    };
    
    function toggleNotifications() {
        var dd = document.getElementById('notifDropdown');
        dd.classList.toggle('show');
    }

    function render(list) {
        var tb = document.getElementById('tbody');
        if (!list || list.length === 0) {
            tb.innerHTML = '<tr><td colspan="6" class="empty">No hay empresas</td></tr>';
            return;
        }
        tb.innerHTML = list.map(function(c) {
            var empCount = employees[c.id] ? employees[c.id].length : 0;
            return '<tr>' +
                '<td><div class="user"><div class="avatar">'+initials(c.name)+'</div><div><h4>'+(c.name||'Sin nombre')+'</h4><small>'+(c.email||'')+'</small></div></div></td>' +
                '<td>'+(c.phone||'-')+'</td>' +
                '<td>'+fmtDate(c.created_at)+'</td>' +
                '<td><span class="badge '+planClass(c.plan)+'">'+(c.plan||'free')+'</span></td>' +
                '<td><span class="badge b-blue">üë∑ '+empCount+'</span></td>' +
                '<td><div class="actions">' +
                    '<button class="act" onclick="viewCompany(\''+c.id+'\')" title="Ver detalles">üëÅ</button>' +
                    '<button class="act" onclick="viewAllUsers(\''+c.id+'\')" title="Ver usuarios">üë•</button>' +
                    '<button class="act" onclick="editPlan(\''+c.id+'\')" title="Cambiar plan">‚úèÔ∏è</button>' +
                    '<button class="act" onclick="openEmailModal(\''+c.id+'\')" title="Enviar email">üìß</button>' +
                    '<button class="act danger" onclick="openDeleteModal(\''+c.id+'\')" title="Eliminar">üóëÔ∏è</button>' +
                '</div></td>' +
            '</tr>';
        }).join('');
    }

    function updateStats(list) {
        var total = list.length;
        var paid = list.filter(function(c){ return c.subscription_status === 'active' && c.plan && c.plan !== 'free'; }).length;
        var free = list.filter(function(c){ return !c.plan || c.plan === 'free'; }).length;
        var mrr = 0;
        list.forEach(function(c) {
            if (c.subscription_status === 'active') {
                if (c.plan === 'profesional') mrr += 149.99;
                if (c.plan === 'enterprise') mrr += 299;
            }
        });
        
        var totalEmps = 0;
        Object.keys(employees).forEach(function(k) {
            totalEmps += employees[k].length;
        });
        
        document.getElementById('s1').textContent = total;
        document.getElementById('s2').textContent = paid;
        document.getElementById('s3').textContent = '$' + Math.round(mrr);
        document.getElementById('s4').textContent = free;
        document.getElementById('s5').textContent = totalEmps;
    }

    function initials(n) {
        if (!n) return '?';
        return n.split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2);
    }

    function fmtDate(d) {
        if (!d) return '-';
        return d.slice(0,10);
    }
    
    function fmtDateTime(d) {
        if (!d) return '-';
        var dt = new Date(d);
        return dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString();
    }

    function planClass(p) {
        if (p === 'enterprise') return 'b-purple';
        if (p === 'profesional') return 'b-yellow';
        return 'b-gray';
    }

    function statusBadge(s) {
        if (s === 'active') return '<span class="badge b-green">‚úì Activo</span>';
        if (s === 'trial') return '<span class="badge b-yellow">‚è± Trial</span>';
        return '<span class="badge b-gray">-</span>';
    }

    function doFilter(f, btn) {
        document.querySelectorAll('.filter').forEach(function(b){b.classList.remove('on')});
        btn.classList.add('on');
        curFilter = f;
        if (f === 'all') {
            render(companies);
        } else {
            render(companies.filter(function(c){return (c.plan||'free') === f}));
        }
    }

    function doSearch() {
        var q = document.getElementById('q').value.toLowerCase();
        var filtered = companies.filter(function(c) {
            return (c.name && c.name.toLowerCase().indexOf(q) >= 0) ||
                   (c.email && c.email.toLowerCase().indexOf(q) >= 0) ||
                   (c.phone && c.phone.indexOf(q) >= 0);
        });
        render(filtered);
    }

    // View company details
    window.viewCompany = function(id) {
        selectedCompany = companies.find(function(x){return x.id === id});
        if (!selectedCompany) return;
        
        document.getElementById('modalTitle').textContent = selectedCompany.name || 'Empresa';
        
        // Info tab
        document.getElementById('companyInfo').innerHTML = 
            '<div style="display:grid;gap:1rem">' +
                '<div><strong>üìß Email:</strong> '+(selectedCompany.email||'N/A')+'</div>' +
                '<div><strong>üì± Tel√©fono:</strong> '+(selectedCompany.phone||'N/A')+'</div>' +
                '<div><strong>üí≥ Plan:</strong> <span class="badge '+planClass(selectedCompany.plan)+'">'+(selectedCompany.plan||'free')+'</span></div>' +
                '<div><strong>üìä Estado:</strong> '+statusBadge(selectedCompany.subscription_status)+'</div>' +
                '<div><strong>üìÖ Registro:</strong> '+fmtDateTime(selectedCompany.created_at)+'</div>' +
                '<div><strong>üÜî ID:</strong> <code style="font-size:0.75rem;background:#f3f4f6;padding:2px 6px;border-radius:4px">'+selectedCompany.id+'</code></div>' +
            '</div>';
        
        // Employees tab
        var emps = employees[id] || [];
        if (emps.length === 0) {
            document.getElementById('employeesList').innerHTML = '<div class="empty">Sin empleados registrados</div>';
        } else {
            document.getElementById('employeesList').innerHTML = '<div class="emp-list">' +
                emps.map(function(e) {
                    var role = e.type === 'technician' ? 'üîß T√©cnico' : 'üë§ ' + (e.role || 'Usuario');
                    return '<div class="emp-item">' +
                        '<div class="avatar">'+initials(e.name)+'</div>' +
                        '<div class="emp-info"><h4>'+(e.name||'Sin nombre')+'</h4><p>'+(e.email||e.phone||'-')+' ‚Ä¢ '+role+'</p></div>' +
                    '</div>';
                }).join('') +
            '</div>';
        }
        
        // Payments tab (placeholder - would need Stripe integration)
        document.getElementById('paymentsList').innerHTML = 
            '<div style="margin-bottom:1rem;padding:1rem;background:#fef3c7;border-radius:0.5rem;font-size:0.85rem">' +
                '‚ö†Ô∏è Para ver pagos reales, necesitas conectar la API de Stripe.' +
            '</div>' +
            '<div class="pay-item"><div><strong>Ejemplo - Pro Plan</strong><div class="pay-date">Feb 10, 2026</div></div><div class="pay-amount">$149.99</div></div>' +
            '<div class="pay-item"><div><strong>Ejemplo - Pro Plan</strong><div class="pay-date">Jan 10, 2026</div></div><div class="pay-amount">$149.99</div></div>';
        
        switchTab('info');
        document.getElementById('modalView').classList.add('show');
    };
    
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('.tab[onclick*="'+tab+'"]').classList.add('active');
        document.getElementById('tab-'+tab).classList.add('active');
    };

    // Edit plan
    window.editPlan = function(id) {
        var c = companies.find(function(x){return x.id === id});
        if (!c) return;
        var np = prompt('Plan para "'+c.name+'":\n\nOpciones: free, profesional, enterprise\nActual: '+(c.plan||'free'), c.plan||'free');
        if (np && ['free','profesional','enterprise'].indexOf(np) >= 0) {
            db.from('companies').update({plan: np, subscription_status: np === 'free' ? 'trial' : 'active'}).eq('id', id).then(function(res){
                if (res.error) {
                    alert('‚ùå Error: ' + res.error.message);
                } else {
                    alert('‚úÖ Plan actualizado a: ' + np);
                    fetchData();
                }
            });
        }
    };
    
    // Email modal
    window.openEmailModal = function(id) {
        var c = companies.find(function(x){return x.id === id});
        if (!c || !c.email) {
            alert('Esta empresa no tiene email registrado');
            return;
        }
        document.getElementById('emailTo').value = c.email;
        document.getElementById('emailSubject').value = '';
        document.getElementById('emailBody').value = '';
        document.getElementById('modalEmail').classList.add('show');
    };
    
    window.sendEmail = function() {
        var to = document.getElementById('emailTo').value;
        var subject = document.getElementById('emailSubject').value;
        var body = document.getElementById('emailBody').value;
        
        if (!subject || !body) {
            alert('Por favor completa el asunto y mensaje');
            return;
        }
        
        // Open default email client
        var mailtoLink = 'mailto:' + to + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
        window.open(mailtoLink);
        
        closeModal('modalEmail');
    };
    
    // Delete modal
    window.openDeleteModal = function(id) {
        var c = companies.find(function(x){return x.id === id});
        if (!c) return;
        deleteCompanyId = id;
        document.getElementById('deleteCompanyName').textContent = c.name + ' (' + (c.email||'sin email') + ')';
        document.getElementById('modalDelete').classList.add('show');
    };
    
    window.confirmDelete = async function() {
        if (!deleteCompanyId) return;
        
        var companyToDelete = deleteCompanyId;
        
        // Cerrar modal inmediatamente para evitar que se quede pegado
        closeModal('modalDelete');
        
        try {
            // Delete related data first (ignorar errores de tablas que no existen)
            await Promise.allSettled([
                db.from('technicians').delete().eq('company_id', companyToDelete),
                db.from('team_users').delete().eq('company_id', companyToDelete),
                db.from('clients').delete().eq('company_id', companyToDelete),
                db.from('jobs').delete().eq('company_id', companyToDelete),
                db.from('work_orders').delete().eq('company_id', companyToDelete),
                db.from('leads').delete().eq('company_id', companyToDelete)
            ]);
            
            // Delete company
            var res = await db.from('companies').delete().eq('id', companyToDelete);
            
            if (res.error) {
                alert('‚ùå Error al eliminar empresa: ' + res.error.message);
            } else {
                alert('‚úÖ Empresa eliminada correctamente');
                fetchData();
            }
        } catch (err) {
            alert('‚ùå Error inesperado: ' + err.message);
        }
        
        deleteCompanyId = null;
    };
    
    window.closeModal = function(id) {
        document.getElementById(id).classList.remove('show');
    };
    
    // Password Reset functionality
    var resetTarget = null; // {type: 'company'|'user', id, email, name}
    
    window.openResetModal = function(type, id, email, name) {
        resetTarget = {type: type, id: id, email: email, name: name};
        document.getElementById('resetUserInfo').innerHTML = 
            '<div><strong>üë§ Usuario:</strong> ' + name + '</div>' +
            '<div><strong>üìß Email:</strong> ' + email + '</div>' +
            '<div><strong>üè∑Ô∏è Tipo:</strong> ' + (type === 'company' ? 'Due√±o de Empresa' : 'T√©cnico/Empleado') + '</div>';
        document.getElementById('newPassword').value = '';
        document.getElementById('modalReset').classList.add('show');
    };
    
    window.generatePassword = function() {
        var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        var password = '';
        for (var i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('newPassword').value = password;
    };
    
    window.confirmResetPassword = function() {
        if (!resetTarget) return;
        var newPass = document.getElementById('newPassword').value;
        if (newPass.length < 6) {
            alert('La contrase√±a debe tener al menos 6 caracteres');
            return;
        }
        
        // Note: Resetting password requires admin API or service_role key
        // For now, we'll show instructions
        alert('‚ö†Ô∏è Para resetear contrase√±as necesitas:\n\n' +
              '1. Ir a Supabase Dashboard\n' +
              '2. Authentication ‚Üí Users\n' +
              '3. Buscar: ' + resetTarget.email + '\n' +
              '4. Click en "..." ‚Üí "Send password reset"\n\n' +
              'O usa esta contrase√±a temporal y p√≠dele al usuario que la cambie:\n' +
              'üîë ' + newPass + '\n\n' +
              '(Copia esta contrase√±a antes de cerrar)');
        
        closeModal('modalReset');
    };
    
    // View all users of a company
    window.viewAllUsers = function(companyId) {
        var c = companies.find(function(x){return x.id === companyId});
        if (!c) return;
        
        var html = '';
        
        // Owner
        html += '<div style="margin-bottom:1.5rem">' +
            '<h4 style="margin-bottom:0.75rem;color:var(--primary)">üëë Due√±o de la Empresa</h4>' +
            '<div class="emp-item">' +
                '<div class="avatar" style="background:var(--primary)">'+initials(c.name)+'</div>' +
                '<div class="emp-info"><h4>'+(c.name||'Sin nombre')+'</h4><p>'+(c.email||'-')+'</p></div>' +
                '<button class="btn-sm btn-success" onclick="openResetModal(\'company\',\''+c.id+'\',\''+c.email+'\',\''+c.name+'\')">üîë Reset</button>' +
            '</div>' +
        '</div>';
        
        // Employees
        var emps = employees[companyId] || [];
        if (emps.length > 0) {
            html += '<h4 style="margin-bottom:0.75rem;color:var(--primary)">üë∑ T√©cnicos y Empleados</h4>' +
                '<div class="emp-list">';
            emps.forEach(function(e) {
                var role = e.type === 'technician' ? 'üîß T√©cnico' : 'üë§ ' + (e.role || 'Usuario');
                html += '<div class="emp-item">' +
                    '<div class="avatar">'+initials(e.name)+'</div>' +
                    '<div class="emp-info"><h4>'+(e.name||'Sin nombre')+'</h4><p>'+(e.email||e.phone||'-')+' ‚Ä¢ '+role+'</p></div>' +
                    (e.email ? '<button class="btn-sm btn-success" onclick="openResetModal(\'user\',\''+e.id+'\',\''+e.email+'\',\''+e.name+'\')">üîë Reset</button>' : '<span class="badge b-gray">Sin email</span>') +
                '</div>';
            });
            html += '</div>';
        } else {
            html += '<div class="empty">No hay empleados registrados</div>';
        }
        
        document.getElementById('allUsersList').innerHTML = html;
        document.getElementById('modalUsers').classList.add('show');
    };

    document.addEventListener('DOMContentLoaded', init);
    
    // Forgot Password
    window.forgotPassword = function() {
        var choice = confirm('¬øC√≥mo quieres recuperar tu contrase√±a?\n\nOK = Por Email\nCancelar = Por Tel√©fono/WhatsApp');
        
        if (choice) {
            // Email
            var email = prompt('Ingresa tu email autorizado:');
            if (email && VALID_EMAILS.indexOf(email.toLowerCase()) >= 0) {
                alert('üìß Env√≠a un email a:\ntrademastersusacrm@gmail.com\n\nAsunto: Reset Password Admin\n\nIncluye tu email: ' + email + '\n\nTe responderemos con tu nueva contrase√±a.');
                window.open('mailto:trademastersusacrm@gmail.com?subject=Reset%20Password%20Admin&body=Email:%20' + encodeURIComponent(email));
            } else if (email) {
                alert('‚ùå Este email no est√° autorizado para el panel de admin.');
            }
        } else {
            // Phone/WhatsApp
            alert('üì± Contacta por WhatsApp:\n\n+1 (909) 639-0448\n\nEscribe: "Necesito resetear mi contrase√±a del Admin Panel"\n\nIncluye tu email autorizado.');
            window.open('https://wa.me/19096390448?text=Necesito%20resetear%20mi%20contrase√±a%20del%20Admin%20Panel');
        }
    };
})();
</script>
</body>
</html>
