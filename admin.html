<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1e40af;--accent:#f97316;--success:#22c55e;--warning:#eab308;--danger:#ef4444;--dark:#1f2937;--gray:#6b7280;--light:#f3f4f6}
        body{font-family:'Inter',sans-serif;background:var(--light);min-height:100vh}
        .login-box{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),#1e3a8a)}
        .login-box.hidden{display:none}
        .login-card{background:white;padding:2.5rem;border-radius:1rem;width:100%;max-width:400px;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .login-card h1{text-align:center;font-size:1.75rem;color:var(--primary);margin-bottom:0.5rem}
        .login-card h1 span{color:var(--accent)}
        .login-card>p{text-align:center;color:var(--gray);margin-bottom:2rem}
        .form-group{margin-bottom:1.25rem}
        .form-group label{display:block;margin-bottom:0.5rem;font-weight:500}
        .form-group input{width:100%;padding:0.75rem 1rem;border:2px solid #e5e7eb;border-radius:0.5rem;font-size:1rem}
        .form-group input:focus{outline:none;border-color:var(--primary)}
        .btn{display:block;width:100%;padding:0.875rem;border:none;border-radius:0.5rem;font-size:1rem;font-weight:600;cursor:pointer;background:var(--primary);color:white}
        .btn:hover{background:#1e3a8a}
        .error{background:#fee2e2;color:#dc2626;padding:0.75rem;border-radius:0.5rem;margin-bottom:1rem;display:none}
        .error.show{display:block}
        .hint{text-align:center;margin-top:1.5rem;color:var(--gray);font-size:0.8rem}
        .dashboard{display:none}
        .dashboard.active{display:block}
        .header{background:white;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);flex-wrap:wrap;gap:1rem}
        .header h1{font-size:1.5rem;color:var(--primary)}
        .header h1 span{color:var(--accent)}
        .header-right{display:flex;align-items:center;gap:1rem}
        .status{font-size:0.75rem;padding:0.25rem 0.75rem;border-radius:1rem;background:#fef3c7;color:#d97706}
        .status.ok{background:#dcfce7;color:#16a34a}
        .status.err{background:#fee2e2;color:#dc2626}
        .avatar{width:36px;height:36px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
        .btn-sm{padding:0.5rem 1rem;font-size:0.875rem;border-radius:0.5rem;border:none;cursor:pointer}
        .btn-refresh{background:var(--light)}
        .btn-danger{background:var(--danger);color:white}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;padding:2rem}
        .stat{background:white;padding:1.5rem;border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .stat-icon{width:48px;height:48px;border-radius:0.75rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:0.75rem}
        .stat h3{font-size:2rem;color:var(--dark)}
        .stat p{color:var(--gray);font-size:0.875rem}
        .content{padding:0 2rem 2rem}
        .card{background:white;border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden}
        .card-head{padding:1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .card-head h2{font-size:1.25rem}
        .search{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--light);border-radius:0.5rem}
        .search input{border:none;background:none;outline:none;width:200px}
        .filters{display:flex;gap:0.5rem;padding:1rem 1.5rem;flex-wrap:wrap}
        .filter{padding:0.5rem 1rem;border:1px solid #e5e7eb;background:white;border-radius:2rem;font-size:0.8rem;cursor:pointer}
        .filter:hover,.filter.on{background:var(--primary);color:white;border-color:var(--primary)}
        .tbl{width:100%;border-collapse:collapse;min-width:600px}
        .tbl th{text-align:left;padding:1rem 1.5rem;background:var(--light);font-size:0.75rem;text-transform:uppercase;font-weight:600}
        .tbl td{padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb}
        .tbl tr:hover{background:#f9fafb}
        .user{display:flex;align-items:center;gap:0.75rem}
        .user .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--accent))}
        .user h4{font-weight:500}
        .user small{color:var(--gray);font-size:0.8rem}
        .badge{display:inline-block;padding:0.375rem 0.75rem;border-radius:2rem;font-size:0.75rem;font-weight:600}
        .b-green{background:#dcfce7;color:#16a34a}
        .b-yellow{background:#fef3c7;color:#d97706}
        .b-gray{background:#f3f4f6;color:#6b7280}
        .b-purple{background:#f3e8ff;color:#9333ea}
        .actions{display:flex;gap:0.5rem}
        .act{width:32px;height:32px;border:none;background:var(--light);border-radius:0.375rem;cursor:pointer}
        .act:hover{background:var(--primary);color:white}
        .empty{text-align:center;padding:3rem;color:var(--gray)}
        .wrap{overflow-x:auto}
        @media(max-width:768px){.stats,.content{padding:1rem}.header{padding:1rem}}
    </style>
</head>
<body>
    <div class="login-box" id="login">
        <div class="login-card">
            <h1>üîê Trade<span>Masters</span></h1>
            <p>Panel de Administraci√≥n</p>
            <div class="error" id="err"></div>
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="em" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn" id="loginBtn">Entrar ‚Üí</button>
            <p class="hint">Acceso: floresmario30@gmail.com / admin123</p>
        </div>
    </div>

    <div class="dashboard" id="dash">
        <header class="header">
            <h1>üîê Trade<span>Masters</span> Admin</h1>
            <div class="header-right">
                <span class="status" id="status">‚è≥ Cargando...</span>
                <button class="btn-sm btn-refresh" id="refreshBtn">üîÑ</button>
                <div class="avatar" id="av">M</div>
                <button class="btn-sm btn-danger" id="logoutBtn">Salir</button>
            </div>
        </header>
        <div class="stats">
            <div class="stat"><div class="stat-icon" style="background:#dbeafe">üë•</div><h3 id="s1">0</h3><p>Total Empresas</p></div>
            <div class="stat"><div class="stat-icon" style="background:#dcfce7">üí≥</div><h3 id="s2">0</h3><p>Suscripciones Activas</p></div>
            <div class="stat"><div class="stat-icon" style="background:#ffedd5">üí∞</div><h3 id="s3">$0</h3><p>Ingresos Mensuales</p></div>
            <div class="stat"><div class="stat-icon" style="background:#f3e8ff">üÜì</div><h3 id="s4">0</h3><p>Free / Trial</p></div>
        </div>
        <div class="content">
            <div class="card">
                <div class="card-head">
                    <h2>üë• Empresas Registradas</h2>
                    <div class="search"><span>üîç</span><input type="text" placeholder="Buscar..." id="q"></div>
                </div>
                <div class="filters">
                    <button class="filter on" data-f="all">Todos</button>
                    <button class="filter" data-f="free">Free</button>
                    <button class="filter" data-f="profesional">Profesional</button>
                    <button class="filter" data-f="enterprise">Enterprise</button>
                </div>
                <div class="wrap"><table class="tbl"><thead><tr><th>Empresa</th><th>Tel√©fono</th><th>Registro</th><th>Plan</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tbody"><tr><td colspan="6" class="empty">Cargando...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

<script>
(function(){
    var SUPABASE_URL = 'https://ucowlcrddzukykbaitzt.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjb3dsY3JkZHp1a3lrYmFpdHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDY4MDUsImV4cCI6MjA4NTg4MjgwNX0.SMZ6VA4jOfT120nUZm0U19dGE2j2MQ2sn_gGjv-oPes';
    var VALID_EMAILS = ['floresmario30@gmail.com','admin@trademastersusa.org','acvoltelectrical@gmail.com'];
    
    var db = null;
    var companies = [];
    var curFilter = 'all';

    function init() {
        db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase ready');
        
        document.getElementById('loginBtn').onclick = doLogin;
        document.getElementById('logoutBtn').onclick = doLogout;
        document.getElementById('refreshBtn').onclick = fetchData;
        document.getElementById('q').oninput = doSearch;
        
        document.querySelectorAll('.filter').forEach(function(btn){
            btn.onclick = function(){ doFilter(btn.dataset.f, btn); };
        });
    }

    function doLogin() {
        var email = document.getElementById('em').value;
        var pass = document.getElementById('pw').value;
        
        if (VALID_EMAILS.indexOf(email.toLowerCase()) >= 0 && pass.length >= 4) {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('dash').classList.add('active');
            document.getElementById('av').textContent = email[0].toUpperCase();
            fetchData();
        } else {
            document.getElementById('err').textContent = 'Email no autorizado o contrase√±a corta (min 4)';
            document.getElementById('err').classList.add('show');
        }
    }

    function doLogout() {
        document.getElementById('login').classList.remove('hidden');
        document.getElementById('dash').classList.remove('active');
        document.getElementById('em').value = '';
        document.getElementById('pw').value = '';
    }

    function fetchData() {
        var st = document.getElementById('status');
        st.textContent = '‚è≥ Cargando...';
        st.className = 'status';

        db.from('companies').select('*').order('created_at', {ascending: false}).then(function(res){
            if (res.error) {
                st.textContent = 'üî¥ Error';
                st.className = 'status err';
                document.getElementById('tbody').innerHTML = '<tr><td colspan="6" class="empty">Error: '+res.error.message+'</td></tr>';
                return;
            }
            
            companies = res.data || [];
            console.log('Loaded:', companies.length);
            
            st.textContent = 'üü¢ Conectado';
            st.className = 'status ok';
            
            render(companies);
            updateStats(companies);
        });
    }

    function render(list) {
        var tb = document.getElementById('tbody');
        if (!list || list.length === 0) {
            tb.innerHTML = '<tr><td colspan="6" class="empty">No hay empresas</td></tr>';
            return;
        }
        tb.innerHTML = list.map(function(c) {
            return '<tr>' +
                '<td><div class="user"><div class="avatar">'+initials(c.name)+'</div><div><h4>'+(c.name||'Sin nombre')+'</h4><small>'+(c.email||'')+'</small></div></div></td>' +
                '<td>'+(c.phone||'-')+'</td>' +
                '<td>'+fmtDate(c.created_at)+'</td>' +
                '<td><span class="badge '+planClass(c.plan)+'">'+(c.plan||'free')+'</span></td>' +
                '<td>'+statusBadge(c.subscription_status)+'</td>' +
                '<td><div class="actions"><button class="act" onclick="viewC(\''+c.id+'\')">üëÅ</button><button class="act" onclick="editC(\''+c.id+'\')">‚úèÔ∏è</button></div></td>' +
            '</tr>';
        }).join('');
    }

    function updateStats(list) {
        var total = list.length;
        var paid = list.filter(function(c){ return c.subscription_status === 'active' && c.plan && c.plan !== 'free'; }).length;
        var free = list.filter(function(c){ return !c.plan || c.plan === 'free'; }).length;
        var mrr = 0;
        list.forEach(function(c) {
            if (c.subscription_status === 'active') {
                if (c.plan === 'profesional') mrr += 149.99;
                if (c.plan === 'enterprise') mrr += 299;
            }
        });
        document.getElementById('s1').textContent = total;
        document.getElementById('s2').textContent = paid;
        document.getElementById('s3').textContent = '$' + Math.round(mrr);
        document.getElementById('s4').textContent = free;
    }

    function initials(n) {
        if (!n) return '?';
        return n.split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2);
    }

    function fmtDate(d) {
        if (!d) return '-';
        return d.slice(0,10);
    }

    function planClass(p) {
        if (p === 'enterprise') return 'b-purple';
        if (p === 'profesional') return 'b-yellow';
        return 'b-gray';
    }

    function statusBadge(s) {
        if (s === 'active') return '<span class="badge b-green">‚úì Activo</span>';
        if (s === 'trial') return '<span class="badge b-yellow">‚è± Trial</span>';
        return '<span class="badge b-gray">-</span>';
    }

    function doFilter(f, btn) {
        document.querySelectorAll('.filter').forEach(function(b){b.classList.remove('on')});
        btn.classList.add('on');
        curFilter = f;
        if (f === 'all') {
            render(companies);
        } else {
            render(companies.filter(function(c){return (c.plan||'free') === f}));
        }
    }

    function doSearch() {
        var q = document.getElementById('q').value.toLowerCase();
        var filtered = companies.filter(function(c) {
            return (c.name && c.name.toLowerCase().indexOf(q) >= 0) ||
                   (c.email && c.email.toLowerCase().indexOf(q) >= 0) ||
                   (c.phone && c.phone.indexOf(q) >= 0);
        });
        render(filtered);
    }

    window.viewC = function(id) {
        var c = companies.find(function(x){return x.id === id});
        if (c) alert('üìã ' + c.name + '\n\nüìß ' + (c.email||'N/A') + '\nüì± ' + (c.phone||'N/A') + '\nüí≥ ' + (c.plan||'free') + '\nüìÖ ' + fmtDate(c.created_at));
    };

    window.editC = function(id) {
        var c = companies.find(function(x){return x.id === id});
        if (!c) return;
        var np = prompt('Plan para "'+c.name+'":\n\nOpciones: free, profesional, enterprise\nActual: '+(c.plan||'free'), c.plan||'free');
        if (np && ['free','profesional','enterprise'].indexOf(np) >= 0) {
            db.from('companies').update({plan: np, subscription_status: np === 'free' ? 'trial' : 'active'}).eq('id', id).then(function(res){
                if (res.error) {
                    alert('‚ùå Error: ' + res.error.message);
                } else {
                    alert('‚úÖ Actualizado');
                    fetchData();
                }
            });
        }
    };

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
